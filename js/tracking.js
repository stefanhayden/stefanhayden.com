!function(e){function __webpack_require__(n){if(t[n])return t[n].exports;var r=t[n]={i:n,l:!1,exports:{}};return e[n].call(r.exports,r,r.exports,__webpack_require__),r.l=!0,r.exports}var t={};__webpack_require__.m=e,__webpack_require__.c=t,__webpack_require__.d=function(e,t,n){__webpack_require__.o(e,t)||Object.defineProperty(e,t,{configurable:!1,enumerable:!0,get:n})},__webpack_require__.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return __webpack_require__.d(t,"a",t),t},__webpack_require__.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},__webpack_require__.p="/",__webpack_require__(__webpack_require__.s=3)}([function(e,t){var n;n=function(){return this}();try{n=n||Function("return this")()||(0,eval)("this")}catch(e){"object"==typeof window&&(n=window)}e.exports=n},function(e,t,n){"use strict";function createFirebaseNamespace(){function removeApp(t){callAppHooks(e[t],"delete"),delete e[t]}function app(t){return t=t||o,i(e,t)||error("no-app",{name:t}),e[t]}function initializeApp(t,n){if(void 0===n&&(n={}),"object"!=typeof n||null===n){n={name:n}}var r=n;void 0===r.name&&(r.name=o);var u=r.name;"string"==typeof u&&u||error("bad-app-name",{name:u+""}),i(e,u)&&error("duplicate-app",{name:u});var c=new s(t,r,a);return e[u]=c,callAppHooks(c,"create"),c}function getApps(){return Object.keys(e).map(function(t){return e[t]})}function registerService(e,i,o,u,c){t[e]&&error("duplicate-service",{name:e}),t[e]=i,u&&(n[e]=u,getApps().forEach(function(e){u("create",e)}));var h=function(t){return void 0===t&&(t=app()),"function"!=typeof t[e]&&error("invalid-app-argument",{name:e}),t[e]()};return void 0!==o&&r.deepExtend(h,o),a[e]=h,s.prototype[e]=function(){for(var t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];return this._getService.bind(this,e).apply(this,c?t:[])},h}function extendNamespace(e){r.deepExtend(a,e)}function callAppHooks(e,r){Object.keys(t).forEach(function(t){var i=useAsService(e,t);null!==i&&n[i]&&n[i](r,e)})}function useAsService(e,t){if("serverAuth"===t)return null;var n=t;e.options;return n}var e={},t={},n={},a={__esModule:!0,initializeApp:initializeApp,app:app,apps:null,Promise:Promise,SDK_VERSION:"5.5.9",INTERNAL:{registerService:registerService,createFirebaseNamespace:createFirebaseNamespace,extendNamespace:extendNamespace,createSubscribe:r.createSubscribe,ErrorFactory:r.ErrorFactory,removeApp:removeApp,factories:t,useAsService:useAsService,Promise:Promise,deepExtend:r.deepExtend}};return r.patchProperty(a,"default",a),Object.defineProperty(a,"apps",{get:getApps}),r.patchProperty(app,"App",s),a}function error(e,t){throw c.create(e,t)}Object.defineProperty(t,"__esModule",{value:!0});var r=n(10),i=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},o="[DEFAULT]",a=[],s=function(){function FirebaseAppImpl(e,t,n){this.firebase_=n,this.isDeleted_=!1,this.services_={},this.name_=t.name,this._automaticDataCollectionEnabled=t.automaticDataCollectionEnabled||!1,this.options_=r.deepCopy(e),this.INTERNAL={getUid:function(){return null},getToken:function(){return Promise.resolve(null)},addAuthTokenListener:function(e){a.push(e),setTimeout(function(){return e(null)},0)},removeAuthTokenListener:function(e){a=a.filter(function(t){return t!==e})}}}return Object.defineProperty(FirebaseAppImpl.prototype,"automaticDataCollectionEnabled",{get:function(){return this.checkDestroyed_(),this._automaticDataCollectionEnabled},set:function(e){this.checkDestroyed_(),this._automaticDataCollectionEnabled=e},enumerable:!0,configurable:!0}),Object.defineProperty(FirebaseAppImpl.prototype,"name",{get:function(){return this.checkDestroyed_(),this.name_},enumerable:!0,configurable:!0}),Object.defineProperty(FirebaseAppImpl.prototype,"options",{get:function(){return this.checkDestroyed_(),this.options_},enumerable:!0,configurable:!0}),FirebaseAppImpl.prototype.delete=function(){var e=this;return new Promise(function(t){e.checkDestroyed_(),t()}).then(function(){e.firebase_.INTERNAL.removeApp(e.name_);var t=[];return Object.keys(e.services_).forEach(function(n){Object.keys(e.services_[n]).forEach(function(r){t.push(e.services_[n][r])})}),Promise.all(t.map(function(e){return e.INTERNAL.delete()}))}).then(function(){e.isDeleted_=!0,e.services_={}})},FirebaseAppImpl.prototype._getService=function(e,t){if(void 0===t&&(t=o),this.checkDestroyed_(),this.services_[e]||(this.services_[e]={}),!this.services_[e][t]){var n=t!==o?t:void 0,r=this.firebase_.INTERNAL.factories[e](this,this.extendApp.bind(this),n);this.services_[e][t]=r}return this.services_[e][t]},FirebaseAppImpl.prototype.extendApp=function(e){var t=this;r.deepExtend(this,e),e.INTERNAL&&e.INTERNAL.addAuthTokenListener&&(a.forEach(function(e){t.INTERNAL.addAuthTokenListener(e)}),a=[])},FirebaseAppImpl.prototype.checkDestroyed_=function(){this.isDeleted_&&error("app-deleted",{name:this.name_})},FirebaseAppImpl}();s.prototype.name&&s.prototype.options||s.prototype.delete||console.log("dc");var u={"no-app":"No Firebase App '{$name}' has been created - call Firebase App.initializeApp()","bad-app-name":"Illegal App name: '{$name}","duplicate-app":"Firebase App named '{$name}' already exists","app-deleted":"Firebase App named '{$name}' already deleted","duplicate-service":"Firebase service named '{$name}' already registered","sa-not-supported":"Initializing the Firebase SDK with a service account is only allowed in a Node.js environment. On client devices, you should instead initialize the SDK with an api key and auth domain","invalid-app-argument":"firebase.{$name}() takes either no argument or a Firebase App instance."},c=new r.ErrorFactory("app","Firebase",u),h=createFirebaseNamespace();t.firebase=h,t.default=h},function(e,t,n){"use strict";function __extends(e,t){function __(){this.constructor=e}r(e,t),e.prototype=null===t?Object.create(t):(__.prototype=t.prototype,new __)}function __rest(e,t){var n={};for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&t.indexOf(r)<0&&(n[r]=e[r]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols)for(var i=0,r=Object.getOwnPropertySymbols(e);i<r.length;i++)t.indexOf(r[i])<0&&(n[r[i]]=e[r[i]]);return n}function __decorate(e,t,n,r){var i,o=arguments.length,a=o<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,n,r);else for(var s=e.length-1;s>=0;s--)(i=e[s])&&(a=(o<3?i(a):o>3?i(t,n,a):i(t,n))||a);return o>3&&a&&Object.defineProperty(t,n,a),a}function __param(e,t){return function(n,r){t(n,r,e)}}function __metadata(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)}function __awaiter(e,t,n,r){return new(n||(n=Promise))(function(i,o){function fulfilled(e){try{step(r.next(e))}catch(e){o(e)}}function rejected(e){try{step(r.throw(e))}catch(e){o(e)}}function step(e){e.done?i(e.value):new n(function(t){t(e.value)}).then(fulfilled,rejected)}step((r=r.apply(e,t||[])).next())})}function __generator(e,t){function verb(e){return function(t){return step([e,t])}}function step(o){if(n)throw new TypeError("Generator is already executing.");for(;a;)try{if(n=1,r&&(i=r[2&o[0]?"return":o[0]?"throw":"next"])&&!(i=i.call(r,o[1])).done)return i;switch(r=0,i&&(o=[0,i.value]),o[0]){case 0:case 1:i=o;break;case 4:return a.label++,{value:o[1],done:!1};case 5:a.label++,r=o[1],o=[0];continue;case 7:o=a.ops.pop(),a.trys.pop();continue;default:if(i=a.trys,!(i=i.length>0&&i[i.length-1])&&(6===o[0]||2===o[0])){a=0;continue}if(3===o[0]&&(!i||o[1]>i[0]&&o[1]<i[3])){a.label=o[1];break}if(6===o[0]&&a.label<i[1]){a.label=i[1],i=o;break}if(i&&a.label<i[2]){a.label=i[2],a.ops.push(o);break}i[2]&&a.ops.pop(),a.trys.pop();continue}o=t.call(e,a)}catch(e){o=[6,e],r=0}finally{n=i=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}var n,r,i,o,a={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return o={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o}function __exportStar(e,t){for(var n in e)t.hasOwnProperty(n)||(t[n]=e[n])}function __values(e){var t="function"==typeof Symbol&&e[Symbol.iterator],n=0;return t?t.call(e):{next:function(){return e&&n>=e.length&&(e=void 0),{value:e&&e[n++],done:!e}}}}function __read(e,t){var n="function"==typeof Symbol&&e[Symbol.iterator];if(!n)return e;var r,i,o=n.call(e),a=[];try{for(;(void 0===t||t-- >0)&&!(r=o.next()).done;)a.push(r.value)}catch(e){i={error:e}}finally{try{r&&!r.done&&(n=o.return)&&n.call(o)}finally{if(i)throw i.error}}return a}function __spread(){for(var e=[],t=0;t<arguments.length;t++)e=e.concat(__read(arguments[t]));return e}function __await(e){return this instanceof __await?(this.v=e,this):new __await(e)}function __asyncGenerator(e,t,n){function verb(e){i[e]&&(r[e]=function(t){return new Promise(function(n,r){o.push([e,t,n,r])>1||resume(e,t)})})}function resume(e,t){try{step(i[e](t))}catch(e){settle(o[0][3],e)}}function step(e){e.value instanceof __await?Promise.resolve(e.value.v).then(fulfill,reject):settle(o[0][2],e)}function fulfill(e){resume("next",e)}function reject(e){resume("throw",e)}function settle(e,t){e(t),o.shift(),o.length&&resume(o[0][0],o[0][1])}if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var r,i=n.apply(e,t||[]),o=[];return r={},verb("next"),verb("throw"),verb("return"),r[Symbol.asyncIterator]=function(){return this},r}function __asyncDelegator(e){function verb(r,i){e[r]&&(t[r]=function(t){return(n=!n)?{value:__await(e[r](t)),done:"return"===r}:i?i(t):t})}var t,n;return t={},verb("next"),verb("throw",function(e){throw e}),verb("return"),t[Symbol.iterator]=function(){return this},t}function __asyncValues(e){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var t=e[Symbol.asyncIterator];return t?t.call(e):"function"==typeof __values?__values(e):e[Symbol.iterator]()}function __makeTemplateObject(e,t){return Object.defineProperty?Object.defineProperty(e,"raw",{value:t}):e.raw=t,e}function __importStar(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t}function __importDefault(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(t,"__esModule",{value:!0}),t.__extends=__extends,n.d(t,"__assign",function(){return i}),t.__rest=__rest,t.__decorate=__decorate,t.__param=__param,t.__metadata=__metadata,t.__awaiter=__awaiter,t.__generator=__generator,t.__exportStar=__exportStar,t.__values=__values,t.__read=__read,t.__spread=__spread,t.__await=__await,t.__asyncGenerator=__asyncGenerator,t.__asyncDelegator=__asyncDelegator,t.__asyncValues=__asyncValues,t.__makeTemplateObject=__makeTemplateObject,t.__importStar=__importStar,t.__importDefault=__importDefault;var r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])},i=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++){t=arguments[n];for(var i in t)Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i])}return e}},function(e,t,n){"use strict";var r=n(4),i=function(e){return e&&e.__esModule?e:{default:e}}(r);n(11);var o={apiKey:"AIzaSyAWN-IlMWeCV9NlMeY8eSUil3r4LqM827w",authDomain:"symphony-metrics.firebaseapp.com",databaseURL:"https://symphony-metrics.firebaseio.com",projectId:"symphony-metrics",storageBucket:"symphony-metrics.appspot.com",messagingSenderId:"135521741295"},a=o;i.default.apps.length||i.default.initializeApp(a);var s=i.default.firestore(),u={timestampsInSnapshots:!0};s.settings(u),window.DingMetrics=function(e){var t=e.accountId,n=e.siteId;return function(e){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;s.collection("dings").doc(t).collection("ding").add({accountId:t,siteId:n,key:e,val:r,timestamp:new Date})}}},function(e,t,n){"use strict";n(5);var r=function(e){return e&&"object"==typeof e&&"default"in e?e.default:e}(n(1));e.exports=r},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),function(e,t){function noop(){}function bind(e,t){return function(){e.apply(t,arguments)}}function Promise(e){if(!(this instanceof Promise))throw new TypeError("Promises must be constructed via new");if("function"!=typeof e)throw new TypeError("not a function");this._state=0,this._handled=!1,this._value=void 0,this._deferreds=[],doResolve(e,this)}function handle(e,t){for(;3===e._state;)e=e._value;if(0===e._state)return void e._deferreds.push(t);e._handled=!0,Promise._immediateFn(function(){var n=1===e._state?t.onFulfilled:t.onRejected;if(null===n)return void(1===e._state?resolve:reject)(t.promise,e._value);var r;try{r=n(e._value)}catch(e){return void reject(t.promise,e)}resolve(t.promise,r)})}function resolve(e,t){try{if(t===e)throw new TypeError("A promise cannot be resolved with itself.");if(t&&("object"==typeof t||"function"==typeof t)){var n=t.then;if(t instanceof Promise)return e._state=3,e._value=t,void finale(e);if("function"==typeof n)return void doResolve(bind(n,t),e)}e._state=1,e._value=t,finale(e)}catch(t){reject(e,t)}}function reject(e,t){e._state=2,e._value=t,finale(e)}function finale(e){2===e._state&&0===e._deferreds.length&&Promise._immediateFn(function(){e._handled||Promise._unhandledRejectionFn(e._value)});for(var t=0,n=e._deferreds.length;t<n;t++)handle(e,e._deferreds[t]);e._deferreds=null}function Handler(e,t,n){this.onFulfilled="function"==typeof e?e:null,this.onRejected="function"==typeof t?t:null,this.promise=n}function doResolve(e,t){var n=!1;try{e(function(e){n||(n=!0,resolve(t,e))},function(e){n||(n=!0,reject(t,e))})}catch(e){if(n)return;n=!0,reject(t,e)}}function createCommonjsModule(e,t){return t={exports:{}},e(t,t.exports),t.exports}var r=n(9),i=(n.n(r),setTimeout);Promise.prototype.catch=function(e){return this.then(null,e)},Promise.prototype.then=function(e,t){var n=new this.constructor(noop);return handle(this,new Handler(e,t,n)),n},Promise.prototype.finally=function(e){var t=this.constructor;return this.then(function(n){return t.resolve(e()).then(function(){return n})},function(n){return t.resolve(e()).then(function(){return t.reject(n)})})},Promise.all=function(e){return new Promise(function(t,n){function res(e,o){try{if(o&&("object"==typeof o||"function"==typeof o)){var a=o.then;if("function"==typeof a)return void a.call(o,function(t){res(e,t)},n)}r[e]=o,0==--i&&t(r)}catch(e){n(e)}}if(!e||void 0===e.length)throw new TypeError("Promise.all accepts an array");var r=Array.prototype.slice.call(e);if(0===r.length)return t([]);for(var i=r.length,o=0;o<r.length;o++)res(o,r[o])})},Promise.resolve=function(e){return e&&"object"==typeof e&&e.constructor===Promise?e:new Promise(function(t){t(e)})},Promise.reject=function(e){return new Promise(function(t,n){n(e)})},Promise.race=function(e){return new Promise(function(t,n){for(var r=0,i=e.length;r<i;r++)e[r].then(t,n)})},Promise._immediateFn="function"==typeof e&&function(t){e(t)}||function(e){i(e,0)},Promise._unhandledRejectionFn=function(e){"undefined"!=typeof console&&console&&console.warn("Possible Unhandled Promise Rejection:",e)};var o=function(){if("undefined"!=typeof self)return self;if("undefined"!=typeof window)return window;if(void 0!==t)return t;throw new Error("unable to locate global object")}();o.Promise||(o.Promise=Promise);var a=createCommonjsModule(function(e){var t=e.exports="undefined"!=typeof window&&window.Math==Math?window:"undefined"!=typeof self&&self.Math==Math?self:Function("return this")();"number"==typeof __g&&(__g=t)}),s=createCommonjsModule(function(e){var t=e.exports={version:"2.5.5"};"number"==typeof __e&&(__e=t)}),u=(s.version,function(e){return"object"==typeof e?null!==e:"function"==typeof e}),c=function(e){if(!u(e))throw TypeError(e+" is not an object!");return e},h=function(e){try{return!!e()}catch(e){return!0}},l=!h(function(){return 7!=Object.defineProperty({},"a",{get:function(){return 7}}).a}),f=a.document,d=u(f)&&u(f.createElement),p=function(e){return d?f.createElement(e):{}},m=!l&&!h(function(){return 7!=Object.defineProperty(p("div"),"a",{get:function(){return 7}}).a}),y=function(e,t){if(!u(e))return e;var n,r;if(t&&"function"==typeof(n=e.toString)&&!u(r=n.call(e)))return r;if("function"==typeof(n=e.valueOf)&&!u(r=n.call(e)))return r;if(!t&&"function"==typeof(n=e.toString)&&!u(r=n.call(e)))return r;throw TypeError("Can't convert object to primitive value")},g=Object.defineProperty,v=l?Object.defineProperty:function(e,t,n){if(c(e),t=y(t,!0),c(n),m)try{return g(e,t,n)}catch(e){}if("get"in n||"set"in n)throw TypeError("Accessors not supported!");return"value"in n&&(e[t]=n.value),e},b={f:v},S=function(e,t){return{enumerable:!(1&e),configurable:!(2&e),writable:!(4&e),value:t}},w=l?function(e,t,n){return b.f(e,t,S(1,n))}:function(e,t,n){return e[t]=n,e},T={}.hasOwnProperty,D=function(e,t){return T.call(e,t)},E=0,C=Math.random(),I=function(e){return"Symbol(".concat(void 0===e?"":e,")_",(++E+C).toString(36))},_=createCommonjsModule(function(e){var t=I("src"),n=Function.toString,r=(""+n).split("toString");s.inspectSource=function(e){return n.call(e)},(e.exports=function(e,n,i,o){var s="function"==typeof i;s&&(D(i,"name")||w(i,"name",n)),e[n]!==i&&(s&&(D(i,t)||w(i,t,e[n]?""+e[n]:r.join(String(n)))),e===a?e[n]=i:o?e[n]?e[n]=i:w(e,n,i):(delete e[n],w(e,n,i)))})(Function.prototype,"toString",function(){return"function"==typeof this&&this[t]||n.call(this)})}),A=function(e){if("function"!=typeof e)throw TypeError(e+" is not a function!");return e},P=function(e,t,n){if(A(e),void 0===t)return e;switch(n){case 1:return function(n){return e.call(t,n)};case 2:return function(n,r){return e.call(t,n,r)};case 3:return function(n,r,i){return e.call(t,n,r,i)}}return function(){return e.apply(t,arguments)}},N=function(e,t,n){var r,i,o,u,c=e&N.F,h=e&N.G,l=e&N.S,f=e&N.P,d=e&N.B,p=h?a:l?a[t]||(a[t]={}):(a[t]||{}).prototype,m=h?s:s[t]||(s[t]={}),y=m.prototype||(m.prototype={});h&&(n=t);for(r in n)i=!c&&p&&void 0!==p[r],o=(i?p:n)[r],u=d&&i?P(o,a):f&&"function"==typeof o?P(Function.call,o):o,p&&_(p,r,o,e&N.U),m[r]!=o&&w(m,r,u),f&&y[r]!=o&&(y[r]=o)};a.core=s,N.F=1,N.G=2,N.S=4,N.P=8,N.B=16,N.W=32,N.U=64,N.R=128;var R=N,M={}.toString,O=function(e){return M.call(e).slice(8,-1)},k=Object("z").propertyIsEnumerable(0)?Object:function(e){return"String"==O(e)?e.split(""):Object(e)},L=function(e){if(void 0==e)throw TypeError("Can't call method on  "+e);return e},x=function(e){return Object(L(e))},F=Math.ceil,V=Math.floor,B=function(e){return isNaN(e=+e)?0:(e>0?V:F)(e)},q=Math.min,U=function(e){return e>0?q(B(e),9007199254740991):0},Q=Array.isArray||function(e){return"Array"==O(e)},j=a["__core-js_shared__"]||(a["__core-js_shared__"]={}),W=function(e){return j[e]||(j[e]={})},K=createCommonjsModule(function(e){var t=W("wks"),n=a.Symbol,r="function"==typeof n;(e.exports=function(e){return t[e]||(t[e]=r&&n[e]||(r?n:I)("Symbol."+e))}).store=t}),z=K("species"),G=function(e){var t;return Q(e)&&(t=e.constructor,"function"!=typeof t||t!==Array&&!Q(t.prototype)||(t=void 0),u(t)&&null===(t=t[z])&&(t=void 0)),void 0===t?Array:t},H=function(e,t){return new(G(e))(t)},J=function(e,t){var n=1==e,r=2==e,i=3==e,o=4==e,a=6==e,s=5==e||a,u=t||H;return function(t,c,h){for(var l,f,d=x(t),p=k(d),m=P(c,h,3),y=U(p.length),g=0,v=n?u(t,y):r?u(t,0):void 0;y>g;g++)if((s||g in p)&&(l=p[g],f=m(l,g,d),e))if(n)v[g]=f;else if(f)switch(e){case 3:return!0;case 5:return l;case 6:return g;case 2:v.push(l)}else if(o)return!1;return a?-1:i||o?o:v}},X=K("unscopables"),Y=Array.prototype;void 0==Y[X]&&w(Y,X,{});var $=function(e){Y[X][e]=!0},Z=J(5),ee=!0;"find"in[]&&Array(1).find(function(){ee=!1}),R(R.P+R.F*ee,"Array",{find:function(e){return Z(this,e,arguments.length>1?arguments[1]:void 0)}}),$("find");var te=(s.Array.find,J(6)),ne=!0;"findIndex"in[]&&Array(1).findIndex(function(){ne=!1}),R(R.P+R.F*ne,"Array",{findIndex:function(e){return te(this,e,arguments.length>1?arguments[1]:void 0)}}),$("findIndex");var re=(s.Array.findIndex,function(e){return k(L(e))}),ie=Math.max,oe=Math.min,ae=function(e,t){return e=B(e),e<0?ie(e+t,0):oe(e,t)},se=W("keys"),ue=function(e){return se[e]||(se[e]=I(e))},ce=function(e){return function(t,n,r){var i,o=re(t),a=U(o.length),s=ae(r,a);if(e&&n!=n){for(;a>s;)if((i=o[s++])!=i)return!0}else for(;a>s;s++)if((e||s in o)&&o[s]===n)return e||s||0;return!e&&-1}}(!1),he=ue("IE_PROTO"),le=function(e,t){var n,r=re(e),i=0,o=[];for(n in r)n!=he&&D(r,n)&&o.push(n);for(;t.length>i;)D(r,n=t[i++])&&(~ce(o,n)||o.push(n));return o},fe="constructor,hasOwnProperty,isPrototypeOf,propertyIsEnumerable,toLocaleString,toString,valueOf".split(","),de=Object.keys||function(e){return le(e,fe)},pe=Object.getOwnPropertySymbols,me={f:pe},ye={}.propertyIsEnumerable,ge={f:ye},ve=Object.assign,be=!ve||h(function(){var e={},t={},n=Symbol(),r="abcdefghijklmnopqrst";return e[n]=7,r.split("").forEach(function(e){t[e]=e}),7!=ve({},e)[n]||Object.keys(ve({},t)).join("")!=r})?function(e,t){for(var n=x(e),r=arguments.length,i=1,o=me.f,a=ge.f;r>i;)for(var s,u=k(arguments[i++]),c=o?de(u).concat(o(u)):de(u),h=c.length,l=0;h>l;)a.call(u,s=c[l++])&&(n[s]=u[s]);return n}:ve;R(R.S+R.F,"Object",{assign:be});var Se=(s.Object.assign,K("match")),we=function(e){var t;return u(e)&&(void 0!==(t=e[Se])?!!t:"RegExp"==O(e))},Te=function(e,t,n){if(we(t))throw TypeError("String#"+n+" doesn't accept regex!");return String(L(e))},De=K("match"),Ee="".startsWith;R(R.P+R.F*function(e){var t=/./;try{"/./"[e](t)}catch(n){try{return t[De]=!1,!"/./"[e](t)}catch(e){}}return!0}("startsWith"),"String",{startsWith:function(e){var t=Te(this,e,"startsWith"),n=U(Math.min(arguments.length>1?arguments[1]:void 0,t.length)),r=String(e);return Ee?Ee.call(t,r,n):t.slice(n,n+r.length)===r}});var Ce=(s.String.startsWith,function(e){var t=String(L(this)),n="",r=B(e);if(r<0||r==1/0)throw RangeError("Count can't be negative");for(;r>0;(r>>>=1)&&(t+=t))1&r&&(n+=t);return n});R(R.P,"String",{repeat:Ce});var Ie=(s.String.repeat,createCommonjsModule(function(e){var t=I("meta"),n=b.f,r=0,i=Object.isExtensible||function(){return!0},o=!h(function(){return i(Object.preventExtensions({}))}),a=function(e){n(e,t,{value:{i:"O"+ ++r,w:{}}})},s=function(e,n){if(!u(e))return"symbol"==typeof e?e:("string"==typeof e?"S":"P")+e;if(!D(e,t)){if(!i(e))return"F";if(!n)return"E";a(e)}return e[t].i},c=function(e,n){if(!D(e,t)){if(!i(e))return!0;if(!n)return!1;a(e)}return e[t].w},l=function(e){return o&&f.NEED&&i(e)&&!D(e,t)&&a(e),e},f=e.exports={KEY:t,NEED:!1,fastKey:s,getWeak:c,onFreeze:l}})),_e=(Ie.KEY,Ie.NEED,Ie.fastKey,Ie.getWeak,Ie.onFreeze,b.f),Ae=K("toStringTag"),Pe=function(e,t,n){e&&!D(e=n?e:e.prototype,Ae)&&_e(e,Ae,{configurable:!0,value:t})},Ne=K,Re={f:Ne},Me=b.f,Oe=function(e){var t=s.Symbol||(s.Symbol=a.Symbol||{});"_"==e.charAt(0)||e in t||Me(t,e,{value:Re.f(e)})},ke=function(e){var t=de(e),n=me.f;if(n)for(var r,i=n(e),o=ge.f,a=0;i.length>a;)o.call(e,r=i[a++])&&t.push(r);return t},Le=l?Object.defineProperties:function(e,t){c(e);for(var n,r=de(t),i=r.length,o=0;i>o;)b.f(e,n=r[o++],t[n]);return e},xe=a.document,Fe=xe&&xe.documentElement,Ve=ue("IE_PROTO"),Be=function(){},qe=function(){var e,t=p("iframe"),n=fe.length;for(t.style.display="none",Fe.appendChild(t),t.src="javascript:",e=t.contentWindow.document,e.open(),e.write("<script>document.F=Object<\/script>"),e.close(),qe=e.F;n--;)delete qe.prototype[fe[n]];return qe()},Ue=Object.create||function(e,t){var n;return null!==e?(Be.prototype=c(e),n=new Be,Be.prototype=null,n[Ve]=e):n=qe(),void 0===t?n:Le(n,t)},Qe=fe.concat("length","prototype"),je=Object.getOwnPropertyNames||function(e){return le(e,Qe)},We={f:je},Ke=We.f,ze={}.toString,Ge="object"==typeof window&&window&&Object.getOwnPropertyNames?Object.getOwnPropertyNames(window):[],He=function(e){try{return Ke(e)}catch(e){return Ge.slice()}},Je=function(e){return Ge&&"[object Window]"==ze.call(e)?He(e):Ke(re(e))},Xe={f:Je},Ye=Object.getOwnPropertyDescriptor,$e=l?Ye:function(e,t){if(e=re(e),t=y(t,!0),m)try{return Ye(e,t)}catch(e){}if(D(e,t))return S(!ge.f.call(e,t),e[t])},Ze={f:$e},et=Ie.KEY,tt=Ze.f,nt=b.f,rt=Xe.f,it=a.Symbol,ot=a.JSON,at=ot&&ot.stringify,st=K("_hidden"),ut=K("toPrimitive"),ct={}.propertyIsEnumerable,ht=W("symbol-registry"),lt=W("symbols"),ft=W("op-symbols"),dt=Object.prototype,pt="function"==typeof it,mt=a.QObject,yt=!mt||!mt.prototype||!mt.prototype.findChild,gt=l&&h(function(){return 7!=Ue(nt({},"a",{get:function(){return nt(this,"a",{value:7}).a}})).a})?function(e,t,n){var r=tt(dt,t);r&&delete dt[t],nt(e,t,n),r&&e!==dt&&nt(dt,t,r)}:nt,vt=function(e){var t=lt[e]=Ue(it.prototype);return t._k=e,t},bt=pt&&"symbol"==typeof it.iterator?function(e){return"symbol"==typeof e}:function(e){return e instanceof it},St=function(e,t,n){return e===dt&&St(ft,t,n),c(e),t=y(t,!0),c(n),D(lt,t)?(n.enumerable?(D(e,st)&&e[st][t]&&(e[st][t]=!1),n=Ue(n,{enumerable:S(0,!1)})):(D(e,st)||nt(e,st,S(1,{})),e[st][t]=!0),gt(e,t,n)):nt(e,t,n)},wt=function(e,t){c(e);for(var n,r=ke(t=re(t)),i=0,o=r.length;o>i;)St(e,n=r[i++],t[n]);return e},Tt=function(e,t){return void 0===t?Ue(e):wt(Ue(e),t)},Dt=function(e){var t=ct.call(this,e=y(e,!0));return!(this===dt&&D(lt,e)&&!D(ft,e))&&(!(t||!D(this,e)||!D(lt,e)||D(this,st)&&this[st][e])||t)},Et=function(e,t){if(e=re(e),t=y(t,!0),e!==dt||!D(lt,t)||D(ft,t)){var n=tt(e,t);return!n||!D(lt,t)||D(e,st)&&e[st][t]||(n.enumerable=!0),n}},Ct=function(e){for(var t,n=rt(re(e)),r=[],i=0;n.length>i;)D(lt,t=n[i++])||t==st||t==et||r.push(t);return r},It=function(e){for(var t,n=e===dt,r=rt(n?ft:re(e)),i=[],o=0;r.length>o;)!D(lt,t=r[o++])||n&&!D(dt,t)||i.push(lt[t]);return i};pt||(it=function(){if(this instanceof it)throw TypeError("Symbol is not a constructor!");var e=I(arguments.length>0?arguments[0]:void 0),t=function(n){this===dt&&t.call(ft,n),D(this,st)&&D(this[st],e)&&(this[st][e]=!1),gt(this,e,S(1,n))};return l&&yt&&gt(dt,e,{configurable:!0,set:t}),vt(e)},_(it.prototype,"toString",function(){return this._k}),Ze.f=Et,b.f=St,We.f=Xe.f=Ct,ge.f=Dt,me.f=It,l&&_(dt,"propertyIsEnumerable",Dt,!0),Re.f=function(e){return vt(K(e))}),R(R.G+R.W+R.F*!pt,{Symbol:it});for(var _t="hasInstance,isConcatSpreadable,iterator,match,replace,search,species,split,toPrimitive,toStringTag,unscopables".split(","),At=0;_t.length>At;)K(_t[At++]);for(var Pt=de(K.store),Nt=0;Pt.length>Nt;)Oe(Pt[Nt++]);R(R.S+R.F*!pt,"Symbol",{for:function(e){return D(ht,e+="")?ht[e]:ht[e]=it(e)},keyFor:function(e){if(!bt(e))throw TypeError(e+" is not a symbol!");for(var t in ht)if(ht[t]===e)return t},useSetter:function(){yt=!0},useSimple:function(){yt=!1}}),R(R.S+R.F*!pt,"Object",{create:Tt,defineProperty:St,defineProperties:wt,getOwnPropertyDescriptor:Et,getOwnPropertyNames:Ct,getOwnPropertySymbols:It}),ot&&R(R.S+R.F*(!pt||h(function(){var e=it();return"[null]"!=at([e])||"{}"!=at({a:e})||"{}"!=at(Object(e))})),"JSON",{stringify:function(e){for(var t,n,r=[e],i=1;arguments.length>i;)r.push(arguments[i++]);if(n=t=r[1],(u(t)||void 0!==e)&&!bt(e))return Q(t)||(t=function(e,t){if("function"==typeof n&&(t=n.call(this,e,t)),!bt(t))return t}),r[1]=t,at.apply(ot,r)}}),it.prototype[ut]||w(it.prototype,ut,it.prototype.valueOf),Pe(it,"Symbol"),Pe(Math,"Math",!0),Pe(a.JSON,"JSON",!0);var Rt=K("toStringTag"),Mt="Arguments"==O(function(){return arguments}()),Ot=function(e,t){try{return e[t]}catch(e){}},kt=function(e){var t,n,r;return void 0===e?"Undefined":null===e?"Null":"string"==typeof(n=Ot(t=Object(e),Rt))?n:Mt?O(t):"Object"==(r=O(t))&&"function"==typeof t.callee?"Arguments":r},Lt={};Lt[K("toStringTag")]="z",Lt+""!="[object z]"&&_(Object.prototype,"toString",function(){return"[object "+kt(this)+"]"},!0),Oe("asyncIterator"),Oe("observable");var xt=(s.Symbol,{}),Ft={};w(Ft,K("iterator"),function(){return this});var Vt=function(e,t,n){e.prototype=Ue(Ft,{next:S(1,n)}),Pe(e,t+" Iterator")},Bt=ue("IE_PROTO"),qt=Object.prototype,Ut=Object.getPrototypeOf||function(e){return e=x(e),D(e,Bt)?e[Bt]:"function"==typeof e.constructor&&e instanceof e.constructor?e.constructor.prototype:e instanceof Object?qt:null},Qt=K("iterator"),jt=!([].keys&&"next"in[].keys()),Wt=function(){return this},Kt=function(e,t,n,r,i,o,a){Vt(n,t,r);var s,u,c,h=function(e){if(!jt&&e in p)return p[e];switch(e){case"keys":case"values":return function(){return new n(this,e)}}return function(){return new n(this,e)}},l=t+" Iterator",f="values"==i,d=!1,p=e.prototype,m=p[Qt]||p["@@iterator"]||i&&p[i],y=m||h(i),g=i?f?h("entries"):y:void 0,v="Array"==t?p.entries||m:m;if(v&&(c=Ut(v.call(new e)))!==Object.prototype&&c.next&&(Pe(c,l,!0),"function"!=typeof c[Qt]&&w(c,Qt,Wt)),f&&m&&"values"!==m.name&&(d=!0,y=function(){return m.call(this)}),(jt||d||!p[Qt])&&w(p,Qt,y),xt[t]=y,xt[l]=Wt,i)if(s={values:f?y:h("values"),keys:o?y:h("keys"),entries:g},a)for(u in s)u in p||_(p,u,s[u]);else R(R.P+R.F*(jt||d),t,s);return s},zt=function(e){return function(t,n){var r,i,o=String(L(t)),a=B(n),s=o.length;return a<0||a>=s?e?"":void 0:(r=o.charCodeAt(a),r<55296||r>56319||a+1===s||(i=o.charCodeAt(a+1))<56320||i>57343?e?o.charAt(a):r:e?o.slice(a,a+2):i-56320+(r-55296<<10)+65536)}}(!0);Kt(String,"String",function(e){this._t=String(e),this._i=0},function(){var e,t=this._t,n=this._i;return n>=t.length?{value:void 0,done:!0}:(e=zt(t,n),this._i+=e.length,{value:e,done:!1})});var Gt=function(e,t){return{value:t,done:!!e}},Ht=Kt(Array,"Array",function(e,t){this._t=re(e),this._i=0,this._k=t},function(){var e=this._t,t=this._k,n=this._i++;return!e||n>=e.length?(this._t=void 0,Gt(1)):"keys"==t?Gt(0,n):"values"==t?Gt(0,e[n]):Gt(0,[n,e[n]])},"values");xt.Arguments=xt.Array,$("keys"),$("values"),$("entries");for(var Jt=K("iterator"),Xt=K("toStringTag"),Yt=xt.Array,$t={CSSRuleList:!0,CSSStyleDeclaration:!1,CSSValueList:!1,ClientRectList:!1,DOMRectList:!1,DOMStringList:!1,DOMTokenList:!0,DataTransferItemList:!1,FileList:!1,HTMLAllCollection:!1,HTMLCollection:!1,HTMLFormElement:!1,HTMLSelectElement:!1,MediaList:!0,MimeTypeArray:!1,NamedNodeMap:!1,NodeList:!0,PaintRequestList:!1,Plugin:!1,PluginArray:!1,SVGLengthList:!1,SVGNumberList:!1,SVGPathSegList:!1,SVGPointList:!1,SVGStringList:!1,SVGTransformList:!1,SourceBufferList:!1,StyleSheetList:!0,TextTrackCueList:!1,TextTrackList:!1,TouchList:!1},Zt=de($t),en=0;en<Zt.length;en++){var tn,nn=Zt[en],rn=$t[nn],on=a[nn],an=on&&on.prototype;if(an&&(an[Jt]||w(an,Jt,Yt),an[Xt]||w(an,Xt,nn),xt[nn]=Yt,rn))for(tn in Ht)an[tn]||_(an,tn,Ht[tn],!0)}Re.f("iterator")}.call(t,n(6).setImmediate,n(0))},function(e,t,n){(function(e){function Timeout(e,t){this._id=e,this._clearFn=t}var r=void 0!==e&&e||"undefined"!=typeof self&&self||window,i=Function.prototype.apply;t.setTimeout=function(){return new Timeout(i.call(setTimeout,r,arguments),clearTimeout)},t.setInterval=function(){return new Timeout(i.call(setInterval,r,arguments),clearInterval)},t.clearTimeout=t.clearInterval=function(e){e&&e.close()},Timeout.prototype.unref=Timeout.prototype.ref=function(){},Timeout.prototype.close=function(){this._clearFn.call(r,this._id)},t.enroll=function(e,t){clearTimeout(e._idleTimeoutId),e._idleTimeout=t},t.unenroll=function(e){clearTimeout(e._idleTimeoutId),e._idleTimeout=-1},t._unrefActive=t.active=function(e){clearTimeout(e._idleTimeoutId);var t=e._idleTimeout;t>=0&&(e._idleTimeoutId=setTimeout(function(){e._onTimeout&&e._onTimeout()},t))},n(7),t.setImmediate="undefined"!=typeof self&&self.setImmediate||void 0!==e&&e.setImmediate||this&&this.setImmediate,t.clearImmediate="undefined"!=typeof self&&self.clearImmediate||void 0!==e&&e.clearImmediate||this&&this.clearImmediate}).call(t,n(0))},function(e,t,n){(function(e,t){!function(e,n){"use strict";function setImmediate(e){"function"!=typeof e&&(e=new Function(""+e));for(var t=new Array(arguments.length-1),n=0;n<t.length;n++)t[n]=arguments[n+1];var a={callback:e,args:t};return o[i]=a,r(i),i++}function clearImmediate(e){delete o[e]}function run(e){var t=e.callback,r=e.args;switch(r.length){case 0:t();break;case 1:t(r[0]);break;case 2:t(r[0],r[1]);break;case 3:t(r[0],r[1],r[2]);break;default:t.apply(n,r)}}function runIfPresent(e){if(a)setTimeout(runIfPresent,0,e);else{var t=o[e];if(t){a=!0;try{run(t)}finally{clearImmediate(e),a=!1}}}}if(!e.setImmediate){var r,i=1,o={},a=!1,s=e.document,u=Object.getPrototypeOf&&Object.getPrototypeOf(e);u=u&&u.setTimeout?u:e,"[object process]"==={}.toString.call(e.process)?function(){r=function(e){t.nextTick(function(){runIfPresent(e)})}}():function(){if(e.postMessage&&!e.importScripts){var t=!0,n=e.onmessage;return e.onmessage=function(){t=!1},e.postMessage("","*"),e.onmessage=n,t}}()?function(){var t="setImmediate$"+Math.random()+"$",n=function(n){n.source===e&&"string"==typeof n.data&&0===n.data.indexOf(t)&&runIfPresent(+n.data.slice(t.length))};e.addEventListener?e.addEventListener("message",n,!1):e.attachEvent("onmessage",n),r=function(n){e.postMessage(t+n,"*")}}():e.MessageChannel?function(){var e=new MessageChannel;e.port1.onmessage=function(e){runIfPresent(e.data)},r=function(t){e.port2.postMessage(t)}}():s&&"onreadystatechange"in s.createElement("script")?function(){var e=s.documentElement;r=function(t){var n=s.createElement("script");n.onreadystatechange=function(){runIfPresent(t),n.onreadystatechange=null,e.removeChild(n),n=null},e.appendChild(n)}}():function(){r=function(e){setTimeout(runIfPresent,0,e)}}(),u.setImmediate=setImmediate,u.clearImmediate=clearImmediate}}("undefined"==typeof self?void 0===e?this:e:self)}).call(t,n(0),n(8))},function(e,t){function defaultSetTimout(){throw new Error("setTimeout has not been defined")}function defaultClearTimeout(){throw new Error("clearTimeout has not been defined")}function runTimeout(e){if(n===setTimeout)return setTimeout(e,0);if((n===defaultSetTimout||!n)&&setTimeout)return n=setTimeout,setTimeout(e,0);try{return n(e,0)}catch(t){try{return n.call(null,e,0)}catch(t){return n.call(this,e,0)}}}function runClearTimeout(e){if(r===clearTimeout)return clearTimeout(e);if((r===defaultClearTimeout||!r)&&clearTimeout)return r=clearTimeout,clearTimeout(e);try{return r(e)}catch(t){try{return r.call(null,e)}catch(t){return r.call(this,e)}}}function cleanUpNextTick(){s&&o&&(s=!1,o.length?a=o.concat(a):u=-1,a.length&&drainQueue())}function drainQueue(){if(!s){var e=runTimeout(cleanUpNextTick);s=!0;for(var t=a.length;t;){for(o=a,a=[];++u<t;)o&&o[u].run();u=-1,t=a.length}o=null,s=!1,runClearTimeout(e)}}function Item(e,t){this.fun=e,this.array=t}function noop(){}var n,r,i=e.exports={};!function(){try{n="function"==typeof setTimeout?setTimeout:defaultSetTimout}catch(e){n=defaultSetTimout}try{r="function"==typeof clearTimeout?clearTimeout:defaultClearTimeout}catch(e){r=defaultClearTimeout}}();var o,a=[],s=!1,u=-1;i.nextTick=function(e){var t=new Array(arguments.length-1);if(arguments.length>1)for(var n=1;n<arguments.length;n++)t[n-1]=arguments[n];a.push(new Item(e,t)),1!==a.length||s||runTimeout(drainQueue)},Item.prototype.run=function(){this.fun.apply(null,this.array)},i.title="browser",i.browser=!0,i.env={},i.argv=[],i.version="",i.versions={},i.on=noop,i.addListener=noop,i.once=noop,i.off=noop,i.removeListener=noop,i.removeAllListeners=noop,i.emit=noop,i.prependListener=noop,i.prependOnceListener=noop,i.listeners=function(e){return[]},i.binding=function(e){throw new Error("process.binding is not supported")},i.cwd=function(){return"/"},i.chdir=function(e){throw new Error("process.chdir is not supported")},i.umask=function(){return 0}},function(e,t){!function(e){"use strict";function normalizeName(e){if("string"!=typeof e&&(e=String(e)),/[^a-z0-9\-#$%&'*+.\^_`|~]/i.test(e))throw new TypeError("Invalid character in header field name");return e.toLowerCase()}function normalizeValue(e){return"string"!=typeof e&&(e=String(e)),e}function iteratorFor(e){var n={next:function(){var t=e.shift();return{done:void 0===t,value:t}}};return t.iterable&&(n[Symbol.iterator]=function(){return n}),n}function Headers(e){this.map={},e instanceof Headers?e.forEach(function(e,t){this.append(t,e)},this):Array.isArray(e)?e.forEach(function(e){this.append(e[0],e[1])},this):e&&Object.getOwnPropertyNames(e).forEach(function(t){this.append(t,e[t])},this)}function consumed(e){if(e.bodyUsed)return Promise.reject(new TypeError("Already read"));e.bodyUsed=!0}function fileReaderReady(e){return new Promise(function(t,n){e.onload=function(){t(e.result)},e.onerror=function(){n(e.error)}})}function readBlobAsArrayBuffer(e){var t=new FileReader,n=fileReaderReady(t);return t.readAsArrayBuffer(e),n}function readBlobAsText(e){var t=new FileReader,n=fileReaderReady(t);return t.readAsText(e),n}function readArrayBufferAsText(e){for(var t=new Uint8Array(e),n=new Array(t.length),r=0;r<t.length;r++)n[r]=String.fromCharCode(t[r]);return n.join("")}function bufferClone(e){if(e.slice)return e.slice(0);var t=new Uint8Array(e.byteLength);return t.set(new Uint8Array(e)),t.buffer}function Body(){return this.bodyUsed=!1,this._initBody=function(e){if(this._bodyInit=e,e)if("string"==typeof e)this._bodyText=e;else if(t.blob&&Blob.prototype.isPrototypeOf(e))this._bodyBlob=e;else if(t.formData&&FormData.prototype.isPrototypeOf(e))this._bodyFormData=e;else if(t.searchParams&&URLSearchParams.prototype.isPrototypeOf(e))this._bodyText=e.toString();else if(t.arrayBuffer&&t.blob&&r(e))this._bodyArrayBuffer=bufferClone(e.buffer),this._bodyInit=new Blob([this._bodyArrayBuffer]);else{if(!t.arrayBuffer||!ArrayBuffer.prototype.isPrototypeOf(e)&&!i(e))throw new Error("unsupported BodyInit type");this._bodyArrayBuffer=bufferClone(e)}else this._bodyText="";this.headers.get("content-type")||("string"==typeof e?this.headers.set("content-type","text/plain;charset=UTF-8"):this._bodyBlob&&this._bodyBlob.type?this.headers.set("content-type",this._bodyBlob.type):t.searchParams&&URLSearchParams.prototype.isPrototypeOf(e)&&this.headers.set("content-type","application/x-www-form-urlencoded;charset=UTF-8"))},t.blob&&(this.blob=function(){var e=consumed(this);if(e)return e;if(this._bodyBlob)return Promise.resolve(this._bodyBlob);if(this._bodyArrayBuffer)return Promise.resolve(new Blob([this._bodyArrayBuffer]));if(this._bodyFormData)throw new Error("could not read FormData body as blob");return Promise.resolve(new Blob([this._bodyText]))},this.arrayBuffer=function(){return this._bodyArrayBuffer?consumed(this)||Promise.resolve(this._bodyArrayBuffer):this.blob().then(readBlobAsArrayBuffer)}),this.text=function(){var e=consumed(this);if(e)return e;if(this._bodyBlob)return readBlobAsText(this._bodyBlob);if(this._bodyArrayBuffer)return Promise.resolve(readArrayBufferAsText(this._bodyArrayBuffer));if(this._bodyFormData)throw new Error("could not read FormData body as text");return Promise.resolve(this._bodyText)},t.formData&&(this.formData=function(){return this.text().then(decode)}),this.json=function(){return this.text().then(JSON.parse)},this}function normalizeMethod(e){var t=e.toUpperCase();return o.indexOf(t)>-1?t:e}function Request(e,t){t=t||{};var n=t.body;if(e instanceof Request){if(e.bodyUsed)throw new TypeError("Already read");this.url=e.url,this.credentials=e.credentials,t.headers||(this.headers=new Headers(e.headers)),this.method=e.method,this.mode=e.mode,n||null==e._bodyInit||(n=e._bodyInit,e.bodyUsed=!0)}else this.url=String(e);if(this.credentials=t.credentials||this.credentials||"omit",!t.headers&&this.headers||(this.headers=new Headers(t.headers)),this.method=normalizeMethod(t.method||this.method||"GET"),this.mode=t.mode||this.mode||null,this.referrer=null,("GET"===this.method||"HEAD"===this.method)&&n)throw new TypeError("Body not allowed for GET or HEAD requests");this._initBody(n)}function decode(e){var t=new FormData;return e.trim().split("&").forEach(function(e){if(e){var n=e.split("="),r=n.shift().replace(/\+/g," "),i=n.join("=").replace(/\+/g," ");t.append(decodeURIComponent(r),decodeURIComponent(i))}}),t}function parseHeaders(e){var t=new Headers;return e.replace(/\r?\n[\t ]+/g," ").split(/\r?\n/).forEach(function(e){var n=e.split(":"),r=n.shift().trim();if(r){var i=n.join(":").trim();t.append(r,i)}}),t}function Response(e,t){t||(t={}),this.type="default",this.status=void 0===t.status?200:t.status,this.ok=this.status>=200&&this.status<300,this.statusText="statusText"in t?t.statusText:"OK",this.headers=new Headers(t.headers),this.url=t.url||"",this._initBody(e)}if(!e.fetch){var t={searchParams:"URLSearchParams"in e,iterable:"Symbol"in e&&"iterator"in Symbol,blob:"FileReader"in e&&"Blob"in e&&function(){try{return new Blob,!0}catch(e){return!1}}(),formData:"FormData"in e,arrayBuffer:"ArrayBuffer"in e};if(t.arrayBuffer)var n=["[object Int8Array]","[object Uint8Array]","[object Uint8ClampedArray]","[object Int16Array]","[object Uint16Array]","[object Int32Array]","[object Uint32Array]","[object Float32Array]","[object Float64Array]"],r=function(e){return e&&DataView.prototype.isPrototypeOf(e)},i=ArrayBuffer.isView||function(e){return e&&n.indexOf(Object.prototype.toString.call(e))>-1};Headers.prototype.append=function(e,t){e=normalizeName(e),t=normalizeValue(t);var n=this.map[e];this.map[e]=n?n+","+t:t},Headers.prototype.delete=function(e){delete this.map[normalizeName(e)]},Headers.prototype.get=function(e){return e=normalizeName(e),this.has(e)?this.map[e]:null},Headers.prototype.has=function(e){return this.map.hasOwnProperty(normalizeName(e))},Headers.prototype.set=function(e,t){this.map[normalizeName(e)]=normalizeValue(t)},Headers.prototype.forEach=function(e,t){for(var n in this.map)this.map.hasOwnProperty(n)&&e.call(t,this.map[n],n,this)},Headers.prototype.keys=function(){var e=[];return this.forEach(function(t,n){e.push(n)}),iteratorFor(e)},Headers.prototype.values=function(){var e=[];return this.forEach(function(t){e.push(t)}),iteratorFor(e)},Headers.prototype.entries=function(){var e=[];return this.forEach(function(t,n){e.push([n,t])}),iteratorFor(e)},t.iterable&&(Headers.prototype[Symbol.iterator]=Headers.prototype.entries);var o=["DELETE","GET","HEAD","OPTIONS","POST","PUT"];Request.prototype.clone=function(){return new Request(this,{body:this._bodyInit})},Body.call(Request.prototype),Body.call(Response.prototype),Response.prototype.clone=function(){return new Response(this._bodyInit,{status:this.status,statusText:this.statusText,headers:new Headers(this.headers),url:this.url})},Response.error=function(){var e=new Response(null,{status:0,statusText:""});return e.type="error",e};var a=[301,302,303,307,308];Response.redirect=function(e,t){if(-1===a.indexOf(t))throw new RangeError("Invalid status code");return new Response(null,{status:t,headers:{location:e}})},e.Headers=Headers,e.Request=Request,e.Response=Response,e.fetch=function(e,n){return new Promise(function(r,i){var o=new Request(e,n),a=new XMLHttpRequest;a.onload=function(){var e={status:a.status,statusText:a.statusText,headers:parseHeaders(a.getAllResponseHeaders()||"")};e.url="responseURL"in a?a.responseURL:e.headers.get("X-Request-URL");var t="response"in a?a.response:a.responseText;r(new Response(t,e))},a.onerror=function(){i(new TypeError("Network request failed"))},a.ontimeout=function(){i(new TypeError("Network request failed"))},a.open(o.method,o.url,!0),"include"===o.credentials?a.withCredentials=!0:"omit"===o.credentials&&(a.withCredentials=!1),"responseType"in a&&t.blob&&(a.responseType="blob"),o.headers.forEach(function(e,t){a.setRequestHeader(t,e)}),a.send(void 0===o._bodyInit?null:o._bodyInit)})},e.fetch.polyfill=!0}}("undefined"!=typeof self?self:this)},function(e,t,n){"use strict";function deepCopy(e){return deepExtend(void 0,e)}function deepExtend(e,t){if(!(t instanceof Object))return t;switch(t.constructor){case Date:var n=t;return new Date(n.getTime());case Object:void 0===e&&(e={});break;case Array:e=[];break;default:return t}for(var r in t)t.hasOwnProperty(r)&&(e[r]=deepExtend(e[r],t[r]));return e}function patchProperty(e,t,n){e[t]=n}function patchCapture(e){var t=v;return v=e,t}function jsonEval(e){return JSON.parse(e)}function stringify(e){return JSON.stringify(e)}function createSubscribe(e,t){var n=new W(e,t);return n.subscribe.bind(n)}function async(e,t){return function(){for(var n=[],r=0;r<arguments.length;r++)n[r]=arguments[r];Promise.resolve(!0).then(function(){e.apply(void 0,n)}).catch(function(e){t&&t(e)})}}function implementsAnyMethods(e,t){if("object"!=typeof e||null===e)return!1;for(var n=0,r=t;n<r.length;n++){var i=r[n];if(i in e&&"function"==typeof e[i])return!0}return!1}function noop(){}function errorPrefix(e,t,n){var r="";switch(t){case 1:r=n?"first":"First";break;case 2:r=n?"second":"Second";break;case 3:r=n?"third":"Third";break;case 4:r=n?"fourth":"Fourth";break;default:throw new Error("errorPrefix called with argumentNumber > 4.  Need to update it?")}var i=e+" failed: ";return i+=r+" argument "}function validateNamespace(e,t,n,r){if((!r||n)&&"string"!=typeof n)throw new Error(errorPrefix(e,t,r)+"must be a valid firebase namespace.")}function validateCallback(e,t,n,r){if((!r||n)&&"function"!=typeof n)throw new Error(errorPrefix(e,t,r)+"must be a valid function.")}function validateContextObject(e,t,n,r){if((!r||n)&&("object"!=typeof n||null===n))throw new Error(errorPrefix(e,t,r)+"must be a valid context object.")}Object.defineProperty(t,"__esModule",{value:!0});var r=n(2),i={NODE_CLIENT:!1,NODE_ADMIN:!1,SDK_VERSION:"${JSCORE_VERSION}"},o=function(e,t){if(!e)throw a(t)},a=function(e){return new Error("Firebase Database ("+i.SDK_VERSION+") INTERNAL ASSERT FAILED: "+e)},s=function(e){for(var t=[],n=0,r=0;r<e.length;r++){var i=e.charCodeAt(r);i<128?t[n++]=i:i<2048?(t[n++]=i>>6|192,t[n++]=63&i|128):55296==(64512&i)&&r+1<e.length&&56320==(64512&e.charCodeAt(r+1))?(i=65536+((1023&i)<<10)+(1023&e.charCodeAt(++r)),t[n++]=i>>18|240,t[n++]=i>>12&63|128,t[n++]=i>>6&63|128,t[n++]=63&i|128):(t[n++]=i>>12|224,t[n++]=i>>6&63|128,t[n++]=63&i|128)}return t},u=function(e){for(var t=[],n=0,r=0;n<e.length;){var i=e[n++];if(i<128)t[r++]=String.fromCharCode(i);else if(i>191&&i<224){var o=e[n++];t[r++]=String.fromCharCode((31&i)<<6|63&o)}else if(i>239&&i<365){var o=e[n++],a=e[n++],s=e[n++],u=((7&i)<<18|(63&o)<<12|(63&a)<<6|63&s)-65536;t[r++]=String.fromCharCode(55296+(u>>10)),t[r++]=String.fromCharCode(56320+(1023&u))}else{var o=e[n++],a=e[n++];t[r++]=String.fromCharCode((15&i)<<12|(63&o)<<6|63&a)}}return t.join("")},c={byteToCharMap_:null,charToByteMap_:null,byteToCharMapWebSafe_:null,charToByteMapWebSafe_:null,ENCODED_VALS_BASE:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",get ENCODED_VALS(){return this.ENCODED_VALS_BASE+"+/="},get ENCODED_VALS_WEBSAFE(){return this.ENCODED_VALS_BASE+"-_."},HAS_NATIVE_SUPPORT:"function"==typeof atob,encodeByteArray:function(e,t){if(!Array.isArray(e))throw Error("encodeByteArray takes an array as a parameter");this.init_();for(var n=t?this.byteToCharMapWebSafe_:this.byteToCharMap_,r=[],i=0;i<e.length;i+=3){var o=e[i],a=i+1<e.length,s=a?e[i+1]:0,u=i+2<e.length,c=u?e[i+2]:0,h=o>>2,l=(3&o)<<4|s>>4,f=(15&s)<<2|c>>6,d=63&c;u||(d=64,a||(f=64)),r.push(n[h],n[l],n[f],n[d])}return r.join("")},encodeString:function(e,t){return this.HAS_NATIVE_SUPPORT&&!t?btoa(e):this.encodeByteArray(s(e),t)},decodeString:function(e,t){return this.HAS_NATIVE_SUPPORT&&!t?atob(e):u(this.decodeStringToByteArray(e,t))},decodeStringToByteArray:function(e,t){this.init_();for(var n=t?this.charToByteMapWebSafe_:this.charToByteMap_,r=[],i=0;i<e.length;){var o=n[e.charAt(i++)],a=i<e.length,s=a?n[e.charAt(i)]:0;++i;var u=i<e.length,c=u?n[e.charAt(i)]:64;++i;var h=i<e.length,l=h?n[e.charAt(i)]:64;if(++i,null==o||null==s||null==c||null==l)throw Error();var f=o<<2|s>>4;if(r.push(f),64!=c){var d=s<<4&240|c>>2;if(r.push(d),64!=l){var p=c<<6&192|l;r.push(p)}}}return r},init_:function(){if(!this.byteToCharMap_){this.byteToCharMap_={},this.charToByteMap_={},this.byteToCharMapWebSafe_={},this.charToByteMapWebSafe_={};for(var e=0;e<this.ENCODED_VALS.length;e++)this.byteToCharMap_[e]=this.ENCODED_VALS.charAt(e),this.charToByteMap_[this.byteToCharMap_[e]]=e,this.byteToCharMapWebSafe_[e]=this.ENCODED_VALS_WEBSAFE.charAt(e),this.charToByteMapWebSafe_[this.byteToCharMapWebSafe_[e]]=e,e>=this.ENCODED_VALS_BASE.length&&(this.charToByteMap_[this.ENCODED_VALS_WEBSAFE.charAt(e)]=e,this.charToByteMapWebSafe_[this.ENCODED_VALS.charAt(e)]=e)}}},h=function(e){var t=s(e);return c.encodeByteArray(t,!0)},l=function(e){try{return c.decodeString(e,!0)}catch(e){console.error("base64Decode failed: ",e)}return null},f=function(){function Deferred(){var e=this;this.promise=new Promise(function(t,n){e.resolve=t,e.reject=n})}return Deferred.prototype.wrapCallback=function(e){var t=this;return function(n,r){n?t.reject(n):t.resolve(r),"function"==typeof e&&(t.promise.catch(function(){}),1===e.length?e(n):e(n,r))}},Deferred}(),d=function(){return"undefined"!=typeof navigator&&"string"==typeof navigator.userAgent?navigator.userAgent:""},p=function(){return"undefined"!=typeof window&&!!(window.cordova||window.phonegap||window.PhoneGap)&&/ios|iphone|ipod|ipad|android|blackberry|iemobile/i.test(d())},m=function(){return"object"==typeof navigator&&"ReactNative"===navigator.product},y=function(){return!0===i.NODE_CLIENT||!0===i.NODE_ADMIN},g="FirebaseError",v=Error.captureStackTrace,b=function(){function FirebaseError(e,t){if(this.code=e,this.message=t,v)v(this,S.prototype.create);else try{throw Error.apply(this,arguments)}catch(e){this.name=g,Object.defineProperty(this,"stack",{get:function(){return e.stack}})}}return FirebaseError}();b.prototype=Object.create(Error.prototype),b.prototype.constructor=b,b.prototype.name=g;var S=function(){function ErrorFactory(e,t,n){this.service=e,this.serviceName=t,this.errors=n,this.pattern=/\{\$([^}]+)}/g}return ErrorFactory.prototype.create=function(e,t){void 0===t&&(t={});var n,r=this.errors[e],i=this.service+"/"+e;n=void 0===r?"Error":r.replace(this.pattern,function(e,n){var r=t[n];return void 0!==r?r.toString():"<"+n+"?>"}),n=this.serviceName+": "+n+" ("+i+").";var o=new b(i,n);for(var a in t)t.hasOwnProperty(a)&&"_"!==a.slice(-1)&&(o[a]=t[a]);return o},ErrorFactory}(),w=function(e){var t={},n={},r={},i="";try{var o=e.split(".");t=jsonEval(l(o[0])||""),n=jsonEval(l(o[1])||""),i=o[2],r=n.d||{},delete n.d}catch(e){}return{header:t,claims:n,data:r,signature:i}},T=function(e){var t,n,r=w(e).claims,i=Math.floor((new Date).getTime()/1e3);return"object"==typeof r&&(r.hasOwnProperty("nbf")?t=r.nbf:r.hasOwnProperty("iat")&&(t=r.iat),n=r.hasOwnProperty("exp")?r.exp:t+86400),i&&t&&n&&i>=t&&i<=n},D=function(e){var t=w(e).claims;return"object"==typeof t&&t.hasOwnProperty("iat")?t.iat:null},E=function(e){var t=w(e),n=t.claims;return!!n&&"object"==typeof n&&n.hasOwnProperty("iat")},C=function(e){var t=w(e).claims;return"object"==typeof t&&!0===t.admin},I=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},_=function(e,t){if(Object.prototype.hasOwnProperty.call(e,t))return e[t]},A=function(e,t){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&t(n,e[n])},P=function(e,t){return A(t,function(t,n){e[t]=n}),e},N=function(e){return P({},e)},R=function(e){return"object"==typeof e&&null!==e},M=function(e){for(var t in e)return!1;return!0},O=function(e){var t=0;for(var n in e)t++;return t},k=function(e,t,n){var r={};for(var i in e)r[i]=t.call(n,e[i],i,e);return r},L=function(e,t,n){for(var r in e)if(t.call(n,e[r],r,e))return r},x=function(e,t,n){var r=L(e,t,n);return r&&e[r]},F=function(e){for(var t in e)return t},V=function(e){var t=[],n=0;for(var r in e)t[n++]=e[r];return t},B=function(e,t){for(var n in e)if(Object.prototype.hasOwnProperty.call(e,n)&&!t(n,e[n]))return!1;return!0},q=function(e){var t=[];return A(e,function(e,n){Array.isArray(n)?n.forEach(function(n){t.push(encodeURIComponent(e)+"="+encodeURIComponent(n))}):t.push(encodeURIComponent(e)+"="+encodeURIComponent(n))}),t.length?"&"+t.join("&"):""},U=function(e){var t={};return e.replace(/^\?/,"").split("&").forEach(function(e){if(e){var n=e.split("=");t[n[0]]=n[1]}}),t},Q=function(){function Hash(){this.blockSize=-1}return Hash}(),j=function(e){function Sha1(){var t=e.call(this)||this;t.chain_=[],t.buf_=[],t.W_=[],t.pad_=[],t.inbuf_=0,t.total_=0,t.blockSize=64,t.pad_[0]=128;for(var n=1;n<t.blockSize;++n)t.pad_[n]=0;return t.reset(),t}return r.__extends(Sha1,e),Sha1.prototype.reset=function(){this.chain_[0]=1732584193,this.chain_[1]=4023233417,this.chain_[2]=2562383102,this.chain_[3]=271733878,this.chain_[4]=3285377520,this.inbuf_=0,this.total_=0},Sha1.prototype.compress_=function(e,t){t||(t=0);var n=this.W_;if("string"==typeof e)for(var r=0;r<16;r++)n[r]=e.charCodeAt(t)<<24|e.charCodeAt(t+1)<<16|e.charCodeAt(t+2)<<8|e.charCodeAt(t+3),t+=4;else for(var r=0;r<16;r++)n[r]=e[t]<<24|e[t+1]<<16|e[t+2]<<8|e[t+3],t+=4;for(var r=16;r<80;r++){var i=n[r-3]^n[r-8]^n[r-14]^n[r-16];n[r]=4294967295&(i<<1|i>>>31)}for(var o,a,s=this.chain_[0],u=this.chain_[1],c=this.chain_[2],h=this.chain_[3],l=this.chain_[4],r=0;r<80;r++){r<40?r<20?(o=h^u&(c^h),a=1518500249):(o=u^c^h,a=1859775393):r<60?(o=u&c|h&(u|c),a=2400959708):(o=u^c^h,a=3395469782);var i=(s<<5|s>>>27)+o+l+a+n[r]&4294967295;l=h,h=c,c=4294967295&(u<<30|u>>>2),u=s,s=i}this.chain_[0]=this.chain_[0]+s&4294967295,this.chain_[1]=this.chain_[1]+u&4294967295,this.chain_[2]=this.chain_[2]+c&4294967295,this.chain_[3]=this.chain_[3]+h&4294967295,this.chain_[4]=this.chain_[4]+l&4294967295},Sha1.prototype.update=function(e,t){if(null!=e){void 0===t&&(t=e.length);for(var n=t-this.blockSize,r=0,i=this.buf_,o=this.inbuf_;r<t;){if(0==o)for(;r<=n;)this.compress_(e,r),r+=this.blockSize;if("string"==typeof e){for(;r<t;)if(i[o]=e.charCodeAt(r),++o,++r,o==this.blockSize){this.compress_(i),o=0;break}}else for(;r<t;)if(i[o]=e[r],++o,++r,o==this.blockSize){this.compress_(i),o=0;break}}this.inbuf_=o,this.total_+=t}},Sha1.prototype.digest=function(){var e=[],t=8*this.total_;this.inbuf_<56?this.update(this.pad_,56-this.inbuf_):this.update(this.pad_,this.blockSize-(this.inbuf_-56));for(var n=this.blockSize-1;n>=56;n--)this.buf_[n]=255&t,t/=256;this.compress_(this.buf_);for(var r=0,n=0;n<5;n++)for(var i=24;i>=0;i-=8)e[r]=this.chain_[n]>>i&255,++r;return e},Sha1}(Q),W=function(){function ObserverProxy(e,t){var n=this;this.observers=[],this.unsubscribes=[],this.observerCount=0,this.task=Promise.resolve(),this.finalized=!1,this.onNoObservers=t,this.task.then(function(){e(n)}).catch(function(e){n.error(e)})}return ObserverProxy.prototype.next=function(e){this.forEachObserver(function(t){t.next(e)})},ObserverProxy.prototype.error=function(e){this.forEachObserver(function(t){t.error(e)}),this.close(e)},ObserverProxy.prototype.complete=function(){this.forEachObserver(function(e){e.complete()}),this.close()},ObserverProxy.prototype.subscribe=function(e,t,n){var r,i=this;if(void 0===e&&void 0===t&&void 0===n)throw new Error("Missing Observer.");r=implementsAnyMethods(e,["next","error","complete"])?e:{next:e,error:t,complete:n},void 0===r.next&&(r.next=noop),void 0===r.error&&(r.error=noop),void 0===r.complete&&(r.complete=noop);var o=this.unsubscribeOne.bind(this,this.observers.length);return this.finalized&&this.task.then(function(){try{i.finalError?r.error(i.finalError):r.complete()}catch(e){}}),this.observers.push(r),o},ObserverProxy.prototype.unsubscribeOne=function(e){void 0!==this.observers&&void 0!==this.observers[e]&&(delete this.observers[e],this.observerCount-=1,0===this.observerCount&&void 0!==this.onNoObservers&&this.onNoObservers(this))},ObserverProxy.prototype.forEachObserver=function(e){if(!this.finalized)for(var t=0;t<this.observers.length;t++)this.sendOne(t,e)},ObserverProxy.prototype.sendOne=function(e,t){var n=this;this.task.then(function(){if(void 0!==n.observers&&void 0!==n.observers[e])try{t(n.observers[e])}catch(e){"undefined"!=typeof console&&console.error&&console.error(e)}})},ObserverProxy.prototype.close=function(e){var t=this;this.finalized||(this.finalized=!0,void 0!==e&&(this.finalError=e),this.task.then(function(){t.observers=void 0,t.onNoObservers=void 0}))},ObserverProxy}(),K=function(e,t,n,r){var i;if(r<t?i="at least "+t:r>n&&(i=0===n?"none":"no more than "+n),i){var o=e+" failed: Was called with "+r+(1===r?" argument.":" arguments.")+" Expects "+i+".";throw new Error(o)}},z=function(e){for(var t=[],n=0,r=0;r<e.length;r++){var i=e.charCodeAt(r);if(i>=55296&&i<=56319){var a=i-55296;r++,o(r<e.length,"Surrogate pair missing trail surrogate.");i=65536+(a<<10)+(e.charCodeAt(r)-56320)}i<128?t[n++]=i:i<2048?(t[n++]=i>>6|192,t[n++]=63&i|128):i<65536?(t[n++]=i>>12|224,t[n++]=i>>6&63|128,t[n++]=63&i|128):(t[n++]=i>>18|240,t[n++]=i>>12&63|128,t[n++]=i>>6&63|128,t[n++]=63&i|128)}return t},G=function(e){for(var t=0,n=0;n<e.length;n++){var r=e.charCodeAt(n);r<128?t++:r<2048?t+=2:r>=55296&&r<=56319?(t+=4,n++):t+=3}return t};t.assert=o,t.assertionError=a,t.base64=c,t.base64Decode=l,t.base64Encode=h,t.CONSTANTS=i,t.deepCopy=deepCopy,t.deepExtend=deepExtend,t.patchProperty=patchProperty,t.Deferred=f,t.getUA=d,t.isMobileCordova=p,t.isNodeSdk=y,t.isReactNative=m,t.ErrorFactory=S,t.FirebaseError=b,t.patchCapture=patchCapture,t.jsonEval=jsonEval,t.stringify=stringify,t.decode=w,t.isAdmin=C,t.issuedAtTime=D,t.isValidFormat=E,t.isValidTimestamp=T,t.clone=N,t.contains=I,t.every=B,t.extend=P,t.findKey=L,t.findValue=x,t.forEach=A,t.getAnyKey=F,t.getCount=O,t.getValues=V,t.isEmpty=M,t.isNonNullObject=R,t.map=k,t.safeGet=_,t.querystring=q,t.querystringDecode=U,t.Sha1=j,t.async=async,t.createSubscribe=createSubscribe,t.errorPrefix=errorPrefix,t.validateArgCount=K,t.validateCallback=validateCallback,t.validateContextObject=validateContextObject,t.validateNamespace=validateNamespace,t.stringLength=G,t.stringToByteArray=z},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(12);n.n(r)},function(e,t,n){"use strict";function getLogLevel(){return c.logLevel===o.LogLevel.DEBUG?r.DEBUG:c.logLevel===o.LogLevel.SILENT?r.SILENT:r.ERROR}function setLogLevel(e){switch(e){case r.DEBUG:c.logLevel=o.LogLevel.DEBUG;break;case r.ERROR:c.logLevel=o.LogLevel.ERROR;break;case r.SILENT:c.logLevel=o.LogLevel.SILENT;break;default:c.error("Firestore ("+u+"): Invalid value passed to `setLogLevel`")}}function debug(e,t){for(var n=[],r=2;r<arguments.length;r++)n[r-2]=arguments[r];if(c.logLevel<=o.LogLevel.DEBUG){var i=n.map(argToString);c.debug.apply(c,["Firestore ("+u+") ["+e+"]: "+t].concat(i))}}function error(e){for(var t=[],n=1;n<arguments.length;n++)t[n-1]=arguments[n];if(c.logLevel<=o.LogLevel.ERROR){var r=t.map(argToString);c.error.apply(c,["Firestore ("+u+"): "+e].concat(r))}}function argToString(e){if("string"==typeof e)return e;var t=h.getPlatform();try{return t.formatJSON(e)}catch(t){return e}}function fail(e){var t="FIRESTORE ("+u+") INTERNAL ASSERTION FAILED: "+e;throw error(t),new Error(t)}function assert(e,t){e||fail(t)}function emptyByteString(){return h.getPlatform().emptyByteString}function makeConstructorPrivate(e,t){function PublicConstructor(){var e="This constructor is private.";throw t&&(e+=" ",e+=t),new f(l.INVALID_ARGUMENT,e)}PublicConstructor.prototype=e.prototype;for(var n in e)e.hasOwnProperty(n)&&(PublicConstructor[n]=e[n]);return PublicConstructor}function contains(e,t){return Object.prototype.hasOwnProperty.call(e,t)}function defaulted(e,t){return void 0!==e?e:t}function forEachNumber(e,t){for(var n in e)if(Object.prototype.hasOwnProperty.call(e,n)){var r=Number(n);isNaN(r)||t(r,e[n])}}function values(e){var t=[];return forEach(e,function(e,n){return t.push(n)}),t}function forEach(e,t){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&t(n,e[n])}function isEmpty(e){assert(null!=e&&"object"==typeof e,"isEmpty() expects object parameter.");for(var t in e)if(Object.prototype.hasOwnProperty.call(e,t))return!1;return!0}function shallowCopy(e){assert(e&&"object"==typeof e,"shallowCopy() expects object parameter.");var t={};for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t}function validateExactNumberOfArgs(e,t,n){if(t.length!==n)throw new f(l.INVALID_ARGUMENT,"Function "+e+"() requires "+formatPlural(n,"argument")+", but was called with "+formatPlural(t.length,"argument")+".")}function validateAtLeastNumberOfArgs(e,t,n){if(t.length<n)throw new f(l.INVALID_ARGUMENT,"Function "+e+"() requires at least "+formatPlural(n,"argument")+", but was called with "+formatPlural(t.length,"argument")+".")}function validateBetweenNumberOfArgs(e,t,n,r){if(t.length<n||t.length>r)throw new f(l.INVALID_ARGUMENT,"Function "+e+"() requires between "+n+" and "+r+" arguments, but was called with "+formatPlural(t.length,"argument")+".")}function validateNamedArrayAtLeastNumberOfElements(e,t,n,r){if(!(t instanceof Array)||t.length<r)throw new f(l.INVALID_ARGUMENT,"Function "+e+"() requires its "+n+" argument to be an array with at least "+formatPlural(r,"element")+".")}function validateArgType(e,t,n,r){validateType(e,t,ordinal(n)+" argument",r)}function validateOptionalArgType(e,t,n,r){void 0!==r&&validateArgType(e,t,n,r)}function validateNamedType(e,t,n,r){validateType(e,t,n+" option",r)}function validateNamedOptionalType(e,t,n,r){void 0!==r&&validateNamedType(e,t,n,r)}function validateArrayElements(e,t,n,r,i){if(!(r instanceof Array))throw new f(l.INVALID_ARGUMENT,"Function "+e+"() requires its "+t+" option to be an array, but it was: "+valueDescription(r));for(var o=0;o<r.length;++o)if(!i(r[o]))throw new f(l.INVALID_ARGUMENT,"Function "+e+"() requires all "+t+" elements to be "+n+", but the value at index "+o+" was: "+valueDescription(r[o]))}function validateOptionalArrayElements(e,t,n,r,i){void 0!==r&&validateArrayElements(e,t,n,r,i)}function validateNamedPropertyEquals(e,t,n,r,i){for(var o=[],a=0,s=i;a<s.length;a++){var u=s[a];if(u===r)return;o.push(valueDescription(u))}var c=valueDescription(r);throw new f(l.INVALID_ARGUMENT,"Invalid value "+c+" provided to function "+e+'() for option "'+n+'". Acceptable values: '+o.join(", "))}function validateNamedOptionalPropertyEquals(e,t,n,r,i){void 0!==r&&validateNamedPropertyEquals(e,t,n,r,i)}function validateType(e,t,n,r){if(!("object"===t?isPlainObject(r):"non-empty string"===t?"string"==typeof r&&""!==r:typeof r===t)){var i=valueDescription(r);throw new f(l.INVALID_ARGUMENT,"Function "+e+"() requires its "+n+" to be of type "+t+", but it was: "+i)}}function isPlainObject(e){return"object"==typeof e&&null!==e&&(Object.getPrototypeOf(e)===Object.prototype||null===Object.getPrototypeOf(e))}function valueDescription(e){if(void 0===e)return"undefined";if(null===e)return"null";if("string"==typeof e)return e.length>20&&(e=e.substring(0,20)+"..."),JSON.stringify(e);if("number"==typeof e||"boolean"==typeof e)return""+e;if("object"==typeof e){if(e instanceof Array)return"an array";var t=tryGetCustomObjectType(e);return t?"a custom "+t+" object":"an object"}return"function"==typeof e?"a function":fail("Unknown wrong type: "+typeof e)}function tryGetCustomObjectType(e){if(e.constructor){var t=/function\s+([^\s(]+)\s*\(/,n=t.exec(e.constructor.toString());if(n&&n.length>1)return n[1]}return null}function validateDefined(e,t,n){if(void 0===n)throw new f(l.INVALID_ARGUMENT,"Function "+e+"() requires a valid "+ordinal(t)+" argument, but it was undefined.")}function validateOptionNames(e,t,n){forEach(t,function(t,r){if(n.indexOf(t)<0)throw new f(l.INVALID_ARGUMENT,"Unknown option '"+t+"' passed to function "+e+"(). Available options: "+n.join(", "))})}function invalidClassError(e,t,n,r){var i=valueDescription(r);return new f(l.INVALID_ARGUMENT,"Function "+e+"() requires its "+ordinal(n)+" argument to be a "+t+", but it was: "+i)}function ordinal(e){switch(e){case 1:return"first";case 2:return"second";case 3:return"third";default:return e+"th"}}function formatPlural(e,t){return e+" "+t+(1===e?"":"s")}function primitiveComparator(e,t){return e<t?-1:e>t?1:0}function equals(e,t){return null!==e&&void 0!==e?!(!t||!e.isEqual(t)):e===t}function arrayEquals(e,t){if(e.length!==t.length)return!1;for(var n=0;n<e.length;n++)if(!e[n].isEqual(t[n]))return!1;return!0}function immediateSuccessor(e){return e+"\0"}function assertUint8ArrayAvailable(){if("undefined"==typeof Uint8Array)throw new f(l.UNIMPLEMENTED,"Uint8Arrays are not available in this environment.")}function assertBase64Available(){if(!h.getPlatform().base64Available)throw new f(l.UNIMPLEMENTED,"Blobs are unavailable in Firestore in this environment.")}function numericComparator(e,t){return e<t?-1:e>t?1:e===t?0:isNaN(e)?isNaN(t)?0:-1:1}function numericEquals(e,t){return e===t?0!==e||1/e==1/t:e!==e&&t!==t}function isNullOrUndefined(e){return null===e||void 0===e}function isSafeInteger(e){return te(e)&&e<=ee&&e>=Z}function coercedFieldValuesArray(e){return e instanceof Y?e.internalValue.slice():[]}function isPermanentError(e){switch(e){case l.OK:return fail("Treated status OK as error");case l.CANCELLED:case l.UNKNOWN:case l.DEADLINE_EXCEEDED:case l.RESOURCE_EXHAUSTED:case l.INTERNAL:case l.UNAVAILABLE:case l.UNAUTHENTICATED:return!1;case l.INVALID_ARGUMENT:case l.NOT_FOUND:case l.ALREADY_EXISTS:case l.PERMISSION_DENIED:case l.FAILED_PRECONDITION:case l.ABORTED:case l.OUT_OF_RANGE:case l.UNIMPLEMENTED:case l.DATA_LOSS:return!0;default:return fail("Unknown status code: "+e)}}function mapCodeFromRpcStatus(e){var t=be[e];if(void 0!==t)return mapCodeFromRpcCode(t)}function mapCodeFromRpcCode(e){if(void 0===e)return error("GRPC error has no .code"),l.UNKNOWN;switch(e){case be.OK:return l.OK;case be.CANCELLED:return l.CANCELLED;case be.UNKNOWN:return l.UNKNOWN;case be.DEADLINE_EXCEEDED:return l.DEADLINE_EXCEEDED;case be.RESOURCE_EXHAUSTED:return l.RESOURCE_EXHAUSTED;case be.INTERNAL:return l.INTERNAL;case be.UNAVAILABLE:return l.UNAVAILABLE;case be.UNAUTHENTICATED:return l.UNAUTHENTICATED;case be.INVALID_ARGUMENT:return l.INVALID_ARGUMENT;case be.NOT_FOUND:return l.NOT_FOUND;case be.ALREADY_EXISTS:return l.ALREADY_EXISTS;case be.PERMISSION_DENIED:return l.PERMISSION_DENIED;case be.FAILED_PRECONDITION:return l.FAILED_PRECONDITION;case be.ABORTED:return l.ABORTED;case be.OUT_OF_RANGE:return l.OUT_OF_RANGE;case be.UNIMPLEMENTED:return l.UNIMPLEMENTED;case be.DATA_LOSS:return l.DATA_LOSS;default:return fail("Unknown status code: "+e)}}function mapRpcCodeFromCode(e){if(void 0===e)return be.OK;switch(e){case l.OK:return be.OK;case l.CANCELLED:return be.CANCELLED;case l.UNKNOWN:return be.UNKNOWN;case l.DEADLINE_EXCEEDED:return be.DEADLINE_EXCEEDED;case l.RESOURCE_EXHAUSTED:return be.RESOURCE_EXHAUSTED;case l.INTERNAL:return be.INTERNAL;case l.UNAVAILABLE:return be.UNAVAILABLE;case l.UNAUTHENTICATED:return be.UNAUTHENTICATED;case l.INVALID_ARGUMENT:return be.INVALID_ARGUMENT;case l.NOT_FOUND:return be.NOT_FOUND;case l.ALREADY_EXISTS:return be.ALREADY_EXISTS;case l.PERMISSION_DENIED:return be.PERMISSION_DENIED;case l.FAILED_PRECONDITION:return be.FAILED_PRECONDITION;case l.ABORTED:return be.ABORTED;case l.OUT_OF_RANGE:return be.OUT_OF_RANGE;case l.UNIMPLEMENTED:return be.UNIMPLEMENTED;case l.DATA_LOSS:return be.DATA_LOSS;default:return fail("Unknown status code: "+e)}}function mapCodeFromHttpStatus(e){switch(e){case 200:return l.OK;case 400:return l.INVALID_ARGUMENT;case 401:return l.UNAUTHENTICATED;case 403:return l.PERMISSION_DENIED;case 404:return l.NOT_FOUND;case 409:return l.ABORTED;case 416:return l.OUT_OF_RANGE;case 429:return l.RESOURCE_EXHAUSTED;case 499:return l.CANCELLED;case 500:return l.UNKNOWN;case 501:return l.UNIMPLEMENTED;case 503:return l.UNAVAILABLE;case 504:return l.DEADLINE_EXCEEDED;default:return e>=200&&e<300?l.OK:e>=400&&e<500?l.FAILED_PRECONDITION:e>=500&&e<600?l.INTERNAL:l.UNKNOWN}}function maybeDocumentMap(){return Me}function documentMap(){return Oe}function documentVersionMap(){return ke}function documentKeySet(){return Le}function targetIdSet(){return xe}function documentTargetMap(){return new N(C.comparator)}function snapshotChangesMap(){return new N(C.comparator)}function assertPresent(e,t){assert(!isNullOrUndefined(e),t+" is missing")}function parseInt64(e){return"number"==typeof e?e:"string"==typeof e?Number(e):fail("can't parse "+e)}function hasTag(e,t,n){return t===n||!t&&n in e}function encode(e){for(var t="",n=0;n<e.length;n++)t.length>0&&(t=encodeSeparator(t)),t=encodeSegment(e.get(n),t);return encodeSeparator(t)}function encodeSegment(e,t){for(var n=t,r=e.length,i=0;i<r;i++){var o=e.charAt(i);switch(o){case"\0":n+=gt+bt;break;case gt:n+=gt+St;break;default:n+=o}}return n}function encodeSeparator(e){return e+gt+vt}function decode$1(e){var t=e.length;if(assert(t>=2,"Invalid path "+e),2===t)return assert(e.charAt(0)===gt&&e.charAt(1)===vt,"Non-empty path "+e+" had length 2"),T.EMPTY_PATH;for(var n=t-2,r=[],i="",o=0;o<t;){var a=e.indexOf(gt,o);(a<0||a>n)&&fail('Invalid encoded resource path: "'+e+'"');switch(e.charAt(a+1)){case vt:var s=e.substring(o,a),u=void 0;0===i.length?u=s:(i+=s,u=i,i=""),r.push(u);break;case bt:i+=e.substring(o,a),i+="\0";break;case St:i+=e.substring(o,a+1);break;default:fail('Invalid encoded resource path: "'+e+'"')}o=a+2}return new T(r)}function wrapRequest(e){return new _t(function(t,n){e.onsuccess=function(e){var n=e.target.result;t(n)},e.onerror=function(e){n(e.target.error)}})}function targetsStore(e){return yn.getStore(e,Jt.store)}function globalTargetStore(e){return yn.getStore(e,Yt.store)}function retrieveMetadata(e){return At.getStore(e,Yt.store).get(Yt.key).next(function(e){return assert(null!==e,"Missing metadata row."),e})}function getHighestListenSequenceNumber(e){return retrieveMetadata(e).next(function(e){return e.highestListenSequenceNumber})}function documentTargetStore(e){return yn.getStore(e,Xt.store)}function documentGlobalStore(e){return yn.getStore(e,Ht.store)}function isDocumentChangeMissingError(e){return e.code===l.DATA_LOSS&&e.message===Lt}function remoteDocumentsStore(e){return yn.getStore(e,Gt.store)}function documentChangesStore(e){return yn.getStore(e,$t.store)}function dbKey(e){return e.path.toArray()}function dbDocumentSize(e){var t;if(e.document)t=e.document;else if(e.unknownDocument)t=e.unknownDocument;else{if(!e.noDocument)throw fail("Unknown remote document type");t=e.noDocument}return JSON.stringify(t).length}function sentinelKey(e){return[0,encode(e)]}function createPrimaryClientStore(e){e.createObjectStore(Ut.store)}function createMutationQueue(e){e.createObjectStore(Qt.store,{keyPath:Qt.keyPath}),e.createObjectStore(jt.store,{keyPath:jt.keyPath,autoIncrement:!0}).createIndex(jt.userMutationsIndex,jt.userMutationsKeyPath,{unique:!0}),e.createObjectStore(Wt.store)}function upgradeMutationBatchSchemaAndMigrateData(e,t){return t.store(jt.store).loadAll().next(function(n){e.deleteObjectStore(jt.store),e.createObjectStore(jt.store,{keyPath:jt.keyPath,autoIncrement:!0}).createIndex(jt.userMutationsIndex,jt.userMutationsKeyPath,{unique:!0});var r=t.store(jt.store),i=n.map(function(e){return r.put(e)});return _t.waitFor(i)})}function createRemoteDocumentCache(e){e.createObjectStore(Gt.store)}function createDocumentGlobalStore(e){e.createObjectStore(Ht.store)}function createQueryCache(e){e.createObjectStore(Xt.store,{keyPath:Xt.keyPath}).createIndex(Xt.documentTargetsIndex,Xt.documentTargetsKeyPath,{unique:!0}),e.createObjectStore(Jt.store,{keyPath:Jt.keyPath}).createIndex(Jt.queryTargetsIndexName,Jt.queryTargetsKeyPath,{unique:!0}),e.createObjectStore(Yt.store)}function dropQueryCache(e){e.deleteObjectStore(Xt.store),e.deleteObjectStore(Jt.store),e.deleteObjectStore(Yt.store)}function writeEmptyTargetGlobalEntry(e){var t=e.store(Yt.store),n=new Yt(0,0,de.MIN.toTimestamp(),0);return t.put(Yt.key,n)}function createRemoteDocumentChangesStore(e){e.createObjectStore($t.store,{keyPath:"id",autoIncrement:!0})}function createClientMetadataStore(e){e.createObjectStore(Zt.store,{keyPath:Zt.keyPath})}function mutationQueueContainsKey(e,t,n){var r=Wt.prefixForPath(t,n.path),i=r[1],o=IDBKeyRange.lowerBound(r),a=!1;return documentMutationsStore(e).iterate({range:o,keysOnly:!0},function(e,n,r){var o=e[0],s=e[1];e[2];o===t&&s===i&&(a=!0),r.done()}).next(function(){return a})}function mutationQueuesContainKey(e,t){var n=!1;return mutationQueuesStore(e).iterateSerial(function(r){return mutationQueueContainsKey(e,r,t).next(function(e){return e&&(n=!0),_t.resolve(!e)})}).next(function(){return n})}function removeMutationBatch(e,t,n){var r=e.store(jt.store),i=e.store(Wt.store),o=[],a=IDBKeyRange.only(n.batchId),s=0,u=r.iterate({range:a},function(e,t,n){return s++,n.delete()});o.push(u.next(function(){assert(1===s,"Dangling document-mutation reference found: Missing batch "+n.batchId)}));for(var c=[],h=0,l=n.mutations;h<l.length;h++){var f=l[h],d=Wt.key(t,f.key.path,n.batchId);o.push(i.delete(d)),c.push(f.key)}return _t.waitFor(o).next(function(){return c})}function convertStreamToken(e){return e instanceof Uint8Array?(assert("YES"===Object({NODE_ENV:"production"}).USE_MOCK_PERSISTENCE,"Persisting non-string stream tokens is only supported with mock persistence."),e.toString()):e}function mutationsStore(e){return yn.getStore(e,jt.store)}function documentMutationsStore(e){return yn.getStore(e,Wt.store)}function mutationQueuesStore(e){return yn.getStore(e,Qt.store)}function isDocumentQuery(e){return void 0!==e.documents}function bufferEntryComparator(e,t){var n=e[0],r=e[1],i=t[0],o=t[1],a=primitiveComparator(n,i);return 0===a?primitiveComparator(r,o):a}function isPrimaryLeaseLostError(e){return e.code===l.FAILED_PRECONDITION&&e.message===fn}function primaryClientStore(e){return e.store(Ut.store)}function clientMetadataStore(e){return e.store(Zt.store)}function sentinelKey$1(e){return[0,encode(e.path)]}function sentinelRow(e,t){return new Xt(0,encode(e.path),t)}function writeSentinelKey(e,t){return documentTargetStore(e).put(sentinelRow(t,e.currentSequenceNumber))}function documentSizeMap(){return new N(C.comparator)}function compareChangeType(e,t){var n=function(e){switch(e){case Ne.Added:return 1;case Ne.Modified:case Ne.Metadata:return 2;case Ne.Removed:return 0;default:return fail("Unknown ChangeType: "+e)}};return n(e)-n(t)}function fromWebStorageSequenceNumber(e){var t=ft.INVALID;if(null!=e)try{var n=JSON.parse(e);assert("number"==typeof n,"Found non-numeric sequence number"),t=n}catch(e){error(tr,"Failed to read sequence number from WebStorage",e)}return t}function fromDotSeparatedString(e){if(e.search(gr)>=0)throw new f(l.INVALID_ARGUMENT,"Invalid field path ("+e+"). Paths must not contain '~', '*', '/', '[', or ']'");try{return new(yr.bind.apply(yr,[void 0].concat(e.split("."))))}catch(t){throw new f(l.INVALID_ARGUMENT,"Invalid field path ("+e+"). Paths must not be empty, begin with '.', end with '.', or contain '..'")}}function makeCredentialsProvider(e){if(!e)return new br;switch(e.type){case"gapi":return new Tr(e.client,e.sessionIndex||"0");case"provider":return e.client;default:throw new f(l.INVALID_ARGUMENT,"makeCredentialsProvider failed due to invalid credential type")}}function isPartialObserver(e){return implementsAnyMethods$1(e,["next","error","complete"])}function implementsAnyMethods$1(e,t){if("object"!=typeof e||null===e)return!1;for(var n=e,r=0,i=t;r<i.length;r++){var o=i[r];if(o in n&&"function"==typeof n[o])return!0}return!1}function isWrite(e){switch(e){case Un.Set:case Un.MergeSet:case Un.Update:return!0;case Un.Argument:return!1;default:throw fail("Unexpected case for UserDataSource: "+e)}}function looksLikeJsonObject(e){return!("object"!=typeof e||null===e||e instanceof Array||e instanceof Date||e instanceof g||e instanceof y||e instanceof p||e instanceof Or||e instanceof Dr)}function validatePlainObject(e,t,n){if(!looksLikeJsonObject(n)||!isPlainObject(n)){var r=valueDescription(n);throw"an object"===r?t.createError(e+" a custom object"):t.createError(e+" "+r)}}function fieldPathFromArgument(e,t){if(t instanceof yr)return t._internalPath;if("string"==typeof t)return fieldPathFromDotSeparatedString(e,t);throw new f(l.INVALID_ARGUMENT,"Function "+e+"() called with invalid data. Field path arguments must be of type string or FieldPath.")}function fieldPathFromDotSeparatedString(e,t){try{return fromDotSeparatedString(t)._internalPath}catch(t){var n=errorMessage(t);throw new f(l.INVALID_ARGUMENT,"Function "+e+"() called with invalid data. "+n)}}function errorMessage(e){return e instanceof Error?e.message:e.toString()}function throwDocChangesMethodError(){throw new f(l.INVALID_ARGUMENT,'QuerySnapshot.docChanges has been changed from a property into a method, so usages like "querySnapshot.docChanges" should become "querySnapshot.docChanges()"')}function validateSetOptions(e,t){if(void 0===t)return{merge:!1};if(validateOptionNames(e,t,["merge","mergeFields"]),validateNamedOptionalType(e,"boolean","merge",t.merge),validateOptionalArrayElements(e,"mergeFields","a string or a FieldPath",t.mergeFields,function(e){return"string"==typeof e||e instanceof yr}),void 0!==t.mergeFields&&void 0!==t.merge)throw new f(l.INVALID_ARGUMENT,"Invalid options passed to function "+e+'(): You cannot specify both "merge" and "mergeFields".');return t}function validateSnapshotOptions(e,t){return void 0===t?{}:(validateOptionNames(e,t,["serverTimestamps"]),validateNamedOptionalPropertyEquals(e,"options","serverTimestamps",t.serverTimestamps,["estimate","previous","none"]),t)}function validateGetOptions(e,t){validateOptionalArgType(e,"object",1,t),t&&(validateOptionNames(e,t,["source"]),validateNamedOptionalPropertyEquals(e,"options","source",t.source,["default","server","cache"]))}function validateReference(e,t,n){if(t instanceof Kr){if(t.firestore!==n)throw new f(l.INVALID_ARGUMENT,"Provided document reference is from a different Firestore instance.");return t}throw invalidClassError(e,"DocumentReference",1,t)}function changesFromSnapshot(e,t,n){if(n.oldDocs.isEmpty()){var r,i=0;return n.docChanges.map(function(t){var o=new Hr(e,t.doc.key,t.doc,n.fromCache,n.mutatedKeys.has(t.doc.key));return assert(t.type===Ne.Added,"Invalid event type for first snapshot"),assert(!r||n.query.docComparator(r,t.doc)<0,"Got added events in wrong order"),r=t.doc,{type:"added",doc:o,oldIndex:-1,newIndex:i++}})}var o=n.oldDocs;return n.docChanges.filter(function(e){return t||e.type!==Ne.Metadata}).map(function(t){var r=new Hr(e,t.doc.key,t.doc,n.fromCache,n.mutatedKeys.has(t.doc.key)),i=-1,a=-1;return t.type!==Ne.Added&&(i=o.indexOf(t.doc.key),assert(i>=0,"Index for document not found"),o=o.delete(t.doc.key)),t.type!==Ne.Removed&&(o=o.add(t.doc),a=o.indexOf(t.doc.key)),{type:resultChangeType(t.type),doc:r,oldIndex:i,newIndex:a}})}function resultChangeType(e){switch(e){case Ne.Added:return"added";case Ne.Modified:case Ne.Metadata:return"modified";case Ne.Removed:return"removed";default:return fail("Unknown change type: "+e)}}function configureForFirebase(e){e.INTERNAL.registerService("firestore",function(e){return new Qr(e)},shallowCopy(si))}function registerFirestore(e){configureForFirebase(e)}Object.defineProperty(t,"__esModule",{value:!0});var r,i=function(e){return e&&"object"==typeof e&&"default"in e?e.default:e}(n(1)),o=n(13),a=n(2),s=n(14),u=i.SDK_VERSION,c=new o.Logger("@firebase/firestore");!function(e){e[e.DEBUG=0]="DEBUG",e[e.ERROR=1]="ERROR",e[e.SILENT=2]="SILENT"}(r||(r={}));var h=function(){function PlatformSupport(){}return PlatformSupport.setPlatform=function(e){PlatformSupport.platform&&fail("Platform already defined"),PlatformSupport.platform=e},PlatformSupport.getPlatform=function(){return PlatformSupport.platform||fail("Platform not set"),PlatformSupport.platform},PlatformSupport}(),l={OK:"ok",CANCELLED:"cancelled",UNKNOWN:"unknown",INVALID_ARGUMENT:"invalid-argument",DEADLINE_EXCEEDED:"deadline-exceeded",NOT_FOUND:"not-found",ALREADY_EXISTS:"already-exists",PERMISSION_DENIED:"permission-denied",UNAUTHENTICATED:"unauthenticated",RESOURCE_EXHAUSTED:"resource-exhausted",FAILED_PRECONDITION:"failed-precondition",ABORTED:"aborted",OUT_OF_RANGE:"out-of-range",UNIMPLEMENTED:"unimplemented",INTERNAL:"internal",UNAVAILABLE:"unavailable",DATA_LOSS:"data-loss"},f=function(e){function FirestoreError(t,n){var r=e.call(this,n)||this;return r.code=t,r.message=n,r.name="FirebaseError",r.toString=function(){return r.name+": [code="+r.code+"]: "+r.message},r}return a.__extends(FirestoreError,e),FirestoreError}(Error),d=function(){function AutoId(){}return AutoId.newId=function(){for(var e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",t="",n=0;n<20;n++)t+=e.charAt(Math.floor(Math.random()*e.length));return assert(20===t.length,"Invalid auto ID: "+t),t},AutoId}(),p=function(){function Blob(e){assertBase64Available(),this._binaryString=e}return Blob.fromBase64String=function(e){validateExactNumberOfArgs("Blob.fromBase64String",arguments,1),validateArgType("Blob.fromBase64String","string",1,e),assertBase64Available();try{return new Blob(h.getPlatform().atob(e))}catch(e){throw new f(l.INVALID_ARGUMENT,"Failed to construct Blob from Base64 string: "+e)}},Blob.fromUint8Array=function(e){if(validateExactNumberOfArgs("Blob.fromUint8Array",arguments,1),assertUint8ArrayAvailable(),!(e instanceof Uint8Array))throw invalidClassError("Blob.fromUint8Array","Uint8Array",1,e);return new Blob(Array.prototype.map.call(e,function(e){return String.fromCharCode(e)}).join(""))},Blob.prototype.toBase64=function(){return validateExactNumberOfArgs("Blob.toBase64",arguments,0),assertBase64Available(),h.getPlatform().btoa(this._binaryString)},Blob.prototype.toUint8Array=function(){validateExactNumberOfArgs("Blob.toUint8Array",arguments,0),assertUint8ArrayAvailable();for(var e=new Uint8Array(this._binaryString.length),t=0;t<this._binaryString.length;t++)e[t]=this._binaryString.charCodeAt(t);return e},Blob.prototype.toString=function(){return"Blob(base64: "+this.toBase64()+")"},Blob.prototype.isEqual=function(e){return this._binaryString===e._binaryString},Blob.prototype._compareTo=function(e){return primitiveComparator(this._binaryString,e._binaryString)},Blob}(),m=makeConstructorPrivate(p,"Use Blob.fromUint8Array() or Blob.fromBase64String() instead."),y=function(){function GeoPoint(e,t){if(validateExactNumberOfArgs("GeoPoint",arguments,2),validateArgType("GeoPoint","number",1,e),validateArgType("GeoPoint","number",2,t),!isFinite(e)||e<-90||e>90)throw new f(l.INVALID_ARGUMENT,"Latitude must be a number between -90 and 90, but was: "+e);if(!isFinite(t)||t<-180||t>180)throw new f(l.INVALID_ARGUMENT,"Longitude must be a number between -180 and 180, but was: "+t);this._lat=e,this._long=t}return Object.defineProperty(GeoPoint.prototype,"latitude",{get:function(){return this._lat},enumerable:!0,configurable:!0}),Object.defineProperty(GeoPoint.prototype,"longitude",{get:function(){return this._long},enumerable:!0,configurable:!0}),GeoPoint.prototype.isEqual=function(e){return this._lat===e._lat&&this._long===e._long},GeoPoint.prototype._compareTo=function(e){return primitiveComparator(this._lat,e._lat)||primitiveComparator(this._long,e._long)},GeoPoint}(),g=function(){function Timestamp(e,t){if(this.seconds=e,this.nanoseconds=t,t<0)throw new f(l.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+t);if(t>=1e9)throw new f(l.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+t);if(e<-62135596800)throw new f(l.INVALID_ARGUMENT,"Timestamp seconds out of range: "+e);if(e>=253402300800)throw new f(l.INVALID_ARGUMENT,"Timestamp seconds out of range: "+e)}return Timestamp.now=function(){return Timestamp.fromMillis(Date.now())},Timestamp.fromDate=function(e){return Timestamp.fromMillis(e.getTime())},Timestamp.fromMillis=function(e){var t=Math.floor(e/1e3);return new Timestamp(t,1e6*(e-1e3*t))},Timestamp.prototype.toDate=function(){return new Date(this.toMillis())},Timestamp.prototype.toMillis=function(){return 1e3*this.seconds+this.nanoseconds/1e6},Timestamp.prototype._compareTo=function(e){return this.seconds===e.seconds?primitiveComparator(this.nanoseconds,e.nanoseconds):primitiveComparator(this.seconds,e.seconds)},Timestamp.prototype.isEqual=function(e){return e.seconds===this.seconds&&e.nanoseconds===this.nanoseconds},Timestamp.prototype.toString=function(){return"Timestamp(seconds="+this.seconds+", nanoseconds="+this.nanoseconds+")"},Timestamp}(),v=function(){function DatabaseInfo(e,t,n,r){this.databaseId=e,this.persistenceKey=t,this.host=n,this.ssl=r}return DatabaseInfo}(),b="(default)",S=function(){function DatabaseId(e,t){this.projectId=e,this.database=t||b}return Object.defineProperty(DatabaseId.prototype,"isDefaultDatabase",{get:function(){return this.database===b},enumerable:!0,configurable:!0}),DatabaseId.prototype.isEqual=function(e){return e instanceof DatabaseId&&e.projectId===this.projectId&&e.database===this.database},DatabaseId.prototype.compareTo=function(e){return primitiveComparator(this.projectId,e.projectId)||primitiveComparator(this.database,e.database)},DatabaseId}(),w=function(){function Path(e,t,n){this.init(e,t,n)}return Path.prototype.init=function(e,t,n){void 0===t?t=0:t>e.length&&fail("offset "+t+" out of range "+e.length),void 0===n?n=e.length-t:n>e.length-t&&fail("length "+n+" out of range "+(e.length-t)),this.segments=e,this.offset=t,this.len=n},Path.prototype.construct=function(e,t,n){var r=Object.create(Object.getPrototypeOf(this));return r.init(e,t,n),r},Object.defineProperty(Path.prototype,"length",{get:function(){return this.len},enumerable:!0,configurable:!0}),Path.prototype.isEqual=function(e){return 0===Path.comparator(this,e)},Path.prototype.child=function(e){var t=this.segments.slice(this.offset,this.limit());return e instanceof Path?e.forEach(function(e){t.push(e)}):"string"==typeof e?t.push(e):fail("Unknown parameter type for Path.child(): "+e),this.construct(t)},Path.prototype.limit=function(){return this.offset+this.length},Path.prototype.popFirst=function(e){return e=void 0===e?1:e,assert(this.length>=e,"Can't call popFirst() with less segments"),this.construct(this.segments,this.offset+e,this.length-e)},Path.prototype.popLast=function(){return assert(!this.isEmpty(),"Can't call popLast() on empty path"),this.construct(this.segments,this.offset,this.length-1)},Path.prototype.firstSegment=function(){return assert(!this.isEmpty(),"Can't call firstSegment() on empty path"),this.segments[this.offset]},Path.prototype.lastSegment=function(){return assert(!this.isEmpty(),"Can't call lastSegment() on empty path"),this.segments[this.limit()-1]},Path.prototype.get=function(e){return assert(e<this.length,"Index out of range"),this.segments[this.offset+e]},Path.prototype.isEmpty=function(){return 0===this.length},Path.prototype.isPrefixOf=function(e){if(e.length<this.length)return!1;for(var t=0;t<this.length;t++)if(this.get(t)!==e.get(t))return!1;return!0},Path.prototype.isImmediateParentOf=function(e){if(this.length+1!==e.length)return!1;for(var t=0;t<this.length;t++)if(this.get(t)!==e.get(t))return!1;return!0},Path.prototype.forEach=function(e){for(var t=this.offset,n=this.limit();t<n;t++)e(this.segments[t])},Path.prototype.toArray=function(){return this.segments.slice(this.offset,this.limit())},Path.comparator=function(e,t){for(var n=Math.min(e.length,t.length),r=0;r<n;r++){var i=e.get(r),o=t.get(r);if(i<o)return-1;if(i>o)return 1}return e.length<t.length?-1:e.length>t.length?1:0},Path}(),T=function(e){function ResourcePath(){return null!==e&&e.apply(this,arguments)||this}return a.__extends(ResourcePath,e),ResourcePath.prototype.canonicalString=function(){return this.toArray().join("/")},ResourcePath.prototype.toString=function(){return this.canonicalString()},ResourcePath.fromString=function(e){if(e.indexOf("//")>=0)throw new f(l.INVALID_ARGUMENT,"Invalid path ("+e+"). Paths must not contain // in them.");return new ResourcePath(e.split("/").filter(function(e){return e.length>0}))},ResourcePath.EMPTY_PATH=new ResourcePath([]),ResourcePath}(w),D=/^[_a-zA-Z][_a-zA-Z0-9]*$/,E=function(e){function FieldPath(){return null!==e&&e.apply(this,arguments)||this}return a.__extends(FieldPath,e),FieldPath.isValidIdentifier=function(e){return D.test(e)},FieldPath.prototype.canonicalString=function(){return this.toArray().map(function(e){return e=e.replace("\\","\\\\").replace("`","\\`"),FieldPath.isValidIdentifier(e)||(e="`"+e+"`"),e}).join(".")},FieldPath.prototype.toString=function(){return this.canonicalString()},FieldPath.prototype.isKeyField=function(){return 1===this.length&&"__name__"===this.get(0)},FieldPath.keyField=function(){return new FieldPath(["__name__"])},FieldPath.fromServerFormat=function(e){for(var t=[],n="",r=0,i=function(){if(0===n.length)throw new f(l.INVALID_ARGUMENT,"Invalid field path ("+e+"). Paths must not be empty, begin with '.', end with '.', or contain '..'");t.push(n),n=""},o=!1;r<e.length;){var a=e[r];if("\\"===a){if(r+1===e.length)throw new f(l.INVALID_ARGUMENT,"Path has trailing escape character: "+e);var s=e[r+1];if("\\"!==s&&"."!==s&&"`"!==s)throw new f(l.INVALID_ARGUMENT,"Path has invalid escape sequence: "+e);n+=s,r+=2}else"`"===a?(o=!o,r++):"."!==a||o?(n+=a,r++):(i(),r++)}if(i(),o)throw new f(l.INVALID_ARGUMENT,"Unterminated ` in path: "+e);return new FieldPath(t)},FieldPath.EMPTY_PATH=new FieldPath([]),FieldPath}(w),C=function(){function DocumentKey(e){this.path=e,assert(DocumentKey.isDocumentKey(e),"Invalid DocumentKey with an odd number of segments: "+e.toArray().join("/"))}return DocumentKey.prototype.isEqual=function(e){return null!==e&&0===T.comparator(this.path,e.path)},DocumentKey.prototype.toString=function(){return this.path.toString()},DocumentKey.comparator=function(e,t){return T.comparator(e.path,t.path)},DocumentKey.isDocumentKey=function(e){return e.length%2==0},DocumentKey.fromSegments=function(e){return new DocumentKey(new T(e.slice()))},DocumentKey.fromPathString=function(e){return new DocumentKey(T.fromString(e))},DocumentKey.EMPTY=new DocumentKey(new T([])),DocumentKey}(),I=function(){function MaybeDocument(e,t){this.key=e,this.version=t}return MaybeDocument.compareByKey=function(e,t){return C.comparator(e.key,t.key)},MaybeDocument}(),_=function(e){function Document(t,n,r,i){var o=e.call(this,t,n)||this;return o.data=r,o.hasLocalMutations=!!i.hasLocalMutations,o.hasCommittedMutations=!!i.hasCommittedMutations,o}return a.__extends(Document,e),Document.prototype.field=function(e){return this.data.field(e)},Document.prototype.fieldValue=function(e){var t=this.field(e);return t?t.value():void 0},Document.prototype.value=function(){return this.data.value()},Document.prototype.isEqual=function(e){return e instanceof Document&&this.key.isEqual(e.key)&&this.version.isEqual(e.version)&&this.data.isEqual(e.data)&&this.hasLocalMutations===e.hasLocalMutations&&this.hasCommittedMutations===e.hasCommittedMutations},Document.prototype.toString=function(){return"Document("+this.key+", "+this.version+", "+this.data.toString()+", {hasLocalMutations: "+this.hasLocalMutations+"}), {hasCommittedMutations: "+this.hasCommittedMutations+"})"},Object.defineProperty(Document.prototype,"hasPendingWrites",{get:function(){return this.hasLocalMutations||this.hasCommittedMutations},enumerable:!0,configurable:!0}),Document.compareByField=function(e,t,n){var r=t.field(e),i=n.field(e);return void 0!==r&&void 0!==i?r.compareTo(i):fail("Trying to compare documents on fields that don't exist")},Document}(I),A=function(e){function NoDocument(t,n,r){var i=e.call(this,t,n)||this;return i.hasCommittedMutations=!(!r||!r.hasCommittedMutations),i}return a.__extends(NoDocument,e),NoDocument.prototype.toString=function(){return"NoDocument("+this.key+", "+this.version+")"},Object.defineProperty(NoDocument.prototype,"hasPendingWrites",{get:function(){return this.hasCommittedMutations},enumerable:!0,configurable:!0}),NoDocument.prototype.isEqual=function(e){return e instanceof NoDocument&&e.hasCommittedMutations===this.hasCommittedMutations&&e.version.isEqual(this.version)&&e.key.isEqual(this.key)},NoDocument}(I),P=function(e){function UnknownDocument(t,n){return e.call(this,t,n)||this}return a.__extends(UnknownDocument,e),UnknownDocument.prototype.toString=function(){return"UnknownDocument("+this.key+", "+this.version+")"},Object.defineProperty(UnknownDocument.prototype,"hasPendingWrites",{get:function(){return!0},enumerable:!0,configurable:!0}),UnknownDocument.prototype.isEqual=function(e){return e instanceof UnknownDocument&&e.version.isEqual(this.version)&&e.key.isEqual(this.key)},UnknownDocument}(I),N=function(){function SortedMap(e,t){this.comparator=e,this.root=t||M.EMPTY}return SortedMap.prototype.insert=function(e,t){return new SortedMap(this.comparator,this.root.insert(e,t,this.comparator).copy(null,null,M.BLACK,null,null))},SortedMap.prototype.remove=function(e){return new SortedMap(this.comparator,this.root.remove(e,this.comparator).copy(null,null,M.BLACK,null,null))},SortedMap.prototype.get=function(e){for(var t=this.root;!t.isEmpty();){var n=this.comparator(e,t.key);if(0===n)return t.value;n<0?t=t.left:n>0&&(t=t.right)}return null},SortedMap.prototype.indexOf=function(e){for(var t=0,n=this.root;!n.isEmpty();){var r=this.comparator(e,n.key);if(0===r)return t+n.left.size;r<0?n=n.left:(t+=n.left.size+1,n=n.right)}return-1},SortedMap.prototype.isEmpty=function(){return this.root.isEmpty()},Object.defineProperty(SortedMap.prototype,"size",{get:function(){return this.root.size},enumerable:!0,configurable:!0}),SortedMap.prototype.minKey=function(){return this.root.minKey()},SortedMap.prototype.maxKey=function(){return this.root.maxKey()},SortedMap.prototype.inorderTraversal=function(e){return this.root.inorderTraversal(e)},SortedMap.prototype.forEach=function(e){this.inorderTraversal(function(t,n){return e(t,n),!1})},SortedMap.prototype.reverseTraversal=function(e){return this.root.reverseTraversal(e)},SortedMap.prototype.getIterator=function(){return new R(this.root,null,this.comparator,!1)},SortedMap.prototype.getIteratorFrom=function(e){return new R(this.root,e,this.comparator,!1)},SortedMap.prototype.getReverseIterator=function(){return new R(this.root,null,this.comparator,!0)},SortedMap.prototype.getReverseIteratorFrom=function(e){return new R(this.root,e,this.comparator,!0)},SortedMap}(),R=function(){function SortedMapIterator(e,t,n,r){this.isReverse=r,this.nodeStack=[];for(var i=1;!e.isEmpty();)if(i=t?n(e.key,t):1,r&&(i*=-1),i<0)e=this.isReverse?e.left:e.right;else{if(0===i){this.nodeStack.push(e);break}this.nodeStack.push(e),e=this.isReverse?e.right:e.left}}return SortedMapIterator.prototype.getNext=function(){assert(this.nodeStack.length>0,"getNext() called on iterator when hasNext() is false.");var e=this.nodeStack.pop(),t={key:e.key,value:e.value};if(this.isReverse)for(e=e.left;!e.isEmpty();)this.nodeStack.push(e),e=e.right;else for(e=e.right;!e.isEmpty();)this.nodeStack.push(e),e=e.left;return t},SortedMapIterator.prototype.hasNext=function(){return this.nodeStack.length>0},SortedMapIterator.prototype.peek=function(){if(0===this.nodeStack.length)return null;var e=this.nodeStack[this.nodeStack.length-1];return{key:e.key,value:e.value}},SortedMapIterator}(),M=function(){function LLRBNode(e,t,n,r,i){this.key=e,this.value=t,this.color=null!=n?n:LLRBNode.RED,this.left=null!=r?r:LLRBNode.EMPTY,this.right=null!=i?i:LLRBNode.EMPTY,this.size=this.left.size+1+this.right.size}return LLRBNode.prototype.copy=function(e,t,n,r,i){return new LLRBNode(null!=e?e:this.key,null!=t?t:this.value,null!=n?n:this.color,null!=r?r:this.left,null!=i?i:this.right)},LLRBNode.prototype.isEmpty=function(){return!1},LLRBNode.prototype.inorderTraversal=function(e){return this.left.inorderTraversal(e)||e(this.key,this.value)||this.right.inorderTraversal(e)},LLRBNode.prototype.reverseTraversal=function(e){return this.right.reverseTraversal(e)||e(this.key,this.value)||this.left.reverseTraversal(e)},LLRBNode.prototype.min=function(){return this.left.isEmpty()?this:this.left.min()},LLRBNode.prototype.minKey=function(){return this.min().key},LLRBNode.prototype.maxKey=function(){return this.right.isEmpty()?this.key:this.right.maxKey()},LLRBNode.prototype.insert=function(e,t,n){var r=this,i=n(e,r.key);return r=i<0?r.copy(null,null,null,r.left.insert(e,t,n),null):0===i?r.copy(null,t,null,null,null):r.copy(null,null,null,null,r.right.insert(e,t,n)),r.fixUp()},LLRBNode.prototype.removeMin=function(){if(this.left.isEmpty())return LLRBNode.EMPTY;var e=this;return e.left.isRed()||e.left.left.isRed()||(e=e.moveRedLeft()),e=e.copy(null,null,null,e.left.removeMin(),null),e.fixUp()},LLRBNode.prototype.remove=function(e,t){var n,r=this;if(t(e,r.key)<0)r.left.isEmpty()||r.left.isRed()||r.left.left.isRed()||(r=r.moveRedLeft()),r=r.copy(null,null,null,r.left.remove(e,t),null);else{if(r.left.isRed()&&(r=r.rotateRight()),r.right.isEmpty()||r.right.isRed()||r.right.left.isRed()||(r=r.moveRedRight()),0===t(e,r.key)){if(r.right.isEmpty())return LLRBNode.EMPTY;n=r.right.min(),r=r.copy(n.key,n.value,null,null,r.right.removeMin())}r=r.copy(null,null,null,null,r.right.remove(e,t))}return r.fixUp()},LLRBNode.prototype.isRed=function(){return this.color},LLRBNode.prototype.fixUp=function(){var e=this;return e.right.isRed()&&!e.left.isRed()&&(e=e.rotateLeft()),e.left.isRed()&&e.left.left.isRed()&&(e=e.rotateRight()),e.left.isRed()&&e.right.isRed()&&(e=e.colorFlip()),e},LLRBNode.prototype.moveRedLeft=function(){var e=this.colorFlip();return e.right.left.isRed()&&(e=e.copy(null,null,null,null,e.right.rotateRight()),e=e.rotateLeft(),e=e.colorFlip()),e},LLRBNode.prototype.moveRedRight=function(){var e=this.colorFlip();return e.left.left.isRed()&&(e=e.rotateRight(),e=e.colorFlip()),e},LLRBNode.prototype.rotateLeft=function(){var e=this.copy(null,null,LLRBNode.RED,null,this.right.left);return this.right.copy(null,null,this.color,e,null)},LLRBNode.prototype.rotateRight=function(){var e=this.copy(null,null,LLRBNode.RED,this.left.right,null);return this.left.copy(null,null,this.color,null,e)},LLRBNode.prototype.colorFlip=function(){var e=this.left.copy(null,null,!this.left.color,null,null),t=this.right.copy(null,null,!this.right.color,null,null);return this.copy(null,null,!this.color,e,t)},LLRBNode.prototype.checkMaxDepth=function(){var e=this.check();return Math.pow(2,e)<=this.size+1},LLRBNode.prototype.check=function(){if(this.isRed()&&this.left.isRed())throw fail("Red node has red child("+this.key+","+this.value+")");if(this.right.isRed())throw fail("Right child of ("+this.key+","+this.value+") is red");var e=this.left.check();if(e!==this.right.check())throw fail("Black depths differ");return e+(this.isRed()?0:1)},LLRBNode.EMPTY=null,LLRBNode.RED=!0,LLRBNode.BLACK=!1,LLRBNode}(),O=function(){function LLRBEmptyNode(){this.size=0}return LLRBEmptyNode.prototype.copy=function(e,t,n,r,i){return this},LLRBEmptyNode.prototype.insert=function(e,t,n){return new M(e,t)},LLRBEmptyNode.prototype.remove=function(e,t){return this},LLRBEmptyNode.prototype.isEmpty=function(){return!0},LLRBEmptyNode.prototype.inorderTraversal=function(e){return!1},LLRBEmptyNode.prototype.reverseTraversal=function(e){return!1},LLRBEmptyNode.prototype.minKey=function(){return null},LLRBEmptyNode.prototype.maxKey=function(){return null},LLRBEmptyNode.prototype.isRed=function(){return!1},LLRBEmptyNode.prototype.checkMaxDepth=function(){return!0},LLRBEmptyNode.prototype.check=function(){return 0},LLRBEmptyNode}();M.EMPTY=new O;var k;!function(e){e[e.NullValue=0]="NullValue",e[e.BooleanValue=1]="BooleanValue",e[e.NumberValue=2]="NumberValue",e[e.TimestampValue=3]="TimestampValue",e[e.StringValue=4]="StringValue",e[e.BlobValue=5]="BlobValue",e[e.RefValue=6]="RefValue",e[e.GeoPointValue=7]="GeoPointValue",e[e.ArrayValue=8]="ArrayValue",e[e.ObjectValue=9]="ObjectValue"}(k||(k={}));var L;!function(e){e[e.Default=0]="Default",e[e.Estimate=1]="Estimate",e[e.Previous=2]="Previous"}(L||(L={}));var x,F=function(){function FieldValueOptions(e,t){this.serverTimestampBehavior=e,this.timestampsInSnapshots=t}return FieldValueOptions.fromSnapshotOptions=function(e,t){switch(e.serverTimestamps){case"estimate":return new FieldValueOptions(L.Estimate,t);case"previous":return new FieldValueOptions(L.Previous,t);case"none":case void 0:return new FieldValueOptions(L.Default,t);default:return fail("fromSnapshotOptions() called with invalid options.")}},FieldValueOptions}(),V=function(){function FieldValue(){}return FieldValue.prototype.toString=function(){var e=this.value();return null===e?"null":e.toString()},FieldValue.prototype.defaultCompareTo=function(e){return assert(this.typeOrder!==e.typeOrder,"Default compareTo should not be used for values of same type."),primitiveComparator(this.typeOrder,e.typeOrder)},FieldValue}(),B=function(e){function NullValue(){var t=e.call(this)||this;return t.typeOrder=k.NullValue,t.internalValue=null,t}return a.__extends(NullValue,e),NullValue.prototype.value=function(e){return null},NullValue.prototype.isEqual=function(e){return e instanceof NullValue},NullValue.prototype.compareTo=function(e){return e instanceof NullValue?0:this.defaultCompareTo(e)},NullValue.INSTANCE=new NullValue,NullValue}(V),q=function(e){function BooleanValue(t){var n=e.call(this)||this;return n.internalValue=t,n.typeOrder=k.BooleanValue,n}return a.__extends(BooleanValue,e),BooleanValue.prototype.value=function(e){return this.internalValue},BooleanValue.prototype.isEqual=function(e){return e instanceof BooleanValue&&this.internalValue===e.internalValue},BooleanValue.prototype.compareTo=function(e){return e instanceof BooleanValue?primitiveComparator(this,e):this.defaultCompareTo(e)},BooleanValue.of=function(e){return e?BooleanValue.TRUE:BooleanValue.FALSE},BooleanValue.TRUE=new BooleanValue(!0),BooleanValue.FALSE=new BooleanValue(!1),BooleanValue}(V),U=function(e){function NumberValue(t){var n=e.call(this)||this;return n.internalValue=t,n.typeOrder=k.NumberValue,n}return a.__extends(NumberValue,e),NumberValue.prototype.value=function(e){return this.internalValue},NumberValue.prototype.compareTo=function(e){return e instanceof NumberValue?numericComparator(this.internalValue,e.internalValue):this.defaultCompareTo(e)},NumberValue}(V),Q=function(e){function IntegerValue(t){return e.call(this,t)||this}return a.__extends(IntegerValue,e),IntegerValue.prototype.isEqual=function(e){return e instanceof IntegerValue&&numericEquals(this.internalValue,e.internalValue)},IntegerValue}(U),j=function(e){function DoubleValue(t){var n=e.call(this,t)||this;return n.internalValue=t,n}return a.__extends(DoubleValue,e),DoubleValue.prototype.isEqual=function(e){return e instanceof DoubleValue&&numericEquals(this.internalValue,e.internalValue)},DoubleValue.NAN=new DoubleValue(NaN),DoubleValue.POSITIVE_INFINITY=new DoubleValue(1/0),DoubleValue.NEGATIVE_INFINITY=new DoubleValue(-1/0),DoubleValue}(U),W=function(e){function StringValue(t){var n=e.call(this)||this;return n.internalValue=t,n.typeOrder=k.StringValue,n}return a.__extends(StringValue,e),StringValue.prototype.value=function(e){return this.internalValue},StringValue.prototype.isEqual=function(e){return e instanceof StringValue&&this.internalValue===e.internalValue},StringValue.prototype.compareTo=function(e){return e instanceof StringValue?primitiveComparator(this.internalValue,e.internalValue):this.defaultCompareTo(e)},StringValue}(V),K=function(e){function TimestampValue(t){var n=e.call(this)||this;return n.internalValue=t,n.typeOrder=k.TimestampValue,n}return a.__extends(TimestampValue,e),TimestampValue.prototype.value=function(e){return e&&e.timestampsInSnapshots?this.internalValue:this.internalValue.toDate()},TimestampValue.prototype.isEqual=function(e){return e instanceof TimestampValue&&this.internalValue.isEqual(e.internalValue)},TimestampValue.prototype.compareTo=function(e){return e instanceof TimestampValue?this.internalValue._compareTo(e.internalValue):e instanceof z?-1:this.defaultCompareTo(e)},TimestampValue}(V),z=function(e){function ServerTimestampValue(t,n){var r=e.call(this)||this;return r.localWriteTime=t,r.previousValue=n,r.typeOrder=k.TimestampValue,r}return a.__extends(ServerTimestampValue,e),ServerTimestampValue.prototype.value=function(e){return e&&e.serverTimestampBehavior===L.Estimate?new K(this.localWriteTime).value(e):e&&e.serverTimestampBehavior===L.Previous&&this.previousValue?this.previousValue.value(e):null},ServerTimestampValue.prototype.isEqual=function(e){return e instanceof ServerTimestampValue&&this.localWriteTime.isEqual(e.localWriteTime)},ServerTimestampValue.prototype.compareTo=function(e){return e instanceof ServerTimestampValue?this.localWriteTime._compareTo(e.localWriteTime):e instanceof K?1:this.defaultCompareTo(e)},ServerTimestampValue.prototype.toString=function(){return"<ServerTimestamp localTime="+this.localWriteTime.toString()+">"},ServerTimestampValue}(V),G=function(e){function BlobValue(t){var n=e.call(this)||this;return n.internalValue=t,n.typeOrder=k.BlobValue,n}return a.__extends(BlobValue,e),BlobValue.prototype.value=function(e){return this.internalValue},BlobValue.prototype.isEqual=function(e){return e instanceof BlobValue&&this.internalValue.isEqual(e.internalValue)},BlobValue.prototype.compareTo=function(e){return e instanceof BlobValue?this.internalValue._compareTo(e.internalValue):this.defaultCompareTo(e)},BlobValue}(V),H=function(e){function RefValue(t,n){var r=e.call(this)||this;return r.databaseId=t,r.key=n,r.typeOrder=k.RefValue,r}return a.__extends(RefValue,e),RefValue.prototype.value=function(e){return this.key},RefValue.prototype.isEqual=function(e){return e instanceof RefValue&&(this.key.isEqual(e.key)&&this.databaseId.isEqual(e.databaseId))},RefValue.prototype.compareTo=function(e){if(e instanceof RefValue){var t=this.databaseId.compareTo(e.databaseId);return 0!==t?t:C.comparator(this.key,e.key)}return this.defaultCompareTo(e)},RefValue}(V),J=function(e){function GeoPointValue(t){var n=e.call(this)||this;return n.internalValue=t,n.typeOrder=k.GeoPointValue,n}return a.__extends(GeoPointValue,e),GeoPointValue.prototype.value=function(e){return this.internalValue},GeoPointValue.prototype.isEqual=function(e){return e instanceof GeoPointValue&&this.internalValue.isEqual(e.internalValue)},GeoPointValue.prototype.compareTo=function(e){return e instanceof GeoPointValue?this.internalValue._compareTo(e.internalValue):this.defaultCompareTo(e)},GeoPointValue}(V),X=function(e){function ObjectValue(t){var n=e.call(this)||this;return n.internalValue=t,n.typeOrder=k.ObjectValue,n}return a.__extends(ObjectValue,e),ObjectValue.prototype.value=function(e){var t={};return this.internalValue.inorderTraversal(function(n,r){t[n]=r.value(e)}),t},ObjectValue.prototype.forEach=function(e){this.internalValue.inorderTraversal(e)},ObjectValue.prototype.isEqual=function(e){if(e instanceof ObjectValue){for(var t=this.internalValue.getIterator(),n=e.internalValue.getIterator();t.hasNext()&&n.hasNext();){var r=t.getNext(),i=n.getNext();if(r.key!==i.key||!r.value.isEqual(i.value))return!1}return!t.hasNext()&&!n.hasNext()}return!1},ObjectValue.prototype.compareTo=function(e){if(e instanceof ObjectValue){for(var t=this.internalValue.getIterator(),n=e.internalValue.getIterator();t.hasNext()&&n.hasNext();){var r=t.getNext(),i=n.getNext(),o=primitiveComparator(r.key,i.key)||r.value.compareTo(i.value);if(o)return o}return primitiveComparator(t.hasNext(),n.hasNext())}return this.defaultCompareTo(e)},ObjectValue.prototype.set=function(e,t){if(assert(!e.isEmpty(),"Cannot set field for empty path on ObjectValue"),1===e.length)return this.setChild(e.firstSegment(),t);var n=this.child(e.firstSegment());n instanceof ObjectValue||(n=ObjectValue.EMPTY);var r=n.set(e.popFirst(),t);return this.setChild(e.firstSegment(),r)},ObjectValue.prototype.delete=function(e){if(assert(!e.isEmpty(),"Cannot delete field for empty path on ObjectValue"),1===e.length)return new ObjectValue(this.internalValue.remove(e.firstSegment()));var t=this.child(e.firstSegment());if(t instanceof ObjectValue){var n=t.delete(e.popFirst());return new ObjectValue(this.internalValue.insert(e.firstSegment(),n))}return this},ObjectValue.prototype.contains=function(e){return void 0!==this.field(e)},ObjectValue.prototype.field=function(e){assert(!e.isEmpty(),"Can't get field of empty path");var t=this;return e.forEach(function(e){t=t instanceof ObjectValue?t.internalValue.get(e)||void 0:void 0}),t},ObjectValue.prototype.toString=function(){return JSON.stringify(this.value())},ObjectValue.prototype.child=function(e){return this.internalValue.get(e)||void 0},ObjectValue.prototype.setChild=function(e,t){return new ObjectValue(this.internalValue.insert(e,t))},ObjectValue.EMPTY=new ObjectValue(new N(primitiveComparator)),ObjectValue}(V),Y=function(e){function ArrayValue(t){var n=e.call(this)||this;return n.internalValue=t,n.typeOrder=k.ArrayValue,n}return a.__extends(ArrayValue,e),ArrayValue.prototype.value=function(e){return this.internalValue.map(function(t){return t.value(e)})},ArrayValue.prototype.forEach=function(e){this.internalValue.forEach(e)},ArrayValue.prototype.isEqual=function(e){if(e instanceof ArrayValue){if(this.internalValue.length!==e.internalValue.length)return!1;for(var t=0;t<this.internalValue.length;t++)if(!this.internalValue[t].isEqual(e.internalValue[t]))return!1;return!0}return!1},ArrayValue.prototype.compareTo=function(e){if(e instanceof ArrayValue){for(var t=Math.min(this.internalValue.length,e.internalValue.length),n=0;n<t;n++){var r=this.internalValue[n].compareTo(e.internalValue[n]);if(r)return r}return primitiveComparator(this.internalValue.length,e.internalValue.length)}return this.defaultCompareTo(e)},ArrayValue.prototype.toString=function(){return JSON.stringify(this.value())},ArrayValue}(V),$=Number,Z=$.MIN_SAFE_INTEGER||-(Math.pow(2,53)-1),ee=$.MAX_SAFE_INTEGER||Math.pow(2,53)-1,te=$.isInteger||function(e){return"number"==typeof e&&isFinite(e)&&Math.floor(e)===e},ne=function(){function Query(e,t,n,r,i,o){void 0===t&&(t=[]),void 0===n&&(n=[]),void 0===r&&(r=null),void 0===i&&(i=null),void 0===o&&(o=null),this.path=e,this.explicitOrderBy=t,this.filters=n,this.limit=r,this.startAt=i,this.endAt=o,this.memoizedCanonicalId=null,this.memoizedOrderBy=null,this.startAt&&this.assertValidBound(this.startAt),this.endAt&&this.assertValidBound(this.endAt)}return Query.atPath=function(e){return new Query(e)},Object.defineProperty(Query.prototype,"orderBy",{get:function(){if(null===this.memoizedOrderBy){var e=this.getInequalityFilterField(),t=this.getFirstOrderByField();if(null!==e&&null===t)e.isKeyField()?this.memoizedOrderBy=[le]:this.memoizedOrderBy=[new he(e),le];else{assert(null===e||null!==t&&e.isEqual(t),"First orderBy should match inequality field."),this.memoizedOrderBy=[];for(var n=!1,r=0,i=this.explicitOrderBy;r<i.length;r++){var o=i[r];this.memoizedOrderBy.push(o),o.field.isKeyField()&&(n=!0)}if(!n){var a=this.explicitOrderBy.length>0?this.explicitOrderBy[this.explicitOrderBy.length-1].dir:ue.ASCENDING;this.memoizedOrderBy.push(a===ue.ASCENDING?le:fe)}}}return this.memoizedOrderBy},enumerable:!0,configurable:!0}),Query.prototype.addFilter=function(e){assert(null==this.getInequalityFilterField()||!(e instanceof oe)||!e.isInequality()||e.field.isEqual(this.getInequalityFilterField()),"Query must only have one inequality field."),assert(!C.isDocumentKey(this.path),"No filtering allowed for document query");var t=this.filters.concat([e]);return new Query(this.path,this.explicitOrderBy.slice(),t,this.limit,this.startAt,this.endAt)},Query.prototype.addOrderBy=function(e){assert(!C.isDocumentKey(this.path),"No ordering allowed for document query"),assert(!this.startAt&&!this.endAt,"Bounds must be set after orderBy");var t=this.explicitOrderBy.concat([e]);return new Query(this.path,t,this.filters.slice(),this.limit,this.startAt,this.endAt)},Query.prototype.withLimit=function(e){return new Query(this.path,this.explicitOrderBy.slice(),this.filters.slice(),e,this.startAt,this.endAt)},Query.prototype.withStartAt=function(e){return new Query(this.path,this.explicitOrderBy.slice(),this.filters.slice(),this.limit,e,this.endAt)},Query.prototype.withEndAt=function(e){return new Query(this.path,this.explicitOrderBy.slice(),this.filters.slice(),this.limit,this.startAt,e)},Query.prototype.canonicalId=function(){if(null===this.memoizedCanonicalId){var e=this.path.canonicalString();e+="|f:";for(var t=0,n=this.filters;t<n.length;t++){e+=n[t].canonicalId(),e+=","}e+="|ob:";for(var r=0,i=this.orderBy;r<i.length;r++){e+=i[r].canonicalId(),e+=","}isNullOrUndefined(this.limit)||(e+="|l:",e+=this.limit),this.startAt&&(e+="|lb:",e+=this.startAt.canonicalId()),this.endAt&&(e+="|ub:",e+=this.endAt.canonicalId()),this.memoizedCanonicalId=e}return this.memoizedCanonicalId},Query.prototype.toString=function(){var e="Query("+this.path.canonicalString();return this.filters.length>0&&(e+=", filters: ["+this.filters.join(", ")+"]"),isNullOrUndefined(this.limit)||(e+=", limit: "+this.limit),this.explicitOrderBy.length>0&&(e+=", orderBy: ["+this.explicitOrderBy.join(", ")+"]"),this.startAt&&(e+=", startAt: "+this.startAt.canonicalId()),this.endAt&&(e+=", endAt: "+this.endAt.canonicalId()),e+")"},Query.prototype.isEqual=function(e){if(this.limit!==e.limit)return!1;if(this.orderBy.length!==e.orderBy.length)return!1;for(var t=0;t<this.orderBy.length;t++)if(!this.orderBy[t].isEqual(e.orderBy[t]))return!1;if(this.filters.length!==e.filters.length)return!1;for(var t=0;t<this.filters.length;t++)if(!this.filters[t].isEqual(e.filters[t]))return!1;return!!this.path.isEqual(e.path)&&(!(null!==this.startAt?!this.startAt.isEqual(e.startAt):null!==e.startAt)&&(null!==this.endAt?this.endAt.isEqual(e.endAt):null===e.endAt))},Query.prototype.docComparator=function(e,t){for(var n=!1,r=0,i=this.orderBy;r<i.length;r++){var o=i[r],a=o.compare(e,t);if(0!==a)return a;n=n||o.field.isKeyField()}return assert(n,"orderBy used that doesn't compare on key field"),0},Query.prototype.matches=function(e){return this.matchesAncestor(e)&&this.matchesOrderBy(e)&&this.matchesFilters(e)&&this.matchesBounds(e)},Query.prototype.hasLimit=function(){return!isNullOrUndefined(this.limit)},Query.prototype.getFirstOrderByField=function(){return this.explicitOrderBy.length>0?this.explicitOrderBy[0].field:null},Query.prototype.getInequalityFilterField=function(){for(var e=0,t=this.filters;e<t.length;e++){var n=t[e];if(n instanceof oe&&n.isInequality())return n.field}return null},Query.prototype.hasArrayContainsFilter=function(){return void 0!==this.filters.find(function(e){return e instanceof oe&&e.op===ie.ARRAY_CONTAINS})},Query.prototype.isDocumentQuery=function(){return C.isDocumentKey(this.path)&&0===this.filters.length},Query.prototype.matchesAncestor=function(e){var t=e.key.path;return C.isDocumentKey(this.path)?this.path.isEqual(t):this.path.isPrefixOf(t)&&this.path.length===t.length-1},Query.prototype.matchesOrderBy=function(e){for(var t=0,n=this.explicitOrderBy;t<n.length;t++){var r=n[t];if(!r.field.isKeyField()&&void 0===e.field(r.field))return!1}return!0},Query.prototype.matchesFilters=function(e){for(var t=0,n=this.filters;t<n.length;t++){if(!n[t].matches(e))return!1}return!0},Query.prototype.matchesBounds=function(e){return!(this.startAt&&!this.startAt.sortsBeforeDocument(this.orderBy,e))&&(!this.endAt||!this.endAt.sortsBeforeDocument(this.orderBy,e))},Query.prototype.assertValidBound=function(e){assert(e.position.length<=this.orderBy.length,"Bound is longer than orderBy")},Query}(),re=function(){function Filter(){}return Filter.create=function(e,t,n){if(n.isEqual(B.INSTANCE)){if(t!==ie.EQUAL)throw new f(l.INVALID_ARGUMENT,"Invalid query. You can only perform equals comparisons on null.");return new ae(e)}if(n.isEqual(j.NAN)){if(t!==ie.EQUAL)throw new f(l.INVALID_ARGUMENT,"Invalid query. You can only perform equals comparisons on NaN.");return new se(e)}return new oe(e,t,n)},Filter}(),ie=function(){function RelationOp(e){this.name=e}return RelationOp.fromString=function(e){switch(e){case"<":return RelationOp.LESS_THAN;case"<=":return RelationOp.LESS_THAN_OR_EQUAL;case"==":return RelationOp.EQUAL;case">=":return RelationOp.GREATER_THAN_OR_EQUAL;case">":return RelationOp.GREATER_THAN;case"array-contains":return RelationOp.ARRAY_CONTAINS;default:return fail("Unknown relation: "+e)}},RelationOp.prototype.toString=function(){return this.name},RelationOp.prototype.isEqual=function(e){return this.name===e.name},RelationOp.LESS_THAN=new RelationOp("<"),RelationOp.LESS_THAN_OR_EQUAL=new RelationOp("<="),RelationOp.EQUAL=new RelationOp("=="),RelationOp.GREATER_THAN=new RelationOp(">"),RelationOp.GREATER_THAN_OR_EQUAL=new RelationOp(">="),RelationOp.ARRAY_CONTAINS=new RelationOp("array-contains"),RelationOp}(),oe=function(e){function RelationFilter(t,n,r){var i=e.call(this)||this;return i.field=t,i.op=n,i.value=r,i}return a.__extends(RelationFilter,e),RelationFilter.prototype.matches=function(e){if(this.field.isKeyField()){assert(this.value instanceof H,"Comparing on key, but filter value not a RefValue"),assert(this.op!==ie.ARRAY_CONTAINS,"array-contains queries don't make sense on document keys.");var t=this.value,n=C.comparator(e.key,t.key);return this.matchesComparison(n)}var r=e.field(this.field);return void 0!==r&&this.matchesValue(r)},RelationFilter.prototype.matchesValue=function(e){var t=this;return this.op===ie.ARRAY_CONTAINS?e instanceof Y&&void 0!==e.internalValue.find(function(e){return e.isEqual(t.value)}):this.value.typeOrder===e.typeOrder&&this.matchesComparison(e.compareTo(this.value))},RelationFilter.prototype.matchesComparison=function(e){switch(this.op){case ie.LESS_THAN:return e<0;case ie.LESS_THAN_OR_EQUAL:return e<=0;case ie.EQUAL:return 0===e;case ie.GREATER_THAN:return e>0;case ie.GREATER_THAN_OR_EQUAL:return e>=0;default:return fail("Unknown relation op"+this.op)}},RelationFilter.prototype.isInequality=function(){return this.op!==ie.EQUAL&&this.op!==ie.ARRAY_CONTAINS},RelationFilter.prototype.canonicalId=function(){return this.field.canonicalString()+this.op.toString()+this.value.toString()},RelationFilter.prototype.isEqual=function(e){return e instanceof RelationFilter&&(this.op.isEqual(e.op)&&this.field.isEqual(e.field)&&this.value.isEqual(e.value))},RelationFilter.prototype.toString=function(){return this.field.canonicalString()+" "+this.op+" "+this.value.value()},RelationFilter}(re),ae=function(e){function NullFilter(t){var n=e.call(this)||this;return n.field=t,n}return a.__extends(NullFilter,e),NullFilter.prototype.matches=function(e){var t=e.field(this.field);return void 0!==t&&null===t.value()},NullFilter.prototype.canonicalId=function(){return this.field.canonicalString()+" IS null"},NullFilter.prototype.toString=function(){return this.field.canonicalString()+" IS null"},NullFilter.prototype.isEqual=function(e){return e instanceof NullFilter&&this.field.isEqual(e.field)},NullFilter}(re),se=function(e){function NanFilter(t){var n=e.call(this)||this;return n.field=t,n}return a.__extends(NanFilter,e),NanFilter.prototype.matches=function(e){var t=e.field(this.field),n=t&&t.value();return"number"==typeof n&&isNaN(n)},NanFilter.prototype.canonicalId=function(){return this.field.canonicalString()+" IS NaN"},NanFilter.prototype.toString=function(){return this.field.canonicalString()+" IS NaN"},NanFilter.prototype.isEqual=function(e){return e instanceof NanFilter&&this.field.isEqual(e.field)},NanFilter}(re),ue=function(){function Direction(e){this.name=e}return Direction.prototype.toString=function(){return this.name},Direction.ASCENDING=new Direction("asc"),Direction.DESCENDING=new Direction("desc"),Direction}(),ce=function(){function Bound(e,t){this.position=e,this.before=t}return Bound.prototype.canonicalId=function(){for(var e=this.before?"b:":"a:",t=0,n=this.position;t<n.length;t++){e+=n[t].toString()}return e},Bound.prototype.sortsBeforeDocument=function(e,t){assert(this.position.length<=e.length,"Bound has more components than query's orderBy");for(var n=0,r=0;r<this.position.length;r++){var i=e[r],o=this.position[r];if(i.field.isKeyField())assert(o instanceof H,"Bound has a non-key value where the key path is being used."),n=C.comparator(o.key,t.key);else{var a=t.field(i.field);assert(void 0!==a,"Field should exist since document matched the orderBy already."),n=o.compareTo(a)}if(i.dir===ue.DESCENDING&&(n*=-1),0!==n)break}return this.before?n<=0:n<0},Bound.prototype.isEqual=function(e){if(null===e)return!1;if(this.before!==e.before||this.position.length!==e.position.length)return!1;for(var t=0;t<this.position.length;t++){var n=this.position[t],r=e.position[t];return n.isEqual(r)}return!0},Bound}(),he=function(){function OrderBy(e,t){this.field=e,void 0===t&&(t=ue.ASCENDING),this.dir=t,this.isKeyOrderBy=e.isKeyField()}return OrderBy.prototype.compare=function(e,t){var n=this.isKeyOrderBy?_.compareByKey(e,t):_.compareByField(this.field,e,t);switch(this.dir){case ue.ASCENDING:return n;case ue.DESCENDING:return-1*n;default:return fail("Unknown direction: "+this.dir)}},OrderBy.prototype.canonicalId=function(){return this.field.canonicalString()+this.dir.toString()},OrderBy.prototype.toString=function(){return this.field.canonicalString()+" ("+this.dir+")"},OrderBy.prototype.isEqual=function(e){return this.dir===e.dir&&this.field.isEqual(e.field)},OrderBy}(),le=new he(E.keyField(),ue.ASCENDING),fe=new he(E.keyField(),ue.DESCENDING),de=function(){function SnapshotVersion(e){this.timestamp=e}return SnapshotVersion.fromMicroseconds=function(e){var t=Math.floor(e/1e6);return new SnapshotVersion(new g(t,e%1e6*1e3))},SnapshotVersion.fromTimestamp=function(e){return new SnapshotVersion(e)},SnapshotVersion.forDeletedDoc=function(){return SnapshotVersion.MIN},SnapshotVersion.prototype.compareTo=function(e){return this.timestamp._compareTo(e.timestamp)},SnapshotVersion.prototype.isEqual=function(e){return this.timestamp.isEqual(e.timestamp)},SnapshotVersion.prototype.toMicroseconds=function(){return 1e6*this.timestamp.seconds+this.timestamp.nanoseconds/1e3},SnapshotVersion.prototype.toString=function(){return"SnapshotVersion("+this.timestamp.toString()+")"},SnapshotVersion.prototype.toTimestamp=function(){return this.timestamp},SnapshotVersion.MIN=new SnapshotVersion(new g(0,0)),SnapshotVersion}();!function(e){e[e.Listen=0]="Listen",e[e.ExistenceFilterMismatch=1]="ExistenceFilterMismatch",e[e.LimboResolution=2]="LimboResolution"}(x||(x={}));var pe,me=function(){function QueryData(e,t,n,r,i,o){void 0===i&&(i=de.MIN),void 0===o&&(o=emptyByteString()),this.query=e,this.targetId=t,this.purpose=n,this.sequenceNumber=r,this.snapshotVersion=i,this.resumeToken=o}return QueryData.prototype.copy=function(e){return new QueryData(this.query,this.targetId,this.purpose,void 0===e.sequenceNumber?this.sequenceNumber:e.sequenceNumber,void 0===e.snapshotVersion?this.snapshotVersion:e.snapshotVersion,void 0===e.resumeToken?this.resumeToken:e.resumeToken)},QueryData.prototype.isEqual=function(e){return this.targetId===e.targetId&&this.purpose===e.purpose&&this.sequenceNumber===e.sequenceNumber&&this.snapshotVersion.isEqual(e.snapshotVersion)&&this.resumeToken===e.resumeToken&&this.query.isEqual(e.query)},QueryData}(),ye=function(){function FieldMask(e){this.fields=e}return FieldMask.prototype.covers=function(e){for(var t=0,n=this.fields;t<n.length;t++){if(n[t].isPrefixOf(e))return!0}return!1},FieldMask.prototype.isEqual=function(e){return arrayEquals(this.fields,e.fields)},FieldMask}(),ge=function(){function FieldTransform(e,t){this.field=e,this.transform=t}return FieldTransform.prototype.isEqual=function(e){return this.field.isEqual(e.field)&&this.transform.isEqual(e.transform)},FieldTransform}(),ve=function(){function MutationResult(e,t){this.version=e,this.transformResults=t}return MutationResult}();!function(e){e[e.Set=0]="Set",e[e.Patch=1]="Patch",e[e.Transform=2]="Transform",e[e.Delete=3]="Delete"}(pe||(pe={}));var be,Se=function(){function Precondition(e,t){this.updateTime=e,this.exists=t,assert(void 0===e||void 0===t,'Precondition can specify "exists" or "updateTime" but not both')}return Precondition.exists=function(e){return new Precondition(void 0,e)},Precondition.updateTime=function(e){return new Precondition(e)},Object.defineProperty(Precondition.prototype,"isNone",{get:function(){return void 0===this.updateTime&&void 0===this.exists},enumerable:!0,configurable:!0}),Precondition.prototype.isValidFor=function(e){return void 0!==this.updateTime?e instanceof _&&e.version.isEqual(this.updateTime):void 0!==this.exists?this.exists===e instanceof _:(assert(this.isNone,"Precondition should be empty"),!0)},Precondition.prototype.isEqual=function(e){return equals(this.updateTime,e.updateTime)&&this.exists===e.exists},Precondition.NONE=new Precondition,Precondition}(),we=function(){function Mutation(){}return Mutation.prototype.verifyKeyMatches=function(e){null!=e&&assert(e.key.isEqual(this.key),"Can only apply a mutation to a document with the same key")},Mutation.getPostMutationVersion=function(e){return e instanceof _?e.version:de.MIN},Mutation}(),Te=function(e){function SetMutation(t,n,r){var i=e.call(this)||this;return i.key=t,i.value=n,i.precondition=r,i.type=pe.Set,i}return a.__extends(SetMutation,e),SetMutation.prototype.applyToRemoteDocument=function(e,t){this.verifyKeyMatches(e),assert(null==t.transformResults,"Transform results received by SetMutation.");var n=t.version;return new _(this.key,n,this.value,{hasCommittedMutations:!0})},SetMutation.prototype.applyToLocalView=function(e,t,n){if(this.verifyKeyMatches(e),!this.precondition.isValidFor(e))return e;var r=we.getPostMutationVersion(e);return new _(this.key,r,this.value,{hasLocalMutations:!0})},SetMutation.prototype.isEqual=function(e){return e instanceof SetMutation&&this.key.isEqual(e.key)&&this.value.isEqual(e.value)&&this.precondition.isEqual(e.precondition)},SetMutation}(we),De=function(e){function PatchMutation(t,n,r,i){var o=e.call(this)||this;return o.key=t,o.data=n,o.fieldMask=r,o.precondition=i,o.type=pe.Patch,o}return a.__extends(PatchMutation,e),PatchMutation.prototype.applyToRemoteDocument=function(e,t){if(this.verifyKeyMatches(e),assert(null==t.transformResults,"Transform results received by PatchMutation."),!this.precondition.isValidFor(e))return new P(this.key,t.version);var n=this.patchDocument(e);return new _(this.key,t.version,n,{hasCommittedMutations:!0})},PatchMutation.prototype.applyToLocalView=function(e,t,n){if(this.verifyKeyMatches(e),!this.precondition.isValidFor(e))return e;var r=we.getPostMutationVersion(e),i=this.patchDocument(e);return new _(this.key,r,i,{hasLocalMutations:!0})},PatchMutation.prototype.isEqual=function(e){return e instanceof PatchMutation&&this.key.isEqual(e.key)&&this.fieldMask.isEqual(e.fieldMask)&&this.precondition.isEqual(e.precondition)},PatchMutation.prototype.patchDocument=function(e){var t;return t=e instanceof _?e.data:X.EMPTY,this.patchObject(t)},PatchMutation.prototype.patchObject=function(e){for(var t=0,n=this.fieldMask.fields;t<n.length;t++){var r=n[t];if(!r.isEmpty()){var i=this.data.field(r);e=void 0!==i?e.set(r,i):e.delete(r)}}return e},PatchMutation}(we),Ee=function(e){function TransformMutation(t,n){var r=e.call(this)||this;return r.key=t,r.fieldTransforms=n,r.type=pe.Transform,r.precondition=Se.exists(!0),r}return a.__extends(TransformMutation,e),TransformMutation.prototype.applyToRemoteDocument=function(e,t){if(this.verifyKeyMatches(e),assert(null!=t.transformResults,"Transform results missing for TransformMutation."),!this.precondition.isValidFor(e))return new P(this.key,t.version);var n=this.requireDocument(e),r=this.serverTransformResults(e,t.transformResults),i=t.version,o=this.transformObject(n.data,r);return new _(this.key,i,o,{hasCommittedMutations:!0})},TransformMutation.prototype.applyToLocalView=function(e,t,n){if(this.verifyKeyMatches(e),!this.precondition.isValidFor(e))return e;var r=this.requireDocument(e),i=this.localTransformResults(n,t),o=this.transformObject(r.data,i);return new _(this.key,r.version,o,{hasLocalMutations:!0})},TransformMutation.prototype.isEqual=function(e){return e instanceof TransformMutation&&this.key.isEqual(e.key)&&arrayEquals(this.fieldTransforms,e.fieldTransforms)&&this.precondition.isEqual(e.precondition)},TransformMutation.prototype.requireDocument=function(e){assert(e instanceof _,"Unknown MaybeDocument type "+e);var t=e;return assert(t.key.isEqual(this.key),"Can only transform a document with the same key"),t},TransformMutation.prototype.serverTransformResults=function(e,t){var n=[];assert(this.fieldTransforms.length===t.length,"server transform result count ("+t.length+") should match field transform count ("+this.fieldTransforms.length+")");for(var r=0;r<t.length;r++){var i=this.fieldTransforms[r],o=i.transform,a=null;e instanceof _&&(a=e.field(i.field)||null),n.push(o.applyToRemoteDocument(a,t[r]))}return n},TransformMutation.prototype.localTransformResults=function(e,t){for(var n=[],r=0,i=this.fieldTransforms;r<i.length;r++){var o=i[r],a=o.transform,s=null;t instanceof _&&(s=t.field(o.field)||null),n.push(a.applyToLocalView(s,e))}return n},TransformMutation.prototype.transformObject=function(e,t){assert(t.length===this.fieldTransforms.length,"TransformResults length mismatch.");for(var n=0;n<this.fieldTransforms.length;n++){var r=this.fieldTransforms[n],i=r.field;e=e.set(i,t[n])}return e},TransformMutation}(we),Ce=function(e){function DeleteMutation(t,n){var r=e.call(this)||this;return r.key=t,r.precondition=n,r.type=pe.Delete,r}return a.__extends(DeleteMutation,e),DeleteMutation.prototype.applyToRemoteDocument=function(e,t){return this.verifyKeyMatches(e),assert(null==t.transformResults,"Transform results received by DeleteMutation."),new A(this.key,t.version,{hasCommittedMutations:!0})},DeleteMutation.prototype.applyToLocalView=function(e,t,n){return this.verifyKeyMatches(e),this.precondition.isValidFor(e)?(e&&assert(e.key.isEqual(this.key),"Can only apply mutation to document with same key"),new A(this.key,de.forDeletedDoc())):e},DeleteMutation.prototype.isEqual=function(e){return e instanceof DeleteMutation&&this.key.isEqual(e.key)&&this.precondition.isEqual(e.precondition)},DeleteMutation}(we),Ie=function(){function ServerTimestampTransform(){}return ServerTimestampTransform.prototype.applyToLocalView=function(e,t){return new z(t,e)},ServerTimestampTransform.prototype.applyToRemoteDocument=function(e,t){return t},ServerTimestampTransform.prototype.isEqual=function(e){return e instanceof ServerTimestampTransform},ServerTimestampTransform.instance=new ServerTimestampTransform,ServerTimestampTransform}(),_e=function(){function ArrayUnionTransformOperation(e){this.elements=e}return ArrayUnionTransformOperation.prototype.applyToLocalView=function(e,t){return this.apply(e)},ArrayUnionTransformOperation.prototype.applyToRemoteDocument=function(e,t){return this.apply(e)},ArrayUnionTransformOperation.prototype.apply=function(e){for(var t=coercedFieldValuesArray(e),n=0,r=this.elements;n<r.length;n++){var i=r[n];!function(e){t.find(function(t){return t.isEqual(e)})||t.push(e)}(i)}return new Y(t)},ArrayUnionTransformOperation.prototype.isEqual=function(e){return e instanceof ArrayUnionTransformOperation&&arrayEquals(e.elements,this.elements)},ArrayUnionTransformOperation}(),Ae=function(){function ArrayRemoveTransformOperation(e){this.elements=e}return ArrayRemoveTransformOperation.prototype.applyToLocalView=function(e,t){return this.apply(e)},ArrayRemoveTransformOperation.prototype.applyToRemoteDocument=function(e,t){return this.apply(e)},ArrayRemoveTransformOperation.prototype.apply=function(e){for(var t=coercedFieldValuesArray(e),n=0,r=this.elements;n<r.length;n++){var i=r[n];!function(e){t=t.filter(function(t){return!t.isEqual(e)})}(i)}return new Y(t)},ArrayRemoveTransformOperation.prototype.isEqual=function(e){return e instanceof ArrayRemoveTransformOperation&&arrayEquals(e.elements,this.elements)},ArrayRemoveTransformOperation}(),Pe=function(){function ExistenceFilter(e){this.count=e}return ExistenceFilter.prototype.isEqual=function(e){return e&&e.count===this.count},ExistenceFilter}();!function(e){e[e.OK=0]="OK",e[e.CANCELLED=1]="CANCELLED",e[e.UNKNOWN=2]="UNKNOWN",e[e.INVALID_ARGUMENT=3]="INVALID_ARGUMENT",e[e.DEADLINE_EXCEEDED=4]="DEADLINE_EXCEEDED",e[e.NOT_FOUND=5]="NOT_FOUND",e[e.ALREADY_EXISTS=6]="ALREADY_EXISTS",e[e.PERMISSION_DENIED=7]="PERMISSION_DENIED",e[e.UNAUTHENTICATED=16]="UNAUTHENTICATED",e[e.RESOURCE_EXHAUSTED=8]="RESOURCE_EXHAUSTED",e[e.FAILED_PRECONDITION=9]="FAILED_PRECONDITION",e[e.ABORTED=10]="ABORTED",e[e.OUT_OF_RANGE=11]="OUT_OF_RANGE",e[e.UNIMPLEMENTED=12]="UNIMPLEMENTED",e[e.INTERNAL=13]="INTERNAL",e[e.UNAVAILABLE=14]="UNAVAILABLE",e[e.DATA_LOSS=15]="DATA_LOSS"}(be||(be={}));var Ne,Re=function(){function SortedSet(e){this.comparator=e,this.data=new N(this.comparator)}return SortedSet.fromMapKeys=function(e){var t=new SortedSet(e.comparator);return e.forEach(function(e){t=t.add(e)}),t},SortedSet.prototype.has=function(e){return null!==this.data.get(e)},SortedSet.prototype.first=function(){return this.data.minKey()},SortedSet.prototype.last=function(){return this.data.maxKey()},Object.defineProperty(SortedSet.prototype,"size",{get:function(){return this.data.size},enumerable:!0,configurable:!0}),SortedSet.prototype.indexOf=function(e){return this.data.indexOf(e)},SortedSet.prototype.forEach=function(e){this.data.inorderTraversal(function(t,n){return e(t),!1})},SortedSet.prototype.forEachInRange=function(e,t){for(var n=this.data.getIteratorFrom(e[0]);n.hasNext();){var r=n.getNext();if(this.comparator(r.key,e[1])>=0)return;t(r.key)}},SortedSet.prototype.forEachWhile=function(e,t){var n;for(n=void 0!==t?this.data.getIteratorFrom(t):this.data.getIterator();n.hasNext();){if(!e(n.getNext().key))return}},SortedSet.prototype.firstAfterOrEqual=function(e){var t=this.data.getIteratorFrom(e);return t.hasNext()?t.getNext().key:null},SortedSet.prototype.add=function(e){return this.copy(this.data.remove(e).insert(e,!0))},SortedSet.prototype.delete=function(e){return this.has(e)?this.copy(this.data.remove(e)):this},SortedSet.prototype.isEmpty=function(){return this.data.isEmpty()},SortedSet.prototype.unionWith=function(e){var t=this;return e.forEach(function(e){t=t.add(e)}),t},SortedSet.prototype.isEqual=function(e){if(!(e instanceof SortedSet))return!1;if(this.size!==e.size)return!1;for(var t=this.data.getIterator(),n=e.data.getIterator();t.hasNext();){var r=t.getNext().key,i=n.getNext().key;if(0!==this.comparator(r,i))return!1}return!0},SortedSet.prototype.toArray=function(){var e=[];return this.forEach(function(t){e.push(t)}),e},SortedSet.prototype.toString=function(){var e=[];return this.forEach(function(t){return e.push(t)}),"SortedSet("+e.toString()+")"},SortedSet.prototype.copy=function(e){var t=new SortedSet(this.comparator);return t.data=e,t},SortedSet}(),Me=new N(C.comparator),Oe=new N(C.comparator),ke=new N(C.comparator),Le=new Re(C.comparator),xe=new Re(primitiveComparator),Fe=function(){function DocumentSet(e){this.comparator=e?function(t,n){return e(t,n)||C.comparator(t.key,n.key)}:function(e,t){return C.comparator(e.key,t.key)},this.keyedMap=documentMap(),this.sortedSet=new N(this.comparator)}return DocumentSet.emptySet=function(e){return new DocumentSet(e.comparator)},DocumentSet.prototype.has=function(e){return null!=this.keyedMap.get(e)},DocumentSet.prototype.get=function(e){return this.keyedMap.get(e)},DocumentSet.prototype.first=function(){return this.sortedSet.minKey()},DocumentSet.prototype.last=function(){return this.sortedSet.maxKey()},DocumentSet.prototype.isEmpty=function(){return this.sortedSet.isEmpty()},DocumentSet.prototype.indexOf=function(e){var t=this.keyedMap.get(e);return t?this.sortedSet.indexOf(t):-1},Object.defineProperty(DocumentSet.prototype,"size",{get:function(){return this.sortedSet.size},enumerable:!0,configurable:!0}),DocumentSet.prototype.forEach=function(e){this.sortedSet.inorderTraversal(function(t,n){return e(t),!1})},DocumentSet.prototype.add=function(e){var t=this.delete(e.key);return t.copy(t.keyedMap.insert(e.key,e),t.sortedSet.insert(e,null))},DocumentSet.prototype.delete=function(e){var t=this.get(e);return t?this.copy(this.keyedMap.remove(e),this.sortedSet.remove(t)):this},DocumentSet.prototype.isEqual=function(e){if(!(e instanceof DocumentSet))return!1;if(this.size!==e.size)return!1;for(var t=this.sortedSet.getIterator(),n=e.sortedSet.getIterator();t.hasNext();){var r=t.getNext().key,i=n.getNext().key;if(!r.isEqual(i))return!1}return!0},DocumentSet.prototype.toString=function(){var e=[];return this.forEach(function(t){e.push(t.toString())}),0===e.length?"DocumentSet ()":"DocumentSet (\n  "+e.join("  \n")+"\n)"},DocumentSet.prototype.copy=function(e,t){var n=new DocumentSet;return n.comparator=this.comparator,n.keyedMap=e,n.sortedSet=t,n},DocumentSet}();!function(e){e[e.Added=0]="Added",e[e.Removed=1]="Removed",e[e.Modified=2]="Modified",e[e.Metadata=3]="Metadata"}(Ne||(Ne={}));var Ve;!function(e){e[e.Local=0]="Local",e[e.Synced=1]="Synced"}(Ve||(Ve={}));var Be,qe=function(){function DocumentChangeSet(){this.changeMap=new N(C.comparator)}return DocumentChangeSet.prototype.track=function(e){var t=e.doc.key,n=this.changeMap.get(t);if(!n)return void(this.changeMap=this.changeMap.insert(t,e));e.type!==Ne.Added&&n.type===Ne.Metadata?this.changeMap=this.changeMap.insert(t,e):e.type===Ne.Metadata&&n.type!==Ne.Removed?this.changeMap=this.changeMap.insert(t,{type:n.type,doc:e.doc}):e.type===Ne.Modified&&n.type===Ne.Modified?this.changeMap=this.changeMap.insert(t,{type:Ne.Modified,doc:e.doc}):e.type===Ne.Modified&&n.type===Ne.Added?this.changeMap=this.changeMap.insert(t,{type:Ne.Added,doc:e.doc}):e.type===Ne.Removed&&n.type===Ne.Added?this.changeMap=this.changeMap.remove(t):e.type===Ne.Removed&&n.type===Ne.Modified?this.changeMap=this.changeMap.insert(t,{type:Ne.Removed,doc:n.doc}):e.type===Ne.Added&&n.type===Ne.Removed?this.changeMap=this.changeMap.insert(t,{type:Ne.Modified,doc:e.doc}):fail("unsupported combination of changes: "+JSON.stringify(e)+" after "+JSON.stringify(n))},DocumentChangeSet.prototype.getChanges=function(){var e=[];return this.changeMap.inorderTraversal(function(t,n){e.push(n)}),e},DocumentChangeSet}(),Ue=function(){function ViewSnapshot(e,t,n,r,i,o,a,s){this.query=e,this.docs=t,this.oldDocs=n,this.docChanges=r,this.mutatedKeys=i,this.fromCache=o,this.syncStateChanged=a,this.excludesMetadataChanges=s}return ViewSnapshot.fromInitialDocuments=function(e,t,n,r){var i=[];return t.forEach(function(e){i.push({type:Ne.Added,doc:e})}),new ViewSnapshot(e,t,Fe.emptySet(t),i,n,r,!0,!1)},Object.defineProperty(ViewSnapshot.prototype,"hasPendingWrites",{get:function(){return!this.mutatedKeys.isEmpty()},enumerable:!0,configurable:!0}),ViewSnapshot.prototype.isEqual=function(e){if(!(this.fromCache===e.fromCache&&this.syncStateChanged===e.syncStateChanged&&this.mutatedKeys.isEqual(e.mutatedKeys)&&this.query.isEqual(e.query)&&this.docs.isEqual(e.docs)&&this.oldDocs.isEqual(e.oldDocs)))return!1;var t=this.docChanges,n=e.docChanges;if(t.length!==n.length)return!1;for(var r=0;r<t.length;r++)if(t[r].type!==n[r].type||!t[r].doc.isEqual(n[r].doc))return!1;return!0},ViewSnapshot}(),Qe=function(){function RemoteEvent(e,t,n,r,i){this.snapshotVersion=e,this.targetChanges=t,this.targetMismatches=n,this.documentUpdates=r,this.resolvedLimboDocuments=i}return RemoteEvent.createSynthesizedRemoteEventForCurrentChange=function(e,t){var n=(r={},r[e]=je.createSynthesizedTargetChangeForCurrentChange(e,t),r);return new RemoteEvent(de.MIN,n,targetIdSet(),maybeDocumentMap(),documentKeySet());var r},RemoteEvent}(),je=function(){function TargetChange(e,t,n,r,i){this.resumeToken=e,this.current=t,this.addedDocuments=n,this.modifiedDocuments=r,this.removedDocuments=i}return TargetChange.createSynthesizedTargetChangeForCurrentChange=function(e,t){return new TargetChange(emptyByteString(),t,documentKeySet(),documentKeySet(),documentKeySet())},TargetChange}(),We=function(){function DocumentWatchChange(e,t,n,r){this.updatedTargetIds=e,this.removedTargetIds=t,this.key=n,this.newDoc=r}return DocumentWatchChange}(),Ke=function(){function ExistenceFilterChange(e,t){this.targetId=e,this.existenceFilter=t}return ExistenceFilterChange}();!function(e){e[e.NoChange=0]="NoChange",e[e.Added=1]="Added",e[e.Removed=2]="Removed",e[e.Current=3]="Current",e[e.Reset=4]="Reset"}(Be||(Be={}));var ze=function(){function WatchTargetChange(e,t,n,r){void 0===n&&(n=emptyByteString()),void 0===r&&(r=null),this.state=e,this.targetIds=t,this.resumeToken=n,this.cause=r}return WatchTargetChange}(),Ge=function(){function TargetState(){this.pendingResponses=0,this.documentChanges=snapshotChangesMap(),this._resumeToken=emptyByteString(),this._current=!1,this._hasPendingChanges=!0}return Object.defineProperty(TargetState.prototype,"current",{get:function(){return this._current},enumerable:!0,configurable:!0}),Object.defineProperty(TargetState.prototype,"resumeToken",{get:function(){return this._resumeToken},enumerable:!0,configurable:!0}),Object.defineProperty(TargetState.prototype,"isPending",{get:function(){return 0!==this.pendingResponses},enumerable:!0,configurable:!0}),Object.defineProperty(TargetState.prototype,"hasPendingChanges",{get:function(){return this._hasPendingChanges},enumerable:!0,configurable:!0}),TargetState.prototype.updateResumeToken=function(e){e.length>0&&(this._hasPendingChanges=!0,this._resumeToken=e)},TargetState.prototype.toTargetChange=function(){var e=documentKeySet(),t=documentKeySet(),n=documentKeySet();return this.documentChanges.forEach(function(r,i){switch(i){case Ne.Added:e=e.add(r);break;case Ne.Modified:t=t.add(r);break;case Ne.Removed:n=n.add(r);break;default:fail("Encountered invalid change type: "+i)}}),new je(this._resumeToken,this._current,e,t,n)},TargetState.prototype.clearPendingChanges=function(){this._hasPendingChanges=!1,this.documentChanges=snapshotChangesMap()},TargetState.prototype.addDocumentChange=function(e,t){this._hasPendingChanges=!0,this.documentChanges=this.documentChanges.insert(e,t)},TargetState.prototype.removeDocumentChange=function(e){this._hasPendingChanges=!0,this.documentChanges=this.documentChanges.remove(e)},TargetState.prototype.recordPendingTargetRequest=function(){this.pendingResponses+=1},TargetState.prototype.recordTargetResponse=function(){this.pendingResponses-=1},TargetState.prototype.markCurrent=function(){this._hasPendingChanges=!0,this._current=!0},TargetState}(),He=function(){function WatchChangeAggregator(e){this.metadataProvider=e,this.targetStates={},this.pendingDocumentUpdates=maybeDocumentMap(),this.pendingDocumentTargetMapping=documentTargetMap(),this.pendingTargetResets=new Re(primitiveComparator)}return WatchChangeAggregator.prototype.handleDocumentChange=function(e){for(var t=0,n=e.updatedTargetIds;t<n.length;t++){var r=n[t];e.newDoc instanceof _?this.addDocumentToTarget(r,e.newDoc):e.newDoc instanceof A&&this.removeDocumentFromTarget(r,e.key,e.newDoc)}for(var i=0,o=e.removedTargetIds;i<o.length;i++){var r=o[i];this.removeDocumentFromTarget(r,e.key,e.newDoc)}},WatchChangeAggregator.prototype.handleTargetChange=function(e){var t=this;this.forEachTarget(e,function(n){var r=t.ensureTargetState(n);switch(e.state){case Be.NoChange:t.isActiveTarget(n)&&r.updateResumeToken(e.resumeToken);break;case Be.Added:r.recordTargetResponse(),r.isPending||r.clearPendingChanges(),r.updateResumeToken(e.resumeToken);break;case Be.Removed:r.recordTargetResponse(),r.isPending||t.removeTarget(n),assert(!e.cause,"WatchChangeAggregator does not handle errored targets");break;case Be.Current:t.isActiveTarget(n)&&(r.markCurrent(),r.updateResumeToken(e.resumeToken));break;case Be.Reset:t.isActiveTarget(n)&&(t.resetTarget(n),r.updateResumeToken(e.resumeToken));break;default:fail("Unknown target watch change state: "+e.state)}})},WatchChangeAggregator.prototype.forEachTarget=function(e,t){e.targetIds.length>0?e.targetIds.forEach(t):forEachNumber(this.targetStates,t)},WatchChangeAggregator.prototype.handleExistenceFilter=function(e){var t=e.targetId,n=e.existenceFilter.count,r=this.queryDataForActiveTarget(t);if(r){var i=r.query;if(i.isDocumentQuery())if(0===n){var o=new C(i.path);this.removeDocumentFromTarget(t,o,new A(o,de.forDeletedDoc()))}else assert(1===n,"Single document existence filter with count: "+n);else{this.getCurrentDocumentCountForTarget(t)!==n&&(this.resetTarget(t),this.pendingTargetResets=this.pendingTargetResets.add(t))}}},WatchChangeAggregator.prototype.createRemoteEvent=function(e){var t=this,n={};forEachNumber(this.targetStates,function(r,i){var o=t.queryDataForActiveTarget(r);if(o){if(i.current&&o.query.isDocumentQuery()){var a=new C(o.query.path);null!==t.pendingDocumentUpdates.get(a)||t.targetContainsDocument(r,a)||t.removeDocumentFromTarget(r,a,new A(a,e))}i.hasPendingChanges&&(n[r]=i.toTargetChange(),i.clearPendingChanges())}});var r=documentKeySet();this.pendingDocumentTargetMapping.forEach(function(e,n){var i=!0;n.forEachWhile(function(e){var n=t.queryDataForActiveTarget(e);return!n||n.purpose===x.LimboResolution||(i=!1,!1)}),i&&(r=r.add(e))});var i=new Qe(e,n,this.pendingTargetResets,this.pendingDocumentUpdates,r);return this.pendingDocumentUpdates=maybeDocumentMap(),this.pendingDocumentTargetMapping=documentTargetMap(),this.pendingTargetResets=new Re(primitiveComparator),i},WatchChangeAggregator.prototype.addDocumentToTarget=function(e,t){if(this.isActiveTarget(e)){var n=this.targetContainsDocument(e,t.key)?Ne.Modified:Ne.Added;this.ensureTargetState(e).addDocumentChange(t.key,n),this.pendingDocumentUpdates=this.pendingDocumentUpdates.insert(t.key,t),this.pendingDocumentTargetMapping=this.pendingDocumentTargetMapping.insert(t.key,this.ensureDocumentTargetMapping(t.key).add(e))}},WatchChangeAggregator.prototype.removeDocumentFromTarget=function(e,t,n){if(this.isActiveTarget(e)){var r=this.ensureTargetState(e);this.targetContainsDocument(e,t)?r.addDocumentChange(t,Ne.Removed):r.removeDocumentChange(t),this.pendingDocumentTargetMapping=this.pendingDocumentTargetMapping.insert(t,this.ensureDocumentTargetMapping(t).delete(e)),n&&(this.pendingDocumentUpdates=this.pendingDocumentUpdates.insert(t,n))}},WatchChangeAggregator.prototype.removeTarget=function(e){delete this.targetStates[e]},WatchChangeAggregator.prototype.getCurrentDocumentCountForTarget=function(e){var t=this.ensureTargetState(e),n=t.toTargetChange();return this.metadataProvider.getRemoteKeysForTarget(e).size+n.addedDocuments.size-n.removedDocuments.size},WatchChangeAggregator.prototype.recordPendingTargetRequest=function(e){this.ensureTargetState(e).recordPendingTargetRequest()},WatchChangeAggregator.prototype.ensureTargetState=function(e){return this.targetStates[e]||(this.targetStates[e]=new Ge),this.targetStates[e]},WatchChangeAggregator.prototype.ensureDocumentTargetMapping=function(e){var t=this.pendingDocumentTargetMapping.get(e);return t||(t=new Re(primitiveComparator),this.pendingDocumentTargetMapping=this.pendingDocumentTargetMapping.insert(e,t)),t},WatchChangeAggregator.prototype.isActiveTarget=function(e){return null!==this.queryDataForActiveTarget(e)},WatchChangeAggregator.prototype.queryDataForActiveTarget=function(e){var t=this.targetStates[e];return t&&t.isPending?null:this.metadataProvider.getQueryDataForTarget(e)},WatchChangeAggregator.prototype.resetTarget=function(e){var t=this;assert(!this.targetStates[e].isPending,"Should only reset active targets"),this.targetStates[e]=new Ge,this.metadataProvider.getRemoteKeysForTarget(e).forEach(function(n){t.removeDocumentFromTarget(e,n,null)})},WatchChangeAggregator.prototype.targetContainsDocument=function(e,t){return this.metadataProvider.getRemoteKeysForTarget(e).has(t)},WatchChangeAggregator}(),Je=function(){var e={};return e[ue.ASCENDING.name]="ASCENDING",e[ue.DESCENDING.name]="DESCENDING",e}(),Xe=function(){var e={};return e[ie.LESS_THAN.name]="LESS_THAN",e[ie.LESS_THAN_OR_EQUAL.name]="LESS_THAN_OR_EQUAL",e[ie.GREATER_THAN.name]="GREATER_THAN",e[ie.GREATER_THAN_OR_EQUAL.name]="GREATER_THAN_OR_EQUAL",e[ie.EQUAL.name]="EQUAL",e[ie.ARRAY_CONTAINS.name]="ARRAY_CONTAINS",e}(),Ye=new RegExp(/^\d{4}-\d\d-\d\dT\d\d:\d\d:\d\d(?:\.(\d+))?Z$/),$e=function(){function JsonProtoSerializer(e,t){this.databaseId=e,this.options=t}return JsonProtoSerializer.prototype.emptyByteString=function(){return this.options.useProto3Json?"":new Uint8Array(0)},JsonProtoSerializer.prototype.unsafeCastProtoByteString=function(e){return e},JsonProtoSerializer.prototype.fromRpcStatus=function(e){var t=void 0===e.code?l.UNKNOWN:mapCodeFromRpcCode(e.code);return new f(t,e.message||"")},JsonProtoSerializer.prototype.toInt32Value=function(e){return isNullOrUndefined(e)?void 0:{value:e}},JsonProtoSerializer.prototype.fromInt32Value=function(e){var t;return t="object"==typeof e?e.value:e,isNullOrUndefined(t)?null:t},JsonProtoSerializer.prototype.toTimestamp=function(e){return{seconds:e.seconds,nanos:e.nanoseconds}},JsonProtoSerializer.prototype.fromTimestamp=function(e){if("string"==typeof e)return this.fromIso8601String(e);assert(!!e,"Cannot deserialize null or undefined timestamp.");var t=parseInt64(e.seconds||"0"),n=e.nanos||0;return new g(t,n)},JsonProtoSerializer.prototype.fromIso8601String=function(e){var t=0,n=Ye.exec(e);if(assert(!!n,"invalid timestamp: "+e),n[1]){var r=n[1];r=(r+"000000000").substr(0,9),t=Number(r)}var i=new Date(e),o=Math.floor(i.getTime()/1e3);return new g(o,t)},JsonProtoSerializer.prototype.toBytes=function(e){return this.options.useProto3Json?e.toBase64():this.unsafeCastProtoByteString(e.toUint8Array())},JsonProtoSerializer.prototype.fromBlob=function(e){return"string"==typeof e?(assert(this.options.useProto3Json,"Expected bytes to be passed in as Uint8Array, but got a string instead."),p.fromBase64String(e)):(assert(!this.options.useProto3Json,"Expected bytes to be passed in as string, but got something else instead."),p.fromUint8Array(e))},JsonProtoSerializer.prototype.toVersion=function(e){return this.toTimestamp(e.toTimestamp())},JsonProtoSerializer.prototype.fromVersion=function(e){return assert(!!e,"Trying to deserialize version that isn't set"),de.fromTimestamp(this.fromTimestamp(e))},JsonProtoSerializer.prototype.toResourceName=function(e,t){return this.fullyQualifiedPrefixPath(e).child("documents").child(t).canonicalString()},JsonProtoSerializer.prototype.fromResourceName=function(e){var t=T.fromString(e);return assert(this.isValidResourceName(t),"Tried to deserialize invalid key "+t.toString()),t},JsonProtoSerializer.prototype.toName=function(e){return this.toResourceName(this.databaseId,e.path)},JsonProtoSerializer.prototype.fromName=function(e){var t=this.fromResourceName(e);return assert(t.get(1)===this.databaseId.projectId,"Tried to deserialize key from different project: "+t.get(1)+" vs "+this.databaseId.projectId),assert(!t.get(3)&&!this.databaseId.database||t.get(3)===this.databaseId.database,"Tried to deserialize key from different database: "+t.get(3)+" vs "+this.databaseId.database),new C(this.extractLocalPathFromResourceName(t))},JsonProtoSerializer.prototype.toQueryPath=function(e){return 0===e.length?this.encodedDatabaseId:this.toResourceName(this.databaseId,e)},JsonProtoSerializer.prototype.fromQueryPath=function(e){var t=this.fromResourceName(e);return 4===t.length?T.EMPTY_PATH:this.extractLocalPathFromResourceName(t)},Object.defineProperty(JsonProtoSerializer.prototype,"encodedDatabaseId",{get:function(){return new T(["projects",this.databaseId.projectId,"databases",this.databaseId.database]).canonicalString()},enumerable:!0,configurable:!0}),JsonProtoSerializer.prototype.fullyQualifiedPrefixPath=function(e){return new T(["projects",e.projectId,"databases",e.database])},JsonProtoSerializer.prototype.extractLocalPathFromResourceName=function(e){return assert(e.length>4&&"documents"===e.get(4),"tried to deserialize invalid key "+e.toString()),e.popFirst(5)},JsonProtoSerializer.prototype.isValidResourceName=function(e){return e.length>=4&&"projects"===e.get(0)&&"databases"===e.get(2)},JsonProtoSerializer.prototype.toValue=function(e){if(e instanceof B)return{nullValue:"NULL_VALUE"};if(e instanceof q)return{booleanValue:e.value()};if(e instanceof Q)return{integerValue:""+e.value()};if(e instanceof j){var t=e.value();if(this.options.useProto3Json){if(isNaN(t))return{doubleValue:"NaN"};if(t===1/0)return{doubleValue:"Infinity"};if(t===-1/0)return{doubleValue:"-Infinity"}}return{doubleValue:e.value()}}return e instanceof W?{stringValue:e.value()}:e instanceof X?{mapValue:this.toMapValue(e)}:e instanceof Y?{arrayValue:this.toArrayValue(e)}:e instanceof K?{timestampValue:this.toTimestamp(e.internalValue)}:e instanceof J?{geoPointValue:{latitude:e.value().latitude,longitude:e.value().longitude}}:e instanceof G?{bytesValue:this.toBytes(e.value())}:e instanceof H?{referenceValue:this.toResourceName(e.databaseId,e.key.path)}:fail("Unknown FieldValue "+JSON.stringify(e))},JsonProtoSerializer.prototype.fromValue=function(e){var t=this,n=e.value_type;if(hasTag(e,n,"nullValue"))return B.INSTANCE;if(hasTag(e,n,"booleanValue"))return q.of(e.booleanValue);if(hasTag(e,n,"integerValue"))return new Q(parseInt64(e.integerValue));if(hasTag(e,n,"doubleValue")){if(this.options.useProto3Json){if("NaN"===e.doubleValue)return j.NAN;if("Infinity"===e.doubleValue)return j.POSITIVE_INFINITY;if("-Infinity"===e.doubleValue)return j.NEGATIVE_INFINITY}return new j(e.doubleValue)}if(hasTag(e,n,"stringValue"))return new W(e.stringValue);if(hasTag(e,n,"mapValue"))return this.fromFields(e.mapValue.fields||{});if(hasTag(e,n,"arrayValue")){assertPresent(e.arrayValue,"arrayValue");var r=e.arrayValue.values||[];return new Y(r.map(function(e){return t.fromValue(e)}))}if(hasTag(e,n,"timestampValue"))return assertPresent(e.timestampValue,"timestampValue"),new K(this.fromTimestamp(e.timestampValue));if(hasTag(e,n,"geoPointValue")){assertPresent(e.geoPointValue,"geoPointValue");var i=e.geoPointValue.latitude||0,o=e.geoPointValue.longitude||0;return new J(new y(i,o))}if(hasTag(e,n,"bytesValue")){assertPresent(e.bytesValue,"bytesValue");var a=this.fromBlob(e.bytesValue);return new G(a)}if(hasTag(e,n,"referenceValue")){assertPresent(e.referenceValue,"referenceValue");var s=this.fromResourceName(e.referenceValue),u=new S(s.get(1),s.get(3)),c=new C(this.extractLocalPathFromResourceName(s));return new H(u,c)}return fail("Unknown Value proto "+JSON.stringify(e))},JsonProtoSerializer.prototype.toMutationDocument=function(e,t){return{name:this.toName(e),fields:this.toFields(t)}},JsonProtoSerializer.prototype.toDocument=function(e){return assert(!e.hasLocalMutations,"Can't serialize documents with mutations."),{name:this.toName(e.key),fields:this.toFields(e.data),updateTime:this.toTimestamp(e.version.toTimestamp())}},JsonProtoSerializer.prototype.fromDocument=function(e,t){return new _(this.fromName(e.name),this.fromVersion(e.updateTime),this.fromFields(e.fields||{}),{hasCommittedMutations:!!t})},JsonProtoSerializer.prototype.toFields=function(e){var t=this,n={};return e.forEach(function(e,r){n[e]=t.toValue(r)}),n},JsonProtoSerializer.prototype.fromFields=function(e){var t=this,n=e,r=X.EMPTY;return forEach(n,function(e,n){r=r.set(new E([e]),t.fromValue(n))}),r},JsonProtoSerializer.prototype.toMapValue=function(e){return{fields:this.toFields(e)}},JsonProtoSerializer.prototype.toArrayValue=function(e){var t=this,n=[];return e.forEach(function(e){n.push(t.toValue(e))}),{values:n}},JsonProtoSerializer.prototype.fromFound=function(e){assert(!!e.found,"Tried to deserialize a found document from a missing document."),assertPresent(e.found.name,"doc.found.name"),assertPresent(e.found.updateTime,"doc.found.updateTime");var t=this.fromName(e.found.name),n=this.fromVersion(e.found.updateTime),r=this.fromFields(e.found.fields||{});return new _(t,n,r,{})},JsonProtoSerializer.prototype.fromMissing=function(e){assert(!!e.missing,"Tried to deserialize a missing document from a found document."),assert(!!e.readTime,"Tried to deserialize a missing document without a read time.");var t=this.fromName(e.missing),n=this.fromVersion(e.readTime);return new A(t,n)},JsonProtoSerializer.prototype.fromMaybeDocument=function(e){var t=e.result;return hasTag(e,t,"found")?this.fromFound(e):hasTag(e,t,"missing")?this.fromMissing(e):fail("invalid batch get response: "+JSON.stringify(e))},JsonProtoSerializer.prototype.toWatchTargetChangeState=function(e){switch(e){case Be.Added:return"ADD";case Be.Current:return"CURRENT";case Be.NoChange:return"NO_CHANGE";case Be.Removed:return"REMOVE";case Be.Reset:return"RESET";default:return fail("Unknown WatchTargetChangeState: "+e)}},JsonProtoSerializer.prototype.toTestWatchChange=function(e){if(e instanceof Ke)return{filter:{count:e.existenceFilter.count,targetId:e.targetId}};if(e instanceof We){if(e.newDoc instanceof _){var t=e.newDoc;return{documentChange:{document:{name:this.toName(t.key),fields:this.toFields(t.data),updateTime:this.toVersion(t.version)},targetIds:e.updatedTargetIds,removedTargetIds:e.removedTargetIds}}}if(e.newDoc instanceof A){var t=e.newDoc;return{documentDelete:{document:this.toName(t.key),readTime:this.toVersion(t.version),removedTargetIds:e.removedTargetIds}}}if(null===e.newDoc)return{documentRemove:{document:this.toName(e.key),removedTargetIds:e.removedTargetIds}}}if(e instanceof ze){var n=void 0;return e.cause&&(n={code:mapRpcCodeFromCode(e.cause.code),message:e.cause.message}),{targetChange:{targetChangeType:this.toWatchTargetChangeState(e.state),targetIds:e.targetIds,resumeToken:this.unsafeCastProtoByteString(e.resumeToken),cause:n}}}return fail("Unrecognized watch change: "+JSON.stringify(e))},JsonProtoSerializer.prototype.fromWatchChange=function(e){var t,n=e.response_type;if(hasTag(e,n,"targetChange")){assertPresent(e.targetChange,"targetChange");var r=this.fromWatchTargetChangeState(e.targetChange.targetChangeType||"NO_CHANGE"),i=e.targetChange.targetIds||[],o=e.targetChange.resumeToken||this.emptyByteString(),a=e.targetChange.cause,s=a&&this.fromRpcStatus(a);t=new ze(r,i,o,s||null)}else if(hasTag(e,n,"documentChange")){assertPresent(e.documentChange,"documentChange"),assertPresent(e.documentChange.document,"documentChange.name"),assertPresent(e.documentChange.document.name,"documentChange.document.name"),assertPresent(e.documentChange.document.updateTime,"documentChange.document.updateTime");var u=e.documentChange,c=this.fromName(u.document.name),h=this.fromVersion(u.document.updateTime),l=this.fromFields(u.document.fields||{}),f=new _(c,h,l,{}),d=u.targetIds||[],p=u.removedTargetIds||[];t=new We(d,p,f.key,f)}else if(hasTag(e,n,"documentDelete")){assertPresent(e.documentDelete,"documentDelete"),assertPresent(e.documentDelete.document,"documentDelete.document");var m=e.documentDelete,c=this.fromName(m.document),h=m.readTime?this.fromVersion(m.readTime):de.forDeletedDoc(),f=new A(c,h),p=m.removedTargetIds||[];t=new We([],p,f.key,f)}else if(hasTag(e,n,"documentRemove")){assertPresent(e.documentRemove,"documentRemove"),assertPresent(e.documentRemove.document,"documentRemove");var y=e.documentRemove,c=this.fromName(y.document),p=y.removedTargetIds||[];t=new We([],p,c,null)}else{if(!hasTag(e,n,"filter"))return fail("Unknown change type "+JSON.stringify(e));assertPresent(e.filter,"filter"),assertPresent(e.filter.targetId,"filter.targetId");var g=e.filter,v=g.count||0,b=new Pe(v),S=g.targetId;t=new Ke(S,b)}return t},JsonProtoSerializer.prototype.fromWatchTargetChangeState=function(e){return"NO_CHANGE"===e?Be.NoChange:"ADD"===e?Be.Added:"REMOVE"===e?Be.Removed:"CURRENT"===e?Be.Current:"RESET"===e?Be.Reset:fail("Got unexpected TargetChange.state: "+e)},JsonProtoSerializer.prototype.versionFromListenResponse=function(e){if(!hasTag(e,e.response_type,"targetChange"))return de.MIN;var t=e.targetChange;return t.targetIds&&t.targetIds.length?de.MIN:t.readTime?this.fromVersion(t.readTime):de.MIN},JsonProtoSerializer.prototype.toMutation=function(e){var t,n=this;if(e instanceof Te)t={update:this.toMutationDocument(e.key,e.value)};else if(e instanceof Ce)t={delete:this.toName(e.key)};else if(e instanceof De)t={update:this.toMutationDocument(e.key,e.data),updateMask:this.toDocumentMask(e.fieldMask)};else{if(!(e instanceof Ee))return fail("Unknown mutation type "+e.type);t={transform:{document:this.toName(e.key),fieldTransforms:e.fieldTransforms.map(function(e){return n.toFieldTransform(e)})}}}return e.precondition.isNone||(t.currentDocument=this.toPrecondition(e.precondition)),t},JsonProtoSerializer.prototype.fromMutation=function(e){var t=this,n=e.currentDocument?this.fromPrecondition(e.currentDocument):Se.NONE;if(e.update){assertPresent(e.update.name,"name");var r=this.fromName(e.update.name),i=this.fromFields(e.update.fields||{});if(e.updateMask){var o=this.fromDocumentMask(e.updateMask);return new De(r,i,o,n)}return new Te(r,i,n)}if(e.delete){var r=this.fromName(e.delete);return new Ce(r,n)}if(e.transform){var r=this.fromName(e.transform.document),a=e.transform.fieldTransforms.map(function(e){return t.fromFieldTransform(e)});return assert(!0===n.exists,'Transforms only support precondition "exists == true"'),new Ee(r,a)}return fail("unknown mutation proto: "+JSON.stringify(e))},JsonProtoSerializer.prototype.toPrecondition=function(e){return assert(!e.isNone,"Can't serialize an empty precondition"),void 0!==e.updateTime?{updateTime:this.toVersion(e.updateTime)}:void 0!==e.exists?{exists:e.exists}:fail("Unknown precondition")},JsonProtoSerializer.prototype.fromPrecondition=function(e){return void 0!==e.updateTime?Se.updateTime(this.fromVersion(e.updateTime)):void 0!==e.exists?Se.exists(e.exists):Se.NONE},JsonProtoSerializer.prototype.fromWriteResult=function(e,t){var n=this,r=e.updateTime?this.fromVersion(e.updateTime):this.fromVersion(t),i=null;return e.transformResults&&e.transformResults.length>0&&(i=e.transformResults.map(function(e){return n.fromValue(e)})),new ve(r,i)},JsonProtoSerializer.prototype.fromWriteResults=function(e,t){var n=this;return e&&e.length>0?(assert(void 0!==t,"Received a write result without a commit time"),e.map(function(e){return n.fromWriteResult(e,t)})):[]},JsonProtoSerializer.prototype.toFieldTransform=function(e){var t=this,n=e.transform;if(n instanceof Ie)return{fieldPath:e.field.canonicalString(),setToServerValue:"REQUEST_TIME"};if(n instanceof _e)return{fieldPath:e.field.canonicalString(),appendMissingElements:{values:n.elements.map(function(e){return t.toValue(e)})}};if(n instanceof Ae)return{fieldPath:e.field.canonicalString(),removeAllFromArray:{values:n.elements.map(function(e){return t.toValue(e)})}};throw fail("Unknown transform: "+e.transform)},JsonProtoSerializer.prototype.fromFieldTransform=function(e){var t=this,n=e.transform_type,r=null;if(hasTag(e,n,"setToServerValue"))assert("REQUEST_TIME"===e.setToServerValue,"Unknown server value transform proto: "+JSON.stringify(e)),r=Ie.instance;else if(hasTag(e,n,"appendMissingElements")){var i=e.appendMissingElements.values||[];r=new _e(i.map(function(e){return t.fromValue(e)}))}else if(hasTag(e,n,"removeAllFromArray")){var i=e.removeAllFromArray.values||[];r=new Ae(i.map(function(e){return t.fromValue(e)}))}else fail("Unknown transform proto: "+JSON.stringify(e));var o=E.fromServerFormat(e.fieldPath);return new ge(o,r)},JsonProtoSerializer.prototype.toDocumentsTarget=function(e){return{documents:[this.toQueryPath(e.path)]}},JsonProtoSerializer.prototype.fromDocumentsTarget=function(e){var t=e.documents.length;assert(1===t,"DocumentsTarget contained other than 1 document: "+t);var n=e.documents[0];return ne.atPath(this.fromQueryPath(n))},JsonProtoSerializer.prototype.toQueryTarget=function(e){var t={structuredQuery:{}};if(e.path.isEmpty())t.parent=this.toQueryPath(T.EMPTY_PATH);else{var n=e.path;assert(n.length%2!=0,"Document queries with filters are not supported."),t.parent=this.toQueryPath(n.popLast()),t.structuredQuery.from=[{collectionId:n.lastSegment()}]}var r=this.toFilter(e.filters);r&&(t.structuredQuery.where=r);var i=this.toOrder(e.orderBy);i&&(t.structuredQuery.orderBy=i);var o=this.toInt32Value(e.limit);return void 0!==o&&(t.structuredQuery.limit=o),e.startAt&&(t.structuredQuery.startAt=this.toCursor(e.startAt)),e.endAt&&(t.structuredQuery.endAt=this.toCursor(e.endAt)),t},JsonProtoSerializer.prototype.fromQueryTarget=function(e){var t=this.fromQueryPath(e.parent),n=e.structuredQuery,r=n.from?n.from.length:0;if(r>0){assert(1===r,"StructuredQuery.from with more than one collection is not supported.");var i=n.from[0];t=t.child(i.collectionId)}var o=[];n.where&&(o=this.fromFilter(n.where));var a=[];n.orderBy&&(a=this.fromOrder(n.orderBy));var s=null;n.limit&&(s=this.fromInt32Value(n.limit));var u=null;n.startAt&&(u=this.fromCursor(n.startAt));var c=null;return n.endAt&&(c=this.fromCursor(n.endAt)),new ne(t,a,o,s,u,c)},JsonProtoSerializer.prototype.toListenRequestLabels=function(e){var t=this.toLabel(e.purpose);return null==t?null:{"goog-listen-tags":t}},JsonProtoSerializer.prototype.toLabel=function(e){switch(e){case x.Listen:return null;case x.ExistenceFilterMismatch:return"existence-filter-mismatch";case x.LimboResolution:return"limbo-document";default:return fail("Unrecognized query purpose: "+e)}},JsonProtoSerializer.prototype.toTarget=function(e){var t,n=e.query;return t=n.isDocumentQuery()?{documents:this.toDocumentsTarget(n)}:{query:this.toQueryTarget(n)},t.targetId=e.targetId,e.resumeToken.length>0&&(t.resumeToken=this.unsafeCastProtoByteString(e.resumeToken)),t},JsonProtoSerializer.prototype.toFilter=function(e){var t=this;if(0!==e.length){var n=e.map(function(e){return e instanceof oe?t.toRelationFilter(e):t.toUnaryFilter(e)});return 1===n.length?n[0]:{compositeFilter:{op:"AND",filters:n}}}},JsonProtoSerializer.prototype.fromFilter=function(e){var t=this;return e?void 0!==e.unaryFilter?[this.fromUnaryFilter(e)]:void 0!==e.fieldFilter?[this.fromRelationFilter(e)]:void 0!==e.compositeFilter?e.compositeFilter.filters.map(function(e){return t.fromFilter(e)}).reduce(function(e,t){return e.concat(t)}):fail("Unknown filter: "+JSON.stringify(e)):[]},JsonProtoSerializer.prototype.toOrder=function(e){var t=this;if(0!==e.length)return e.map(function(e){return t.toPropertyOrder(e)})},JsonProtoSerializer.prototype.fromOrder=function(e){var t=this;return e.map(function(e){return t.fromPropertyOrder(e)})},JsonProtoSerializer.prototype.toCursor=function(e){var t=this;return{before:e.before,values:e.position.map(function(e){return t.toValue(e)})}},JsonProtoSerializer.prototype.fromCursor=function(e){var t=this,n=!!e.before,r=e.values.map(function(e){return t.fromValue(e)});return new ce(r,n)},JsonProtoSerializer.prototype.toDirection=function(e){return Je[e.name]},JsonProtoSerializer.prototype.fromDirection=function(e){switch(e){case"ASCENDING":return ue.ASCENDING;case"DESCENDING":return ue.DESCENDING;default:return}},JsonProtoSerializer.prototype.toOperatorName=function(e){return Xe[e.name]},JsonProtoSerializer.prototype.fromOperatorName=function(e){switch(e){case"EQUAL":return ie.EQUAL;case"GREATER_THAN":return ie.GREATER_THAN;case"GREATER_THAN_OR_EQUAL":return ie.GREATER_THAN_OR_EQUAL;case"LESS_THAN":return ie.LESS_THAN;case"LESS_THAN_OR_EQUAL":return ie.LESS_THAN_OR_EQUAL;case"ARRAY_CONTAINS":return ie.ARRAY_CONTAINS;case"OPERATOR_UNSPECIFIED":return fail("Unspecified relation");default:return fail("Unknown relation")}},JsonProtoSerializer.prototype.toFieldPathReference=function(e){return{fieldPath:e.canonicalString()}},JsonProtoSerializer.prototype.fromFieldPathReference=function(e){return E.fromServerFormat(e.fieldPath)},JsonProtoSerializer.prototype.toPropertyOrder=function(e){return{field:this.toFieldPathReference(e.field),direction:this.toDirection(e.dir)}},JsonProtoSerializer.prototype.fromPropertyOrder=function(e){return new he(this.fromFieldPathReference(e.field),this.fromDirection(e.direction))},JsonProtoSerializer.prototype.toRelationFilter=function(e){return e instanceof oe?{fieldFilter:{field:this.toFieldPathReference(e.field),op:this.toOperatorName(e.op),value:this.toValue(e.value)}}:fail("Unrecognized filter: "+JSON.stringify(e))},JsonProtoSerializer.prototype.fromRelationFilter=function(e){return new oe(this.fromFieldPathReference(e.fieldFilter.field),this.fromOperatorName(e.fieldFilter.op),this.fromValue(e.fieldFilter.value))},JsonProtoSerializer.prototype.toUnaryFilter=function(e){return e instanceof se?{unaryFilter:{field:this.toFieldPathReference(e.field),op:"IS_NAN"}}:e instanceof ae?{unaryFilter:{field:this.toFieldPathReference(e.field),op:"IS_NULL"}}:fail("Unrecognized filter: "+JSON.stringify(e))},JsonProtoSerializer.prototype.fromUnaryFilter=function(e){switch(e.unaryFilter.op){case"IS_NAN":var t=this.fromFieldPathReference(e.unaryFilter.field);return new se(t);case"IS_NULL":var n=this.fromFieldPathReference(e.unaryFilter.field);return new ae(n);case"OPERATOR_UNSPECIFIED":return fail("Unspecified filter");default:return fail("Unknown filter")}},JsonProtoSerializer.prototype.toDocumentMask=function(e){return{fieldPaths:e.fields.map(function(e){return e.canonicalString()})}},JsonProtoSerializer.prototype.fromDocumentMask=function(e){var t=e.fieldPaths||[],n=t.map(function(e){return E.fromServerFormat(e)});return new ye(n)},JsonProtoSerializer}(),Ze=function(){return"object"==typeof navigator&&"ReactNative"===navigator.product},et="FirebaseError",tt=Error.captureStackTrace,nt=function(){function FirebaseError(e,t){if(this.code=e,this.message=t,tt)tt(this,rt.prototype.create);else try{throw Error.apply(this,arguments)}catch(e){this.name=et,Object.defineProperty(this,"stack",{get:function(){return e.stack}})}}return FirebaseError}();nt.prototype=Object.create(Error.prototype),nt.prototype.constructor=nt,nt.prototype.name=et;var rt=function(){function ErrorFactory(e,t,n){this.service=e,this.serviceName=t,this.errors=n,this.pattern=/\{\$([^}]+)}/g}return ErrorFactory.prototype.create=function(e,t){void 0===t&&(t={});var n,r=this.errors[e],i=this.service+"/"+e;n=void 0===r?"Error":r.replace(this.pattern,function(e,n){var r=t[n];return void 0!==r?r.toString():"<"+n+"?>"}),n=this.serviceName+": "+n+" ("+i+").";var o=new nt(i,n);for(var a in t)t.hasOwnProperty(a)&&"_"!==a.slice(-1)&&(o[a]=t[a]);return o},ErrorFactory}(),it=function(){function Hash(){this.blockSize=-1}return Hash}(),ot=(function(e){function Sha1(){var t=e.call(this)||this;t.chain_=[],t.buf_=[],t.W_=[],t.pad_=[],t.inbuf_=0,t.total_=0,t.blockSize=64,t.pad_[0]=128;for(var n=1;n<t.blockSize;++n)t.pad_[n]=0;return t.reset(),t}a.__extends(Sha1,e),Sha1.prototype.reset=function(){this.chain_[0]=1732584193,this.chain_[1]=4023233417,this.chain_[2]=2562383102,this.chain_[3]=271733878,this.chain_[4]=3285377520,this.inbuf_=0,this.total_=0},Sha1.prototype.compress_=function(e,t){t||(t=0);var n=this.W_;if("string"==typeof e)for(var r=0;r<16;r++)n[r]=e.charCodeAt(t)<<24|e.charCodeAt(t+1)<<16|e.charCodeAt(t+2)<<8|e.charCodeAt(t+3),t+=4;else for(var r=0;r<16;r++)n[r]=e[t]<<24|e[t+1]<<16|e[t+2]<<8|e[t+3],t+=4;for(var r=16;r<80;r++){var i=n[r-3]^n[r-8]^n[r-14]^n[r-16];n[r]=4294967295&(i<<1|i>>>31)}for(var o,a,s=this.chain_[0],u=this.chain_[1],c=this.chain_[2],h=this.chain_[3],l=this.chain_[4],r=0;r<80;r++){r<40?r<20?(o=h^u&(c^h),a=1518500249):(o=u^c^h,a=1859775393):r<60?(o=u&c|h&(u|c),a=2400959708):(o=u^c^h,a=3395469782);var i=(s<<5|s>>>27)+o+l+a+n[r]&4294967295;l=h,h=c,c=4294967295&(u<<30|u>>>2),u=s,s=i}this.chain_[0]=this.chain_[0]+s&4294967295,this.chain_[1]=this.chain_[1]+u&4294967295,this.chain_[2]=this.chain_[2]+c&4294967295,this.chain_[3]=this.chain_[3]+h&4294967295,this.chain_[4]=this.chain_[4]+l&4294967295},Sha1.prototype.update=function(e,t){if(null!=e){void 0===t&&(t=e.length);for(var n=t-this.blockSize,r=0,i=this.buf_,o=this.inbuf_;r<t;){if(0==o)for(;r<=n;)this.compress_(e,r),r+=this.blockSize;if("string"==typeof e){for(;r<t;)if(i[o]=e.charCodeAt(r),++o,++r,o==this.blockSize){this.compress_(i),o=0;break}}else for(;r<t;)if(i[o]=e[r],++o,++r,o==this.blockSize){this.compress_(i),o=0;break}}this.inbuf_=o,this.total_+=t}},Sha1.prototype.digest=function(){var e=[],t=8*this.total_;this.inbuf_<56?this.update(this.pad_,56-this.inbuf_):this.update(this.pad_,this.blockSize-(this.inbuf_-56));for(var n=this.blockSize-1;n>=56;n--)this.buf_[n]=255&t,t/=256;this.compress_(this.buf_);for(var r=0,n=0;n<5;n++)for(var i=24;i>=0;i-=8)e[r]=this.chain_[n]>>i&255,++r;return e}}(it),function(){function StreamBridge(e){this.sendFn=e.sendFn,this.closeFn=e.closeFn}return StreamBridge.prototype.onOpen=function(e){assert(!this.wrappedOnOpen,"Called onOpen on stream twice!"),this.wrappedOnOpen=e},StreamBridge.prototype.onClose=function(e){assert(!this.wrappedOnClose,"Called onClose on stream twice!"),this.wrappedOnClose=e},StreamBridge.prototype.onMessage=function(e){assert(!this.wrappedOnMessage,"Called onMessage on stream twice!"),this.wrappedOnMessage=e},StreamBridge.prototype.close=function(){this.closeFn()},StreamBridge.prototype.send=function(e){this.sendFn(e)},StreamBridge.prototype.callOnOpen=function(){assert(void 0!==this.wrappedOnOpen,"Cannot call onOpen because no callback was set"),this.wrappedOnOpen()},StreamBridge.prototype.callOnClose=function(e){assert(void 0!==this.wrappedOnClose,"Cannot call onClose because no callback was set"),this.wrappedOnClose(e)},StreamBridge.prototype.callOnMessage=function(e){assert(void 0!==this.wrappedOnMessage,"Cannot call onMessage because no callback was set"),this.wrappedOnMessage(e)},StreamBridge}()),at="Connection",st={BatchGetDocuments:"batchGet",Commit:"commit"},ut="gl-js/ fire/"+u,ct=function(){function WebChannelConnection(e){this.databaseId=e.databaseId,this.pool=new s.XhrIoPool;var t=e.ssl?"https":"http";this.baseUrl=t+"://"+e.host}return WebChannelConnection.prototype.modifyHeadersForRequest=function(e,t){if(t)for(var n in t.authHeaders)t.authHeaders.hasOwnProperty(n)&&(e[n]=t.authHeaders[n]);e["X-Goog-Api-Client"]=ut},WebChannelConnection.prototype.invokeRPC=function(e,t,n){var r=this,i=this.makeUrl(e);return new Promise(function(o,a){r.pool.getObject(function(u){u.listenOnce(s.EventType.COMPLETE,function(){try{switch(u.getLastErrorCode()){case s.ErrorCode.NO_ERROR:var t=u.getResponseJson();debug(at,"XHR received:",JSON.stringify(t)),o(t);break;case s.ErrorCode.TIMEOUT:debug(at,'RPC "'+e+'" timed out'),a(new f(l.DEADLINE_EXCEEDED,"Request time out"));break;case s.ErrorCode.HTTP_ERROR:var n=u.getStatus();debug(at,'RPC "'+e+'" failed with status:',n,"response text:",u.getResponseText()),n>0?a(new f(mapCodeFromHttpStatus(n),"Server responded with status "+u.getStatusText())):(debug(at,'RPC "'+e+'" failed'),a(new f(l.UNAVAILABLE,"Connection failed.")));break;default:fail('RPC "'+e+'" failed with unanticipated webchannel error '+u.getLastErrorCode()+": "+u.getLastError()+", giving up.")}}finally{debug(at,'RPC "'+e+'" completed.'),r.pool.releaseObject(u)}});var c=JSON.stringify(t);debug(at,"XHR sending: ",i+" "+c);var h={"Content-Type":"text/plain"};r.modifyHeadersForRequest(h,n),u.send(i,"POST",c,h,15)})})},WebChannelConnection.prototype.invokeStreamingRPC=function(e,t,n){return this.invokeRPC(e,t,n)},WebChannelConnection.prototype.openStream=function(e,t){var n=[this.baseUrl,"/","google.firestore.v1beta1.Firestore","/",e,"/channel"],r=s.createWebChannelTransport(),i={backgroundChannelTest:!0,httpSessionIdParam:"gsessionid",initMessageHeaders:{},messageUrlParams:{database:"projects/"+this.databaseId.projectId+"/databases/"+this.databaseId.database},sendRawJson:!0,supportsCrossDomainXhr:!0};this.modifyHeadersForRequest(i.initMessageHeaders,t),Ze()||(i.httpHeadersOverwriteParam="$httpHeaders");var o=n.join("");debug(at,"Creating WebChannel: "+o+" "+i);var a=r.createWebChannel(o,i),u=!1,c=!1,h=new ot({sendFn:function(e){c?debug(at,"Not sending because WebChannel is closed:",e):(u||(debug(at,"Opening WebChannel transport."),a.open(),u=!0),debug(at,"WebChannel sending:",e),a.send(e))},closeFn:function(){return a.close()}}),d=function(e,t){a.listen(e,function(e){try{t(e)}catch(e){setTimeout(function(){throw e},0)}})};return d(s.WebChannel.EventType.OPEN,function(){c||debug(at,"WebChannel transport opened.")}),d(s.WebChannel.EventType.CLOSE,function(){c||(c=!0,debug(at,"WebChannel transport closed"),h.callOnClose())}),d(s.WebChannel.EventType.ERROR,function(e){c||(c=!0,debug(at,"WebChannel transport errored:",e),h.callOnClose(new f(l.UNAVAILABLE,"The operation could not be completed")))}),d(s.WebChannel.EventType.MESSAGE,function(e){if(!c){var t=e.data[0];assert(!!t,"Got a webchannel message without data.");var n=t.error||t[0]&&t[0].error;if(n){debug(at,"WebChannel received error:",n);var r=n.status,i=mapCodeFromRpcStatus(r),o=n.message;void 0===i&&(i=l.INTERNAL,o="Unknown error status: "+r+" with message "+n.message),c=!0,h.callOnClose(new f(i,o)),a.close()}else debug(at,"WebChannel received:",t),h.callOnMessage(t)}}),setTimeout(function(){h.callOnOpen()},0),h},WebChannelConnection.prototype.makeUrl=function(e){var t=st[e];assert(void 0!==t,"Unknown REST mapping for: "+e);var n=[this.baseUrl,"/","v1beta1"];return n.push("/projects/"),n.push(this.databaseId.projectId),n.push("/databases/"),n.push(this.databaseId.database),n.push("/documents"),n.push(":"),n.push(t),n.join("")},WebChannelConnection}(),ht=function(){function BrowserPlatform(){this.emptyByteString="",this.base64Available="undefined"!=typeof atob}return Object.defineProperty(BrowserPlatform.prototype,"document",{get:function(){return"undefined"!=typeof document?document:null},enumerable:!0,configurable:!0}),Object.defineProperty(BrowserPlatform.prototype,"window",{get:function(){return"undefined"!=typeof window?window:null},enumerable:!0,configurable:!0}),BrowserPlatform.prototype.loadConnection=function(e){return Promise.resolve(new ct(e))},BrowserPlatform.prototype.newSerializer=function(e){return new $e(e,{useProto3Json:!0})},BrowserPlatform.prototype.formatJSON=function(e){return JSON.stringify(e)},BrowserPlatform.prototype.atob=function(e){return atob(e)},BrowserPlatform.prototype.btoa=function(e){return btoa(e)},BrowserPlatform}();h.setPlatform(new ht);var lt,ft=function(){function ListenSequence(e,t){var n=this;this.previousValue=e,t&&(t.sequenceNumberHandler=function(e){return n.setPreviousValue(e)},this.writeNewSequenceNumber=function(e){return t.writeSequenceNumber(e)})}return ListenSequence.prototype.setPreviousValue=function(e){return this.previousValue=Math.max(e,this.previousValue),this.previousValue},ListenSequence.prototype.next=function(){var e=++this.previousValue;return this.writeNewSequenceNumber&&this.writeNewSequenceNumber(e),e},ListenSequence.INVALID=-1,ListenSequence}(),dt=function(){function Deferred(){var e=this;this.promise=new Promise(function(t,n){e.resolve=t,e.reject=n})}return Deferred}();!function(e){e.All="all",e.ListenStreamIdle="listen_stream_idle",e.ListenStreamConnectionBackoff="listen_stream_connection_backoff",e.WriteStreamIdle="write_stream_idle",e.WriteStreamConnectionBackoff="write_stream_connection_backoff",e.OnlineStateTimeout="online_state_timeout",e.ClientMetadataRefresh="client_metadata_refresh"}(lt||(lt={}));var pt,mt=function(){function DelayedOperation(e,t,n,r,i){this.asyncQueue=e,this.timerId=t,this.targetTimeMs=n,this.op=r,this.removalCallback=i,this.deferred=new dt,this.then=this.deferred.promise.then.bind(this.deferred.promise),this.catch=this.deferred.promise.catch.bind(this.deferred.promise),this.deferred.promise.catch(function(e){})}return DelayedOperation.createAndSchedule=function(e,t,n,r,i){var o=Date.now()+n,a=new DelayedOperation(e,t,o,r,i);return a.start(n),a},DelayedOperation.prototype.start=function(e){var t=this;this.timerHandle=setTimeout(function(){return t.handleDelayElapsed()},e)},DelayedOperation.prototype.skipDelay=function(){return this.handleDelayElapsed()},DelayedOperation.prototype.cancel=function(e){null!==this.timerHandle&&(this.clearTimeout(),this.deferred.reject(new f(l.CANCELLED,"Operation cancelled"+(e?": "+e:""))))},DelayedOperation.prototype.handleDelayElapsed=function(){var e=this;this.asyncQueue.enqueueAndForget(function(){return null!==e.timerHandle?(e.clearTimeout(),e.op().then(function(t){return e.deferred.resolve(t)})):Promise.resolve()})},DelayedOperation.prototype.clearTimeout=function(){null!==this.timerHandle&&(this.removalCallback(this),clearTimeout(this.timerHandle),this.timerHandle=null)},DelayedOperation}(),yt=function(){function AsyncQueue(){this.tail=Promise.resolve(),this.delayedOperations=[],this.operationInProgress=!1}return AsyncQueue.prototype.enqueueAndForget=function(e){this.enqueue(e)},AsyncQueue.prototype.enqueue=function(e){var t=this;this.verifyNotFailed();var n=this.tail.then(function(){return t.operationInProgress=!0,e().catch(function(e){t.failure=e,t.operationInProgress=!1;var n=e.stack||e.message||"";throw error("INTERNAL UNHANDLED ERROR: ",n),n.indexOf("Firestore Test Simulated Error")<0&&setTimeout(function(){throw e},0),e}).then(function(e){return t.operationInProgress=!1,e})});return this.tail=n,n},AsyncQueue.prototype.enqueueAfterDelay=function(e,t,n){var r=this;this.verifyNotFailed(),assert(t>=0,"Attempted to schedule an operation with a negative delay of "+t),assert(!this.containsDelayedOperation(e),"Attempted to schedule multiple operations with timer id "+e+".");var i=mt.createAndSchedule(this,e,t,n,function(e){return r.removeDelayedOperation(e)});return this.delayedOperations.push(i),i},AsyncQueue.prototype.verifyNotFailed=function(){this.failure&&fail("AsyncQueue is already failed: "+(this.failure.stack||this.failure.message))},AsyncQueue.prototype.verifyOperationInProgress=function(){assert(this.operationInProgress,"verifyOpInProgress() called when no op in progress on this queue.")},AsyncQueue.prototype.drain=function(){return this.enqueue(function(){return Promise.resolve()})},AsyncQueue.prototype.containsDelayedOperation=function(e){for(var t=0,n=this.delayedOperations;t<n.length;t++){if(n[t].timerId===e)return!0}return!1},AsyncQueue.prototype.runDelayedOperationsEarly=function(e){var t=this;return this.drain().then(function(){assert(e===lt.All||t.containsDelayedOperation(e),"Attempted to drain to missing operation "+e),t.delayedOperations.sort(function(e,t){return e.targetTimeMs-t.targetTimeMs});for(var n=0,r=t.delayedOperations;n<r.length;n++){var i=r[n];if(i.skipDelay(),e!==lt.All&&i.timerId===e)break}return t.drain()})},AsyncQueue.prototype.removeDelayedOperation=function(e){var t=this.delayedOperations.indexOf(e);assert(t>=0,"Delayed operation not found."),this.delayedOperations.splice(t,1)},AsyncQueue}(),gt="",vt="",bt="",St="",wt=-1,Tt=function(){function MutationBatch(e,t,n){this.batchId=e,this.localWriteTime=t,this.mutations=n,assert(n.length>0,"Cannot create an empty mutation batch")}return MutationBatch.prototype.applyToRemoteDocument=function(e,t,n){t&&assert(t.key.isEqual(e),"applyToRemoteDocument: key "+e+" should match maybeDoc key\n        "+t.key);var r=n.mutationResults;assert(r.length===this.mutations.length,"Mismatch between mutations length\n      ("+this.mutations.length+") and mutation results length\n      ("+r.length+").");for(var i=0;i<this.mutations.length;i++){var o=this.mutations[i];if(o.key.isEqual(e)){var a=r[i];t=o.applyToRemoteDocument(t,a)}}return t},MutationBatch.prototype.applyToLocalView=function(e,t){t&&assert(t.key.isEqual(e),"applyToLocalDocument: key "+e+" should match maybeDoc key\n        "+t.key);for(var n=t,r=0;r<this.mutations.length;r++){var i=this.mutations[r];i.key.isEqual(e)&&(t=i.applyToLocalView(t,n,this.localWriteTime))}return t},MutationBatch.prototype.keys=function(){for(var e=documentKeySet(),t=0,n=this.mutations;t<n.length;t++){var r=n[t];e=e.add(r.key)}return e},MutationBatch.prototype.isEqual=function(e){return this.batchId===e.batchId&&arrayEquals(this.mutations,e.mutations)},MutationBatch}(),Dt=function(){function MutationBatchResult(e,t,n,r,i){this.batch=e,this.commitVersion=t,this.mutationResults=n,this.streamToken=r,this.docVersions=i}return MutationBatchResult.from=function(e,t,n,r){assert(e.mutations.length===n.length,"Mutations sent "+e.mutations.length+" must equal results received "+n.length);for(var i=documentVersionMap(),o=e.mutations,a=0;a<o.length;a++)i=i.insert(o[a].key,n[a].version);return new MutationBatchResult(e,t,n,r,i)},MutationBatchResult}(),Et=1;!function(e){e[e.QueryCache=0]="QueryCache",e[e.SyncEngine=1]="SyncEngine"}(pt||(pt={}));var Ct,It=function(){function TargetIdGenerator(e,t){this.generatorId=e,assert((e&Et)===e,"Generator ID "+e+" contains more than "+Et+" reserved bits"),this.seek(void 0!==t?t:this.generatorId)}return TargetIdGenerator.prototype.next=function(){var e=this.nextId;return this.nextId+=1<<Et,e},TargetIdGenerator.prototype.after=function(e){return this.seek(e+(1<<Et)),this.next()},TargetIdGenerator.prototype.seek=function(e){assert((e&Et)===this.generatorId,"Cannot supply target ID from different generator ID"),this.nextId=e},TargetIdGenerator.forQueryCache=function(){return new TargetIdGenerator(pt.QueryCache,2)},TargetIdGenerator.forSyncEngine=function(){return new TargetIdGenerator(pt.SyncEngine)},TargetIdGenerator}(),_t=function(){function PersistencePromise(e){var t=this;this.nextCallback=null,this.catchCallback=null,this.result=void 0,this.error=void 0,this.isDone=!1,this.callbackAttached=!1,e(function(e){t.isDone=!0,t.result=e,t.nextCallback&&t.nextCallback(e)},function(e){t.isDone=!0,t.error=e,t.catchCallback&&t.catchCallback(e)})}return PersistencePromise.prototype.catch=function(e){return this.next(void 0,e)},PersistencePromise.prototype.next=function(e,t){var n=this;return this.callbackAttached&&fail("Called next() or catch() twice for PersistencePromise"),this.callbackAttached=!0,this.isDone?this.error?this.wrapFailure(t,this.error):this.wrapSuccess(e,this.result):new PersistencePromise(function(r,i){n.nextCallback=function(t){n.wrapSuccess(e,t).next(r,i)},n.catchCallback=function(e){n.wrapFailure(t,e).next(r,i)}})},PersistencePromise.prototype.toPromise=function(){var e=this;return new Promise(function(t,n){e.next(t,n)})},PersistencePromise.prototype.wrapUserFunction=function(e){try{var t=e();return t instanceof PersistencePromise?t:PersistencePromise.resolve(t)}catch(e){return PersistencePromise.reject(e)}},PersistencePromise.prototype.wrapSuccess=function(e,t){return e?this.wrapUserFunction(function(){return e(t)}):PersistencePromise.resolve(t)},PersistencePromise.prototype.wrapFailure=function(e,t){return e?this.wrapUserFunction(function(){return e(t)}):PersistencePromise.reject(t)},PersistencePromise.resolve=function(e){return new PersistencePromise(function(t,n){t(e)})},PersistencePromise.reject=function(e){return new PersistencePromise(function(t,n){n(e)})},PersistencePromise.waitFor=function(e){return new PersistencePromise(function(t,n){var r=0,i=0,o=!1;e.forEach(function(e){++r,e.next(function(){++i,o&&i===r&&t()},function(e){return n(e)})}),o=!0,i===r&&t()})},PersistencePromise.or=function(e){for(var t=PersistencePromise.resolve(!1),n=0,r=e;n<r.length;n++){var i=r[n];!function(e){t=t.next(function(t){return t?PersistencePromise.resolve(t):e()})}(i)}return t},PersistencePromise.forEach=function(e,t){var n=this,r=[];return e.forEach(function(e,i){r.push(t.call(n,e,i))}),this.waitFor(r)},PersistencePromise}(),At=function(){function SimpleDb(e){this.db=e}return SimpleDb.openOrCreate=function(e,t,n){return assert(SimpleDb.isAvailable(),"IndexedDB not supported in current environment."),debug("SimpleDb","Opening database:",e),new _t(function(r,i){var o=window.indexedDB.open(e,t);o.onsuccess=function(e){var t=e.target.result;r(new SimpleDb(t))},o.onblocked=function(){i(new f(l.FAILED_PRECONDITION,"Cannot upgrade IndexedDB schema while another tab is open. Close all tabs that access Firestore and reload this page to proceed."))},o.onerror=function(e){i(e.target.error)},o.onupgradeneeded=function(t){debug("SimpleDb",'Database "'+e+'" requires upgrade from version:',t.oldVersion);var r=t.target.result,i=new Nt(o.transaction);n.createOrUpgrade(r,i,t.oldVersion,Vt).next(function(){debug("SimpleDb","Database upgrade to version "+Vt+" complete")})}}).toPromise()},SimpleDb.delete=function(e){return debug("SimpleDb","Removing database:",e),wrapRequest(window.indexedDB.deleteDatabase(e)).toPromise()},SimpleDb.isAvailable=function(){if("undefined"==typeof window||null==window.indexedDB)return!1;if(void 0===window.navigator)return"YES"===Object({NODE_ENV:"production"}).USE_MOCK_PERSISTENCE;var e=window.navigator.userAgent;return!(e.indexOf("MSIE ")>0||e.indexOf("Trident/")>0||e.indexOf("Edge/")>0)},SimpleDb.getStore=function(e,t){return e.store(t)},SimpleDb.prototype.runTransaction=function(e,t,n){var r=Nt.open(this.db,e,t),i=n(r).catch(function(e){r.abort(e)}).toPromise();return r.completionPromise.then(function(){return i})},SimpleDb.prototype.close=function(){this.db.close()},SimpleDb}(),Pt=function(){function IterationController(e){this.dbCursor=e,this.shouldStop=!1,this.nextKey=null}return Object.defineProperty(IterationController.prototype,"isDone",{get:function(){return this.shouldStop},enumerable:!0,configurable:!0}),Object.defineProperty(IterationController.prototype,"skipToKey",{get:function(){return this.nextKey},enumerable:!0,configurable:!0}),Object.defineProperty(IterationController.prototype,"cursor",{set:function(e){this.dbCursor=e},enumerable:!0,configurable:!0}),IterationController.prototype.done=function(){this.shouldStop=!0},IterationController.prototype.skip=function(e){this.nextKey=e},IterationController.prototype.delete=function(){return wrapRequest(this.dbCursor.delete())},IterationController}(),Nt=function(){function SimpleDbTransaction(e){var t=this;this.transaction=e,this.aborted=!1,this.completionDeferred=new dt,this.transaction.oncomplete=function(){t.completionDeferred.resolve()},this.transaction.onabort=function(){e.error?t.completionDeferred.reject(e.error):t.completionDeferred.resolve()},this.transaction.onerror=function(e){t.completionDeferred.reject(e.target.error)}}return SimpleDbTransaction.open=function(e,t,n){return new SimpleDbTransaction(e.transaction(n,t))},Object.defineProperty(SimpleDbTransaction.prototype,"completionPromise",{get:function(){return this.completionDeferred.promise},enumerable:!0,configurable:!0}),SimpleDbTransaction.prototype.abort=function(e){e&&this.completionDeferred.reject(e),this.aborted||(debug("SimpleDb","Aborting transaction:",e?e.message:"Client-initiated abort"),this.aborted=!0,this.transaction.abort())},SimpleDbTransaction.prototype.store=function(e){var t=this.transaction.objectStore(e);return assert(!!t,"Object store not part of transaction: "+e),new Rt(t)},SimpleDbTransaction}(),Rt=function(){function SimpleDbStore(e){this.store=e}return SimpleDbStore.prototype.put=function(e,t){var n;return void 0!==t?(debug("SimpleDb","PUT",this.store.name,e,t),n=this.store.put(t,e)):(debug("SimpleDb","PUT",this.store.name,"<auto-key>",e),n=this.store.put(e)),wrapRequest(n)},SimpleDbStore.prototype.add=function(e){return debug("SimpleDb","ADD",this.store.name,e,e),wrapRequest(this.store.add(e))},SimpleDbStore.prototype.get=function(e){var t=this;return wrapRequest(this.store.get(e)).next(function(n){return void 0===n&&(n=null),debug("SimpleDb","GET",t.store.name,e,n),n})},SimpleDbStore.prototype.delete=function(e){return debug("SimpleDb","DELETE",this.store.name,e),wrapRequest(this.store.delete(e))},SimpleDbStore.prototype.count=function(){return debug("SimpleDb","COUNT",this.store.name),wrapRequest(this.store.count())},SimpleDbStore.prototype.loadAll=function(e,t){var n=this.cursor(this.options(e,t)),r=[];return this.iterateCursor(n,function(e,t){r.push(t)}).next(function(){return r})},SimpleDbStore.prototype.deleteAll=function(e,t){debug("SimpleDb","DELETE ALL",this.store.name);var n=this.options(e,t);n.keysOnly=!1;var r=this.cursor(n);return this.iterateCursor(r,function(e,t,n){return n.delete()})},SimpleDbStore.prototype.iterate=function(e,t){var n;t?n=e:(n={},t=e);var r=this.cursor(n);return this.iterateCursor(r,t)},SimpleDbStore.prototype.iterateSerial=function(e){var t=this.cursor({});return new _t(function(n,r){t.onerror=function(e){r(e.target.error)},t.onsuccess=function(t){var r=t.target.result;if(!r)return void n();e(r.primaryKey,r.value).next(function(e){e?r.continue():n()})}})},SimpleDbStore.prototype.iterateCursor=function(e,t){var n=[];return new _t(function(r,i){e.onerror=function(e){i(e.target.error)},e.onsuccess=function(e){var i=e.target.result;if(!i)return void r();var o=new Pt(i),a=t(i.primaryKey,i.value,o);if(a instanceof _t){var s=a.catch(function(e){return o.done(),_t.reject(e)});n.push(s)}o.isDone?r():null===o.skipToKey?i.continue():i.continue(o.skipToKey)}}).next(function(){return _t.waitFor(n)})},SimpleDbStore.prototype.options=function(e,t){var n=void 0;return void 0!==e&&("string"==typeof e?n=e:(assert(void 0===t,"3rd argument must not be defined if 2nd is a range."),t=e)),{index:n,range:t}},SimpleDbStore.prototype.cursor=function(e){var t="next";if(e.reverse&&(t="prev"),e.index){var n=this.store.index(e.index);return e.keysOnly?n.openKeyCursor(e.range,t):n.openCursor(e.range,t)}return this.store.openCursor(e.range,t)},SimpleDbStore}(),Mt=function(){function IndexedDbQueryCache(e,t){this.referenceDelegate=e,this.serializer=t,this.targetIdGenerator=It.forQueryCache()}return IndexedDbQueryCache.prototype.allocateTargetId=function(e){var t=this;return this.retrieveMetadata(e).next(function(n){return n.highestTargetId=t.targetIdGenerator.after(n.highestTargetId),t.saveMetadata(e,n).next(function(){return n.highestTargetId})})},IndexedDbQueryCache.prototype.getLastRemoteSnapshotVersion=function(e){return this.retrieveMetadata(e).next(function(e){return de.fromTimestamp(new g(e.lastRemoteSnapshotVersion.seconds,e.lastRemoteSnapshotVersion.nanoseconds))})},IndexedDbQueryCache.prototype.getHighestSequenceNumber=function(e){return getHighestListenSequenceNumber(e.simpleDbTransaction)},IndexedDbQueryCache.prototype.setTargetsMetadata=function(e,t,n){var r=this;return this.retrieveMetadata(e).next(function(i){return i.highestListenSequenceNumber=t,n&&(i.lastRemoteSnapshotVersion=n.toTimestamp()),t>i.highestListenSequenceNumber&&(i.highestListenSequenceNumber=t),r.saveMetadata(e,i)})},IndexedDbQueryCache.prototype.addQueryData=function(e,t){var n=this;return this.saveQueryData(e,t).next(function(){return n.retrieveMetadata(e).next(function(r){return r.targetCount+=1,n.updateMetadataFromQueryData(t,r),n.saveMetadata(e,r)})})},IndexedDbQueryCache.prototype.updateQueryData=function(e,t){return this.saveQueryData(e,t)},IndexedDbQueryCache.prototype.removeQueryData=function(e,t){var n=this;return this.removeMatchingKeysForTargetId(e,t.targetId).next(function(){return targetsStore(e).delete(t.targetId)}).next(function(){return n.retrieveMetadata(e)}).next(function(t){return assert(t.targetCount>0,"Removing from an empty query cache"),t.targetCount-=1,n.saveMetadata(e,t)})},IndexedDbQueryCache.prototype.removeTargets=function(e,t,n){var r=this,i=0,o=[];return targetsStore(e).iterate(function(a,s){var u=r.serializer.fromDbTarget(s);u.sequenceNumber<=t&&void 0===n[u.targetId]&&(i++,o.push(r.removeQueryData(e,u)))}).next(function(){return _t.waitFor(o)}).next(function(){return i})},IndexedDbQueryCache.prototype.forEachTarget=function(e,t){var n=this;return targetsStore(e).iterate(function(e,r){var i=n.serializer.fromDbTarget(r);t(i)})},IndexedDbQueryCache.prototype.retrieveMetadata=function(e){return retrieveMetadata(e.simpleDbTransaction)},IndexedDbQueryCache.prototype.saveMetadata=function(e,t){return globalTargetStore(e).put(Yt.key,t)},IndexedDbQueryCache.prototype.saveQueryData=function(e,t){return targetsStore(e).put(this.serializer.toDbTarget(t))},IndexedDbQueryCache.prototype.updateMetadataFromQueryData=function(e,t){var n=!1;return e.targetId>t.highestTargetId&&(t.highestTargetId=e.targetId,n=!0),e.sequenceNumber>t.highestListenSequenceNumber&&(t.highestListenSequenceNumber=e.sequenceNumber,n=!0),n},IndexedDbQueryCache.prototype.getQueryCount=function(e){return this.retrieveMetadata(e).next(function(e){return e.targetCount})},IndexedDbQueryCache.prototype.getQueryData=function(e,t){var n=this,r=t.canonicalId(),i=IDBKeyRange.bound([r,Number.NEGATIVE_INFINITY],[r,Number.POSITIVE_INFINITY]),o=null;return targetsStore(e).iterate({range:i,index:Jt.queryTargetsIndexName},function(e,r,i){var a=n.serializer.fromDbTarget(r);t.isEqual(a.query)&&(o=a,i.done())}).next(function(){return o})},IndexedDbQueryCache.prototype.addMatchingKeys=function(e,t,n){var r=this,i=[],o=documentTargetStore(e);return t.forEach(function(t){var a=encode(t.path);i.push(o.put(new Xt(n,a))),i.push(r.referenceDelegate.addReference(e,t))}),_t.waitFor(i)},IndexedDbQueryCache.prototype.removeMatchingKeys=function(e,t,n){var r=this,i=documentTargetStore(e);return _t.forEach(t,function(t){var o=encode(t.path);return _t.waitFor([i.delete([n,o]),r.referenceDelegate.removeReference(e,t)])})},IndexedDbQueryCache.prototype.removeMatchingKeysForTargetId=function(e,t){var n=documentTargetStore(e),r=IDBKeyRange.bound([t],[t+1],!1,!0);return n.delete(r)},IndexedDbQueryCache.prototype.getMatchingKeysForTargetId=function(e,t){var n=IDBKeyRange.bound([t],[t+1],!1,!0),r=documentTargetStore(e),i=documentKeySet();return r.iterate({range:n,keysOnly:!0},function(e,t,n){var r=decode$1(e[1]),o=new C(r);i=i.add(o)}).next(function(){return i})},IndexedDbQueryCache.prototype.containsKey=function(e,t){var n=encode(t.path),r=IDBKeyRange.bound([n],[immediateSuccessor(n)],!1,!0),i=0;return documentTargetStore(e).iterate({index:Xt.documentTargetsIndex,keysOnly:!0,range:r},function(e,t,n){var r=e[0];e[1];0!==r&&(i++,n.done())}).next(function(){return i>0})},IndexedDbQueryCache.prototype.getQueryDataForTarget=function(e,t){var n=this;return targetsStore(e).get(t).next(function(e){return e?n.serializer.fromDbTarget(e):null})},IndexedDbQueryCache}(),Ot=function(){function ObjectMap(e){this.mapKeyFn=e,this.inner={}}return ObjectMap.prototype.get=function(e){var t=this.mapKeyFn(e),n=this.inner[t];if(void 0!==n)for(var r=0,i=n;r<i.length;r++){var o=i[r],a=o[0],s=o[1];if(a.isEqual(e))return s}},ObjectMap.prototype.has=function(e){return void 0!==this.get(e)},ObjectMap.prototype.set=function(e,t){var n=this.mapKeyFn(e),r=this.inner[n];if(void 0===r)return void(this.inner[n]=[[e,t]]);for(var i=0;i<r.length;i++)if(r[i][0].isEqual(e))return void(r[i]=[e,t]);r.push([e,t])},ObjectMap.prototype.delete=function(e){var t=this.mapKeyFn(e),n=this.inner[t];if(void 0===n)return!1;for(var r=0;r<n.length;r++)if(n[r][0].isEqual(e))return 1===n.length?delete this.inner[t]:n.splice(r,1),!0;return!1},ObjectMap.prototype.forEach=function(e){forEach(this.inner,function(t,n){for(var r=0,i=n;r<i.length;r++){var o=i[r],a=o[0],s=o[1];e(a,s)}})},ObjectMap.prototype.isEmpty=function(){return isEmpty(this.inner)},ObjectMap}(),kt=function(){function RemoteDocumentChangeBuffer(){this.changes=maybeDocumentMap(),this.documentSizes=new Ot(function(e){return e.toString()})}return RemoteDocumentChangeBuffer.prototype.addEntry=function(e){var t=this.assertChanges();this.changes=t.insert(e.key,e)},RemoteDocumentChangeBuffer.prototype.getEntry=function(e,t){var n=this,r=this.assertChanges(),i=r.get(t);return i?_t.resolve(i):this.getFromCache(e,t).next(function(e){return null===e?(n.documentSizes.set(t,0),null):(n.documentSizes.set(t,e.size),e.maybeDocument)})},RemoteDocumentChangeBuffer.prototype.apply=function(e){var t=this.applyChanges(e);return this.changes=null,t},RemoteDocumentChangeBuffer.prototype.assertChanges=function(){return assert(null!==this.changes,"Changes have already been applied."),this.changes},RemoteDocumentChangeBuffer}(),Lt="The remote document changelog no longer contains all changes for all local query views. It may be necessary to rebuild these views.",xt=function(){function IndexedDbRemoteDocumentCache(e,t){this.serializer=e,this.keepDocumentChangeLog=t,this._lastProcessedDocumentChangeId=0}return Object.defineProperty(IndexedDbRemoteDocumentCache.prototype,"lastProcessedDocumentChangeId",{get:function(){return this._lastProcessedDocumentChangeId},enumerable:!0,configurable:!0}),IndexedDbRemoteDocumentCache.prototype.start=function(e){var t=At.getStore(e,$t.store);return this.synchronizeLastDocumentChangeId(t)},IndexedDbRemoteDocumentCache.prototype.addEntries=function(e,t,n){var r=[];if(t.length>0){for(var i=remoteDocumentsStore(e),o=documentKeySet(),a=0,s=t;a<s.length;a++){var u=s[a],c=u.key,h=u.doc;r.push(i.put(dbKey(c),h)),o=o.add(c)}this.keepDocumentChangeLog&&r.push(documentChangesStore(e).put({changes:this.serializer.toDbResourcePaths(o)})),r.push(this.updateSize(e,n))}return _t.waitFor(r)},IndexedDbRemoteDocumentCache.prototype.removeEntry=function(e,t){var n=remoteDocumentsStore(e),r=dbKey(t);return n.get(r).next(function(e){return e?n.delete(r).next(function(){return dbDocumentSize(e)}):_t.resolve(0)})},IndexedDbRemoteDocumentCache.prototype.getEntry=function(e,t){var n=this;return remoteDocumentsStore(e).get(dbKey(t)).next(function(e){return e?n.serializer.fromDbRemoteDocument(e):null})},IndexedDbRemoteDocumentCache.prototype.getSizedEntry=function(e,t){var n=this;return remoteDocumentsStore(e).get(dbKey(t)).next(function(e){return e?{maybeDocument:n.serializer.fromDbRemoteDocument(e),size:dbDocumentSize(e)}:null})},IndexedDbRemoteDocumentCache.prototype.getDocumentsMatchingQuery=function(e,t){var n=this,r=documentMap(),i=t.path.toArray(),o=IDBKeyRange.lowerBound(i);return remoteDocumentsStore(e).iterate({range:o},function(e,i,o){var a=n.serializer.fromDbRemoteDocument(i);t.path.isPrefixOf(a.key.path)?a instanceof _&&t.matches(a)&&(r=r.insert(a.key,a)):o.done()}).next(function(){return r})},IndexedDbRemoteDocumentCache.prototype.getNewDocumentChanges=function(e){var t=this;assert(this.keepDocumentChangeLog,"Can only call getNewDocumentChanges() when document change log is enabled");var n=documentKeySet(),r=maybeDocumentMap(),i=IDBKeyRange.lowerBound(this._lastProcessedDocumentChangeId+1),o=!0,a=documentChangesStore(e);return a.iterate({range:i},function(e,r){if(o&&(o=!1,t._lastProcessedDocumentChangeId+1!==r.id))return t.synchronizeLastDocumentChangeId(a).next(function(){return _t.reject(new f(l.DATA_LOSS,Lt))});n=n.unionWith(t.serializer.fromDbResourcePaths(r.changes)),t._lastProcessedDocumentChangeId=r.id}).next(function(){var i=[];return n.forEach(function(n){i.push(t.getEntry(e,n).next(function(e){var t=e||new A(n,de.forDeletedDoc());r=r.insert(n,t)}))}),_t.waitFor(i)}).next(function(){return r})},IndexedDbRemoteDocumentCache.prototype.removeDocumentChangesThroughChangeId=function(e,t){var n=IDBKeyRange.upperBound(t);return documentChangesStore(e).delete(n)},IndexedDbRemoteDocumentCache.prototype.synchronizeLastDocumentChangeId=function(e){var t=this;return this._lastProcessedDocumentChangeId=0,e.iterate({keysOnly:!0,reverse:!0},function(e,n,r){t._lastProcessedDocumentChangeId=e,r.done()})},IndexedDbRemoteDocumentCache.prototype.newChangeBuffer=function(){return new Ft(this)},IndexedDbRemoteDocumentCache.prototype.getSize=function(e){return this.getMetadata(e).next(function(e){return e.byteSize})},IndexedDbRemoteDocumentCache.prototype.getMetadata=function(e){return documentGlobalStore(e).get(Ht.key).next(function(e){return assert(!!e,"Missing document cache metadata"),e})},IndexedDbRemoteDocumentCache.prototype.setMetadata=function(e,t){return documentGlobalStore(e).put(Ht.key,t)},IndexedDbRemoteDocumentCache.prototype.updateSize=function(e,t){var n=this;return this.getMetadata(e).next(function(r){return r.byteSize+=t,n.setMetadata(e,r)})},IndexedDbRemoteDocumentCache}(),Ft=function(e){function IndexedDbRemoteDocumentChangeBuffer(t){var n=e.call(this)||this;return n.documentCache=t,n}return a.__extends(IndexedDbRemoteDocumentChangeBuffer,e),IndexedDbRemoteDocumentChangeBuffer.prototype.applyChanges=function(e){var t=this,n=this.assertChanges(),r=0,i=[];return n.forEach(function(e,n){var o=t.documentCache.serializer.toDbRemoteDocument(n),a=t.documentSizes.get(e);assert(void 0!==a,"Attempting to change document "+e.toString()+" without having read it first");var s=dbDocumentSize(o);r+=s-a,i.push({key:e,doc:o})}),this.documentCache.addEntries(e,i,r)},IndexedDbRemoteDocumentChangeBuffer.prototype.getFromCache=function(e,t){return this.documentCache.getSizedEntry(e,t)},IndexedDbRemoteDocumentChangeBuffer}(kt),Vt=7,Bt=function(){function SchemaConverter(e){this.serializer=e}return SchemaConverter.prototype.createOrUpgrade=function(e,t,n,r){var i=this;assert(n<r&&n>=0&&r<=Vt,"Unexpected schema upgrade from v"+n+" to v{toVersion}."),n<1&&r>=1&&(createPrimaryClientStore(e),createMutationQueue(e),createQueryCache(e),createRemoteDocumentCache(e));var o=_t.resolve();return n<3&&r>=3&&(0!==n&&(dropQueryCache(e),createQueryCache(e)),o=o.next(function(){return writeEmptyTargetGlobalEntry(t)})),n<4&&r>=4&&(0!==n&&(o=o.next(function(){return upgradeMutationBatchSchemaAndMigrateData(e,t)})),o=o.next(function(){createClientMetadataStore(e),createRemoteDocumentChangesStore(e)})),n<5&&r>=5&&(o=o.next(function(){return i.removeAcknowledgedMutations(t)})),n<6&&r>=6&&(o=o.next(function(){return createDocumentGlobalStore(e),i.addDocumentGlobal(t)})),n<7&&r>=7&&(o=o.next(function(){return i.ensureSequenceNumbers(t)})),o},SchemaConverter.prototype.addDocumentGlobal=function(e){var t=0;return e.store(Gt.store).iterate(function(e,n){t+=dbDocumentSize(n)}).next(function(){var n=new Ht(t);return e.store(Ht.store).put(Ht.key,n)})},SchemaConverter.prototype.removeAcknowledgedMutations=function(e){var t=this,n=e.store(Qt.store),r=e.store(jt.store);return n.loadAll().next(function(n){return _t.forEach(n,function(n){var i=IDBKeyRange.bound([n.userId,wt],[n.userId,n.lastAcknowledgedBatchId]);return r.loadAll(jt.userMutationsIndex,i).next(function(r){return _t.forEach(r,function(r){assert(r.userId===n.userId,"Cannot process batch "+r.batchId+" from unexpected user");var i=t.serializer.fromDbMutationBatch(r);return removeMutationBatch(e,n.userId,i).next(function(){})})})})})},SchemaConverter.prototype.ensureSequenceNumbers=function(e){var t=e.store(Xt.store),n=e.store(Gt.store);return getHighestListenSequenceNumber(e).next(function(e){var r=function(n){return t.put(new Xt(0,encode(n),e))},i=[];return n.iterate(function(e,n){var o=new T(e),a=sentinelKey(o);i.push(t.get(a).next(function(e){return e?_t.resolve():r(o)}))}).next(function(){return _t.waitFor(i)})})},SchemaConverter}(),qt=function(){function DbTimestamp(e,t){this.seconds=e,this.nanoseconds=t}return DbTimestamp}(),Ut=function(){function DbPrimaryClient(e,t,n){this.ownerId=e,this.allowTabSynchronization=t,this.leaseTimestampMs=n}return DbPrimaryClient.store="owner",DbPrimaryClient.key="owner",DbPrimaryClient}(),Qt=function(){function DbMutationQueue(e,t,n){this.userId=e,this.lastAcknowledgedBatchId=t,this.lastStreamToken=n}return DbMutationQueue.store="mutationQueues",DbMutationQueue.keyPath="userId",DbMutationQueue}(),jt=function(){function DbMutationBatch(e,t,n,r){this.userId=e,this.batchId=t,this.localWriteTimeMs=n,this.mutations=r}return DbMutationBatch.store="mutations",DbMutationBatch.keyPath="batchId",DbMutationBatch.userMutationsIndex="userMutationsIndex",DbMutationBatch.userMutationsKeyPath=["userId","batchId"],DbMutationBatch}(),Wt=function(){function DbDocumentMutation(){}return DbDocumentMutation.prefixForUser=function(e){return[e]},DbDocumentMutation.prefixForPath=function(e,t){return[e,encode(t)]},DbDocumentMutation.key=function(e,t,n){return[e,encode(t),n]},DbDocumentMutation.store="documentMutations",DbDocumentMutation.PLACEHOLDER=new DbDocumentMutation,DbDocumentMutation}(),Kt=function(){function DbNoDocument(e,t){this.path=e,this.readTime=t}return DbNoDocument}(),zt=function(){function DbUnknownDocument(e,t){this.path=e,this.version=t}return DbUnknownDocument}(),Gt=function(){function DbRemoteDocument(e,t,n,r){this.unknownDocument=e,this.noDocument=t,this.document=n,this.hasCommittedMutations=r}return DbRemoteDocument.store="remoteDocuments",DbRemoteDocument}(),Ht=function(){function DbRemoteDocumentGlobal(e){this.byteSize=e}return DbRemoteDocumentGlobal.store="remoteDocumentGlobal",DbRemoteDocumentGlobal.key="remoteDocumentGlobalKey",DbRemoteDocumentGlobal}(),Jt=function(){function DbTarget(e,t,n,r,i,o){this.targetId=e,this.canonicalId=t,this.readTime=n,this.resumeToken=r,this.lastListenSequenceNumber=i,this.query=o}return DbTarget.store="targets",DbTarget.keyPath="targetId",DbTarget.queryTargetsIndexName="queryTargetsIndex",DbTarget.queryTargetsKeyPath=["canonicalId","targetId"],DbTarget}(),Xt=function(){function DbTargetDocument(e,t,n){this.targetId=e,this.path=t,this.sequenceNumber=n,assert(0===e==(void 0!==n),"A target-document row must either have targetId == 0 and a defined sequence number, or a non-zero targetId and no sequence number")}return DbTargetDocument.store="targetDocuments",DbTargetDocument.keyPath=["targetId","path"],DbTargetDocument.documentTargetsIndex="documentTargetsIndex",DbTargetDocument.documentTargetsKeyPath=["path","targetId"],DbTargetDocument}(),Yt=function(){function DbTargetGlobal(e,t,n,r){this.highestTargetId=e,this.highestListenSequenceNumber=t,this.lastRemoteSnapshotVersion=n,this.targetCount=r}return DbTargetGlobal.key="targetGlobalKey",DbTargetGlobal.store="targetGlobal",DbTargetGlobal}(),$t=function(){function DbRemoteDocumentChanges(e){this.changes=e}return DbRemoteDocumentChanges.store="remoteDocumentChanges",DbRemoteDocumentChanges.keyPath="id",DbRemoteDocumentChanges}(),Zt=function(){function DbClientMetadata(e,t,n,r,i){this.clientId=e,this.updateTimeMs=t,this.networkEnabled=n,this.inForeground=r,this.lastProcessedDocumentChangeId=i}return DbClientMetadata.store="clientMetadata",DbClientMetadata.keyPath="clientId",DbClientMetadata}(),en=[Qt.store,jt.store,Wt.store,Gt.store,Jt.store,Ut.store,Yt.store,Xt.store],tn=en,nn=tn.concat([Zt.store,$t.store]),rn=nn.concat([Ht.store]),on=rn,an=function(){function IndexedDbMutationQueue(e,t,n){this.userId=e,this.serializer=t,this.referenceDelegate=n,this.documentKeysByBatchId={}}return IndexedDbMutationQueue.forUser=function(e,t,n){return assert(""!==e.uid,"UserID must not be an empty string."),new IndexedDbMutationQueue(e.isAuthenticated()?e.uid:"",t,n)},IndexedDbMutationQueue.prototype.checkEmpty=function(e){var t=!0,n=IDBKeyRange.bound([this.userId,Number.NEGATIVE_INFINITY],[this.userId,Number.POSITIVE_INFINITY]);return mutationsStore(e).iterate({index:jt.userMutationsIndex,range:n},function(e,n,r){t=!1,r.done()}).next(function(){return t})},IndexedDbMutationQueue.prototype.acknowledgeBatch=function(e,t,n){return this.getMutationQueueMetadata(e).next(function(r){var i=t.batchId;return assert(i>r.lastAcknowledgedBatchId,"Mutation batchIDs must be acknowledged in order"),r.lastAcknowledgedBatchId=i,r.lastStreamToken=convertStreamToken(n),mutationQueuesStore(e).put(r)})},IndexedDbMutationQueue.prototype.getLastStreamToken=function(e){return this.getMutationQueueMetadata(e).next(function(e){return e.lastStreamToken})},IndexedDbMutationQueue.prototype.setLastStreamToken=function(e,t){return this.getMutationQueueMetadata(e).next(function(n){return n.lastStreamToken=convertStreamToken(t),mutationQueuesStore(e).put(n)})},IndexedDbMutationQueue.prototype.addMutationBatch=function(e,t,n){var r=this,i=documentMutationsStore(e),o=mutationsStore(e);return o.add({}).next(function(e){assert("number"==typeof e,"Auto-generated key is not a number");var a=new Tt(e,t,n),s=r.serializer.toDbMutationBatch(r.userId,a);r.documentKeysByBatchId[e]=a.keys();for(var u=[],c=0,h=n;c<h.length;c++){var l=h[c],f=Wt.key(r.userId,l.key.path,e);u.push(o.put(s)),u.push(i.put(f,Wt.PLACEHOLDER))}return _t.waitFor(u).next(function(){return a})})},IndexedDbMutationQueue.prototype.lookupMutationBatch=function(e,t){var n=this;return mutationsStore(e).get(t).next(function(e){return e?(assert(e.userId===n.userId,"Unexpected user '"+e.userId+"' for mutation batch "+t),n.serializer.fromDbMutationBatch(e)):null})},IndexedDbMutationQueue.prototype.lookupMutationKeys=function(e,t){var n=this;return this.documentKeysByBatchId[t]?_t.resolve(this.documentKeysByBatchId[t]):this.lookupMutationBatch(e,t).next(function(e){if(e){var r=e.keys();return n.documentKeysByBatchId[t]=r,r}return null})},IndexedDbMutationQueue.prototype.getNextMutationBatchAfterBatchId=function(e,t){var n=this;return this.getMutationQueueMetadata(e).next(function(r){var i=Math.max(t,r.lastAcknowledgedBatchId)+1,o=IDBKeyRange.lowerBound([n.userId,i]),a=null;return mutationsStore(e).iterate({index:jt.userMutationsIndex,range:o},function(e,t,r){t.userId===n.userId&&(assert(t.batchId>=i,"Should have found mutation after "+i),a=n.serializer.fromDbMutationBatch(t)),r.done()}).next(function(){return a})})},IndexedDbMutationQueue.prototype.getAllMutationBatches=function(e){var t=this,n=IDBKeyRange.bound([this.userId,wt],[this.userId,Number.POSITIVE_INFINITY]);return mutationsStore(e).loadAll(jt.userMutationsIndex,n).next(function(e){return e.map(function(e){return t.serializer.fromDbMutationBatch(e)})})},IndexedDbMutationQueue.prototype.getAllMutationBatchesAffectingDocumentKey=function(e,t){var n=this,r=Wt.prefixForPath(this.userId,t.path),i=IDBKeyRange.lowerBound(r),o=[];return documentMutationsStore(e).iterate({range:i},function(r,i,a){var s=r[0],u=r[1],c=r[2],h=decode$1(u);return s===n.userId&&t.path.isEqual(h)?mutationsStore(e).get(c).next(function(e){if(!e)throw fail("Dangling document-mutation reference found: "+r+" which points to "+c);assert(e.userId===n.userId,"Unexpected user '"+e.userId+"' for mutation batch "+c),o.push(n.serializer.fromDbMutationBatch(e))}):void a.done()}).next(function(){return o})},IndexedDbMutationQueue.prototype.getAllMutationBatchesAffectingDocumentKeys=function(e,t){var n=this,r=new Re(primitiveComparator),i=[];return t.forEach(function(t){var o=Wt.prefixForPath(n.userId,t.path),a=IDBKeyRange.lowerBound(o),s=documentMutationsStore(e).iterate({range:a},function(e,i,o){var a=e[0],s=e[1],u=e[2],c=decode$1(s);if(a!==n.userId||!t.path.isEqual(c))return void o.done();r=r.add(u)});i.push(s)}),_t.waitFor(i).next(function(){return n.lookupMutationBatches(e,r)})},IndexedDbMutationQueue.prototype.getAllMutationBatchesAffectingQuery=function(e,t){var n=this;assert(!t.isDocumentQuery(),"Document queries shouldn't go down this path");var r=t.path,i=r.length+1,o=Wt.prefixForPath(this.userId,r),a=IDBKeyRange.lowerBound(o),s=new Re(primitiveComparator);return documentMutationsStore(e).iterate({range:a},function(e,t,o){var a=e[0],u=e[1],c=e[2],h=decode$1(u);if(a!==n.userId||!r.isPrefixOf(h))return void o.done();h.length===i&&(s=s.add(c))}).next(function(){return n.lookupMutationBatches(e,s)})},IndexedDbMutationQueue.prototype.lookupMutationBatches=function(e,t){var n=this,r=[],i=[];return t.forEach(function(t){i.push(mutationsStore(e).get(t).next(function(e){if(null===e)throw fail("Dangling document-mutation reference found, which points to "+t);assert(e.userId===n.userId,"Unexpected user '"+e.userId+"' for mutation batch "+t),r.push(n.serializer.fromDbMutationBatch(e))}))}),_t.waitFor(i).next(function(){return r})},IndexedDbMutationQueue.prototype.removeMutationBatch=function(e,t){var n=this;return removeMutationBatch(e.simpleDbTransaction,this.userId,t).next(function(r){return n.removeCachedMutationKeys(t.batchId),_t.forEach(r,function(t){return n.referenceDelegate.removeMutationReference(e,t)})})},IndexedDbMutationQueue.prototype.removeCachedMutationKeys=function(e){delete this.documentKeysByBatchId[e]},IndexedDbMutationQueue.prototype.performConsistencyCheck=function(e){var t=this;return this.checkEmpty(e).next(function(n){if(!n)return _t.resolve();var r=IDBKeyRange.lowerBound(Wt.prefixForUser(t.userId)),i=[];return documentMutationsStore(e).iterate({range:r},function(e,n,r){if(e[0]!==t.userId)return void r.done();var o=decode$1(e[1]);i.push(o)}).next(function(){assert(0===i.length,"Document leak -- detected dangling mutation references when queue is empty. Dangling keys: "+i.map(function(e){return e.canonicalString()}))})})},IndexedDbMutationQueue.prototype.containsKey=function(e,t){return mutationQueueContainsKey(e,this.userId,t)},IndexedDbMutationQueue.prototype.getMutationQueueMetadata=function(e){var t=this;return mutationQueuesStore(e).get(this.userId).next(function(e){return e||new Qt(t.userId,wt,"")})},IndexedDbMutationQueue}(),sn=function(){function LocalSerializer(e){this.remoteSerializer=e}return LocalSerializer.prototype.fromDbRemoteDocument=function(e){if(e.document)return this.remoteSerializer.fromDocument(e.document,!!e.hasCommittedMutations);if(e.noDocument){var t=C.fromSegments(e.noDocument.path),n=this.fromDbTimestamp(e.noDocument.readTime);return new A(t,n,{hasCommittedMutations:!!e.hasCommittedMutations})}if(e.unknownDocument){var t=C.fromSegments(e.unknownDocument.path),n=this.fromDbTimestamp(e.unknownDocument.version);return new P(t,n)}return fail("Unexpected DbRemoteDocument")},LocalSerializer.prototype.toDbRemoteDocument=function(e){if(e instanceof _){var t=this.remoteSerializer.toDocument(e),n=e.hasCommittedMutations;return new Gt(null,null,t,n)}if(e instanceof A){var r=e.key.path.toArray(),i=this.toDbTimestamp(e.version),n=e.hasCommittedMutations;return new Gt(null,new Kt(r,i),null,n)}if(e instanceof P){var r=e.key.path.toArray(),i=this.toDbTimestamp(e.version);return new Gt(new zt(r,i),null,null,!0)}return fail("Unexpected MaybeDocumment")},LocalSerializer.prototype.toDbTimestamp=function(e){var t=e.toTimestamp();return new qt(t.seconds,t.nanoseconds)},LocalSerializer.prototype.fromDbTimestamp=function(e){var t=new g(e.seconds,e.nanoseconds);return de.fromTimestamp(t)},LocalSerializer.prototype.toDbMutationBatch=function(e,t){var n=this,r=t.mutations.map(function(e){return n.remoteSerializer.toMutation(e)});return new jt(e,t.batchId,t.localWriteTime.toMillis(),r)},LocalSerializer.prototype.fromDbMutationBatch=function(e){var t=this,n=e.mutations.map(function(e){return t.remoteSerializer.fromMutation(e)}),r=g.fromMillis(e.localWriteTimeMs);return new Tt(e.batchId,r,n)},LocalSerializer.prototype.toDbResourcePaths=function(e){var t=[];return e.forEach(function(e){t.push(encode(e.path))}),t},LocalSerializer.prototype.fromDbResourcePaths=function(e){for(var t=documentKeySet(),n=0,r=e;n<r.length;n++){var i=r[n];t=t.add(new C(decode$1(i)))}return t},LocalSerializer.prototype.fromDbTarget=function(e){var t,n=this.fromDbTimestamp(e.readTime);return t=isDocumentQuery(e.query)?this.remoteSerializer.fromDocumentsTarget(e.query):this.remoteSerializer.fromQueryTarget(e.query),new me(t,e.targetId,x.Listen,e.lastListenSequenceNumber,n,e.resumeToken)},LocalSerializer.prototype.toDbTarget=function(e){assert(x.Listen===e.purpose,"Only queries with purpose "+x.Listen+" may be stored, got "+e.purpose);var t,n=this.toDbTimestamp(e.snapshotVersion);t=e.query.isDocumentQuery()?this.remoteSerializer.toDocumentsTarget(e.query):this.remoteSerializer.toQueryTarget(e.query);var r;return e.resumeToken instanceof Uint8Array?(assert("YES"===Object({NODE_ENV:"production"}).USE_MOCK_PERSISTENCE,"Persisting non-string stream tokens is only supported with mock persistence ."),r=e.resumeToken.toString()):r=e.resumeToken,new Jt(e.targetId,e.query.canonicalId(),n,r,e.sequenceNumber,t)},LocalSerializer}(),un=function(){function RollingSequenceNumberBuffer(e){this.maxElements=e,this.buffer=new Re(bufferEntryComparator),this.previousIndex=0}return RollingSequenceNumberBuffer.prototype.nextIndex=function(){return++this.previousIndex},RollingSequenceNumberBuffer.prototype.addElement=function(e){var t=[e,this.nextIndex()];if(this.buffer.size<this.maxElements)this.buffer=this.buffer.add(t);else{var n=this.buffer.last();bufferEntryComparator(t,n)<0&&(this.buffer=this.buffer.delete(n).add(t))}},Object.defineProperty(RollingSequenceNumberBuffer.prototype,"maxValue",{get:function(){return this.buffer.last()[0]},enumerable:!0,configurable:!0}),RollingSequenceNumberBuffer}(),cn=function(){function LruGarbageCollector(e){this.delegate=e}return LruGarbageCollector.prototype.calculateTargetCount=function(e,t){return this.delegate.getSequenceNumberCount(e).next(function(e){return Math.floor(t/100*e)})},LruGarbageCollector.prototype.nthSequenceNumber=function(e,t){var n=this;if(0===t)return _t.resolve(ft.INVALID);var r=new un(t);return this.delegate.forEachTarget(e,function(e){return r.addElement(e.sequenceNumber)}).next(function(){return n.delegate.forEachOrphanedDocumentSequenceNumber(e,function(e){return r.addElement(e)})}).next(function(){return r.maxValue})},LruGarbageCollector.prototype.removeTargets=function(e,t,n){return this.delegate.removeTargets(e,t,n)},LruGarbageCollector.prototype.removeOrphanedDocuments=function(e,t){return this.delegate.removeOrphanedDocuments(e,t)},LruGarbageCollector}(),hn=function(){function PersistenceTransaction(){}return PersistenceTransaction}(),ln="IndexedDbPersistence",fn="The current tab is not in the required state to perform this operation. It might be necessary to refresh the browser tab.",dn="Another tab has exclusive access to the persistence layer. To allow shared access, make sure to invoke `enablePersistence()` with `experimentalTabSynchronization:true` in all tabs.",pn="This platform is either missing IndexedDB or is known to have an incomplete implementation. Offline persistence has been disabled.",mn=function(e){function IndexedDbTransaction(t,n){var r=e.call(this)||this;return r.simpleDbTransaction=t,r.currentSequenceNumber=n,r}return a.__extends(IndexedDbTransaction,e),IndexedDbTransaction}(hn),yn=function(){function IndexedDbPersistence(e,t,n,r,i,o){if(this.persistenceKey=e,this.clientId=t,this.queue=r,this.multiClientParams=o,this._started=!1,this.isPrimary=!1,this.networkEnabled=!0,this.inForeground=!1,this.lastGarbageCollectionTime=Number.NEGATIVE_INFINITY,this.primaryStateListener=function(e){return Promise.resolve()},!IndexedDbPersistence.isAvailable())throw new f(l.UNIMPLEMENTED,pn);if(this.referenceDelegate=new gn(this),this.dbName=e+IndexedDbPersistence.MAIN_DATABASE,this.serializer=new sn(i),this.document=n.document,this.allowTabSynchronization=void 0!==o,this.queryCache=new Mt(this.referenceDelegate,this.serializer),this.remoteDocumentCache=new xt(this.serializer,this.allowTabSynchronization),!n.window||!n.window.localStorage)throw new f(l.UNIMPLEMENTED,"IndexedDB persistence is only available on platforms that support LocalStorage.");this.window=n.window,this.webStorage=this.window.localStorage}return IndexedDbPersistence.getStore=function(e,t){if(e instanceof mn)return At.getStore(e.simpleDbTransaction,t);throw fail("IndexedDbPersistence must use instances of IndexedDbTransaction")},IndexedDbPersistence.createIndexedDbPersistence=function(e,t,n,r,i){return a.__awaiter(this,void 0,void 0,function(){var o;return a.__generator(this,function(a){switch(a.label){case 0:return o=new IndexedDbPersistence(e,t,n,r,i),[4,o.start()];case 1:return a.sent(),[2,o]}})})},IndexedDbPersistence.createMultiClientIndexedDbPersistence=function(e,t,n,r,i,o){return a.__awaiter(this,void 0,void 0,function(){var s;return a.__generator(this,function(a){switch(a.label){case 0:return s=new IndexedDbPersistence(e,t,n,r,i,o),[4,s.start()];case 1:return a.sent(),[2,s]}})})},IndexedDbPersistence.prototype.start=function(){var e=this;return assert(!this.started,"IndexedDbPersistence double-started!"),assert(null!==this.window,"Expected 'window' to be defined"),At.openOrCreate(this.dbName,Vt,new Bt(this.serializer)).then(function(t){e.simpleDb=t}).then(function(){return e.startRemoteDocumentCache()}).then(function(){return e.attachVisibilityHandler(),e.attachWindowUnloadHook(),e.updateClientMetadataAndTryBecomePrimary().then(function(){return e.scheduleClientMetadataAndPrimaryLeaseRefreshes()})}).then(function(){return e.simpleDb.runTransaction("readonly",[Yt.store],function(t){return getHighestListenSequenceNumber(t).next(function(t){var n=e.multiClientParams?e.multiClientParams.sequenceNumberSyncer:void 0;e.listenSequence=new ft(t,n)})})}).then(function(){e._started=!0}).catch(function(t){return e.simpleDb&&e.simpleDb.close(),Promise.reject(t)})},IndexedDbPersistence.prototype.startRemoteDocumentCache=function(){var e=this;return this.simpleDb.runTransaction("readonly",on,function(t){return e.remoteDocumentCache.start(t)})},IndexedDbPersistence.prototype.setPrimaryStateListener=function(e){var t=this;return this.primaryStateListener=function(n){return a.__awaiter(t,void 0,void 0,function(){return a.__generator(this,function(t){return this.started?[2,e(n)]:[2]})})},e(this.isPrimary)},IndexedDbPersistence.prototype.setNetworkEnabled=function(e){var t=this;this.networkEnabled!==e&&(this.networkEnabled=e,this.queue.enqueueAndForget(function(){return a.__awaiter(t,void 0,void 0,function(){return a.__generator(this,function(e){switch(e.label){case 0:return this.started?[4,this.updateClientMetadataAndTryBecomePrimary()]:[3,2];case 1:e.sent(),e.label=2;case 2:return[2]}})})}))},IndexedDbPersistence.prototype.updateClientMetadataAndTryBecomePrimary=function(){var e=this;return this.simpleDb.runTransaction("readwrite",on,function(t){return clientMetadataStore(t).put(new Zt(e.clientId,Date.now(),e.networkEnabled,e.inForeground,e.remoteDocumentCache.lastProcessedDocumentChangeId)).next(function(){if(e.isPrimary)return e.verifyPrimaryLease(t).next(function(t){t||(e.isPrimary=!1,e.queue.enqueueAndForget(function(){return e.primaryStateListener(!1)}))})}).next(function(){return e.canActAsPrimary(t)}).next(function(n){var r=e.isPrimary;return e.isPrimary=n,r!==e.isPrimary&&e.queue.enqueueAndForget(function(){return e.primaryStateListener(e.isPrimary)}),r&&!e.isPrimary?e.releasePrimaryLeaseIfHeld(t):e.isPrimary?e.acquireOrExtendPrimaryLease(t):void 0})})},IndexedDbPersistence.prototype.verifyPrimaryLease=function(e){var t=this;return primaryClientStore(e).get(Ut.key).next(function(e){return _t.resolve(t.isLocalClient(e))})},IndexedDbPersistence.prototype.removeClientMetadata=function(e){return clientMetadataStore(e).delete(this.clientId)},IndexedDbPersistence.prototype.maybeGarbageCollectMultiClientState=function(){return a.__awaiter(this,void 0,void 0,function(){var e,t,n=this;return a.__generator(this,function(r){switch(r.label){case 0:return!this.isPrimary||this.isWithinAge(this.lastGarbageCollectionTime,18e5)?[3,2]:(this.lastGarbageCollectionTime=Date.now(),t=[],[4,this.runTransaction("maybeGarbageCollectMultiClientState","readwrite-primary",function(r){var i=IndexedDbPersistence.getStore(r,Zt.store);return i.loadAll().next(function(r){e=n.filterActiveClients(r,18e5),t=r.filter(function(t){return-1===e.indexOf(t)})}).next(function(){return _t.forEach(t,function(e){return i.delete(e.clientId)})}).next(function(){if(e=e.filter(function(e){return e.clientId!==n.clientId}),e.length>0){var t=e.map(function(e){return e.lastProcessedDocumentChangeId||0}),i=Math.min.apply(Math,t);return n.remoteDocumentCache.removeDocumentChangesThroughChangeId(r,i)}})})]);case 1:r.sent(),t.forEach(function(e){n.window.localStorage.removeItem(n.zombiedClientLocalStorageKey(e.clientId))}),r.label=2;case 2:return[2]}})})},IndexedDbPersistence.prototype.scheduleClientMetadataAndPrimaryLeaseRefreshes=function(){var e=this;this.clientMetadataRefresher=this.queue.enqueueAfterDelay(lt.ClientMetadataRefresh,4e3,function(){return e.updateClientMetadataAndTryBecomePrimary().then(function(){return e.maybeGarbageCollectMultiClientState()}).then(function(){return e.scheduleClientMetadataAndPrimaryLeaseRefreshes()})})},IndexedDbPersistence.prototype.isLocalClient=function(e){return!!e&&e.ownerId===this.clientId},IndexedDbPersistence.prototype.canActAsPrimary=function(e){var t=this;return primaryClientStore(e).get(Ut.key).next(function(n){if(null!==n&&t.isWithinAge(n.leaseTimestampMs,5e3)&&!t.isClientZombied(n.ownerId)){if(t.isLocalClient(n)&&t.networkEnabled)return!0;if(!t.isLocalClient(n)){if(!n.allowTabSynchronization)throw new f(l.FAILED_PRECONDITION,dn);return!1}}return!(!t.networkEnabled||!t.inForeground)||clientMetadataStore(e).loadAll().next(function(e){return void 0===t.filterActiveClients(e,5e3).find(function(e){if(t.clientId!==e.clientId){var n=!t.networkEnabled&&e.networkEnabled,r=!t.inForeground&&e.inForeground,i=t.networkEnabled===e.networkEnabled;if(n||r&&i)return!0}return!1})})}).next(function(e){return t.isPrimary!==e&&debug(ln,"Client "+(e?"is":"is not")+" eligible for a primary lease."),e})},IndexedDbPersistence.prototype.shutdown=function(e){return a.__awaiter(this,void 0,void 0,function(){var t=this;return a.__generator(this,function(n){switch(n.label){case 0:return this._started=!1,this.markClientZombied(),this.clientMetadataRefresher&&this.clientMetadataRefresher.cancel(),this.detachVisibilityHandler(),this.detachWindowUnloadHook(),[4,this.simpleDb.runTransaction("readwrite",[Ut.store,Zt.store],function(e){return t.releasePrimaryLeaseIfHeld(e).next(function(){return t.removeClientMetadata(e)})})];case 1:return n.sent(),this.simpleDb.close(),this.removeClientZombiedEntry(),e?[4,At.delete(this.dbName)]:[3,3];case 2:n.sent(),n.label=3;case 3:return[2]}})})},IndexedDbPersistence.prototype.filterActiveClients=function(e,t){var n=this;return e.filter(function(e){return n.isWithinAge(e.updateTimeMs,t)&&!n.isClientZombied(e.clientId)})},IndexedDbPersistence.prototype.getActiveClients=function(){var e=this;return this.simpleDb.runTransaction("readonly",[Zt.store],function(t){return clientMetadataStore(t).loadAll().next(function(t){return e.filterActiveClients(t,18e5).map(function(e){return e.clientId})})})},Object.defineProperty(IndexedDbPersistence.prototype,"started",{get:function(){return this._started},enumerable:!0,configurable:!0}),IndexedDbPersistence.prototype.getMutationQueue=function(e){return assert(this.started,"Cannot initialize MutationQueue before persistence is started."),an.forUser(e,this.serializer,this.referenceDelegate)},IndexedDbPersistence.prototype.getQueryCache=function(){return assert(this.started,"Cannot initialize QueryCache before persistence is started."),this.queryCache},IndexedDbPersistence.prototype.getRemoteDocumentCache=function(){return assert(this.started,"Cannot initialize RemoteDocumentCache before persistence is started."),this.remoteDocumentCache},IndexedDbPersistence.prototype.runTransaction=function(e,t,n){var r=this;return debug(ln,"Starting transaction:",e),this.simpleDb.runTransaction("readonly"===t?"readonly":"readwrite",on,function(i){return"readwrite-primary"===t?r.verifyPrimaryLease(i).next(function(t){if(!t)throw error("Failed to obtain primary lease for action '"+e+"'."),r.isPrimary=!1,r.queue.enqueueAndForget(function(){return r.primaryStateListener(!1)}),new f(l.FAILED_PRECONDITION,fn);return n(new mn(i,r.listenSequence.next()))}).next(function(e){return r.acquireOrExtendPrimaryLease(i).next(function(){return e})}):r.verifyAllowTabSynchronization(i).next(function(){return n(new mn(i,r.listenSequence.next()))})})},IndexedDbPersistence.prototype.verifyAllowTabSynchronization=function(e){var t=this;return primaryClientStore(e).get(Ut.key).next(function(e){if(null!==e&&t.isWithinAge(e.leaseTimestampMs,5e3)&&!t.isClientZombied(e.ownerId)&&!t.isLocalClient(e)&&!e.allowTabSynchronization)throw new f(l.FAILED_PRECONDITION,dn)})},IndexedDbPersistence.prototype.acquireOrExtendPrimaryLease=function(e){var t=new Ut(this.clientId,this.allowTabSynchronization,Date.now());return primaryClientStore(e).put(Ut.key,t)},IndexedDbPersistence.isAvailable=function(){return At.isAvailable()},IndexedDbPersistence.buildStoragePrefix=function(e){var t=e.databaseId.projectId;return e.databaseId.isDefaultDatabase||(t+="."+e.databaseId.database),"firestore/"+e.persistenceKey+"/"+t+"/"},IndexedDbPersistence.prototype.releasePrimaryLeaseIfHeld=function(e){var t=this,n=primaryClientStore(e);return n.get(Ut.key).next(function(e){return t.isLocalClient(e)?(debug(ln,"Releasing primary lease."),n.delete(Ut.key)):_t.resolve()})},IndexedDbPersistence.prototype.isWithinAge=function(e,t){var n=Date.now(),r=n-t,i=n;return!(e<r)&&(!(e>i)||(error("Detected an update time that is in the future: "+e+" > "+i),!1))},IndexedDbPersistence.prototype.attachVisibilityHandler=function(){var e=this;null!==this.document&&"function"==typeof this.document.addEventListener&&(this.documentVisibilityHandler=function(){e.queue.enqueueAndForget(function(){return e.inForeground="visible"===e.document.visibilityState,e.updateClientMetadataAndTryBecomePrimary()})},this.document.addEventListener("visibilitychange",this.documentVisibilityHandler),this.inForeground="visible"===this.document.visibilityState)},IndexedDbPersistence.prototype.detachVisibilityHandler=function(){this.documentVisibilityHandler&&(assert(null!==this.document&&"function"==typeof this.document.addEventListener,"Expected 'document.addEventListener' to be a function"),this.document.removeEventListener("visibilitychange",this.documentVisibilityHandler),this.documentVisibilityHandler=null)},IndexedDbPersistence.prototype.attachWindowUnloadHook=function(){var e=this;"function"==typeof this.window.addEventListener&&(this.windowUnloadHandler=function(){e.markClientZombied(),e.queue.enqueueAndForget(function(){return e.shutdown()})},this.window.addEventListener("unload",this.windowUnloadHandler))},IndexedDbPersistence.prototype.detachWindowUnloadHook=function(){this.windowUnloadHandler&&(assert("function"==typeof this.window.removeEventListener,"Expected 'window.removeEventListener' to be a function"),this.window.removeEventListener("unload",this.windowUnloadHandler),this.windowUnloadHandler=null)},IndexedDbPersistence.prototype.isClientZombied=function(e){try{var t=null!==this.webStorage.getItem(this.zombiedClientLocalStorageKey(e));return debug(ln,"Client '"+e+"' "+(t?"is":"is not")+" zombied in LocalStorage"),t}catch(e){return error(ln,"Failed to get zombied client id.",e),!1}},IndexedDbPersistence.prototype.markClientZombied=function(){try{this.webStorage.setItem(this.zombiedClientLocalStorageKey(this.clientId),String(Date.now()))}catch(e){error("Failed to set zombie client id.",e)}},IndexedDbPersistence.prototype.removeClientZombiedEntry=function(){try{this.webStorage.removeItem(this.zombiedClientLocalStorageKey(this.clientId))}catch(e){}},IndexedDbPersistence.prototype.zombiedClientLocalStorageKey=function(e){return"firestore_zombie_"+this.persistenceKey+"_"+e},IndexedDbPersistence.MAIN_DATABASE="main",IndexedDbPersistence}(),gn=function(){function IndexedDbLruDelegate(e){this.db=e,this.garbageCollector=new cn(this)}return IndexedDbLruDelegate.prototype.getSequenceNumberCount=function(e){var t=this.orphanedDocmentCount(e);return this.db.getQueryCache().getQueryCount(e).next(function(e){return t.next(function(t){return e+t})})},IndexedDbLruDelegate.prototype.orphanedDocmentCount=function(e){var t=0;return this.forEachOrphanedDocumentSequenceNumber(e,function(e){t++}).next(function(){return t})},IndexedDbLruDelegate.prototype.forEachTarget=function(e,t){return this.db.getQueryCache().forEachTarget(e,t)},IndexedDbLruDelegate.prototype.forEachOrphanedDocumentSequenceNumber=function(e,t){return this.forEachOrphanedDocument(e,function(e,n){return t(n)})},IndexedDbLruDelegate.prototype.setInMemoryPins=function(e){this.inMemoryPins=e},IndexedDbLruDelegate.prototype.addReference=function(e,t){return writeSentinelKey(e,t)},IndexedDbLruDelegate.prototype.removeReference=function(e,t){return writeSentinelKey(e,t)},IndexedDbLruDelegate.prototype.removeTargets=function(e,t,n){return this.db.getQueryCache().removeTargets(e,t,n)},IndexedDbLruDelegate.prototype.removeMutationReference=function(e,t){return writeSentinelKey(e,t)},IndexedDbLruDelegate.prototype.isPinned=function(e,t){return this.inMemoryPins.containsKey(t)?_t.resolve(!0):mutationQueuesContainKey(e,t)},IndexedDbLruDelegate.prototype.removeOrphanedDocuments=function(e,t){var n=this,r=0,i=0,o=[];return this.forEachOrphanedDocument(e,function(a,s){if(s<=t){var u=n.isPinned(e,a).next(function(t){if(!t)return r++,n.removeOrphanedDocument(e,a).next(function(e){i+=e})});o.push(u)}}).next(function(){return _t.waitFor(o)}).next(function(){return n.db.getRemoteDocumentCache().updateSize(e,-i)}).next(function(){return r})},IndexedDbLruDelegate.prototype.removeOrphanedDocument=function(e,t){var n=0,r=this.db.getRemoteDocumentCache();return _t.waitFor([documentTargetStore(e).delete(sentinelKey$1(t)),r.removeEntry(e,t).next(function(e){n+=e})]).next(function(){return n})},IndexedDbLruDelegate.prototype.removeTarget=function(e,t){var n=t.copy({sequenceNumber:e.currentSequenceNumber});return this.db.getQueryCache().updateQueryData(e,n)},IndexedDbLruDelegate.prototype.updateLimboDocument=function(e,t){return writeSentinelKey(e,t)},IndexedDbLruDelegate.prototype.forEachOrphanedDocument=function(e,t){var n,r=documentTargetStore(e),i=ft.INVALID;return r.iterate({index:Xt.documentTargetsIndex},function(e,r){var o=e[0],a=(e[1],r.path),s=r.sequenceNumber;0===o?(i!==ft.INVALID&&t(new C(decode$1(n)),i),i=s,n=a):i=ft.INVALID}).next(function(){i!==ft.INVALID&&t(new C(decode$1(n)),i)})},IndexedDbLruDelegate}(),vn=function(){function LocalDocumentsView(e,t){this.remoteDocumentCache=e,this.mutationQueue=t}return LocalDocumentsView.prototype.getDocument=function(e,t){var n=this;return this.mutationQueue.getAllMutationBatchesAffectingDocumentKey(e,t).next(function(r){return n.getDocumentInternal(e,t,r)})},LocalDocumentsView.prototype.getDocumentInternal=function(e,t,n){return this.remoteDocumentCache.getEntry(e,t).next(function(e){for(var r=0,i=n;r<i.length;r++){e=i[r].applyToLocalView(t,e)}return e})},LocalDocumentsView.prototype.getDocuments=function(e,t){var n=this;return this.mutationQueue.getAllMutationBatchesAffectingDocumentKeys(e,t).next(function(r){var i=[],o=maybeDocumentMap();return t.forEach(function(t){i.push(n.getDocumentInternal(e,t,r).next(function(e){e||(e=new A(t,de.forDeletedDoc())),o=o.insert(t,e)}))}),_t.waitFor(i).next(function(){return o})})},LocalDocumentsView.prototype.getDocumentsMatchingQuery=function(e,t){return C.isDocumentKey(t.path)?this.getDocumentsMatchingDocumentQuery(e,t.path):this.getDocumentsMatchingCollectionQuery(e,t)},LocalDocumentsView.prototype.getDocumentsMatchingDocumentQuery=function(e,t){return this.getDocument(e,new C(t)).next(function(e){var t=documentMap();return e instanceof _&&(t=t.insert(e.key,e)),t})},LocalDocumentsView.prototype.getDocumentsMatchingCollectionQuery=function(e,t){var n,r=this;return this.remoteDocumentCache.getDocumentsMatchingQuery(e,t).next(function(i){return n=i,r.mutationQueue.getAllMutationBatchesAffectingQuery(e,t)}).next(function(e){for(var r=0,i=e;r<i.length;r++)for(var o=i[r],a=0,s=o.mutations;a<s.length;a++){var u=s[a],c=u.key;if(t.path.isImmediateParentOf(c.path)){var h=n.get(c),l=u.applyToLocalView(h,h,o.localWriteTime);n=l instanceof _?n.insert(c,l):n.remove(c)}}}).next(function(){return n.forEach(function(e,r){t.matches(r)||(n=n.remove(e))}),n})},LocalDocumentsView}(),bn=function(){function ReferenceSet(){this.refsByKey=new Re(Sn.compareByKey),this.refsByTarget=new Re(Sn.compareByTargetId)}return ReferenceSet.prototype.isEmpty=function(){return this.refsByKey.isEmpty()},ReferenceSet.prototype.addReference=function(e,t){var n=new Sn(e,t);this.refsByKey=this.refsByKey.add(n),this.refsByTarget=this.refsByTarget.add(n)},ReferenceSet.prototype.addReferences=function(e,t){var n=this;e.forEach(function(e){return n.addReference(e,t)})},ReferenceSet.prototype.removeReference=function(e,t){this.removeRef(new Sn(e,t))},ReferenceSet.prototype.removeReferences=function(e,t){var n=this;e.forEach(function(e){return n.removeReference(e,t)})},ReferenceSet.prototype.removeReferencesForId=function(e){var t=this,n=C.EMPTY,r=new Sn(n,e),i=new Sn(n,e+1),o=[];return this.refsByTarget.forEachInRange([r,i],function(e){t.removeRef(e),o.push(e.key)}),o},ReferenceSet.prototype.removeAllReferences=function(){var e=this;this.refsByKey.forEach(function(t){return e.removeRef(t)})},ReferenceSet.prototype.removeRef=function(e){this.refsByKey=this.refsByKey.delete(e),this.refsByTarget=this.refsByTarget.delete(e)},ReferenceSet.prototype.referencesForId=function(e){var t=C.EMPTY,n=new Sn(t,e),r=new Sn(t,e+1),i=documentKeySet();return this.refsByTarget.forEachInRange([n,r],function(e){i=i.add(e.key)}),i},ReferenceSet.prototype.containsKey=function(e){var t=new Sn(e,0),n=this.refsByKey.firstAfterOrEqual(t);return null!==n&&e.isEqual(n.key)},ReferenceSet}(),Sn=function(){function DocReference(e,t){this.key=e,this.targetOrBatchId=t}return DocReference.compareByKey=function(e,t){return C.comparator(e.key,t.key)||primitiveComparator(e.targetOrBatchId,t.targetOrBatchId)},DocReference.compareByTargetId=function(e,t){return primitiveComparator(e.targetOrBatchId,t.targetOrBatchId)||C.comparator(e.key,t.key)},DocReference}(),wn=function(){function LocalStore(e,t){this.persistence=e,this.localViewReferences=new bn,this.queryDataByTarget={},assert(e.started,"LocalStore was passed an unstarted persistence implementation"),this.persistence.referenceDelegate.setInMemoryPins(this.localViewReferences),this.mutationQueue=e.getMutationQueue(t),this.remoteDocuments=e.getRemoteDocumentCache(),this.queryCache=e.getQueryCache(),this.localDocuments=new vn(this.remoteDocuments,this.mutationQueue)}return LocalStore.prototype.handleUserChange=function(e){var t=this;return this.persistence.runTransaction("Handle user change","readonly",function(n){var r;return t.mutationQueue.getAllMutationBatches(n).next(function(i){return r=i,t.mutationQueue=t.persistence.getMutationQueue(e),t.localDocuments=new vn(t.remoteDocuments,t.mutationQueue),t.mutationQueue.getAllMutationBatches(n)}).next(function(e){for(var i=[],o=[],a=documentKeySet(),s=0,u=r;s<u.length;s++){var c=u[s];i.push(c.batchId);for(var h=0,l=c.mutations;h<l.length;h++){var f=l[h];a=a.add(f.key)}}for(var d=0,p=e;d<p.length;d++){var c=p[d];o.push(c.batchId);for(var m=0,y=c.mutations;m<y.length;m++){var f=y[m];a=a.add(f.key)}}return t.localDocuments.getDocuments(n,a).next(function(e){return{affectedDocuments:e,removedBatchIds:i,addedBatchIds:o}})})})},LocalStore.prototype.localWrite=function(e){var t=this;return this.persistence.runTransaction("Locally write mutations","readwrite",function(n){var r,i=g.now();return t.mutationQueue.addMutationBatch(n,i,e).next(function(e){r=e;var i=r.keys();return t.localDocuments.getDocuments(n,i)}).next(function(e){return{batchId:r.batchId,changes:e}})})},LocalStore.prototype.lookupMutationDocuments=function(e){var t=this;return this.persistence.runTransaction("Lookup mutation documents","readonly",function(n){return t.mutationQueue.lookupMutationKeys(n,e).next(function(e){return e?t.localDocuments.getDocuments(n,e):_t.resolve(null)})})},LocalStore.prototype.acknowledgeBatch=function(e){var t=this;return this.persistence.runTransaction("Acknowledge batch","readwrite-primary",function(n){var r=e.batch.keys(),i=t.remoteDocuments.newChangeBuffer();return t.mutationQueue.acknowledgeBatch(n,e.batch,e.streamToken).next(function(){return t.applyWriteToRemoteDocuments(n,e,i)}).next(function(){return i.apply(n)}).next(function(){return t.mutationQueue.performConsistencyCheck(n)}).next(function(){return t.localDocuments.getDocuments(n,r)})})},LocalStore.prototype.rejectBatch=function(e){var t=this;return this.persistence.runTransaction("Reject batch","readwrite-primary",function(n){var r;return t.mutationQueue.lookupMutationBatch(n,e).next(function(e){return assert(null!==e,"Attempt to reject nonexistent batch!"),r=e.keys(),t.mutationQueue.removeMutationBatch(n,e)}).next(function(){return t.mutationQueue.performConsistencyCheck(n)}).next(function(){return t.localDocuments.getDocuments(n,r)})})},LocalStore.prototype.getLastStreamToken=function(){var e=this;return this.persistence.runTransaction("Get last stream token","readonly",function(t){return e.mutationQueue.getLastStreamToken(t)})},LocalStore.prototype.setLastStreamToken=function(e){var t=this;return this.persistence.runTransaction("Set last stream token","readwrite-primary",function(n){return t.mutationQueue.setLastStreamToken(n,e)})},LocalStore.prototype.getLastRemoteSnapshotVersion=function(){var e=this;return this.persistence.runTransaction("Get last remote snapshot version","readonly",function(t){return e.queryCache.getLastRemoteSnapshotVersion(t)})},LocalStore.prototype.applyRemoteEvent=function(e){var t=this,n=this.remoteDocuments.newChangeBuffer();return this.persistence.runTransaction("Apply remote event","readwrite-primary",function(r){var i=[],o=documentKeySet();forEachNumber(e.targetChanges,function(n,a){var s=t.queryDataByTarget[n];if(s){a.addedDocuments.forEach(function(e){o=o.add(e)}),a.modifiedDocuments.forEach(function(e){o=o.add(e)}),i.push(t.queryCache.removeMatchingKeys(r,a.removedDocuments,n).next(function(){return t.queryCache.addMatchingKeys(r,a.addedDocuments,n)}));var u=a.resumeToken;if(u.length>0){var c=s;s=s.copy({resumeToken:u,snapshotVersion:e.snapshotVersion}),t.queryDataByTarget[n]=s,LocalStore.shouldPersistQueryData(c,s,a)&&i.push(t.queryCache.updateQueryData(r,s))}}});var a=documentKeySet();e.documentUpdates.forEach(function(s,u){a=a.add(s),i.push(n.getEntry(r,s).next(function(e){null==e||u.version.isEqual(de.MIN)||o.has(u.key)&&!e.hasPendingWrites||u.version.compareTo(e.version)>=0?n.addEntry(u):debug("LocalStore","Ignoring outdated watch update for ",s,". Current version:",e.version," Watch version:",u.version)})),e.resolvedLimboDocuments.has(s)&&i.push(t.persistence.referenceDelegate.updateLimboDocument(r,s))});var s=e.snapshotVersion;if(!s.isEqual(de.MIN)){var u=t.queryCache.getLastRemoteSnapshotVersion(r).next(function(e){return assert(s.compareTo(e)>=0,"Watch stream reverted to previous snapshot?? "+s+" < "+e),t.queryCache.setTargetsMetadata(r,r.currentSequenceNumber,s)});i.push(u)}return _t.waitFor(i).next(function(){return n.apply(r)}).next(function(){return t.localDocuments.getDocuments(r,a)})})},LocalStore.shouldPersistQueryData=function(e,t,n){return 0!==t.resumeToken.length&&(0===e.resumeToken.length||(t.snapshotVersion.toMicroseconds()-e.snapshotVersion.toMicroseconds()>=this.RESUME_TOKEN_MAX_AGE_MICROS||n.addedDocuments.size+n.modifiedDocuments.size+n.removedDocuments.size>0))},LocalStore.prototype.notifyLocalViewChanges=function(e){var t=this;return this.persistence.runTransaction("notifyLocalViewChanges","readwrite",function(n){return _t.forEach(e,function(e){return t.localViewReferences.addReferences(e.addedKeys,e.targetId),t.localViewReferences.removeReferences(e.removedKeys,e.targetId),_t.forEach(e.removedKeys,function(e){return t.persistence.referenceDelegate.removeReference(n,e)})})})},LocalStore.prototype.nextMutationBatch=function(e){var t=this;return this.persistence.runTransaction("Get next mutation batch","readonly",function(n){return void 0===e&&(e=wt),t.mutationQueue.getNextMutationBatchAfterBatchId(n,e)})},LocalStore.prototype.readDocument=function(e){var t=this;return this.persistence.runTransaction("read document","readonly",function(n){return t.localDocuments.getDocument(n,e)})},LocalStore.prototype.allocateQuery=function(e){var t=this;return this.persistence.runTransaction("Allocate query","readwrite",function(n){var r;return t.queryCache.getQueryData(n,e).next(function(i){return i?(r=i,_t.resolve()):t.queryCache.allocateTargetId(n).next(function(i){return r=new me(e,i,x.Listen,n.currentSequenceNumber),t.queryCache.addQueryData(n,r)})}).next(function(){return assert(!t.queryDataByTarget[r.targetId],"Tried to allocate an already allocated query: "+e),t.queryDataByTarget[r.targetId]=r,r})})},LocalStore.prototype.releaseQuery=function(e,t){var n=this,r=t?"readwrite":"readwrite-primary";return this.persistence.runTransaction("Release query",r,function(r){return n.queryCache.getQueryData(r,e).next(function(i){assert(null!=i,"Tried to release nonexistent query: "+e);var o=i.targetId,a=n.queryDataByTarget[o],s=n.localViewReferences.removeReferencesForId(o);return delete n.queryDataByTarget[o],t?_t.resolve():_t.forEach(s,function(e){return n.persistence.referenceDelegate.removeReference(r,e)}).next(function(){return n.persistence.referenceDelegate.removeTarget(r,a)})})})},LocalStore.prototype.executeQuery=function(e){var t=this;return this.persistence.runTransaction("Execute query","readonly",function(n){return t.localDocuments.getDocumentsMatchingQuery(n,e)})},LocalStore.prototype.remoteDocumentKeys=function(e){var t=this;return this.persistence.runTransaction("Remote document keys","readonly",function(n){return t.queryCache.getMatchingKeysForTargetId(n,e)})},LocalStore.prototype.getActiveClients=function(){return this.persistence.getActiveClients()},LocalStore.prototype.removeCachedMutationBatchMetadata=function(e){this.mutationQueue.removeCachedMutationKeys(e)},LocalStore.prototype.setNetworkEnabled=function(e){this.persistence.setNetworkEnabled(e)},LocalStore.prototype.applyWriteToRemoteDocuments=function(e,t,n){var r=this,i=t.batch,o=i.keys(),a=_t.resolve();return o.forEach(function(r){a=a.next(function(){return n.getEntry(e,r)}).next(function(e){var o=e,a=t.docVersions.get(r);assert(null!==a,"ackVersions should contain every doc in the write."),(!o||o.version.compareTo(a)<0)&&(o=i.applyToRemoteDocument(r,o,t),o?n.addEntry(o):assert(!e,"Mutation batch "+i+" applied to document "+e+" resulted in null"))})}),a.next(function(){return r.mutationQueue.removeMutationBatch(e,i)})},LocalStore.prototype.getQueryForTarget=function(e){var t=this;return this.queryDataByTarget[e]?Promise.resolve(this.queryDataByTarget[e].query):this.persistence.runTransaction("Get query data","readonly",function(n){return t.queryCache.getQueryDataForTarget(n,e).next(function(e){return e?e.query:null})})},LocalStore.prototype.getNewDocumentChanges=function(){var e=this;return this.persistence.runTransaction("Get new document changes","readonly",function(t){return e.remoteDocuments.getNewDocumentChanges(t)})},LocalStore.RESUME_TOKEN_MAX_AGE_MICROS=3e8,LocalStore}(),Tn=function(){function MemoryMutationQueue(e){this.referenceDelegate=e,this.mutationQueue=[],this.nextBatchId=1,this.highestAcknowledgedBatchId=wt,this.lastStreamToken=emptyByteString(),this.batchesByDocumentKey=new Re(Sn.compareByKey)}return MemoryMutationQueue.prototype.checkEmpty=function(e){return _t.resolve(0===this.mutationQueue.length)},MemoryMutationQueue.prototype.acknowledgeBatch=function(e,t,n){var r=t.batchId;assert(r>this.highestAcknowledgedBatchId,"Mutation batchIDs must be acknowledged in order");var i=this.indexOfExistingBatchId(r,"acknowledged");assert(0===i,"Can only acknowledge the first batch in the mutation queue");var o=this.mutationQueue[i];return assert(r===o.batchId,"Queue ordering failure: expected batch "+r+", got batch "+o.batchId),this.highestAcknowledgedBatchId=r,this.lastStreamToken=n,_t.resolve()},MemoryMutationQueue.prototype.getLastStreamToken=function(e){return _t.resolve(this.lastStreamToken)},MemoryMutationQueue.prototype.setLastStreamToken=function(e,t){return this.lastStreamToken=t,_t.resolve()},MemoryMutationQueue.prototype.addMutationBatch=function(e,t,n){assert(0!==n.length,"Mutation batches should not be empty");var r=this.nextBatchId;if(this.nextBatchId++,this.mutationQueue.length>0){assert(this.mutationQueue[this.mutationQueue.length-1].batchId<r,"Mutation batchIDs must be monotonically increasing order")}var i=new Tt(r,t,n);this.mutationQueue.push(i);for(var o=0,a=n;o<a.length;o++){var s=a[o];this.batchesByDocumentKey=this.batchesByDocumentKey.add(new Sn(s.key,r))}return _t.resolve(i)},MemoryMutationQueue.prototype.lookupMutationBatch=function(e,t){return _t.resolve(this.findMutationBatch(t))},MemoryMutationQueue.prototype.lookupMutationKeys=function(e,t){var n=this.findMutationBatch(t);return assert(null!=n,"Failed to find local mutation batch."),_t.resolve(n.keys())},MemoryMutationQueue.prototype.getNextMutationBatchAfterBatchId=function(e,t){var n=Math.max(t,this.highestAcknowledgedBatchId)+1,r=this.indexOfBatchId(n),i=r<0?0:r;return _t.resolve(this.mutationQueue.length>i?this.mutationQueue[i]:null)},MemoryMutationQueue.prototype.getAllMutationBatches=function(e){return _t.resolve(this.mutationQueue.slice())},MemoryMutationQueue.prototype.getAllMutationBatchesAffectingDocumentKey=function(e,t){var n=this,r=new Sn(t,0),i=new Sn(t,Number.POSITIVE_INFINITY),o=[];return this.batchesByDocumentKey.forEachInRange([r,i],function(e){assert(t.isEqual(e.key),"Should only iterate over a single key's batches");var r=n.findMutationBatch(e.targetOrBatchId);assert(null!==r,"Batches in the index must exist in the main table"),o.push(r)}),_t.resolve(o)},MemoryMutationQueue.prototype.getAllMutationBatchesAffectingDocumentKeys=function(e,t){var n=this,r=new Re(primitiveComparator);return t.forEach(function(e){var t=new Sn(e,0),i=new Sn(e,Number.POSITIVE_INFINITY);n.batchesByDocumentKey.forEachInRange([t,i],function(t){assert(e.isEqual(t.key),"For each key, should only iterate over a single key's batches"),r=r.add(t.targetOrBatchId)})}),_t.resolve(this.findMutationBatches(r))},MemoryMutationQueue.prototype.getAllMutationBatchesAffectingQuery=function(e,t){var n=t.path,r=n.length+1,i=n;C.isDocumentKey(i)||(i=i.child(""));var o=new Sn(new C(i),0),a=new Re(primitiveComparator);return this.batchesByDocumentKey.forEachWhile(function(e){var t=e.key.path;return!!n.isPrefixOf(t)&&(t.length===r&&(a=a.add(e.targetOrBatchId)),!0)},o),_t.resolve(this.findMutationBatches(a))},MemoryMutationQueue.prototype.findMutationBatches=function(e){var t=this,n=[];return e.forEach(function(e){var r=t.findMutationBatch(e);null!==r&&n.push(r)}),n},MemoryMutationQueue.prototype.removeMutationBatch=function(e,t){var n=this;assert(0===this.indexOfExistingBatchId(t.batchId,"removed"),"Can only remove the first entry of the mutation queue"),this.mutationQueue.shift();var r=this.batchesByDocumentKey;return _t.forEach(t.mutations,function(i){var o=new Sn(i.key,t.batchId);return r=r.delete(o),n.referenceDelegate.removeMutationReference(e,i.key)}).next(function(){n.batchesByDocumentKey=r})},MemoryMutationQueue.prototype.removeCachedMutationKeys=function(e){},MemoryMutationQueue.prototype.containsKey=function(e,t){var n=new Sn(t,0),r=this.batchesByDocumentKey.firstAfterOrEqual(n);return _t.resolve(t.isEqual(r&&r.key))},MemoryMutationQueue.prototype.performConsistencyCheck=function(e){return 0===this.mutationQueue.length&&assert(this.batchesByDocumentKey.isEmpty(),"Document leak -- detected dangling mutation references when queue is empty."),_t.resolve()},MemoryMutationQueue.prototype.indexOfExistingBatchId=function(e,t){var n=this.indexOfBatchId(e);return assert(n>=0&&n<this.mutationQueue.length,"Batches must exist to be "+t),n},MemoryMutationQueue.prototype.indexOfBatchId=function(e){return 0===this.mutationQueue.length?0:e-this.mutationQueue[0].batchId},MemoryMutationQueue.prototype.findMutationBatch=function(e){var t=this.indexOfBatchId(e);if(t<0||t>=this.mutationQueue.length)return null;var n=this.mutationQueue[t];return assert(n.batchId===e,"If found batch must match"),n},MemoryMutationQueue}(),Dn=function(){function MemoryQueryCache(e){this.persistence=e,this.queries=new Ot(function(e){return e.canonicalId()}),this.lastRemoteSnapshotVersion=de.MIN,this.highestTargetId=0,this.highestSequenceNumber=0,this.references=new bn,this.targetCount=0,this.targetIdGenerator=It.forQueryCache()}return MemoryQueryCache.prototype.getTargetCount=function(e){return _t.resolve(this.targetCount)},MemoryQueryCache.prototype.forEachTarget=function(e,t){return this.queries.forEach(function(e,n){return t(n)}),_t.resolve()},MemoryQueryCache.prototype.getLastRemoteSnapshotVersion=function(e){return _t.resolve(this.lastRemoteSnapshotVersion)},MemoryQueryCache.prototype.getHighestSequenceNumber=function(e){return _t.resolve(this.highestSequenceNumber)},MemoryQueryCache.prototype.allocateTargetId=function(e){var t=this.targetIdGenerator.after(this.highestTargetId);return this.highestTargetId=t,_t.resolve(t)},MemoryQueryCache.prototype.setTargetsMetadata=function(e,t,n){return n&&(this.lastRemoteSnapshotVersion=n),t>this.highestSequenceNumber&&(this.highestSequenceNumber=t),_t.resolve()},MemoryQueryCache.prototype.saveQueryData=function(e){this.queries.set(e.query,e);var t=e.targetId;t>this.highestTargetId&&(this.highestTargetId=t),e.sequenceNumber>this.highestSequenceNumber&&(this.highestSequenceNumber=e.sequenceNumber)},MemoryQueryCache.prototype.addQueryData=function(e,t){return assert(!this.queries.has(t.query),"Adding a query that already exists"),this.saveQueryData(t),this.targetCount+=1,_t.resolve()},MemoryQueryCache.prototype.updateQueryData=function(e,t){return assert(this.queries.has(t.query),"Updating a non-existent query"),this.saveQueryData(t),_t.resolve()},MemoryQueryCache.prototype.removeQueryData=function(e,t){return assert(this.targetCount>0,"Removing a target from an empty cache"),assert(this.queries.has(t.query),"Removing a non-existent target from the cache"),this.queries.delete(t.query),this.references.removeReferencesForId(t.targetId),this.targetCount-=1,_t.resolve()},MemoryQueryCache.prototype.removeTargets=function(e,t,n){var r=this,i=0,o=[];return this.queries.forEach(function(a,s){s.sequenceNumber<=t&&!n[s.targetId]&&(r.queries.delete(a),o.push(r.removeMatchingKeysForTargetId(e,s.targetId)),i++)}),_t.waitFor(o).next(function(){return i})},MemoryQueryCache.prototype.getQueryCount=function(e){return _t.resolve(this.targetCount)},MemoryQueryCache.prototype.getQueryData=function(e,t){var n=this.queries.get(t)||null;return _t.resolve(n)},MemoryQueryCache.prototype.getQueryDataForTarget=function(e,t){return fail("Not yet implemented.")},MemoryQueryCache.prototype.addMatchingKeys=function(e,t,n){this.references.addReferences(t,n);var r=this.persistence.referenceDelegate,i=[];return r&&t.forEach(function(t){i.push(r.addReference(e,t))}),_t.waitFor(i)},MemoryQueryCache.prototype.removeMatchingKeys=function(e,t,n){this.references.removeReferences(t,n);var r=this.persistence.referenceDelegate,i=[];return r&&t.forEach(function(t){i.push(r.removeReference(e,t))}),_t.waitFor(i)},MemoryQueryCache.prototype.removeMatchingKeysForTargetId=function(e,t){return this.references.removeReferencesForId(t),_t.resolve()},MemoryQueryCache.prototype.getMatchingKeysForTargetId=function(e,t){var n=this.references.referencesForId(t);return _t.resolve(n)},MemoryQueryCache.prototype.containsKey=function(e,t){return _t.resolve(this.references.containsKey(t))},MemoryQueryCache}(),En=function(){function MemoryRemoteDocumentCache(e){this.sizer=e,this.docs=documentSizeMap(),this.newDocumentChanges=documentKeySet(),this.size=0}return MemoryRemoteDocumentCache.prototype.addEntries=function(e,t,n){for(var r=0,i=t;r<i.length;r++){var o=i[r],a=o.maybeDocument.key;this.docs=this.docs.insert(a,o),this.newDocumentChanges=this.newDocumentChanges.add(a)}return this.size+=n,_t.resolve()},MemoryRemoteDocumentCache.prototype.removeEntry=function(e,t){var n=this.docs.get(t);return n?(this.docs=this.docs.remove(t),this.size-=n.size,_t.resolve(n.size)):_t.resolve(0)},MemoryRemoteDocumentCache.prototype.getEntry=function(e,t){var n=this.docs.get(t);return _t.resolve(n?n.maybeDocument:null)},MemoryRemoteDocumentCache.prototype.getSizedEntry=function(e,t){return _t.resolve(this.docs.get(t))},MemoryRemoteDocumentCache.prototype.getDocumentsMatchingQuery=function(e,t){for(var n=documentMap(),r=new C(t.path.child("")),i=this.docs.getIteratorFrom(r);i.hasNext();){var o=i.getNext(),a=o.key,s=o.value.maybeDocument;if(!t.path.isPrefixOf(a.path))break;s instanceof _&&t.matches(s)&&(n=n.insert(s.key,s))}return _t.resolve(n)},MemoryRemoteDocumentCache.prototype.forEachDocumentKey=function(e,t){return _t.forEach(this.docs,function(e){return t(e)})},MemoryRemoteDocumentCache.prototype.getNewDocumentChanges=function(e){var t=this,n=maybeDocumentMap();return this.newDocumentChanges.forEach(function(e){var r=t.docs.get(e),i=r?r.maybeDocument:new A(e,de.forDeletedDoc());n=n.insert(e,i)}),this.newDocumentChanges=documentKeySet(),_t.resolve(n)},MemoryRemoteDocumentCache.prototype.newChangeBuffer=function(){return new Cn(this.sizer,this)},MemoryRemoteDocumentCache.prototype.getSize=function(e){return _t.resolve(this.size)},MemoryRemoteDocumentCache}(),Cn=function(e){function MemoryRemoteDocumentChangeBuffer(t,n){var r=e.call(this)||this;return r.sizer=t,r.documentCache=n,r}return a.__extends(MemoryRemoteDocumentChangeBuffer,e),MemoryRemoteDocumentChangeBuffer.prototype.applyChanges=function(e){var t=this,n=this.assertChanges(),r=0,i=[];return n.forEach(function(e,n){var o=t.documentSizes.get(e);assert(void 0!==o,"Attempting to change document "+e.toString()+" without having read it first");var a=t.sizer(n);r+=a-o,i.push({maybeDocument:n,size:a})}),this.documentCache.addEntries(e,i,r)},MemoryRemoteDocumentChangeBuffer.prototype.getFromCache=function(e,t){return this.documentCache.getSizedEntry(e,t)},MemoryRemoteDocumentChangeBuffer}(kt),In=function(){function MemoryPersistence(e,t,n){var r=this;this.clientId=e,this.mutationQueues={},this.listenSequence=new ft(0),this._started=!1,this._started=!0,this.referenceDelegate=t?new An(this):new Pn(this,new sn(n)),this.queryCache=new Dn(this);var i=function(e){return r.referenceDelegate.documentSize(e)};this.remoteDocumentCache=new En(i)}return MemoryPersistence.createLruPersistence=function(e,t){return new MemoryPersistence(e,!1,t)},MemoryPersistence.createEagerPersistence=function(e,t){return new MemoryPersistence(e,!0,t)},MemoryPersistence.prototype.shutdown=function(e){return this._started=!1,Promise.resolve()},Object.defineProperty(MemoryPersistence.prototype,"started",{get:function(){return this._started},enumerable:!0,configurable:!0}),MemoryPersistence.prototype.getActiveClients=function(){return a.__awaiter(this,void 0,void 0,function(){return a.__generator(this,function(e){return[2,[this.clientId]]})})},MemoryPersistence.prototype.setPrimaryStateListener=function(e){return e(!0)},MemoryPersistence.prototype.setNetworkEnabled=function(e){},MemoryPersistence.prototype.getMutationQueue=function(e){var t=this.mutationQueues[e.toKey()];return t||(t=new Tn(this.referenceDelegate),this.mutationQueues[e.toKey()]=t),t},MemoryPersistence.prototype.getQueryCache=function(){return this.queryCache},MemoryPersistence.prototype.getRemoteDocumentCache=function(){return this.remoteDocumentCache},MemoryPersistence.prototype.runTransaction=function(e,t,n){var r=this;debug("MemoryPersistence","Starting transaction:",e);var i=new _n(this.listenSequence.next());return this.referenceDelegate.onTransactionStarted(),n(i).next(function(e){return r.referenceDelegate.onTransactionCommitted(i).next(function(){return e})}).toPromise()},MemoryPersistence.prototype.mutationQueuesContainKey=function(e,t){return _t.or(values(this.mutationQueues).map(function(n){return function(){return n.containsKey(e,t)}}))},MemoryPersistence}(),_n=function(){function MemoryTransaction(e){this.currentSequenceNumber=e}return MemoryTransaction}(),An=function(){function MemoryEagerDelegate(e){this.persistence=e}return MemoryEagerDelegate.prototype.setInMemoryPins=function(e){this.inMemoryPins=e},MemoryEagerDelegate.prototype.addReference=function(e,t){return this.orphanedDocuments.delete(t),_t.resolve()},MemoryEagerDelegate.prototype.removeReference=function(e,t){return this.orphanedDocuments.add(t),_t.resolve()},MemoryEagerDelegate.prototype.removeMutationReference=function(e,t){return this.orphanedDocuments.add(t),_t.resolve()},MemoryEagerDelegate.prototype.removeTarget=function(e,t){var n=this,r=this.persistence.getQueryCache();return r.getMatchingKeysForTargetId(e,t.targetId).next(function(e){e.forEach(function(e){return n.orphanedDocuments.add(e)})}).next(function(){return r.removeQueryData(e,t)})},MemoryEagerDelegate.prototype.onTransactionStarted=function(){this.orphanedDocuments=new Set},MemoryEagerDelegate.prototype.onTransactionCommitted=function(e){var t=this,n=this.persistence.getRemoteDocumentCache();return _t.forEach(this.orphanedDocuments,function(r){return t.isReferenced(e,r).next(function(t){return t?_t.resolve():n.removeEntry(e,r).next(function(){})})})},MemoryEagerDelegate.prototype.updateLimboDocument=function(e,t){var n=this;return this.isReferenced(e,t).next(function(e){e?n.orphanedDocuments.delete(t):n.orphanedDocuments.add(t)})},MemoryEagerDelegate.prototype.documentSize=function(e){return 0},MemoryEagerDelegate.prototype.isReferenced=function(e,t){var n=this;return _t.or([function(){return n.persistence.getQueryCache().containsKey(e,t)},function(){return n.persistence.mutationQueuesContainKey(e,t)},function(){return _t.resolve(n.inMemoryPins.containsKey(t))}])},MemoryEagerDelegate}(),Pn=function(){function MemoryLruDelegate(e,t){this.persistence=e,this.serializer=t,this.orphanedSequenceNumbers=new Ot(function(e){return encode(e.path)}),this.garbageCollector=new cn(this)}return MemoryLruDelegate.prototype.onTransactionStarted=function(){},MemoryLruDelegate.prototype.onTransactionCommitted=function(e){return _t.resolve()},MemoryLruDelegate.prototype.forEachTarget=function(e,t){return this.persistence.getQueryCache().forEachTarget(e,t)},MemoryLruDelegate.prototype.getSequenceNumberCount=function(e){var t=this.orphanedDocumentCount(e);return this.persistence.getQueryCache().getTargetCount(e).next(function(e){return t.next(function(t){return e+t})})},MemoryLruDelegate.prototype.orphanedDocumentCount=function(e){var t=0;return this.forEachOrphanedDocumentSequenceNumber(e,function(e){t++}).next(function(){return t})},MemoryLruDelegate.prototype.forEachOrphanedDocumentSequenceNumber=function(e,t){var n=this;return _t.forEach(this.orphanedSequenceNumbers,function(r,i){return n.isPinned(e,r,i).next(function(e){return e?_t.resolve():t(i)})})},MemoryLruDelegate.prototype.setInMemoryPins=function(e){this.inMemoryPins=e},MemoryLruDelegate.prototype.removeTargets=function(e,t,n){return this.persistence.getQueryCache().removeTargets(e,t,n)},MemoryLruDelegate.prototype.removeOrphanedDocuments=function(e,t){var n=this,r=0,i=this.persistence.getRemoteDocumentCache();return i.forEachDocumentKey(e,function(o){return n.isPinned(e,o,t).next(function(t){return t?_t.resolve():(r++,i.removeEntry(e,o).next())})}).next(function(){return r})},MemoryLruDelegate.prototype.removeMutationReference=function(e,t){return this.orphanedSequenceNumbers.set(t,e.currentSequenceNumber),_t.resolve()},MemoryLruDelegate.prototype.removeTarget=function(e,t){var n=t.copy({sequenceNumber:e.currentSequenceNumber});return this.persistence.getQueryCache().updateQueryData(e,n)},MemoryLruDelegate.prototype.addReference=function(e,t){return this.orphanedSequenceNumbers.set(t,e.currentSequenceNumber),_t.resolve()},MemoryLruDelegate.prototype.removeReference=function(e,t){return this.orphanedSequenceNumbers.set(t,e.currentSequenceNumber),_t.resolve()},MemoryLruDelegate.prototype.updateLimboDocument=function(e,t){return this.orphanedSequenceNumbers.set(t,e.currentSequenceNumber),_t.resolve()},MemoryLruDelegate.prototype.documentSize=function(e){var t,n=this.serializer.toDbRemoteDocument(e);if(n.document)t=n.document;else if(n.unknownDocument)t=n.unknownDocument;else{if(!n.noDocument)throw fail("Unknown remote document type");t=n.noDocument}return JSON.stringify(t).length},MemoryLruDelegate.prototype.isPinned=function(e,t,n){var r=this;return _t.or([function(){return r.persistence.mutationQueuesContainKey(e,t)},function(){return _t.resolve(r.inMemoryPins.containsKey(t))},function(){return r.persistence.getQueryCache().containsKey(e,t)},function(){var e=r.orphanedSequenceNumbers.get(t);return _t.resolve(void 0!==e&&e>n)}])},MemoryLruDelegate}(),Nn=function(){function ExponentialBackoff(e,t,n,r,i){this.queue=e,this.timerId=t,this.initialDelayMs=n,this.backoffFactor=r,this.maxDelayMs=i,this.timerPromise=null,this.lastAttemptTime=Date.now(),this.reset()}return ExponentialBackoff.prototype.reset=function(){this.currentBaseMs=0},ExponentialBackoff.prototype.resetToMax=function(){this.currentBaseMs=this.maxDelayMs},ExponentialBackoff.prototype.backoffAndRun=function(e){var t=this;this.cancel();var n=Math.floor(this.currentBaseMs+this.jitterDelayMs()),r=Math.max(0,Date.now()-this.lastAttemptTime),i=Math.max(0,n-r);this.currentBaseMs>0&&debug("ExponentialBackoff","Backing off for "+i+" ms (base delay: "+this.currentBaseMs+" ms, delay with jitter: "+n+" ms, last attempt: "+r+" ms ago)"),this.timerPromise=this.queue.enqueueAfterDelay(this.timerId,i,function(){return t.lastAttemptTime=Date.now(),e()}),this.currentBaseMs*=this.backoffFactor,this.currentBaseMs<this.initialDelayMs&&(this.currentBaseMs=this.initialDelayMs),this.currentBaseMs>this.maxDelayMs&&(this.currentBaseMs=this.maxDelayMs)},ExponentialBackoff.prototype.cancel=function(){null!==this.timerPromise&&(this.timerPromise.cancel(),this.timerPromise=null)},ExponentialBackoff.prototype.jitterDelayMs=function(){return(Math.random()-.5)*this.currentBaseMs},ExponentialBackoff}();!function(e){e[e.Initial=0]="Initial",e[e.Starting=1]="Starting",e[e.Open=2]="Open",e[e.Error=3]="Error",e[e.Backoff=4]="Backoff"}(Ct||(Ct={}));var Rn,Mn=1e3,On=6e4,kn=1.5,Ln=function(){function PersistentStream(e,t,n,r,i,o){this.queue=e,this.idleTimerId=n,this.connection=r,this.credentialsProvider=i,this.listener=o,this.state=Ct.Initial,this.closeCount=0,this.idleTimer=null,this.stream=null,this.backoff=new Nn(e,t,Mn,kn,On)}return PersistentStream.prototype.isStarted=function(){return this.state===Ct.Starting||this.state===Ct.Open||this.state===Ct.Backoff},PersistentStream.prototype.isOpen=function(){return this.state===Ct.Open},PersistentStream.prototype.start=function(){if(this.state===Ct.Error)return void this.performBackoff();assert(this.state===Ct.Initial,"Already started"),this.auth()},PersistentStream.prototype.stop=function(){return a.__awaiter(this,void 0,void 0,function(){return a.__generator(this,function(e){switch(e.label){case 0:return this.isStarted()?[4,this.close(Ct.Initial)]:[3,2];case 1:e.sent(),e.label=2;case 2:return[2]}})})},PersistentStream.prototype.inhibitBackoff=function(){assert(!this.isStarted(),"Can only inhibit backoff in a stopped state"),this.state=Ct.Initial,this.backoff.reset()},PersistentStream.prototype.markIdle=function(){var e=this;this.isOpen()&&null===this.idleTimer&&(this.idleTimer=this.queue.enqueueAfterDelay(this.idleTimerId,6e4,function(){return e.handleIdleCloseTimer()}))},PersistentStream.prototype.sendRequest=function(e){this.cancelIdleCheck(),this.stream.send(e)},PersistentStream.prototype.handleIdleCloseTimer=function(){return a.__awaiter(this,void 0,void 0,function(){return a.__generator(this,function(e){return this.isOpen()?[2,this.close(Ct.Initial)]:[2]})})},PersistentStream.prototype.cancelIdleCheck=function(){this.idleTimer&&(this.idleTimer.cancel(),this.idleTimer=null)},PersistentStream.prototype.close=function(e,t){return a.__awaiter(this,void 0,void 0,function(){return a.__generator(this,function(n){switch(n.label){case 0:return assert(this.isStarted(),"Only started streams should be closed."),assert(e===Ct.Error||isNullOrUndefined(t),"Can't provide an error when not in an error state."),this.cancelIdleCheck(),this.backoff.cancel(),this.closeCount++,e!==Ct.Error?this.backoff.reset():t&&t.code===l.RESOURCE_EXHAUSTED?(error(t.toString()),error("Using maximum backoff delay to prevent overloading the backend."),this.backoff.resetToMax()):t&&t.code===l.UNAUTHENTICATED&&this.credentialsProvider.invalidateToken(),null!==this.stream&&(this.tearDown(),this.stream.close(),this.stream=null),this.state=e,[4,this.listener.onClose(t)];case 1:return n.sent(),[2]}})})},PersistentStream.prototype.tearDown=function(){},PersistentStream.prototype.auth=function(){var e=this;assert(this.state===Ct.Initial,"Must be in initial state to auth"),this.state=Ct.Starting;var t=this.getCloseGuardedDispatcher(this.closeCount),n=this.closeCount;this.credentialsProvider.getToken().then(function(t){e.closeCount===n&&e.startStream(t)},function(n){t(function(){var t=new f(l.UNKNOWN,"Fetching auth token failed: "+n.message);return e.handleStreamClose(t)})})},PersistentStream.prototype.startStream=function(e){var t=this;assert(this.state===Ct.Starting,"Trying to start stream in a non-starting state");var n=this.getCloseGuardedDispatcher(this.closeCount);this.stream=this.startRpc(e),this.stream.onOpen(function(){n(function(){return assert(t.state===Ct.Starting,"Expected stream to be in state Starting, but was "+t.state),t.state=Ct.Open,t.listener.onOpen()})}),this.stream.onClose(function(e){n(function(){return t.handleStreamClose(e)})}),this.stream.onMessage(function(e){n(function(){return t.onMessage(e)})})},PersistentStream.prototype.performBackoff=function(){var e=this;assert(this.state===Ct.Error,"Should only perform backoff when in Error state"),this.state=Ct.Backoff,this.backoff.backoffAndRun(function(){return a.__awaiter(e,void 0,void 0,function(){return a.__generator(this,function(e){return assert(this.state===Ct.Backoff,"Backoff elapsed but state is now: "+this.state),this.state=Ct.Initial,this.start(),assert(this.isStarted(),"PersistentStream should have started"),[2]})})})},PersistentStream.prototype.handleStreamClose=function(e){return assert(this.isStarted(),"Can't handle server close on non-started stream"),debug("PersistentStream","close with error: "+e),this.stream=null,this.close(Ct.Error,e)},PersistentStream.prototype.getCloseGuardedDispatcher=function(e){var t=this;return function(n){t.queue.enqueueAndForget(function(){return t.closeCount===e?n():(debug("PersistentStream","stream callback skipped by getCloseGuardedDispatcher."),Promise.resolve())})}},PersistentStream}(),xn=function(e){function PersistentListenStream(t,n,r,i,o){var a=e.call(this,t,lt.ListenStreamConnectionBackoff,lt.ListenStreamIdle,n,r,o)||this;return a.serializer=i,a}return a.__extends(PersistentListenStream,e),PersistentListenStream.prototype.startRpc=function(e){return this.connection.openStream("Listen",e)},PersistentListenStream.prototype.onMessage=function(e){this.backoff.reset();var t=this.serializer.fromWatchChange(e),n=this.serializer.versionFromListenResponse(e);return this.listener.onWatchChange(t,n)},PersistentListenStream.prototype.watch=function(e){var t={};t.database=this.serializer.encodedDatabaseId,t.addTarget=this.serializer.toTarget(e);var n=this.serializer.toListenRequestLabels(e);n&&(t.labels=n),this.sendRequest(t)},PersistentListenStream.prototype.unwatch=function(e){var t={};t.database=this.serializer.encodedDatabaseId,t.removeTarget=e,this.sendRequest(t)},PersistentListenStream}(Ln),Fn=function(e){function PersistentWriteStream(t,n,r,i,o){var a=e.call(this,t,lt.WriteStreamConnectionBackoff,lt.WriteStreamIdle,n,r,o)||this;return a.serializer=i,a.handshakeComplete_=!1,a}return a.__extends(PersistentWriteStream,e),Object.defineProperty(PersistentWriteStream.prototype,"handshakeComplete",{get:function(){return this.handshakeComplete_},enumerable:!0,configurable:!0}),PersistentWriteStream.prototype.start=function(){this.handshakeComplete_=!1,e.prototype.start.call(this)},PersistentWriteStream.prototype.tearDown=function(){this.handshakeComplete_&&this.writeMutations([])},PersistentWriteStream.prototype.startRpc=function(e){return this.connection.openStream("Write",e)},PersistentWriteStream.prototype.onMessage=function(e){if(assert(!!e.streamToken,"Got a write response without a stream token"),this.lastStreamToken=e.streamToken,this.handshakeComplete_){this.backoff.reset();var t=this.serializer.fromWriteResults(e.writeResults,e.commitTime),n=this.serializer.fromVersion(e.commitTime);return this.listener.onMutationResult(n,t)}return assert(!e.writeResults||0===e.writeResults.length,"Got mutation results for handshake"),this.handshakeComplete_=!0,this.listener.onHandshakeComplete()},PersistentWriteStream.prototype.writeHandshake=function(){assert(this.isOpen(),"Writing handshake requires an opened stream"),assert(!this.handshakeComplete_,"Handshake already completed");var e={};e.database=this.serializer.encodedDatabaseId,this.sendRequest(e)},PersistentWriteStream.prototype.writeMutations=function(e){var t=this;assert(this.isOpen(),"Writing mutations requires an opened stream"),assert(this.handshakeComplete_,"Handshake must be complete before writing mutations"),assert(this.lastStreamToken.length>0,"Trying to write mutation without a token");var n={streamToken:this.lastStreamToken,writes:e.map(function(e){return t.serializer.toMutation(e)})};this.sendRequest(n)},PersistentWriteStream}(Ln),Vn=function(){function Datastore(e,t,n,r){this.queue=e,this.connection=t,this.credentials=n,this.serializer=r}return Datastore.prototype.newPersistentWriteStream=function(e){return new Fn(this.queue,this.connection,this.credentials,this.serializer,e)},Datastore.prototype.newPersistentWatchStream=function(e){return new xn(this.queue,this.connection,this.credentials,this.serializer,e)},Datastore.prototype.commit=function(e){var t=this,n={database:this.serializer.encodedDatabaseId,writes:e.map(function(e){return t.serializer.toMutation(e)})};return this.invokeRPC("Commit",n).then(function(e){return t.serializer.fromWriteResults(e.writeResults,e.commitTime)})},Datastore.prototype.lookup=function(e){var t=this,n={database:this.serializer.encodedDatabaseId,documents:e.map(function(e){return t.serializer.toName(e)})};return this.invokeStreamingRPC("BatchGetDocuments",n).then(function(n){var r=maybeDocumentMap();n.forEach(function(e){var n=t.serializer.fromMaybeDocument(e);r=r.insert(n.key,n)});var i=[];return e.forEach(function(e){var t=r.get(e);assert(!!t,"Missing entity in write response for "+e),i.push(t)}),i})},Datastore.prototype.invokeRPC=function(e,t){var n=this;return this.credentials.getToken().then(function(r){return n.connection.invokeRPC(e,t,r)}).catch(function(e){throw e.code===l.UNAUTHENTICATED&&n.credentials.invalidateToken(),e})},Datastore.prototype.invokeStreamingRPC=function(e,t){var n=this;return this.credentials.getToken().then(function(r){return n.connection.invokeStreamingRPC(e,t,r)}).catch(function(e){throw e.code===l.UNAUTHENTICATED&&n.credentials.invalidateToken(),e})},Datastore}(),Bn=function(){function Transaction(e){this.datastore=e,this.readVersions=documentVersionMap(),this.mutations=[],this.committed=!1}return Transaction.prototype.recordVersion=function(e){var t;if(e instanceof _)t=e.version;else{if(!(e instanceof A))throw fail("Document in a transaction was a "+e.constructor.name);t=de.forDeletedDoc()}var n=this.readVersions.get(e.key);if(null!==n){if(!t.isEqual(n))throw new f(l.ABORTED,"Document version changed between two reads.")}else this.readVersions=this.readVersions.insert(e.key,t)},Transaction.prototype.lookup=function(e){var t=this;return this.committed?Promise.reject("Transaction has already completed."):this.mutations.length>0?Promise.reject("Transactions lookups are invalid after writes."):this.datastore.lookup(e).then(function(e){return e.forEach(function(e){e instanceof A||e instanceof _?t.recordVersion(e):fail("Document in a transaction was a "+e.constructor.name)}),e})},Transaction.prototype.write=function(e){if(this.committed)throw new f(l.FAILED_PRECONDITION,"Transaction has already completed.");this.mutations=this.mutations.concat(e)},Transaction.prototype.precondition=function(e){var t=this.readVersions.get(e);return t?Se.updateTime(t):Se.NONE},Transaction.prototype.preconditionForUpdate=function(e){var t=this.readVersions.get(e);if(t&&t.isEqual(de.forDeletedDoc()))throw new f(l.FAILED_PRECONDITION,"Can't update a document that doesn't exist.");return t?Se.updateTime(t):Se.exists(!0)},Transaction.prototype.set=function(e,t){this.write(t.toMutations(e,this.precondition(e)))},Transaction.prototype.update=function(e,t){this.write(t.toMutations(e,this.preconditionForUpdate(e)))},Transaction.prototype.delete=function(e){this.write([new Ce(e,this.precondition(e))]),this.readVersions=this.readVersions.insert(e,de.forDeletedDoc())},Transaction.prototype.commit=function(){var e=this,t=this.readVersions;return this.mutations.forEach(function(e){t=t.remove(e.key)}),t.isEmpty()?this.datastore.commit(this.mutations).then(function(){e.committed=!0}):Promise.reject(Error("Every document read in a transaction must also be written."))},Transaction}();!function(e){e[e.Unknown=0]="Unknown",e[e.Online=1]="Online",e[e.Offline=2]="Offline"}(Rn||(Rn={}));var qn;!function(e){e[e.RemoteStore=0]="RemoteStore",e[e.SharedClientState=1]="SharedClientState"}(qn||(qn={}));var Un,Qn=function(){function OnlineStateTracker(e,t){this.asyncQueue=e,this.onlineStateHandler=t,this.state=Rn.Unknown,this.watchStreamFailures=0,this.onlineStateTimer=null,this.shouldWarnClientIsOffline=!0}return OnlineStateTracker.prototype.handleWatchStreamStart=function(){var e=this;0===this.watchStreamFailures&&(this.setAndBroadcast(Rn.Unknown),assert(null===this.onlineStateTimer,"onlineStateTimer shouldn't be started yet"),this.onlineStateTimer=this.asyncQueue.enqueueAfterDelay(lt.OnlineStateTimeout,1e4,function(){return e.onlineStateTimer=null,assert(e.state===Rn.Unknown,"Timer should be canceled if we transitioned to a different state."),e.logClientOfflineWarningIfNecessary("Backend didn't respond within 10 seconds."),e.setAndBroadcast(Rn.Offline),Promise.resolve()}))},OnlineStateTracker.prototype.handleWatchStreamFailure=function(e){this.state===Rn.Online?(this.setAndBroadcast(Rn.Unknown),assert(0===this.watchStreamFailures,"watchStreamFailures must be 0"),assert(null===this.onlineStateTimer,"onlineStateTimer must be null")):++this.watchStreamFailures>=1&&(this.clearOnlineStateTimer(),this.logClientOfflineWarningIfNecessary("Connection failed 1 times. Most recent error: "+e.toString()),this.setAndBroadcast(Rn.Offline))},OnlineStateTracker.prototype.set=function(e){this.clearOnlineStateTimer(),this.watchStreamFailures=0,e===Rn.Online&&(this.shouldWarnClientIsOffline=!1),this.setAndBroadcast(e)},OnlineStateTracker.prototype.setAndBroadcast=function(e){e!==this.state&&(this.state=e,this.onlineStateHandler(e))},OnlineStateTracker.prototype.logClientOfflineWarningIfNecessary=function(e){var t="Could not reach Cloud Firestore backend. "+e+"\nThis typically indicates that your device does not have a healthy Internet connection at the moment. The client will operate in offline mode until it is able to successfully connect to the backend.";this.shouldWarnClientIsOffline?(error(t),this.shouldWarnClientIsOffline=!1):debug("OnlineStateTracker",t)},OnlineStateTracker.prototype.clearOnlineStateTimer=function(){null!==this.onlineStateTimer&&(this.onlineStateTimer.cancel(),this.onlineStateTimer=null)},OnlineStateTracker}(),jn=function(){function RemoteStore(e,t,n,r){this.localStore=e,this.datastore=t,this.writePipeline=[],this.listenTargets={},this.watchChangeAggregator=null,this.networkEnabled=!1,this.isPrimary=!1,this.onlineStateTracker=new Qn(n,r),this.watchStream=this.datastore.newPersistentWatchStream({onOpen:this.onWatchStreamOpen.bind(this),onClose:this.onWatchStreamClose.bind(this),onWatchChange:this.onWatchStreamChange.bind(this)}),this.writeStream=this.datastore.newPersistentWriteStream({onOpen:this.onWriteStreamOpen.bind(this),onClose:this.onWriteStreamClose.bind(this),onHandshakeComplete:this.onWriteHandshakeComplete.bind(this),onMutationResult:this.onMutationResult.bind(this)})}return RemoteStore.prototype.start=function(){return this.enableNetwork()},RemoteStore.prototype.enableNetwork=function(){return a.__awaiter(this,void 0,void 0,function(){var e;return a.__generator(this,function(t){switch(t.label){case 0:return this.networkEnabled=!0,this.canUseNetwork()?(e=this.writeStream,[4,this.localStore.getLastStreamToken()]):[3,3];case 1:return e.lastStreamToken=t.sent(),this.shouldStartWatchStream()?this.startWatchStream():this.onlineStateTracker.set(Rn.Unknown),[4,this.fillWritePipeline()];case 2:t.sent(),t.label=3;case 3:return[2]}})})},RemoteStore.prototype.disableNetwork=function(){return a.__awaiter(this,void 0,void 0,function(){return a.__generator(this,function(e){switch(e.label){case 0:return this.networkEnabled=!1,[4,this.disableNetworkInternal()];case 1:return e.sent(),this.onlineStateTracker.set(Rn.Offline),[2]}})})},RemoteStore.prototype.disableNetworkInternal=function(){return a.__awaiter(this,void 0,void 0,function(){return a.__generator(this,function(e){switch(e.label){case 0:return[4,this.writeStream.stop()];case 1:return e.sent(),[4,this.watchStream.stop()];case 2:return e.sent(),this.writePipeline.length>0&&(debug("RemoteStore","Stopping write stream with "+this.writePipeline.length+" pending writes"),this.writePipeline=[]),this.cleanUpWatchStreamState(),[2]}})})},RemoteStore.prototype.shutdown=function(){return a.__awaiter(this,void 0,void 0,function(){return a.__generator(this,function(e){switch(e.label){case 0:return debug("RemoteStore","RemoteStore shutting down."),this.networkEnabled=!1,[4,this.disableNetworkInternal()];case 1:return e.sent(),this.onlineStateTracker.set(Rn.Unknown),[2]}})})},RemoteStore.prototype.listen=function(e){assert(!contains(this.listenTargets,e.targetId),"listen called with duplicate targetId!"),this.listenTargets[e.targetId]=e,this.shouldStartWatchStream()?this.startWatchStream():this.watchStream.isOpen()&&this.sendWatchRequest(e)},RemoteStore.prototype.unlisten=function(e){assert(contains(this.listenTargets,e),"unlisten called without assigned target ID!"),delete this.listenTargets[e],this.watchStream.isOpen()&&this.sendUnwatchRequest(e),isEmpty(this.listenTargets)&&(this.watchStream.isOpen()?this.watchStream.markIdle():this.canUseNetwork()&&this.onlineStateTracker.set(Rn.Unknown))},RemoteStore.prototype.getQueryDataForTarget=function(e){return this.listenTargets[e]||null},RemoteStore.prototype.getRemoteKeysForTarget=function(e){return this.syncEngine.getRemoteKeysForTarget(e)},RemoteStore.prototype.sendWatchRequest=function(e){this.watchChangeAggregator.recordPendingTargetRequest(e.targetId),this.watchStream.watch(e)},RemoteStore.prototype.sendUnwatchRequest=function(e){this.watchChangeAggregator.recordPendingTargetRequest(e),this.watchStream.unwatch(e)},RemoteStore.prototype.startWatchStream=function(){assert(this.shouldStartWatchStream(),"startWatchStream() called when shouldStartWatchStream() is false."),this.watchChangeAggregator=new He(this),this.watchStream.start(),this.onlineStateTracker.handleWatchStreamStart()},RemoteStore.prototype.shouldStartWatchStream=function(){return this.canUseNetwork()&&!this.watchStream.isStarted()&&!isEmpty(this.listenTargets)},RemoteStore.prototype.canUseNetwork=function(){return this.isPrimary&&this.networkEnabled},RemoteStore.prototype.cleanUpWatchStreamState=function(){this.watchChangeAggregator=null},RemoteStore.prototype.onWatchStreamOpen=function(){return a.__awaiter(this,void 0,void 0,function(){var e=this;return a.__generator(this,function(t){return forEachNumber(this.listenTargets,function(t,n){e.sendWatchRequest(n)}),[2]})})},RemoteStore.prototype.onWatchStreamClose=function(e){return a.__awaiter(this,void 0,void 0,function(){return a.__generator(this,function(t){return void 0===e&&assert(!this.shouldStartWatchStream(),"Watch stream was stopped gracefully while still needed."),this.cleanUpWatchStreamState(),this.shouldStartWatchStream()?(this.onlineStateTracker.handleWatchStreamFailure(e),this.startWatchStream()):this.onlineStateTracker.set(Rn.Unknown),[2]})})},RemoteStore.prototype.onWatchStreamChange=function(e,t){return a.__awaiter(this,void 0,void 0,function(){var n;return a.__generator(this,function(r){switch(r.label){case 0:return this.onlineStateTracker.set(Rn.Online),e instanceof ze&&e.state===Be.Removed&&e.cause?[2,this.handleTargetError(e)]:(e instanceof We?this.watchChangeAggregator.handleDocumentChange(e):e instanceof Ke?this.watchChangeAggregator.handleExistenceFilter(e):(assert(e instanceof ze,"Expected watchChange to be an instance of WatchTargetChange"),this.watchChangeAggregator.handleTargetChange(e)),t.isEqual(de.MIN)?[3,3]:[4,this.localStore.getLastRemoteSnapshotVersion()]);case 1:return n=r.sent(),t.compareTo(n)>=0?[4,this.raiseWatchSnapshot(t)]:[3,3];case 2:r.sent(),r.label=3;case 3:return[2]}})})},RemoteStore.prototype.raiseWatchSnapshot=function(e){var t=this;assert(!e.isEqual(de.MIN),"Can't raise event for unknown SnapshotVersion");var n=this.watchChangeAggregator.createRemoteEvent(e);return forEachNumber(n.targetChanges,function(n,r){if(r.resumeToken.length>0){var i=t.listenTargets[n];i&&(t.listenTargets[n]=i.copy({resumeToken:r.resumeToken,snapshotVersion:e}))}}),n.targetMismatches.forEach(function(e){var n=t.listenTargets[e];if(n){t.listenTargets[e]=n.copy({resumeToken:emptyByteString()}),t.sendUnwatchRequest(e);var r=new me(n.query,e,x.ExistenceFilterMismatch,n.sequenceNumber);t.sendWatchRequest(r)}}),this.syncEngine.applyRemoteEvent(n)},RemoteStore.prototype.handleTargetError=function(e){var t=this;assert(!!e.cause,"Handling target error without a cause");var n=e.cause,r=Promise.resolve();return e.targetIds.forEach(function(e){r=r.then(function(){return a.__awaiter(t,void 0,void 0,function(){return a.__generator(this,function(t){return contains(this.listenTargets,e)?(delete this.listenTargets[e],this.watchChangeAggregator.removeTarget(e),[2,this.syncEngine.rejectListen(e,n)]):[2]})})})}),r},RemoteStore.prototype.fillWritePipeline=function(){return a.__awaiter(this,void 0,void 0,function(){var e,t;return a.__generator(this,function(n){switch(n.label){case 0:return this.canAddToWritePipeline()?(e=this.writePipeline.length>0?this.writePipeline[this.writePipeline.length-1].batchId:wt,[4,this.localStore.nextMutationBatch(e)]):[3,4];case 1:return null!==(t=n.sent())?[3,2]:(0===this.writePipeline.length&&this.writeStream.markIdle(),[3,4]);case 2:return this.addToWritePipeline(t),[4,this.fillWritePipeline()];case 3:n.sent(),n.label=4;case 4:return this.shouldStartWriteStream()&&this.startWriteStream(),[2]}})})},RemoteStore.prototype.canAddToWritePipeline=function(){return this.canUseNetwork()&&this.writePipeline.length<10},RemoteStore.prototype.outstandingWrites=function(){return this.writePipeline.length},RemoteStore.prototype.addToWritePipeline=function(e){assert(this.canAddToWritePipeline(),"addToWritePipeline called when pipeline is full"),this.writePipeline.push(e),this.writeStream.isOpen()&&this.writeStream.handshakeComplete&&this.writeStream.writeMutations(e.mutations)},RemoteStore.prototype.shouldStartWriteStream=function(){return this.canUseNetwork()&&!this.writeStream.isStarted()&&this.writePipeline.length>0},RemoteStore.prototype.startWriteStream=function(){assert(this.shouldStartWriteStream(),"startWriteStream() called when shouldStartWriteStream() is false."),this.writeStream.start()},RemoteStore.prototype.onWriteStreamOpen=function(){return a.__awaiter(this,void 0,void 0,function(){return a.__generator(this,function(e){return this.writeStream.writeHandshake(),[2]})})},RemoteStore.prototype.onWriteHandshakeComplete=function(){var e=this;return this.localStore.setLastStreamToken(this.writeStream.lastStreamToken).then(function(){for(var t=0,n=e.writePipeline;t<n.length;t++){var r=n[t];e.writeStream.writeMutations(r.mutations)}}).catch(function(t){return e.ignoreIfPrimaryLeaseLoss(t)})},RemoteStore.prototype.ignoreIfPrimaryLeaseLoss=function(e){if(!isPrimaryLeaseLostError(e))throw e;debug("RemoteStore","Unexpectedly lost primary lease")},RemoteStore.prototype.onMutationResult=function(e,t){var n=this;assert(this.writePipeline.length>0,"Got result for empty write pipeline");var r=this.writePipeline.shift(),i=Dt.from(r,e,t,this.writeStream.lastStreamToken);return this.syncEngine.applySuccessfulWrite(i).then(function(){return n.fillWritePipeline()})},RemoteStore.prototype.onWriteStreamClose=function(e){return a.__awaiter(this,void 0,void 0,function(){var t,n=this;return a.__generator(this,function(r){return void 0===e&&assert(!this.shouldStartWriteStream(),"Write stream was stopped gracefully while still needed."),e&&this.writePipeline.length>0?(t=void 0,t=this.writeStream.handshakeComplete?this.handleWriteError(e):this.handleHandshakeError(e),[2,t.then(function(){n.shouldStartWriteStream()&&n.startWriteStream()})]):[2]})})},RemoteStore.prototype.handleHandshakeError=function(e){return a.__awaiter(this,void 0,void 0,function(){var t=this;return a.__generator(this,function(n){return isPermanentError(e.code)||e.code===l.ABORTED?(debug("RemoteStore","RemoteStore error before completed handshake; resetting stream token: ",this.writeStream.lastStreamToken),this.writeStream.lastStreamToken=emptyByteString(),[2,this.localStore.setLastStreamToken(emptyByteString()).catch(function(e){return t.ignoreIfPrimaryLeaseLoss(e)})]):[2]})})},RemoteStore.prototype.handleWriteError=function(e){return a.__awaiter(this,void 0,void 0,function(){var t,n=this;return a.__generator(this,function(r){return isPermanentError(e.code)?(t=this.writePipeline.shift(),this.writeStream.inhibitBackoff(),[2,this.syncEngine.rejectFailedWrite(t.batchId,e).then(function(){return n.fillWritePipeline()})]):[2]})})},RemoteStore.prototype.createTransaction=function(){return new Bn(this.datastore)},RemoteStore.prototype.handleCredentialChange=function(){return a.__awaiter(this,void 0,void 0,function(){return a.__generator(this,function(e){switch(e.label){case 0:return this.canUseNetwork()?(debug("RemoteStore","RemoteStore restarting streams for new credential"),this.networkEnabled=!1,[4,this.disableNetworkInternal()]):[3,3];case 1:return e.sent(),this.onlineStateTracker.set(Rn.Unknown),[4,this.enableNetwork()];case 2:e.sent(),e.label=3;case 3:return[2]}})})},RemoteStore.prototype.applyPrimaryState=function(e){return a.__awaiter(this,void 0,void 0,function(){return a.__generator(this,function(t){switch(t.label){case 0:return this.isPrimary=e,e&&this.networkEnabled?[4,this.enableNetwork()]:[3,2];case 1:return t.sent(),[3,4];case 2:return e?[3,4]:[4,this.disableNetworkInternal()];case 3:t.sent(),this.onlineStateTracker.set(Rn.Unknown),t.label=4;case 4:return[2]}})})},RemoteStore}(),Wn=function(){function QueryListenersInfo(){this.listeners=[]}return QueryListenersInfo}(),Kn=function(){function EventManager(e){this.syncEngine=e,this.queries=new Ot(function(e){return e.canonicalId()}),this.onlineState=Rn.Unknown,this.syncEngine.subscribe(this)}return EventManager.prototype.listen=function(e){var t=e.query,n=!1,r=this.queries.get(t);return r||(n=!0,r=new Wn,this.queries.set(t,r)),r.listeners.push(e),e.applyOnlineStateChange(this.onlineState),r.viewSnap&&e.onViewSnapshot(r.viewSnap),n?this.syncEngine.listen(t).then(function(e){return r.targetId=e,e}):Promise.resolve(r.targetId)},EventManager.prototype.unlisten=function(e){return a.__awaiter(this,void 0,void 0,function(){var t,n,r,i;return a.__generator(this,function(o){return t=e.query,n=!1,r=this.queries.get(t),r&&(i=r.listeners.indexOf(e))>=0&&(r.listeners.splice(i,1),n=0===r.listeners.length),n?(this.queries.delete(t),[2,this.syncEngine.unlisten(t)]):[2]})})},EventManager.prototype.onWatchChange=function(e){for(var t=0,n=e;t<n.length;t++){var r=n[t],i=r.query,o=this.queries.get(i);if(o){for(var a=0,s=o.listeners;a<s.length;a++){s[a].onViewSnapshot(r)}o.viewSnap=r}}},EventManager.prototype.onWatchError=function(e,t){var n=this.queries.get(e);if(n)for(var r=0,i=n.listeners;r<i.length;r++){var o=i[r];o.onError(t)}this.queries.delete(e)},EventManager.prototype.onOnlineStateChange=function(e){this.onlineState=e,this.queries.forEach(function(t,n){for(var r=0,i=n.listeners;r<i.length;r++){i[r].applyOnlineStateChange(e)}})},EventManager}(),zn=function(){function QueryListener(e,t,n){this.query=e,this.queryObserver=t,this.raisedInitialEvent=!1,this.onlineState=Rn.Unknown,this.options=n||{}}return QueryListener.prototype.onViewSnapshot=function(e){if(assert(e.docChanges.length>0||e.syncStateChanged,"We got a new snapshot with no changes?"),!this.options.includeMetadataChanges){for(var t=[],n=0,r=e.docChanges;n<r.length;n++){var i=r[n];i.type!==Ne.Metadata&&t.push(i)}e=new Ue(e.query,e.docs,e.oldDocs,t,e.mutatedKeys,e.fromCache,e.syncStateChanged,!0)}this.raisedInitialEvent?this.shouldRaiseEvent(e)&&this.queryObserver.next(e):this.shouldRaiseInitialEvent(e,this.onlineState)&&this.raiseInitialEvent(e),this.snap=e},QueryListener.prototype.onError=function(e){this.queryObserver.error(e)},QueryListener.prototype.applyOnlineStateChange=function(e){this.onlineState=e,this.snap&&!this.raisedInitialEvent&&this.shouldRaiseInitialEvent(this.snap,e)&&this.raiseInitialEvent(this.snap)},QueryListener.prototype.shouldRaiseInitialEvent=function(e,t){if(assert(!this.raisedInitialEvent,"Determining whether to raise first event but already had first event"),!e.fromCache)return!0;var n=t!==Rn.Offline;return this.options.waitForSyncWhenOnline&&n?(assert(e.fromCache,"Waiting for sync, but snapshot is not from cache"),!1):!e.docs.isEmpty()||t===Rn.Offline},QueryListener.prototype.shouldRaiseEvent=function(e){if(e.docChanges.length>0)return!0;var t=this.snap&&this.snap.hasPendingWrites!==e.hasPendingWrites;return!(!e.syncStateChanged&&!t)&&!0===this.options.includeMetadataChanges},QueryListener.prototype.raiseInitialEvent=function(e){assert(!this.raisedInitialEvent,"Trying to raise initial events for second time"),e=Ue.fromInitialDocuments(e.query,e.docs,e.mutatedKeys,e.fromCache),this.raisedInitialEvent=!0,this.queryObserver.next(e)},QueryListener}(),Gn=function(){function LocalViewChanges(e,t,n){this.targetId=e,this.addedKeys=t,this.removedKeys=n}return LocalViewChanges.fromSnapshot=function(e,t){for(var n=documentKeySet(),r=documentKeySet(),i=0,o=t.docChanges;i<o.length;i++){var a=o[i];switch(a.type){case Ne.Added:n=n.add(a.doc.key);break;case Ne.Removed:r=r.add(a.doc.key)}}return new LocalViewChanges(e,n,r)},LocalViewChanges}(),Hn=function(){function AddedLimboDocument(e){this.key=e}return AddedLimboDocument}(),Jn=function(){function RemovedLimboDocument(e){this.key=e}return RemovedLimboDocument}(),Xn=function(){function View(e,t){this.query=e,this._syncedDocuments=t,this.syncState=null,this.current=!1,this.limboDocuments=documentKeySet(),this.mutatedKeys=documentKeySet(),this.documentSet=new Fe(e.docComparator.bind(e))}return Object.defineProperty(View.prototype,"syncedDocuments",{get:function(){return this._syncedDocuments},enumerable:!0,configurable:!0}),View.prototype.computeDocChanges=function(e,t){var n=this,r=t?t.changeSet:new qe,i=t?t.documentSet:this.documentSet,o=t?t.mutatedKeys:this.mutatedKeys,a=i,s=!1,u=this.query.hasLimit()&&i.size===this.query.limit?i.last():null;if(e.inorderTraversal(function(e,t){var c=i.get(e),h=t instanceof _?t:null;h&&(assert(e.isEqual(h.key),"Mismatching keys found in document changes: "+e+" != "+h.key),h=n.query.matches(h)?h:null);var l=!!c&&n.mutatedKeys.has(c.key),f=!!h&&(h.hasLocalMutations||n.mutatedKeys.has(h.key)&&h.hasCommittedMutations),d=!1;if(c&&h){c.data.isEqual(h.data)?l!==f&&(r.track({type:Ne.Metadata,doc:h}),d=!0):n.shouldWaitForSyncedDocument(c,h)||(r.track({type:Ne.Modified,doc:h}),d=!0,u&&n.query.docComparator(h,u)>0&&(s=!0))}else!c&&h?(r.track({type:Ne.Added,doc:h}),d=!0):c&&!h&&(r.track({type:Ne.Removed,doc:c}),d=!0,u&&(s=!0));d&&(h?(a=a.add(h),o=f?o.add(e):o.delete(e)):(a=a.delete(e),o=o.delete(e)))}),this.query.hasLimit())for(;a.size>this.query.limit;){var c=a.last();a=a.delete(c.key),o=o.delete(c.key),r.track({type:Ne.Removed,doc:c})}return assert(!s||!t,"View was refilled using docs that themselves needed refilling."),{documentSet:a,changeSet:r,needsRefill:s,mutatedKeys:o}},View.prototype.shouldWaitForSyncedDocument=function(e,t){return e.hasLocalMutations&&t.hasCommittedMutations&&!t.hasLocalMutations},View.prototype.applyChanges=function(e,t,n){var r=this;assert(!e.needsRefill,"Cannot apply changes that need a refill");var i=this.documentSet;this.documentSet=e.documentSet,this.mutatedKeys=e.mutatedKeys;var o=e.changeSet.getChanges();o.sort(function(e,t){return compareChangeType(e.type,t.type)||r.query.docComparator(e.doc,t.doc)}),this.applyTargetChange(n);var a=t?this.updateLimboDocuments():[],s=0===this.limboDocuments.size&&this.current,u=s?Ve.Synced:Ve.Local,c=u!==this.syncState;if(this.syncState=u,0!==o.length||c){return{snapshot:new Ue(this.query,e.documentSet,i,o,e.mutatedKeys,u===Ve.Local,c,!1),limboChanges:a}}return{limboChanges:a}},View.prototype.applyOnlineStateChange=function(e){return this.current&&e===Rn.Offline?(this.current=!1,this.applyChanges({documentSet:this.documentSet,changeSet:new qe,mutatedKeys:this.mutatedKeys,needsRefill:!1},!1)):{limboChanges:[]}},View.prototype.shouldBeInLimbo=function(e){return!this._syncedDocuments.has(e)&&(!!this.documentSet.has(e)&&!this.documentSet.get(e).hasLocalMutations)},View.prototype.applyTargetChange=function(e){var t=this;e&&(e.addedDocuments.forEach(function(e){return t._syncedDocuments=t._syncedDocuments.add(e)}),e.modifiedDocuments.forEach(function(e){return assert(t._syncedDocuments.has(e),"Modified document "+e+" not found in view.")}),e.removedDocuments.forEach(function(e){return t._syncedDocuments=t._syncedDocuments.delete(e)}),this.current=e.current)},View.prototype.updateLimboDocuments=function(){var e=this;if(!this.current)return[];var t=this.limboDocuments;this.limboDocuments=documentKeySet(),this.documentSet.forEach(function(t){e.shouldBeInLimbo(t.key)&&(e.limboDocuments=e.limboDocuments.add(t.key))});var n=[];return t.forEach(function(t){e.limboDocuments.has(t)||n.push(new Jn(t))}),this.limboDocuments.forEach(function(e){t.has(e)||n.push(new Hn(e))}),n},View.prototype.synchronizeWithPersistedState=function(e,t){this._syncedDocuments=t,this.limboDocuments=documentKeySet();var n=this.computeDocChanges(e);return this.applyChanges(n,!0)},View.prototype.computeInitialSnapshot=function(){return Ue.fromInitialDocuments(this.query,this.documentSet,this.mutatedKeys,this.syncState===Ve.Local)},View}(),Yn=function(){function QueryView(e,t,n){this.query=e,this.targetId=t,this.view=n}return QueryView}(),$n=function(){function LimboResolution(e){this.key=e}return LimboResolution}(),Zn=function(){function SyncEngine(e,t,n,r){this.localStore=e,this.remoteStore=t,this.sharedClientState=n,this.currentUser=r,this.syncEngineListener=null,this.queryViewsByQuery=new Ot(function(e){return e.canonicalId()}),this.queryViewsByTarget={},this.limboTargetsByKey=new N(C.comparator),this.limboResolutionsByTarget={},this.limboDocumentRefs=new bn,this.mutationUserCallbacks={},this.limboTargetIdGenerator=It.forSyncEngine(),this.isPrimary=void 0,this.onlineState=Rn.Unknown}return Object.defineProperty(SyncEngine.prototype,"isPrimaryClient",{get:function(){return!0===this.isPrimary},enumerable:!0,configurable:!0}),SyncEngine.prototype.subscribe=function(e){assert(null!==e,"SyncEngine listener cannot be null"),assert(null===this.syncEngineListener,"SyncEngine already has a subscriber."),this.syncEngineListener=e},SyncEngine.prototype.listen=function(e){return a.__awaiter(this,void 0,void 0,function(){var t,n,r,i,o;return a.__generator(this,function(a){switch(a.label){case 0:return this.assertSubscribed("listen()"),(r=this.queryViewsByQuery.get(e))?(t=r.targetId,this.sharedClientState.addLocalQueryTarget(t),n=r.view.computeInitialSnapshot(),[3,4]):[3,1];case 1:return[4,this.localStore.allocateQuery(e)];case 2:return i=a.sent(),o=this.sharedClientState.addLocalQueryTarget(i.targetId),t=i.targetId,[4,this.initializeViewAndComputeSnapshot(i,"current"===o)];case 3:n=a.sent(),this.isPrimary&&this.remoteStore.listen(i),a.label=4;case 4:return this.syncEngineListener.onWatchChange([n]),[2,t]}})})},SyncEngine.prototype.initializeViewAndComputeSnapshot=function(e,t){var n=this,r=e.query;return this.localStore.executeQuery(r).then(function(i){return n.localStore.remoteDocumentKeys(e.targetId).then(function(o){var a=new Xn(r,o),s=a.computeDocChanges(i),u=je.createSynthesizedTargetChangeForCurrentChange(e.targetId,t&&n.onlineState!==Rn.Offline),c=a.applyChanges(s,!0===n.isPrimary,u);assert(0===c.limboChanges.length,"View returned limbo docs before target ack from the server."),assert(!!c.snapshot,"applyChanges for new view should always return a snapshot");var h=new Yn(r,e.targetId,a);return n.queryViewsByQuery.set(r,h),n.queryViewsByTarget[e.targetId]=h,c.snapshot})})},SyncEngine.prototype.synchronizeViewAndComputeSnapshot=function(e){var t=this;return this.localStore.executeQuery(e.query).then(function(n){return t.localStore.remoteDocumentKeys(e.targetId).then(function(r){return a.__awaiter(t,void 0,void 0,function(){var t;return a.__generator(this,function(i){return t=e.view.synchronizeWithPersistedState(n,r),this.isPrimary&&this.updateTrackedLimbos(e.targetId,t.limboChanges),[2,t]})})})})},SyncEngine.prototype.unlisten=function(e){return a.__awaiter(this,void 0,void 0,function(){var t,n,r=this;return a.__generator(this,function(i){switch(i.label){case 0:return this.assertSubscribed("unlisten()"),(t=this.queryViewsByQuery.get(e),assert(!!t,"Trying to unlisten on query not found:"+e),this.isPrimary)?(this.sharedClientState.removeLocalQueryTarget(t.targetId),n=this.sharedClientState.isActiveQueryTarget(t.targetId),n?[3,2]:[4,this.localStore.releaseQuery(e,!1).then(function(){r.sharedClientState.clearQueryState(t.targetId),r.remoteStore.unlisten(t.targetId),r.removeAndCleanupQuery(t)}).catch(function(e){return r.ignoreIfPrimaryLeaseLoss(e)})]):[3,3];case 1:i.sent(),i.label=2;case 2:return[3,5];case 3:return this.removeAndCleanupQuery(t),[4,this.localStore.releaseQuery(e,!0)];case 4:i.sent(),i.label=5;case 5:return[2]}})})},SyncEngine.prototype.write=function(e,t){var n=this;return this.assertSubscribed("write()"),this.localStore.localWrite(e).then(function(e){return n.sharedClientState.addPendingMutation(e.batchId),n.addMutationCallback(e.batchId,t),n.emitNewSnapsAndNotifyLocalStore(e.changes)}).then(function(){return n.remoteStore.fillWritePipeline()})},SyncEngine.prototype.wrapUpdateFunctionError=function(e){return e},SyncEngine.prototype.runTransaction=function(e,t){var n=this;void 0===t&&(t=5),assert(t>=0,"Got negative number of retries for transaction.");var r=this.remoteStore.createTransaction();return function(){try{var t=e(r);return!isNullOrUndefined(t)&&t.catch&&t.then?t.catch(function(e){return Promise.reject(n.wrapUpdateFunctionError(e))}):Promise.reject(Error("Transaction callback must return a Promise"))}catch(e){return Promise.reject(n.wrapUpdateFunctionError(e))}}().then(function(i){return r.commit().then(function(){return i}).catch(function(r){return 0===t?Promise.reject(r):n.runTransaction(e,t-1)})})},SyncEngine.prototype.applyRemoteEvent=function(e){var t=this;return this.assertSubscribed("applyRemoteEvent()"),this.localStore.applyRemoteEvent(e).then(function(n){return forEach(e.targetChanges,function(e,n){var r=t.limboResolutionsByTarget[e];r&&(assert(n.addedDocuments.size+n.modifiedDocuments.size+n.removedDocuments.size<=1,"Limbo resolution for single document contains multiple changes."),n.addedDocuments.size>0?r.receivedDocument=!0:n.modifiedDocuments.size>0?assert(r.receivedDocument,"Received change for limbo target document without add."):n.removedDocuments.size>0&&(assert(r.receivedDocument,"Received remove for limbo target document without add."),r.receivedDocument=!1))}),t.emitNewSnapsAndNotifyLocalStore(n,e)}).catch(function(e){return t.ignoreIfPrimaryLeaseLoss(e)})},SyncEngine.prototype.applyOnlineStateChange=function(e,t){if(this.isPrimary&&t===qn.RemoteStore||!this.isPrimary&&t===qn.SharedClientState){var n=[];this.queryViewsByQuery.forEach(function(t,r){var i=r.view.applyOnlineStateChange(e);assert(0===i.limboChanges.length,"OnlineState should not affect limbo documents."),i.snapshot&&n.push(i.snapshot)}),this.syncEngineListener.onOnlineStateChange(e),this.syncEngineListener.onWatchChange(n),this.onlineState=e,this.isPrimary&&this.sharedClientState.setOnlineState(e)}},SyncEngine.prototype.rejectListen=function(e,t){return a.__awaiter(this,void 0,void 0,function(){var n,r,i,o,s,u,c=this;return a.__generator(this,function(a){switch(a.label){case 0:return this.assertSubscribed("rejectListens()"),(this.sharedClientState.updateQueryState(e,"rejected",t),n=this.limboResolutionsByTarget[e],r=n&&n.key)?(this.limboTargetsByKey=this.limboTargetsByKey.remove(r),delete this.limboResolutionsByTarget[e],i=new N(C.comparator),i=i.insert(r,new A(r,de.forDeletedDoc())),o=documentKeySet().add(r),s=new Qe(de.MIN,{},new Re(primitiveComparator),i,o),[2,this.applyRemoteEvent(s)]):[3,1];case 1:return u=this.queryViewsByTarget[e],assert(!!u,"Unknown targetId: "+e),[4,this.localStore.releaseQuery(u.query,!1).then(function(){return c.removeAndCleanupQuery(u)}).catch(function(e){return c.ignoreIfPrimaryLeaseLoss(e)})];case 2:a.sent(),this.syncEngineListener.onWatchError(u.query,t),a.label=3;case 3:return[2]}})})},SyncEngine.prototype.applyBatchState=function(e,t,n){return a.__awaiter(this,void 0,void 0,function(){var r;return a.__generator(this,function(i){switch(i.label){case 0:return this.assertSubscribed("applyBatchState()"),[4,this.localStore.lookupMutationDocuments(e)];case 1:return r=i.sent(),null===r?(debug("SyncEngine","Cannot apply mutation batch with id: "+e),[2]):"pending"!==t?[3,3]:[4,this.remoteStore.fillWritePipeline()];case 2:return i.sent(),[3,4];case 3:"acknowledged"===t||"rejected"===t?(this.processUserCallback(e,n||null),this.localStore.removeCachedMutationBatchMetadata(e)):fail("Unknown batchState: "+t),i.label=4;case 4:return[4,this.emitNewSnapsAndNotifyLocalStore(r)];case 5:return i.sent(),[2]}})})},SyncEngine.prototype.applySuccessfulWrite=function(e){var t=this;this.assertSubscribed("applySuccessfulWrite()");var n=e.batch.batchId;return this.processUserCallback(n,null),this.localStore.acknowledgeBatch(e).then(function(e){return t.sharedClientState.updateMutationState(n,"acknowledged"),t.emitNewSnapsAndNotifyLocalStore(e)}).catch(function(e){return t.ignoreIfPrimaryLeaseLoss(e)})},SyncEngine.prototype.rejectFailedWrite=function(e,t){var n=this;return this.assertSubscribed("rejectFailedWrite()"),this.processUserCallback(e,t),this.localStore.rejectBatch(e).then(function(r){return n.sharedClientState.updateMutationState(e,"rejected",t),n.emitNewSnapsAndNotifyLocalStore(r)}).catch(function(e){return n.ignoreIfPrimaryLeaseLoss(e)})},SyncEngine.prototype.addMutationCallback=function(e,t){var n=this.mutationUserCallbacks[this.currentUser.toKey()];n||(n=new N(primitiveComparator)),n=n.insert(e,t),this.mutationUserCallbacks[this.currentUser.toKey()]=n},SyncEngine.prototype.processUserCallback=function(e,t){var n=this.mutationUserCallbacks[this.currentUser.toKey()];if(n){var r=n.get(e);r&&(assert(e===n.minKey(),"Mutation callbacks processed out-of-order?"),t?r.reject(t):r.resolve(),n=n.remove(e)),this.mutationUserCallbacks[this.currentUser.toKey()]=n}},SyncEngine.prototype.removeAndCleanupQuery=function(e){var t=this;if(this.sharedClientState.removeLocalQueryTarget(e.targetId),this.queryViewsByQuery.delete(e.query),delete this.queryViewsByTarget[e.targetId],this.isPrimary){var n=this.limboDocumentRefs.referencesForId(e.targetId);this.limboDocumentRefs.removeReferencesForId(e.targetId),n.forEach(function(e){t.limboDocumentRefs.containsKey(e)||t.removeLimboTarget(e)})}},SyncEngine.prototype.removeLimboTarget=function(e){var t=this.limboTargetsByKey.get(e);null!==t&&(this.remoteStore.unlisten(t),this.limboTargetsByKey=this.limboTargetsByKey.remove(e),delete this.limboResolutionsByTarget[t])},SyncEngine.prototype.updateTrackedLimbos=function(e,t){for(var n=0,r=t;n<r.length;n++){var i=r[n];if(i instanceof Hn)this.limboDocumentRefs.addReference(i.key,e),this.trackLimboChange(i);else if(i instanceof Jn){debug("SyncEngine","Document no longer in limbo: "+i.key),this.limboDocumentRefs.removeReference(i.key,e);var o=this.limboDocumentRefs.containsKey(i.key);o||this.removeLimboTarget(i.key)}else fail("Unknown limbo change: "+JSON.stringify(i))}},SyncEngine.prototype.trackLimboChange=function(e){var t=e.key;if(!this.limboTargetsByKey.get(t)){debug("SyncEngine","New document in limbo: "+t);var n=this.limboTargetIdGenerator.next(),r=ne.atPath(t.path);this.limboResolutionsByTarget[n]=new $n(t),this.remoteStore.listen(new me(r,n,x.LimboResolution,ft.INVALID)),this.limboTargetsByKey=this.limboTargetsByKey.insert(t,n)}},SyncEngine.prototype.currentLimboDocs=function(){return this.limboTargetsByKey},SyncEngine.prototype.emitNewSnapsAndNotifyLocalStore=function(e,t){return a.__awaiter(this,void 0,void 0,function(){var n,r,i,o=this;return a.__generator(this,function(a){switch(a.label){case 0:return n=[],r=[],i=[],this.queryViewsByQuery.forEach(function(a,s){i.push(Promise.resolve().then(function(){var t=s.view.computeDocChanges(e);return t.needsRefill?o.localStore.executeQuery(s.query).then(function(e){return s.view.computeDocChanges(e,t)}):t}).then(function(e){var i=t&&t.targetChanges[s.targetId],a=s.view.applyChanges(e,!0===o.isPrimary,i);if(o.updateTrackedLimbos(s.targetId,a.limboChanges),a.snapshot){o.isPrimary&&o.sharedClientState.updateQueryState(s.targetId,a.snapshot.fromCache?"not-current":"current"),n.push(a.snapshot);var u=Gn.fromSnapshot(s.targetId,a.snapshot);r.push(u)}}))}),[4,Promise.all(i)];case 1:return a.sent(),this.syncEngineListener.onWatchChange(n),[4,this.localStore.notifyLocalViewChanges(r)];case 2:return a.sent(),[2]}})})},SyncEngine.prototype.ignoreIfPrimaryLeaseLoss=function(e){return a.__awaiter(this,void 0,void 0,function(){return a.__generator(this,function(t){if(!isPrimaryLeaseLostError(e))throw e;return debug("SyncEngine","Unexpectedly lost primary lease"),[2]})})},SyncEngine.prototype.assertSubscribed=function(e){assert(null!==this.syncEngineListener,"Trying to call "+e+" before calling subscribe().")},SyncEngine.prototype.handleCredentialChange=function(e){return a.__awaiter(this,void 0,void 0,function(){var t,n;return a.__generator(this,function(r){switch(r.label){case 0:return t=!this.currentUser.isEqual(e),this.currentUser=e,t?[4,this.localStore.handleUserChange(e)]:[3,3];case 1:return n=r.sent(),this.sharedClientState.handleUserChange(e,n.removedBatchIds,n.addedBatchIds),[4,this.emitNewSnapsAndNotifyLocalStore(n.affectedDocuments)];case 2:r.sent(),r.label=3;case 3:return[4,this.remoteStore.handleCredentialChange()];case 4:return r.sent(),[2]}})})},SyncEngine.prototype.applyPrimaryState=function(e){return a.__awaiter(this,void 0,void 0,function(){var t,n,r,i,o,s,u,c=this;return a.__generator(this,function(a){switch(a.label){case 0:return!0!==e||!0===this.isPrimary?[3,3]:(this.isPrimary=!0,[4,this.remoteStore.applyPrimaryState(!0)]);case 1:return a.sent(),t=this.sharedClientState.getAllActiveQueryTargets(),[4,this.synchronizeQueryViewsAndRaiseSnapshots(t.toArray())];case 2:for(n=a.sent(),r=0,i=n;r<i.length;r++)o=i[r],this.remoteStore.listen(o);return[3,7];case 3:return!1!==e||!1===this.isPrimary?[3,7]:(this.isPrimary=!1,s=[],u=Promise.resolve(),forEachNumber(this.queryViewsByTarget,function(e,t){c.sharedClientState.isLocalQueryTarget(e)?s.push(e):u=u.then(function(){return c.unlisten(t.query)}),c.remoteStore.unlisten(t.targetId)}),[4,u]);case 4:return a.sent(),[4,this.synchronizeQueryViewsAndRaiseSnapshots(s)];case 5:return a.sent(),this.resetLimboDocuments(),[4,this.remoteStore.applyPrimaryState(!1)];case 6:a.sent(),a.label=7;case 7:return[2]}})})},SyncEngine.prototype.resetLimboDocuments=function(){var e=this;forEachNumber(this.limboResolutionsByTarget,function(t){e.remoteStore.unlisten(t)}),this.limboDocumentRefs.removeAllReferences(),this.limboResolutionsByTarget=[],this.limboTargetsByKey=new N(C.comparator)},SyncEngine.prototype.synchronizeQueryViewsAndRaiseSnapshots=function(e){for(var t=this,n=Promise.resolve(),r=[],i=[],o=0,s=e;o<s.length;o++){var u=s[o];!function(e){n=n.then(function(){return a.__awaiter(t,void 0,void 0,function(){var t,n,o,s;return a.__generator(this,function(a){switch(a.label){case 0:return n=this.queryViewsByTarget[e],n?[4,this.localStore.releaseQuery(n.query,!0)]:[3,4];case 1:return a.sent(),[4,this.localStore.allocateQuery(n.query)];case 2:return t=a.sent(),[4,this.synchronizeViewAndComputeSnapshot(n)];case 3:return o=a.sent(),o.snapshot&&i.push(o.snapshot),[3,8];case 4:return assert(!0===this.isPrimary,"A secondary tab should never have an active query without an active view."),[4,this.localStore.getQueryForTarget(e)];case 5:return s=a.sent(),assert(!!s,"Query data for target "+e+" not found"),[4,this.localStore.allocateQuery(s)];case 6:return t=a.sent(),[4,this.initializeViewAndComputeSnapshot(t,!1)];case 7:a.sent(),a.label=8;case 8:return r.push(t),[2]}})})})}(u)}return n.then(function(){return t.syncEngineListener.onWatchChange(i),r})},SyncEngine.prototype.getActiveClients=function(){return this.localStore.getActiveClients()},SyncEngine.prototype.applyTargetState=function(e,t,n){return a.__awaiter(this,void 0,void 0,function(){var r,i,o=this;return a.__generator(this,function(s){switch(s.label){case 0:if(this.isPrimary)return debug("SyncEngine","Ignoring unexpected query state notification."),[2];if(!this.queryViewsByTarget[e])return[3,5];switch(r=t){case"current":case"not-current":return[3,1];case"rejected":return[3,2]}return[3,4];case 1:return[2,this.localStore.getNewDocumentChanges().then(function(n){return a.__awaiter(o,void 0,void 0,function(){var r;return a.__generator(this,function(i){switch(i.label){case 0:return r=Qe.createSynthesizedRemoteEventForCurrentChange(e,"current"===t),[4,this.emitNewSnapsAndNotifyLocalStore(n,r)];case 1:return i.sent(),[2]}})})},function(e){return a.__awaiter(o,void 0,void 0,function(){var t;return a.__generator(this,function(n){switch(n.label){case 0:return isDocumentChangeMissingError(e)?(t=[],forEachNumber(this.queryViewsByTarget,function(e){return t.push(e)}),[4,this.synchronizeQueryViewsAndRaiseSnapshots(t)]):[3,2];case 1:return n.sent(),[3,3];case 2:throw e;case 3:return[2]}})})})];case 2:return i=this.queryViewsByTarget[e],this.removeAndCleanupQuery(i),[4,this.localStore.releaseQuery(i.query,!0)];case 3:return s.sent(),this.syncEngineListener.onWatchError(i.query,n),[3,5];case 4:fail("Unexpected target state: "+t),s.label=5;case 5:return[2]}})})},SyncEngine.prototype.applyActiveTargetsChange=function(e,t){return a.__awaiter(this,void 0,void 0,function(){var n,r,i,o,s,u,c,h,l,i,f=this;return a.__generator(this,function(d){switch(d.label){case 0:if(!this.isPrimary)return[2];n=0,r=e,d.label=1;case 1:return n<r.length?(i=r[n],assert(!this.queryViewsByTarget[i],"Trying to add an already active target"),[4,this.localStore.getQueryForTarget(i)]):[3,6];case 2:return o=d.sent(),assert(!!o,"Query data for active target "+i+" not found"),[4,this.localStore.allocateQuery(o)];case 3:return s=d.sent(),[4,this.initializeViewAndComputeSnapshot(s,!1)];case 4:d.sent(),this.remoteStore.listen(s),d.label=5;case 5:return n++,[3,1];case 6:u=function(e){var t;return a.__generator(this,function(n){switch(n.label){case 0:return t=c.queryViewsByTarget[e],t?[4,c.localStore.releaseQuery(t.query,!1).then(function(){f.remoteStore.unlisten(e),f.removeAndCleanupQuery(t)}).catch(function(e){return f.ignoreIfPrimaryLeaseLoss(e)})]:[3,2];case 1:n.sent(),n.label=2;case 2:return[2]}})},c=this,h=0,l=t,d.label=7;case 7:return h<l.length?(i=l[h],[5,u(i)]):[3,10];case 8:d.sent(),d.label=9;case 9:return h++,[3,7];case 10:return[2]}})})},SyncEngine.prototype.enableNetwork=function(){return this.localStore.setNetworkEnabled(!0),this.remoteStore.enableNetwork()},SyncEngine.prototype.disableNetwork=function(){return this.localStore.setNetworkEnabled(!1),this.remoteStore.disableNetwork()},SyncEngine.prototype.getRemoteKeysForTarget=function(e){var t=this.limboResolutionsByTarget[e];return t&&t.receivedDocument?documentKeySet().add(t.key):this.queryViewsByTarget[e]?this.queryViewsByTarget[e].view.syncedDocuments:documentKeySet()},SyncEngine}(),er=function(){function User(e){this.uid=e}return User.prototype.isAuthenticated=function(){return null!=this.uid},User.prototype.toKey=function(){return this.isAuthenticated()?"uid:"+this.uid:"anonymous-user"},User.prototype.isEqual=function(e){return e.uid===this.uid},User.UNAUTHENTICATED=new User(null),User.GOOGLE_CREDENTIALS=new User("google-credentials-uid"),User.FIRST_PARTY=new User("first-party-uid"),User}(),tr="SharedClientState",nr="firestore_clients",rr="firestore_mutations",ir="firestore_targets",or="firestore_online_state",ar="firestore_sequence_number",sr=function(){function MutationMetadata(e,t,n,r){this.user=e,this.batchId=t,this.state=n,this.error=r,assert(void 0!==r==("rejected"===n),"MutationMetadata must contain an error iff state is 'rejected'")}return MutationMetadata.fromWebStorageEntry=function(e,t,n){var r=JSON.parse(n),i="object"==typeof r&&-1!==["pending","acknowledged","rejected"].indexOf(r.state)&&(void 0===r.error||"object"==typeof r.error),o=void 0;return i&&r.error&&(i="string"==typeof r.error.message&&"string"==typeof r.error.code)&&(o=new f(r.error.code,r.error.message)),i?new MutationMetadata(e,t,r.state,o):(error(tr,"Failed to parse mutation state for ID '"+t+"': "+n),null)},MutationMetadata.prototype.toWebStorageJSON=function(){var e={state:this.state,updateTimeMs:Date.now()};return this.error&&(e.error={code:this.error.code,message:this.error.message}),JSON.stringify(e)},MutationMetadata}(),ur=function(){function QueryTargetMetadata(e,t,n){this.targetId=e,this.state=t,this.error=n,assert(void 0!==n==("rejected"===t),"QueryTargetMetadata must contain an error iff state is 'rejected'")}return QueryTargetMetadata.fromWebStorageEntry=function(e,t){var n=JSON.parse(t),r="object"==typeof n&&-1!==["not-current","current","rejected"].indexOf(n.state)&&(void 0===n.error||"object"==typeof n.error),i=void 0;return r&&n.error&&(r="string"==typeof n.error.message&&"string"==typeof n.error.code)&&(i=new f(n.error.code,n.error.message)),r?new QueryTargetMetadata(e,n.state,i):(error(tr,"Failed to parse target state for ID '"+e+"': "+t),null)},QueryTargetMetadata.prototype.toWebStorageJSON=function(){var e={state:this.state,updateTimeMs:Date.now()};return this.error&&(e.error={code:this.error.code,message:this.error.message}),JSON.stringify(e)},QueryTargetMetadata}(),cr=function(){function RemoteClientState(e,t){this.clientId=e,this.activeTargetIds=t}return RemoteClientState.fromWebStorageEntry=function(e,t){for(var n=JSON.parse(t),r="object"==typeof n&&n.activeTargetIds instanceof Array,i=targetIdSet(),o=0;r&&o<n.activeTargetIds.length;++o)r=isSafeInteger(n.activeTargetIds[o]),i=i.add(n.activeTargetIds[o]);return r?new RemoteClientState(e,i):(error(tr,"Failed to parse client data for instance '"+e+"': "+t),null)},RemoteClientState}(),hr=function(){function SharedOnlineState(e,t){this.clientId=e,this.onlineState=t}return SharedOnlineState.fromWebStorageEntry=function(e){var t=JSON.parse(e);return"object"==typeof t&&void 0!==Rn[t.onlineState]&&"string"==typeof t.clientId?new SharedOnlineState(t.clientId,Rn[t.onlineState]):(error(tr,"Failed to parse online state: "+e),null)},SharedOnlineState}(),lr=function(){function LocalClientState(){this.activeTargetIds=targetIdSet()}return LocalClientState.prototype.addQueryTarget=function(e){assert(!this.activeTargetIds.has(e),"Target with ID '"+e+"' already active."),this.activeTargetIds=this.activeTargetIds.add(e)},LocalClientState.prototype.removeQueryTarget=function(e){this.activeTargetIds=this.activeTargetIds.delete(e)},LocalClientState.prototype.toWebStorageJSON=function(){var e={activeTargetIds:this.activeTargetIds.toArray(),updateTimeMs:Date.now()};return JSON.stringify(e)},LocalClientState}(),fr=function(){function WebStorageSharedClientState(e,t,n,r,i){if(this.queue=e,this.platform=t,this.persistenceKey=n,this.localClientId=r,this.syncEngine=null,this.onlineStateHandler=null,this.sequenceNumberHandler=null,this.activeClients={},this.storageListener=this.handleWebStorageEvent.bind(this),this.started=!1,this.earlyEvents=[],!WebStorageSharedClientState.isAvailable(this.platform))throw new f(l.UNIMPLEMENTED,"LocalStorage is not available on this platform.");var o=n.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");this.storage=this.platform.window.localStorage,this.currentUser=i,this.localClientStorageKey=this.toWebStorageClientStateKey(this.localClientId),this.sequenceNumberKey=ar+"_"+n,this.activeClients[this.localClientId]=new lr,this.clientStateKeyRe=new RegExp("^"+nr+"_"+o+"_([^_]*)$"),this.mutationBatchKeyRe=new RegExp("^"+rr+"_"+o+"_(\\d+)(?:_(.*))?$"),this.queryTargetKeyRe=new RegExp("^"+ir+"_"+o+"_(\\d+)$"),this.onlineStateKey=or+"_"+n,this.platform.window.addEventListener("storage",this.storageListener)}return WebStorageSharedClientState.isAvailable=function(e){return!(!e.window||null==e.window.localStorage)},WebStorageSharedClientState.prototype.start=function(){return a.__awaiter(this,void 0,void 0,function(){var e,t,n,r,i,o,s,u,c,h,l,f=this;return a.__generator(this,function(a){switch(a.label){case 0:return assert(!this.started,"WebStorageSharedClientState already started"),assert(null!==this.syncEngine,"syncEngine property must be set before calling start()"),assert(null!==this.onlineStateHandler,"onlineStateHandler property must be set before calling start()"),[4,this.syncEngine.getActiveClients()];case 1:for(e=a.sent(),t=0,n=e;t<n.length;t++)(r=n[t])!==this.localClientId&&(i=this.getItem(this.toWebStorageClientStateKey(r)))&&(o=cr.fromWebStorageEntry(r,i))&&(this.activeClients[o.clientId]=o);for(this.persistClientState(),s=this.storage.getItem(this.onlineStateKey),s&&(u=this.fromWebStorageOnlineState(s))&&this.handleOnlineStateEvent(u),c=0,h=this.earlyEvents;c<h.length;c++)l=h[c],this.handleWebStorageEvent(l);return this.earlyEvents=[],this.platform.window.addEventListener("unload",function(){return f.shutdown()}),this.started=!0,[2]}})})},WebStorageSharedClientState.prototype.writeSequenceNumber=function(e){this.setItem(this.sequenceNumberKey,JSON.stringify(e))},WebStorageSharedClientState.prototype.getAllActiveQueryTargets=function(){var e=targetIdSet();return forEach(this.activeClients,function(t,n){e=e.unionWith(n.activeTargetIds)}),e},WebStorageSharedClientState.prototype.isActiveQueryTarget=function(e){for(var t in this.activeClients)if(this.activeClients.hasOwnProperty(t)&&this.activeClients[t].activeTargetIds.has(e))return!0;return!1},WebStorageSharedClientState.prototype.addPendingMutation=function(e){this.persistMutationState(e,"pending")},WebStorageSharedClientState.prototype.updateMutationState=function(e,t,n){this.persistMutationState(e,t,n),this.removeMutationState(e)},WebStorageSharedClientState.prototype.addLocalQueryTarget=function(e){var t="not-current";if(this.isActiveQueryTarget(e)){var n=this.storage.getItem(this.toWebStorageQueryTargetMetadataKey(e));if(n){var r=ur.fromWebStorageEntry(e,n);r&&(t=r.state)}}return this.localClientState.addQueryTarget(e),this.persistClientState(),t},WebStorageSharedClientState.prototype.removeLocalQueryTarget=function(e){this.localClientState.removeQueryTarget(e),this.persistClientState()},WebStorageSharedClientState.prototype.isLocalQueryTarget=function(e){return this.localClientState.activeTargetIds.has(e)},WebStorageSharedClientState.prototype.clearQueryState=function(e){this.removeItem(this.toWebStorageQueryTargetMetadataKey(e))},WebStorageSharedClientState.prototype.updateQueryState=function(e,t,n){this.persistQueryTargetState(e,t,n)},WebStorageSharedClientState.prototype.handleUserChange=function(e,t,n){var r=this;t.forEach(function(e){r.removeMutationState(e)}),this.currentUser=e,n.forEach(function(e){r.addPendingMutation(e)})},WebStorageSharedClientState.prototype.setOnlineState=function(e){this.persistOnlineState(e)},WebStorageSharedClientState.prototype.shutdown=function(){this.started&&(this.platform.window.removeEventListener("storage",this.storageListener),this.removeItem(this.localClientStorageKey),this.started=!1)},WebStorageSharedClientState.prototype.getItem=function(e){var t=this.storage.getItem(e);return debug(tr,"READ",e,t),t},WebStorageSharedClientState.prototype.setItem=function(e,t){debug(tr,"SET",e,t),this.storage.setItem(e,t)},WebStorageSharedClientState.prototype.removeItem=function(e){debug(tr,"REMOVE",e),this.storage.removeItem(e)},WebStorageSharedClientState.prototype.handleWebStorageEvent=function(e){var t=this;if(e.storageArea===this.storage){if(debug(tr,"EVENT",e.key,e.newValue),e.key===this.localClientStorageKey)return void error("Received WebStorage notification for local change. Another client might have garbage-collected our state");this.queue.enqueueAndForget(function(){return a.__awaiter(t,void 0,void 0,function(){var t,n,r,i,o,s;return a.__generator(this,function(a){if(!this.started)return this.earlyEvents.push(e),[2];if(null===e.key)return[2];if(this.clientStateKeyRe.test(e.key)){if(null==e.newValue)return n=this.fromWebStorageClientStateKey(e.key),[2,this.handleClientStateEvent(n,null)];if(t=this.fromWebStorageClientState(e.key,e.newValue))return[2,this.handleClientStateEvent(t.clientId,t)]}else if(this.mutationBatchKeyRe.test(e.key)){if(null!==e.newValue&&(r=this.fromWebStorageMutationMetadata(e.key,e.newValue)))return[2,this.handleMutationBatchEvent(r)]}else if(this.queryTargetKeyRe.test(e.key)){if(null!==e.newValue&&(i=this.fromWebStorageQueryTargetMetadata(e.key,e.newValue)))return[2,this.handleQueryTargetEvent(i)]}else if(e.key===this.onlineStateKey){if(null!==e.newValue&&(o=this.fromWebStorageOnlineState(e.newValue)))return[2,this.handleOnlineStateEvent(o)]}else e.key===this.sequenceNumberKey&&(assert(!!this.sequenceNumberHandler,"Missing sequenceNumberHandler"),(s=fromWebStorageSequenceNumber(e.newValue))!==ft.INVALID&&this.sequenceNumberHandler(s));return[2]})})})}},Object.defineProperty(WebStorageSharedClientState.prototype,"localClientState",{get:function(){return this.activeClients[this.localClientId]},enumerable:!0,configurable:!0}),WebStorageSharedClientState.prototype.persistClientState=function(){this.setItem(this.localClientStorageKey,this.localClientState.toWebStorageJSON())},WebStorageSharedClientState.prototype.persistMutationState=function(e,t,n){var r=new sr(this.currentUser,e,t,n),i=this.toWebStorageMutationBatchKey(e);this.setItem(i,r.toWebStorageJSON())},WebStorageSharedClientState.prototype.removeMutationState=function(e){var t=this.toWebStorageMutationBatchKey(e);this.removeItem(t)},WebStorageSharedClientState.prototype.persistOnlineState=function(e){var t={clientId:this.localClientId,onlineState:Rn[e]};this.storage.setItem(this.onlineStateKey,JSON.stringify(t))},WebStorageSharedClientState.prototype.persistQueryTargetState=function(e,t,n){var r=this.toWebStorageQueryTargetMetadataKey(e),i=new ur(e,t,n);this.setItem(r,i.toWebStorageJSON())},WebStorageSharedClientState.prototype.toWebStorageClientStateKey=function(e){return assert(-1===e.indexOf("_"),"Client key cannot contain '_', but was '"+e+"'"),nr+"_"+this.persistenceKey+"_"+e},WebStorageSharedClientState.prototype.toWebStorageQueryTargetMetadataKey=function(e){return ir+"_"+this.persistenceKey+"_"+e},WebStorageSharedClientState.prototype.toWebStorageMutationBatchKey=function(e){var t=rr+"_"+this.persistenceKey+"_"+e;return this.currentUser.isAuthenticated()&&(t+="_"+this.currentUser.uid),t},WebStorageSharedClientState.prototype.fromWebStorageClientStateKey=function(e){var t=this.clientStateKeyRe.exec(e);return t?t[1]:null},WebStorageSharedClientState.prototype.fromWebStorageClientState=function(e,t){var n=this.fromWebStorageClientStateKey(e);return assert(null!==n,"Cannot parse client state key '"+e+"'"),cr.fromWebStorageEntry(n,t)},WebStorageSharedClientState.prototype.fromWebStorageMutationMetadata=function(e,t){var n=this.mutationBatchKeyRe.exec(e);assert(null!==n,"Cannot parse mutation batch key '"+e+"'");var r=Number(n[1]),i=void 0!==n[2]?n[2]:null;return sr.fromWebStorageEntry(new er(i),r,t)},WebStorageSharedClientState.prototype.fromWebStorageQueryTargetMetadata=function(e,t){var n=this.queryTargetKeyRe.exec(e);assert(null!==n,"Cannot parse query target key '"+e+"'");var r=Number(n[1]);return ur.fromWebStorageEntry(r,t)},WebStorageSharedClientState.prototype.fromWebStorageOnlineState=function(e){return hr.fromWebStorageEntry(e)},WebStorageSharedClientState.prototype.handleMutationBatchEvent=function(e){return a.__awaiter(this,void 0,void 0,function(){return a.__generator(this,function(t){return e.user.uid!==this.currentUser.uid?(debug(tr,"Ignoring mutation for non-active user "+e.user.uid),[2]):[2,this.syncEngine.applyBatchState(e.batchId,e.state,e.error)]})})},WebStorageSharedClientState.prototype.handleQueryTargetEvent=function(e){return this.syncEngine.applyTargetState(e.targetId,e.state,e.error)},WebStorageSharedClientState.prototype.handleClientStateEvent=function(e,t){var n=this,r=this.getAllActiveQueryTargets();t?this.activeClients[e]=t:delete this.activeClients[e];var i=this.getAllActiveQueryTargets(),o=[],s=[];return i.forEach(function(e){return a.__awaiter(n,void 0,void 0,function(){return a.__generator(this,function(t){return r.has(e)||o.push(e),[2]})})}),r.forEach(function(e){return a.__awaiter(n,void 0,void 0,function(){return a.__generator(this,function(t){return i.has(e)||s.push(e),[2]})})}),this.syncEngine.applyActiveTargetsChange(o,s)},WebStorageSharedClientState.prototype.handleOnlineStateEvent=function(e){this.activeClients[e.clientId]&&this.onlineStateHandler(e.onlineState)},WebStorageSharedClientState}(),dr=function(){function MemorySharedClientState(){this.localState=new lr,this.queryState={},this.syncEngine=null,this.onlineStateHandler=null,this.sequenceNumberHandler=null}return MemorySharedClientState.prototype.addPendingMutation=function(e){},MemorySharedClientState.prototype.updateMutationState=function(e,t,n){},MemorySharedClientState.prototype.addLocalQueryTarget=function(e){return this.localState.addQueryTarget(e),this.queryState[e]||"not-current"},MemorySharedClientState.prototype.updateQueryState=function(e,t,n){this.queryState[e]=t},MemorySharedClientState.prototype.removeLocalQueryTarget=function(e){this.localState.removeQueryTarget(e)},MemorySharedClientState.prototype.isLocalQueryTarget=function(e){return this.localState.activeTargetIds.has(e)},MemorySharedClientState.prototype.clearQueryState=function(e){delete this.queryState[e]},MemorySharedClientState.prototype.getAllActiveQueryTargets=function(){return this.localState.activeTargetIds},MemorySharedClientState.prototype.isActiveQueryTarget=function(e){return this.localState.activeTargetIds.has(e)},MemorySharedClientState.prototype.start=function(){return this.localState=new lr,Promise.resolve()},MemorySharedClientState.prototype.handleUserChange=function(e,t,n){},MemorySharedClientState.prototype.setOnlineState=function(e){},MemorySharedClientState.prototype.shutdown=function(){},MemorySharedClientState.prototype.writeSequenceNumber=function(e){},MemorySharedClientState}(),pr=function(){function FirestoreClient(e,t,n,r){this.platform=e,this.databaseInfo=t,this.credentials=n,this.asyncQueue=r,this.clientId=d.newId()}return FirestoreClient.prototype.start=function(e){var t=this,n=new dt,r=new dt,i=!1;return this.credentials.setChangeListener(function(o){i?t.asyncQueue.enqueueAndForget(function(){return t.handleCredentialChange(o)}):(i=!0,t.initializePersistence(e,r,o).then(function(){return t.initializeRest(o)}).then(n.resolve,n.reject))}),this.asyncQueue.enqueueAndForget(function(){return n.promise}),r.promise},FirestoreClient.prototype.enableNetwork=function(){var e=this;return this.asyncQueue.enqueue(function(){return e.syncEngine.enableNetwork()})},FirestoreClient.prototype.initializePersistence=function(e,t,n){var r=this;return e.enabled?this.startIndexedDbPersistence(n,e).then(t.resolve).catch(function(e){return t.reject(e),r.canFallback(e)?(console.warn("Error enabling offline storage. Falling back to storage disabled: "+e),r.startMemoryPersistence()):Promise.reject(e)}):(t.resolve(),this.startMemoryPersistence())},FirestoreClient.prototype.canFallback=function(e){return e instanceof f?e.code===l.FAILED_PRECONDITION||e.code===l.UNIMPLEMENTED:!("undefined"!=typeof DOMException&&e instanceof DOMException)||(22===e.code||20===e.code)},FirestoreClient.prototype.startIndexedDbPersistence=function(e,t){var n=this;assert(t.enabled,"Should only start IndexedDb persitence with offline persistence enabled.");var r=yn.buildStoragePrefix(this.databaseInfo),i=new $e(this.databaseInfo.databaseId,{useProto3Json:!0});return Promise.resolve().then(function(){return a.__awaiter(n,void 0,void 0,function(){var n,o;return a.__generator(this,function(a){switch(a.label){case 0:if(t.experimentalTabSynchronization&&!fr.isAvailable(this.platform))throw new f(l.UNIMPLEMENTED,"IndexedDB persistence is only available on platforms that support LocalStorage.");return t.experimentalTabSynchronization?(this.sharedClientState=new fr(this.asyncQueue,this.platform,r,this.clientId,e),n=this,[4,yn.createMultiClientIndexedDbPersistence(r,this.clientId,this.platform,this.asyncQueue,i,{sequenceNumberSyncer:this.sharedClientState})]):[3,2];case 1:return n.persistence=a.sent(),[3,4];case 2:return this.sharedClientState=new dr,o=this,[4,yn.createIndexedDbPersistence(r,this.clientId,this.platform,this.asyncQueue,i)];case 3:o.persistence=a.sent(),a.label=4;case 4:return[2]}})})})},FirestoreClient.prototype.startMemoryPersistence=function(){var e=new $e(this.databaseInfo.databaseId,{useProto3Json:!0});return this.persistence=In.createEagerPersistence(this.clientId,e),this.sharedClientState=new dr,Promise.resolve()},FirestoreClient.prototype.initializeRest=function(e){var t=this;return debug("FirestoreClient","Initializing. user=",e.uid),this.platform.loadConnection(this.databaseInfo).then(function(n){return a.__awaiter(t,void 0,void 0,function(){var t,r,i,o,s=this;return a.__generator(this,function(a){switch(a.label){case 0:return this.localStore=new wn(this.persistence,e),t=this.platform.newSerializer(this.databaseInfo.databaseId),r=new Vn(this.asyncQueue,n,this.credentials,t),i=function(e){return s.syncEngine.applyOnlineStateChange(e,qn.RemoteStore)},o=function(e){return s.syncEngine.applyOnlineStateChange(e,qn.SharedClientState)},this.remoteStore=new jn(this.localStore,r,this.asyncQueue,i),this.syncEngine=new Zn(this.localStore,this.remoteStore,this.sharedClientState,e),this.sharedClientState.onlineStateHandler=o,this.remoteStore.syncEngine=this.syncEngine,this.sharedClientState.syncEngine=this.syncEngine,this.eventMgr=new Kn(this.syncEngine),[4,this.sharedClientState.start()];case 1:return a.sent(),[4,this.remoteStore.start()];case 2:return a.sent(),[4,this.persistence.setPrimaryStateListener(function(e){return s.syncEngine.applyPrimaryState(e)})];case 3:return a.sent(),[2]}})})})},FirestoreClient.prototype.handleCredentialChange=function(e){return this.asyncQueue.verifyOperationInProgress(),debug("FirestoreClient","Credential Changed. Current user: "+e.uid),this.syncEngine.handleCredentialChange(e)},FirestoreClient.prototype.disableNetwork=function(){var e=this;return this.asyncQueue.enqueue(function(){return e.syncEngine.disableNetwork()})},FirestoreClient.prototype.shutdown=function(e){var t=this;return this.asyncQueue.enqueue(function(){return a.__awaiter(t,void 0,void 0,function(){return a.__generator(this,function(t){switch(t.label){case 0:return[4,this.remoteStore.shutdown()];case 1:return t.sent(),[4,this.sharedClientState.shutdown()];case 2:return t.sent(),[4,this.persistence.shutdown(e&&e.purgePersistenceWithDataLoss)];case 3:return t.sent(),this.credentials.removeChangeListener(),[2]}})})})},FirestoreClient.prototype.listen=function(e,t,n){var r=this,i=new zn(e,t,n);return this.asyncQueue.enqueueAndForget(function(){return r.eventMgr.listen(i)}),i},FirestoreClient.prototype.unlisten=function(e){var t=this;this.asyncQueue.enqueueAndForget(function(){return t.eventMgr.unlisten(e)})},FirestoreClient.prototype.getDocumentFromLocalCache=function(e){var t=this;return this.asyncQueue.enqueue(function(){return t.localStore.readDocument(e)}).then(function(e){if(e instanceof _)return e;if(e instanceof A)return null;throw new f(l.UNAVAILABLE,"Failed to get document from cache. (However, this document may exist on the server. Run again without setting 'source' in the GetOptions to attempt to retrieve the document from the server.)")})},FirestoreClient.prototype.getDocumentsFromLocalCache=function(e){var t=this;return this.asyncQueue.enqueue(function(){return t.localStore.executeQuery(e)}).then(function(t){var n=documentKeySet(),r=new Xn(e,n),i=r.computeDocChanges(t);return r.applyChanges(i,!1).snapshot})},FirestoreClient.prototype.write=function(e){var t=this,n=new dt;return this.asyncQueue.enqueueAndForget(function(){return t.syncEngine.write(e,n)}),n.promise},FirestoreClient.prototype.databaseId=function(){return this.databaseInfo.databaseId},FirestoreClient.prototype.transaction=function(e){var t=this;return this.asyncQueue.enqueue(function(){return a.__awaiter(t,void 0,void 0,function(){return a.__generator(this,function(e){return[2]})})}).then(function(){return t.syncEngine.runTransaction(e)})},FirestoreClient}(),mr=function(){function AsyncObserver(e){this.observer=e,this.muted=!1}return AsyncObserver.prototype.next=function(e){this.scheduleEvent(this.observer.next,e)},AsyncObserver.prototype.error=function(e){this.scheduleEvent(this.observer.error,e)},AsyncObserver.prototype.mute=function(){this.muted=!0},AsyncObserver.prototype.scheduleEvent=function(e,t){var n=this;this.muted||setTimeout(function(){n.muted||e(t)},0)},AsyncObserver}(),yr=function(){function FieldPath$$1(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];validateNamedArrayAtLeastNumberOfElements("FieldPath",e,"fieldNames",1);for(var n=0;n<e.length;++n)if(validateArgType("FieldPath","string",n,e[n]),0===e[n].length)throw new f(l.INVALID_ARGUMENT,"Invalid field name at argument $(i + 1). Field names must not be empty.");this._internalPath=new E(e)}return FieldPath$$1.documentId=function(){return FieldPath$$1._DOCUMENT_ID},FieldPath$$1.prototype.isEqual=function(e){if(!(e instanceof FieldPath$$1))throw invalidClassError("isEqual","FieldPath",1,e);return this._internalPath.isEqual(e._internalPath)},FieldPath$$1._DOCUMENT_ID=new FieldPath$$1(E.keyField().canonicalString()),FieldPath$$1}(),gr=new RegExp("[~\\*/\\[\\]]"),vr=function(){function OAuthToken(e,t){this.user=t,this.type="OAuth",this.authHeaders={Authorization:"Bearer "+e}}return OAuthToken}(),br=function(){function EmptyCredentialsProvider(){this.changeListener=null}return EmptyCredentialsProvider.prototype.getToken=function(){return Promise.resolve(null)},EmptyCredentialsProvider.prototype.invalidateToken=function(){},EmptyCredentialsProvider.prototype.setChangeListener=function(e){assert(!this.changeListener,"Can only call setChangeListener() once."),this.changeListener=e,e(er.UNAUTHENTICATED)},EmptyCredentialsProvider.prototype.removeChangeListener=function(){assert(null!==this.changeListener,"removeChangeListener() when no listener registered"),this.changeListener=null},EmptyCredentialsProvider}(),Sr=function(){function FirebaseCredentialsProvider(e){var t=this;this.app=e,this.tokenListener=null,this.tokenCounter=0,this.changeListener=null,this.forceRefresh=!1,this.tokenListener=function(){t.tokenCounter++,t.currentUser=t.getUser(),t.changeListener&&t.changeListener(t.currentUser)},this.tokenCounter=0,this.app.INTERNAL.addAuthTokenListener(this.tokenListener)}return FirebaseCredentialsProvider.prototype.getToken=function(){var e=this;assert(null!=this.tokenListener,"getToken cannot be called after listener removed.");var t=this.tokenCounter,n=this.forceRefresh;return this.forceRefresh=!1,this.app.INTERNAL.getToken(n).then(function(n){if(e.tokenCounter!==t)throw new f(l.ABORTED,"getToken aborted due to token change.");return n?(assert("string"==typeof n.accessToken,"Invalid tokenData returned from getToken():"+n),new vr(n.accessToken,e.currentUser)):null})},FirebaseCredentialsProvider.prototype.invalidateToken=function(){this.forceRefresh=!0},FirebaseCredentialsProvider.prototype.setChangeListener=function(e){assert(!this.changeListener,"Can only call setChangeListener() once."),this.changeListener=e,this.currentUser&&e(this.currentUser)},FirebaseCredentialsProvider.prototype.removeChangeListener=function(){assert(null!=this.tokenListener,"removeChangeListener() called twice"),assert(null!==this.changeListener,"removeChangeListener() called when no listener registered"),this.app.INTERNAL.removeAuthTokenListener(this.tokenListener),this.tokenListener=null,this.changeListener=null},FirebaseCredentialsProvider.prototype.getUser=function(){var e=this.app.INTERNAL.getUid();return assert(null===e||"string"==typeof e,"Received invalid UID: "+e),new er(e)},FirebaseCredentialsProvider}(),wr=function(){function FirstPartyToken(e,t){this.gapi=e,this.sessionIndex=t,this.type="FirstParty",this.user=er.FIRST_PARTY,assert(this.gapi&&this.gapi.auth&&this.gapi.auth.getAuthHeaderValueForFirstParty,"unexpected gapi interface")}return Object.defineProperty(FirstPartyToken.prototype,"authHeaders",{get:function(){return{Authorization:this.gapi.auth.getAuthHeaderValueForFirstParty([]),"X-Goog-AuthUser":this.sessionIndex}},enumerable:!0,configurable:!0}),FirstPartyToken}(),Tr=function(){function FirstPartyCredentialsProvider(e,t){this.gapi=e,this.sessionIndex=t,assert(this.gapi&&this.gapi.auth&&this.gapi.auth.getAuthHeaderValueForFirstParty,"unexpected gapi interface")}return FirstPartyCredentialsProvider.prototype.getToken=function(){return Promise.resolve(new wr(this.gapi,this.sessionIndex))},FirstPartyCredentialsProvider.prototype.setChangeListener=function(e){e(er.FIRST_PARTY)},FirstPartyCredentialsProvider.prototype.removeChangeListener=function(){},FirstPartyCredentialsProvider.prototype.invalidateToken=function(){},FirstPartyCredentialsProvider}(),Dr=function(){function FieldValueImpl(e){this._methodName=e}return FieldValueImpl.delete=function(){return Er.instance},FieldValueImpl.serverTimestamp=function(){return Cr.instance},FieldValueImpl.arrayUnion=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return validateAtLeastNumberOfArgs("FieldValue.arrayUnion",arguments,1),new Ir(e)},FieldValueImpl.arrayRemove=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return validateAtLeastNumberOfArgs("FieldValue.arrayRemove",arguments,1),new _r(e)},FieldValueImpl.prototype.isEqual=function(e){return this===e},FieldValueImpl}(),Er=function(e){function DeleteFieldValueImpl(){return e.call(this,"FieldValue.delete")||this}return a.__extends(DeleteFieldValueImpl,e),DeleteFieldValueImpl.instance=new DeleteFieldValueImpl,DeleteFieldValueImpl}(Dr),Cr=function(e){function ServerTimestampFieldValueImpl(){return e.call(this,"FieldValue.serverTimestamp")||this}return a.__extends(ServerTimestampFieldValueImpl,e),ServerTimestampFieldValueImpl.instance=new ServerTimestampFieldValueImpl,ServerTimestampFieldValueImpl}(Dr),Ir=function(e){function ArrayUnionFieldValueImpl(t){var n=e.call(this,"FieldValue.arrayUnion")||this;return n._elements=t,n}return a.__extends(ArrayUnionFieldValueImpl,e),ArrayUnionFieldValueImpl}(Dr),_r=function(e){function ArrayRemoveFieldValueImpl(t){var n=e.call(this,"FieldValue.arrayRemove")||this;return n._elements=t,n}return a.__extends(ArrayRemoveFieldValueImpl,e),ArrayRemoveFieldValueImpl}(Dr),Ar=makeConstructorPrivate(Dr,"Use FieldValue.<field>() instead."),Pr=/^__.*__$/,Nr=function(){function ParsedSetData(e,t,n){this.data=e,this.fieldMask=t,this.fieldTransforms=n}return ParsedSetData.prototype.toMutations=function(e,t){var n=[];return null!==this.fieldMask?n.push(new De(e,this.data,this.fieldMask,t)):n.push(new Te(e,this.data,t)),this.fieldTransforms.length>0&&n.push(new Ee(e,this.fieldTransforms)),n},ParsedSetData}(),Rr=function(){function ParsedUpdateData(e,t,n){this.data=e,this.fieldMask=t,this.fieldTransforms=n}return ParsedUpdateData.prototype.toMutations=function(e,t){var n=[new De(e,this.data,this.fieldMask,t)];return this.fieldTransforms.length>0&&n.push(new Ee(e,this.fieldTransforms)),n},ParsedUpdateData}();!function(e){e[e.Set=0]="Set",e[e.Update=1]="Update",e[e.MergeSet=2]="MergeSet",e[e.Argument=3]="Argument"}(Un||(Un={}));var Mr=function(){function ParseContext(e,t,n,r,i,o){this.dataSource=e,this.methodName=t,this.path=n,this.arrayElement=r,void 0===i&&this.validatePath(),this.arrayElement=void 0!==r&&r,this.fieldTransforms=i||[],this.fieldMask=o||[]}return ParseContext.prototype.childContextForField=function(e){var t=null==this.path?null:this.path.child(e),n=new ParseContext(this.dataSource,this.methodName,t,!1,this.fieldTransforms,this.fieldMask);return n.validatePathSegment(e),n},ParseContext.prototype.childContextForFieldPath=function(e){var t=null==this.path?null:this.path.child(e),n=new ParseContext(this.dataSource,this.methodName,t,!1,this.fieldTransforms,this.fieldMask);return n.validatePath(),n},ParseContext.prototype.childContextForArray=function(e){return new ParseContext(this.dataSource,this.methodName,null,!0,this.fieldTransforms,this.fieldMask)},ParseContext.prototype.createError=function(e){var t=null===this.path||this.path.isEmpty()?"":" (found in field "+this.path.toString()+")";return new f(l.INVALID_ARGUMENT,"Function "+this.methodName+"() called with invalid data. "+e+t)},ParseContext.prototype.contains=function(e){return void 0!==this.fieldMask.find(function(t){return e.isPrefixOf(t)})||void 0!==this.fieldTransforms.find(function(t){return e.isPrefixOf(t.field)})},ParseContext.prototype.validatePath=function(){if(null!==this.path)for(var e=0;e<this.path.length;e++)this.validatePathSegment(this.path.get(e))},ParseContext.prototype.validatePathSegment=function(e){if(isWrite(this.dataSource)&&Pr.test(e))throw this.createError("Document fields cannot begin and end with __")},ParseContext}(),Or=function(){function DocumentKeyReference(e,t){this.databaseId=e,this.key=t}return DocumentKeyReference}(),kr=function(){function UserDataConverter(e){this.preConverter=e}return UserDataConverter.prototype.parseSetData=function(e,t){var n=new Mr(Un.Set,e,E.EMPTY_PATH);validatePlainObject("Data must be an object, but it was:",n,t);var r=this.parseData(t,n);return new Nr(r,null,n.fieldTransforms)},UserDataConverter.prototype.parseMergeData=function(e,t,n){var r=new Mr(Un.MergeSet,e,E.EMPTY_PATH);validatePlainObject("Data must be an object, but it was:",r,t);var i,o,a=this.parseData(t,r);if(n){for(var s=[],u=0,c=n;u<c.length;u++){var h=c[u],d=void 0;if(h instanceof yr)d=h._internalPath;else{if("string"!=typeof h)throw fail("Expected stringOrFieldPath to be a string or a FieldPath");d=fieldPathFromDotSeparatedString(e,h)}if(!r.contains(d))throw new f(l.INVALID_ARGUMENT,"Field '"+d+"' is specified in your field mask but missing from your input data.");s.push(d)}i=new ye(s),o=r.fieldTransforms.filter(function(e){return i.covers(e.field)})}else i=new ye(r.fieldMask),o=r.fieldTransforms;return new Nr(a,i,o)},UserDataConverter.prototype.parseUpdateData=function(e,t){var n=this,r=new Mr(Un.Update,e,E.EMPTY_PATH);validatePlainObject("Data must be an object, but it was:",r,t);var i=[],o=X.EMPTY;forEach(t,function(t,a){var s=fieldPathFromDotSeparatedString(e,t),u=r.childContextForFieldPath(s);if((a=n.runPreConverter(a,u))instanceof Er)i.push(s);else{var c=n.parseData(a,u);null!=c&&(i.push(s),o=o.set(s,c))}});var a=new ye(i);return new Rr(o,a,r.fieldTransforms)},UserDataConverter.prototype.parseUpdateVarargs=function(e,t,n,r){var i=new Mr(Un.Update,e,E.EMPTY_PATH),o=[fieldPathFromArgument(e,t)],a=[n];if(r.length%2!=0)throw new f(l.INVALID_ARGUMENT,"Function "+e+"() needs to be called with an even number of arguments that alternate between field names and values.");for(var s=0;s<r.length;s+=2)o.push(fieldPathFromArgument(e,r[s])),a.push(r[s+1]);for(var u=[],c=X.EMPTY,s=0;s<o.length;++s){var h=o[s],d=i.childContextForFieldPath(h),p=this.runPreConverter(a[s],d);if(p instanceof Er)u.push(h);else{var m=this.parseData(p,d);null!=m&&(u.push(h),c=c.set(h,m))}}var y=new ye(u);return new Rr(c,y,i.fieldTransforms)},UserDataConverter.prototype.parseQueryValue=function(e,t){var n=new Mr(Un.Argument,e,E.EMPTY_PATH),r=this.parseData(t,n);return assert(null!=r,"Parsed data should not be null."),assert(0===n.fieldTransforms.length,"Field transforms should have been disallowed."),r},UserDataConverter.prototype.runPreConverter=function(e,t){try{return this.preConverter(e)}catch(e){var n=errorMessage(e);throw t.createError(n)}},UserDataConverter.prototype.parseData=function(e,t){if(e=this.runPreConverter(e,t),looksLikeJsonObject(e))return validatePlainObject("Unsupported field value:",t,e),this.parseObject(e,t);if(e instanceof Dr)return this.parseSentinelFieldValue(e,t),null;if(t.path&&t.fieldMask.push(t.path),e instanceof Array){if(t.arrayElement)throw t.createError("Nested arrays are not supported");return this.parseArray(e,t)}return this.parseScalarValue(e,t)},UserDataConverter.prototype.parseObject=function(e,t){var n=this,r=new N(primitiveComparator);return isEmpty(e)?t.path&&t.path.length>0&&t.fieldMask.push(t.path):forEach(e,function(e,i){var o=n.parseData(i,t.childContextForField(e));null!=o&&(r=r.insert(e,o))}),new X(r)},UserDataConverter.prototype.parseArray=function(e,t){for(var n=[],r=0,i=0,o=e;i<o.length;i++){var a=o[i],s=this.parseData(a,t.childContextForArray(r));null==s&&(s=B.INSTANCE),n.push(s),r++}return new Y(n)},UserDataConverter.prototype.parseSentinelFieldValue=function(e,t){if(!isWrite(t.dataSource))throw t.createError(e._methodName+"() can only be used with update() and set()");if(null===t.path)throw t.createError(e._methodName+"() is not currently supported inside arrays");if(e instanceof Er){if(t.dataSource!==Un.MergeSet)throw t.dataSource===Un.Update?(assert(t.path.length>0,"FieldValue.delete() at the top level should have already been handled."),t.createError("FieldValue.delete() can only appear at the top level of your update data")):t.createError("FieldValue.delete() cannot be used with set() unless you pass {merge:true}");t.fieldMask.push(t.path)}else if(e instanceof Cr)t.fieldTransforms.push(new ge(t.path,Ie.instance));else if(e instanceof Ir){var n=this.parseArrayTransformElements(e._methodName,e._elements),r=new _e(n);t.fieldTransforms.push(new ge(t.path,r))}else if(e instanceof _r){var n=this.parseArrayTransformElements(e._methodName,e._elements),i=new Ae(n);t.fieldTransforms.push(new ge(t.path,i))}else fail("Unknown FieldValue type: "+e)},UserDataConverter.prototype.parseScalarValue=function(e,t){if(null===e)return B.INSTANCE;if("number"==typeof e)return isSafeInteger(e)?new Q(e):new j(e);if("boolean"==typeof e)return q.of(e);if("string"==typeof e)return new W(e);if(e instanceof Date)return new K(g.fromDate(e));if(e instanceof g)return new K(new g(e.seconds,1e3*Math.floor(e.nanoseconds/1e3)));if(e instanceof y)return new J(e);if(e instanceof p)return new G(e);if(e instanceof Or)return new H(e.databaseId,e.key);throw t.createError("Unsupported field value: "+valueDescription(e))},UserDataConverter.prototype.parseArrayTransformElements=function(e,t){var n=this;return t.map(function(t,r){var i=new Mr(Un.Argument,e,E.EMPTY_PATH);return n.parseData(t,i.childContextForArray(r))})},UserDataConverter}(),Lr="firestore.googleapis.com",xr=!0,Fr=!1,Vr=!1,Br=function(){function FirestoreSettings(e){if(void 0===e.host){if(void 0!==e.ssl)throw new f(l.INVALID_ARGUMENT,"Can't provide ssl option if host option is not set");this.host=Lr,this.ssl=xr}else validateNamedType("settings","non-empty string","host",e.host),this.host=e.host,validateNamedOptionalType("settings","boolean","ssl",e.ssl),this.ssl=defaulted(e.ssl,xr);validateOptionNames("settings",e,["host","ssl","credentials","timestampsInSnapshots"]),validateNamedOptionalType("settings","object","credentials",e.credentials),this.credentials=e.credentials,validateNamedOptionalType("settings","boolean","timestampsInSnapshots",e.timestampsInSnapshots),this.timestampsInSnapshots=defaulted(e.timestampsInSnapshots,Fr)}return FirestoreSettings.prototype.isEqual=function(e){return this.host===e.host&&this.ssl===e.ssl&&this.timestampsInSnapshots===e.timestampsInSnapshots&&this.credentials===e.credentials},FirestoreSettings}(),qr=function(){function FirestoreConfig(){}return FirestoreConfig}(),Ur=function(){function PersistenceSettings(e,t){this.enabled=e,assert(e||!t,"Can only provide PersistenceSettings with persistence enabled"),t=t||{},this.experimentalTabSynchronization=defaulted(t.experimentalTabSynchronization,Vr)}return PersistenceSettings.prototype.isEqual=function(e){return this.enabled===e.enabled&&this.experimentalTabSynchronization===e.experimentalTabSynchronization},PersistenceSettings}(),Qr=function(){function Firestore(e){var t=this;this._queue=new yt,this.INTERNAL={delete:function(e){return a.__awaiter(t,void 0,void 0,function(){return a.__generator(this,function(t){return this._firestoreClient?[2,this._firestoreClient.shutdown(e)]:[2]})})}};var n=new qr;if("object"==typeof e.options){var r=e;n.firebaseApp=r,n.databaseId=Firestore.databaseIdFromApp(r),n.persistenceKey=n.firebaseApp.name,n.credentials=new Sr(r)}else{var i=e;if(!i.projectId)throw new f(l.INVALID_ARGUMENT,"Must provide projectId");n.databaseId=new S(i.projectId,i.database),n.persistenceKey="[DEFAULT]",n.credentials=new br}n.settings=new Br({}),this._config=n,this._databaseId=n.databaseId}return Firestore.prototype.settings=function(e){if(validateExactNumberOfArgs("Firestore.settings",arguments,1),validateArgType("Firestore.settings","object",1,e),contains(e,"persistence"))throw new f(l.INVALID_ARGUMENT,'"persistence" is now specified with a separate call to firestore.enablePersistence().');var t=new Br(e);if(this._firestoreClient&&!this._config.settings.isEqual(t))throw new f(l.FAILED_PRECONDITION,"Firestore has already been started and its settings can no longer be changed. You can only call settings() before calling any other methods on a Firestore object.");this._config.settings=t,void 0!==t.credentials&&(this._config.credentials=makeCredentialsProvider(t.credentials))},Firestore.prototype.enableNetwork=function(){return this.ensureClientConfigured(),this._firestoreClient.enableNetwork()},Firestore.prototype.disableNetwork=function(){return this.ensureClientConfigured(),this._firestoreClient.disableNetwork()},Firestore.prototype.enablePersistence=function(e){if(this._firestoreClient)throw new f(l.FAILED_PRECONDITION,"Firestore has already been started and persistence can no longer be enabled. You can only call enablePersistence() before calling any other methods on a Firestore object.");return this.configureClient(new Ur(!0,e))},Firestore.prototype.ensureClientConfigured=function(){return this._firestoreClient||this.configureClient(new Ur(!1)),this._firestoreClient},Firestore.prototype.configureClient=function(e){var t=this;assert(!!this._config.settings.host,"FirestoreSettings.host cannot be falsey"),this._config.settings.timestampsInSnapshots||error("\nThe behavior for Date objects stored in Firestore is going to change\nAND YOUR APP MAY BREAK.\nTo hide this warning and ensure your app does not break, you need to add the\nfollowing code to your app before calling any other Cloud Firestore methods:\n\n  const firestore = firebase.firestore();\n  const settings = {/* your settings... */ timestampsInSnapshots: true};\n  firestore.settings(settings);\n\nWith this change, timestamps stored in Cloud Firestore will be read back as\nFirebase Timestamp objects instead of as system Date objects. So you will also\nneed to update code expecting a Date to instead expect a Timestamp. For example:\n\n  // Old:\n  const date = snapshot.get('created_at');\n  // New:\n  const timestamp = snapshot.get('created_at');\n  const date = timestamp.toDate();\n\nPlease audit all existing usages of Date when you enable the new behavior. In a\nfuture release, the behavior will change to the new behavior, so if you do not\nfollow these steps, YOUR APP MAY BREAK."),assert(!this._firestoreClient,"configureClient() called multiple times");var n=new v(this._config.databaseId,this._config.persistenceKey,this._config.settings.host,this._config.settings.ssl),r=function(e){if(e instanceof Kr){var n=t._config.databaseId,r=e.firestore._config.databaseId;if(!r.isEqual(n))throw new f(l.INVALID_ARGUMENT,"Document reference is for database "+r.projectId+"/"+r.database+" but should be for database "+n.projectId+"/"+n.database);return new Or(t._config.databaseId,e._key)}return e};return this._dataConverter=new kr(r),this._firestoreClient=new pr(h.getPlatform(),n,this._config.credentials,this._queue),this._firestoreClient.start(e)},Firestore.databaseIdFromApp=function(e){var t=e.options;if(!contains(t,"projectId"))throw new f(l.INVALID_ARGUMENT,'"projectId" not provided in firebase.initializeApp.');var n=t.projectId;if(!n||"string"!=typeof n)throw new f(l.INVALID_ARGUMENT,"projectId must be a string in FirebaseApp.options");return new S(n)},Object.defineProperty(Firestore.prototype,"app",{get:function(){if(!this._config.firebaseApp)throw new f(l.FAILED_PRECONDITION,"Firestore was not initialized using the Firebase SDK. 'app' is not available");return this._config.firebaseApp},enumerable:!0,configurable:!0}),Firestore.prototype.collection=function(e){if(validateExactNumberOfArgs("Firestore.collection",arguments,1),validateArgType("Firestore.collection","non-empty string",1,e),!e)throw new f(l.INVALID_ARGUMENT,"Must provide a non-empty collection path to collection()");return this.ensureClientConfigured(),new Yr(T.fromString(e),this)},Firestore.prototype.doc=function(e){if(validateExactNumberOfArgs("Firestore.doc",arguments,1),validateArgType("Firestore.doc","non-empty string",1,e),!e)throw new f(l.INVALID_ARGUMENT,"Must provide a non-empty document path to doc()");return this.ensureClientConfigured(),Kr.forPath(T.fromString(e),this)},Firestore.prototype.runTransaction=function(e){var t=this;return validateExactNumberOfArgs("Firestore.runTransaction",arguments,1),validateArgType("Firestore.runTransaction","function",1,e),this.ensureClientConfigured().transaction(function(n){return e(new jr(t,n))})},Firestore.prototype.batch=function(){return this.ensureClientConfigured(),new Wr(this)},Object.defineProperty(Firestore,"logLevel",{get:function(){switch(getLogLevel()){case r.DEBUG:return"debug";case r.ERROR:return"error";case r.SILENT:return"silent";default:return fail("Unknown log level: "+getLogLevel())}},enumerable:!0,configurable:!0}),Firestore.setLogLevel=function(e){switch(validateExactNumberOfArgs("Firestore.setLogLevel",arguments,1),validateArgType("Firestore.setLogLevel","non-empty string",1,e),e){case"debug":setLogLevel(r.DEBUG);break;case"error":setLogLevel(r.ERROR);break;case"silent":setLogLevel(r.SILENT);break;default:throw new f(l.INVALID_ARGUMENT,"Invalid log level: "+e)}},Firestore.prototype._areTimestampsInSnapshotsEnabled=function(){return this._config.settings.timestampsInSnapshots},Firestore}(),jr=function(){function Transaction(e,t){this._firestore=e,this._transaction=t}return Transaction.prototype.get=function(e){var t=this;validateExactNumberOfArgs("Transaction.get",arguments,1);var n=validateReference("Transaction.get",e,this._firestore);return this._transaction.lookup([n._key]).then(function(e){if(!e||1!==e.length)return fail("Mismatch in docs returned from document lookup.");var r=e[0];if(r instanceof A)return new Gr(t._firestore,n._key,null,!1,!1);if(r instanceof _)return new Gr(t._firestore,n._key,r,!1,!1);throw fail("BatchGetDocumentsRequest returned unexpected document type: "+r.constructor.name)})},Transaction.prototype.set=function(e,t,n){validateBetweenNumberOfArgs("Transaction.set",arguments,2,3);var r=validateReference("Transaction.set",e,this._firestore);n=validateSetOptions("Transaction.set",n);var i=n.merge||n.mergeFields?this._firestore._dataConverter.parseMergeData("Transaction.set",t,n.mergeFields):this._firestore._dataConverter.parseSetData("Transaction.set",t);return this._transaction.set(r._key,i),this},Transaction.prototype.update=function(e,t,n){for(var r=[],i=3;i<arguments.length;i++)r[i-3]=arguments[i];var o,a;return"string"==typeof t||t instanceof yr?(validateAtLeastNumberOfArgs("Transaction.update",arguments,3),o=validateReference("Transaction.update",e,this._firestore),a=this._firestore._dataConverter.parseUpdateVarargs("Transaction.update",t,n,r)):(validateExactNumberOfArgs("Transaction.update",arguments,2),o=validateReference("Transaction.update",e,this._firestore),a=this._firestore._dataConverter.parseUpdateData("Transaction.update",t)),this._transaction.update(o._key,a),this},Transaction.prototype.delete=function(e){validateExactNumberOfArgs("Transaction.delete",arguments,1);var t=validateReference("Transaction.delete",e,this._firestore);return this._transaction.delete(t._key),this},Transaction}(),Wr=function(){function WriteBatch(e){this._firestore=e,this._mutations=[],this._committed=!1}return WriteBatch.prototype.set=function(e,t,n){validateBetweenNumberOfArgs("WriteBatch.set",arguments,2,3),this.verifyNotCommitted();var r=validateReference("WriteBatch.set",e,this._firestore);n=validateSetOptions("WriteBatch.set",n);var i=n.merge||n.mergeFields?this._firestore._dataConverter.parseMergeData("WriteBatch.set",t,n.mergeFields):this._firestore._dataConverter.parseSetData("WriteBatch.set",t);return this._mutations=this._mutations.concat(i.toMutations(r._key,Se.NONE)),this},WriteBatch.prototype.update=function(e,t,n){for(var r=[],i=3;i<arguments.length;i++)r[i-3]=arguments[i];this.verifyNotCommitted();var o,a;return"string"==typeof t||t instanceof yr?(validateAtLeastNumberOfArgs("WriteBatch.update",arguments,3),o=validateReference("WriteBatch.update",e,this._firestore),a=this._firestore._dataConverter.parseUpdateVarargs("WriteBatch.update",t,n,r)):(validateExactNumberOfArgs("WriteBatch.update",arguments,2),o=validateReference("WriteBatch.update",e,this._firestore),a=this._firestore._dataConverter.parseUpdateData("WriteBatch.update",t)),this._mutations=this._mutations.concat(a.toMutations(o._key,Se.exists(!0))),this},WriteBatch.prototype.delete=function(e){validateExactNumberOfArgs("WriteBatch.delete",arguments,1),this.verifyNotCommitted();var t=validateReference("WriteBatch.delete",e,this._firestore);return this._mutations=this._mutations.concat(new Ce(t._key,Se.NONE)),this},WriteBatch.prototype.commit=function(){return a.__awaiter(this,void 0,void 0,function(){return a.__generator(this,function(e){return this.verifyNotCommitted(),this._committed=!0,this._mutations.length>0?[2,this._firestore.ensureClientConfigured().write(this._mutations)]:[2]})})},WriteBatch.prototype.verifyNotCommitted=function(){if(this._committed)throw new f(l.FAILED_PRECONDITION,"A write batch can no longer be used after commit() has been called.")},WriteBatch}(),Kr=function(){function DocumentReference(e,t){this._key=e,this.firestore=t,this._firestoreClient=this.firestore.ensureClientConfigured()}return DocumentReference.forPath=function(e,t){if(e.length%2!=0)throw new f(l.INVALID_ARGUMENT,"Invalid document reference. Document references must have an even number of segments, but "+e.canonicalString()+" has "+e.length);return new DocumentReference(new C(e),t)},Object.defineProperty(DocumentReference.prototype,"id",{get:function(){return this._key.path.lastSegment()},enumerable:!0,configurable:!0}),Object.defineProperty(DocumentReference.prototype,"parent",{get:function(){return new Yr(this._key.path.popLast(),this.firestore)},enumerable:!0,configurable:!0}),Object.defineProperty(DocumentReference.prototype,"path",{get:function(){return this._key.path.canonicalString()},enumerable:!0,configurable:!0}),DocumentReference.prototype.collection=function(e){if(validateExactNumberOfArgs("DocumentReference.collection",arguments,1),validateArgType("DocumentReference.collection","non-empty string",1,e),!e)throw new f(l.INVALID_ARGUMENT,"Must provide a non-empty collection name to collection()");var t=T.fromString(e);return new Yr(this._key.path.child(t),this.firestore)},DocumentReference.prototype.isEqual=function(e){if(!(e instanceof DocumentReference))throw invalidClassError("isEqual","DocumentReference",1,e);return this.firestore===e.firestore&&this._key.isEqual(e._key)},DocumentReference.prototype.set=function(e,t){validateBetweenNumberOfArgs("DocumentReference.set",arguments,1,2),t=validateSetOptions("DocumentReference.set",t);var n=t.merge||t.mergeFields?this.firestore._dataConverter.parseMergeData("DocumentReference.set",e,t.mergeFields):this.firestore._dataConverter.parseSetData("DocumentReference.set",e);return this._firestoreClient.write(n.toMutations(this._key,Se.NONE))},DocumentReference.prototype.update=function(e,t){for(var n=[],r=2;r<arguments.length;r++)n[r-2]=arguments[r];var i;return"string"==typeof e||e instanceof yr?(validateAtLeastNumberOfArgs("DocumentReference.update",arguments,2),i=this.firestore._dataConverter.parseUpdateVarargs("DocumentReference.update",e,t,n)):(validateExactNumberOfArgs("DocumentReference.update",arguments,1),i=this.firestore._dataConverter.parseUpdateData("DocumentReference.update",e)),this._firestoreClient.write(i.toMutations(this._key,Se.exists(!0)))},DocumentReference.prototype.delete=function(){return validateExactNumberOfArgs("DocumentReference.delete",arguments,0),this._firestoreClient.write([new Ce(this._key,Se.NONE)])},DocumentReference.prototype.onSnapshot=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];validateBetweenNumberOfArgs("DocumentReference.onSnapshot",arguments,1,4);var n,r={includeMetadataChanges:!1},i=0;"object"!=typeof e[i]||isPartialObserver(e[i])||(r=e[i],validateOptionNames("DocumentReference.onSnapshot",r,["includeMetadataChanges"]),validateNamedOptionalType("DocumentReference.onSnapshot","boolean","includeMetadataChanges",r.includeMetadataChanges),i++);var o={includeMetadataChanges:r.includeMetadataChanges};return isPartialObserver(e[i])?n=e[i]:(validateArgType("DocumentReference.onSnapshot","function",i,e[i]),validateOptionalArgType("DocumentReference.onSnapshot","function",i+1,e[i+1]),validateOptionalArgType("DocumentReference.onSnapshot","function",i+2,e[i+2]),n={next:e[i],error:e[i+1],complete:e[i+2]}),this.onSnapshotInternal(o,n)},DocumentReference.prototype.onSnapshotInternal=function(e,t){var n=this,r=function(e){console.error("Uncaught Error in onSnapshot:",e)};t.error&&(r=t.error.bind(t));var i=new mr({next:function(e){if(t.next){assert(e.docs.size<=1,"Too many documents returned on a document query");var r=e.docs.get(n._key);t.next(new Gr(n.firestore,n._key,r,e.fromCache,e.hasPendingWrites))}},error:r}),o=this._firestoreClient.listen(ne.atPath(this._key.path),i,e);return function(){i.mute(),n._firestoreClient.unlisten(o)}},DocumentReference.prototype.get=function(e){var t=this;return validateBetweenNumberOfArgs("DocumentReference.get",arguments,0,1),validateGetOptions("DocumentReference.get",e),new Promise(function(n,r){e&&"cache"===e.source?t.firestore.ensureClientConfigured().getDocumentFromLocalCache(t._key).then(function(e){n(new Gr(t.firestore,t._key,e,!0,e instanceof _&&e.hasLocalMutations))},r):t.getViaSnapshotListener(n,r,e)})},DocumentReference.prototype.getViaSnapshotListener=function(e,t,n){var r=this.onSnapshotInternal({includeMetadataChanges:!0,waitForSyncWhenOnline:!0},{next:function(i){r(),!i.exists&&i.metadata.fromCache?t(new f(l.UNAVAILABLE,"Failed to get document because the client is offline.")):i.exists&&i.metadata.fromCache&&n&&"server"===n.source?t(new f(l.UNAVAILABLE,'Failed to get document from server. (However, this document does exist in the local cache. Run again without setting source to "server" to retrieve the cached document.)')):e(i)},error:t})},DocumentReference}(),zr=function(){function SnapshotMetadata(e,t){this.hasPendingWrites=e,this.fromCache=t}return SnapshotMetadata.prototype.isEqual=function(e){return this.hasPendingWrites===e.hasPendingWrites&&this.fromCache===e.fromCache},SnapshotMetadata}(),Gr=function(){function DocumentSnapshot(e,t,n,r,i){this._firestore=e,this._key=t,this._document=n,this._fromCache=r,this._hasPendingWrites=i}return DocumentSnapshot.prototype.data=function(e){return validateBetweenNumberOfArgs("DocumentSnapshot.data",arguments,0,1),e=validateSnapshotOptions("DocumentSnapshot.data",e),this._document?this.convertObject(this._document.data,F.fromSnapshotOptions(e,this._firestore._areTimestampsInSnapshotsEnabled())):void 0},DocumentSnapshot.prototype.get=function(e,t){if(validateBetweenNumberOfArgs("DocumentSnapshot.get",arguments,1,2),t=validateSnapshotOptions("DocumentSnapshot.get",t),this._document){var n=this._document.data.field(fieldPathFromArgument("DocumentSnapshot.get",e));if(void 0!==n)return this.convertValue(n,F.fromSnapshotOptions(t,this._firestore._areTimestampsInSnapshotsEnabled()))}},Object.defineProperty(DocumentSnapshot.prototype,"id",{get:function(){return this._key.path.lastSegment()},enumerable:!0,configurable:!0}),Object.defineProperty(DocumentSnapshot.prototype,"ref",{get:function(){return new Kr(this._key,this._firestore)},enumerable:!0,configurable:!0}),Object.defineProperty(DocumentSnapshot.prototype,"exists",{get:function(){return null!==this._document},enumerable:!0,configurable:!0}),Object.defineProperty(DocumentSnapshot.prototype,"metadata",{get:function(){return new zr(this._hasPendingWrites,this._fromCache)},enumerable:!0,configurable:!0}),DocumentSnapshot.prototype.isEqual=function(e){if(!(e instanceof DocumentSnapshot))throw invalidClassError("isEqual","DocumentSnapshot",1,e);return this._firestore===e._firestore&&this._fromCache===e._fromCache&&this._key.isEqual(e._key)&&(null===this._document?null===e._document:this._document.isEqual(e._document))},DocumentSnapshot.prototype.convertObject=function(e,t){var n=this,r={};return e.forEach(function(e,i){r[e]=n.convertValue(i,t)}),r},DocumentSnapshot.prototype.convertValue=function(e,t){if(e instanceof X)return this.convertObject(e,t);if(e instanceof Y)return this.convertArray(e,t);if(e instanceof H){var n=e.value(t),r=this._firestore.ensureClientConfigured().databaseId();return e.databaseId.isEqual(r)||error("Document "+this._key.path+" contains a document reference within a different database ("+e.databaseId.projectId+"/"+e.databaseId.database+") which is not supported. It will be treated as a reference in the current database ("+r.projectId+"/"+r.database+") instead."),new Kr(n,this._firestore)}return e.value(t)},DocumentSnapshot.prototype.convertArray=function(e,t){var n=this;return e.internalValue.map(function(e){return n.convertValue(e,t)})},DocumentSnapshot}(),Hr=function(e){function QueryDocumentSnapshot(t,n,r,i,o){return e.call(this,t,n,r,i,o)||this}return a.__extends(QueryDocumentSnapshot,e),QueryDocumentSnapshot.prototype.data=function(t){var n=e.prototype.data.call(this,t);return assert("object"==typeof n,"Document in a QueryDocumentSnapshot should exist"),n},QueryDocumentSnapshot}(Gr),Jr=function(){function Query$$1(e,t){this._query=e,this.firestore=t}return Query$$1.prototype.where=function(e,t,n){validateExactNumberOfArgs("Query.where",arguments,3),validateArgType("Query.where","non-empty string",2,t),validateDefined("Query.where",3,n);var r,i=fieldPathFromArgument("Query.where",e),o=ie.fromString(t);if(i.isKeyField()){if(o===ie.ARRAY_CONTAINS)throw new f(l.INVALID_ARGUMENT,"Invalid Query. You can't perform array-contains queries on FieldPath.documentId() since document IDs are not arrays.");if("string"==typeof n){if(-1!==n.indexOf("/"))throw new f(l.INVALID_ARGUMENT,"Function Query.where() requires its third parameter to be a valid document ID if the first parameter is FieldPath.documentId(), but it contains a slash.");if(""===n)throw new f(l.INVALID_ARGUMENT,"Function Query.where() requires its third parameter to be a valid document ID if the first parameter is FieldPath.documentId(), but it was an empty string.");var a=this._query.path.child(new T([n]));assert(a.length%2==0,"Path should be a document key"),r=new H(this.firestore._databaseId,new C(a))}else{if(!(n instanceof Kr))throw new f(l.INVALID_ARGUMENT,"Function Query.where() requires its third parameter to be a string or a DocumentReference if the first parameter is FieldPath.documentId(), but it was: "+valueDescription(n)+".");var s=n;r=new H(this.firestore._databaseId,s._key)}}else r=this.firestore._dataConverter.parseQueryValue("Query.where",n);var u=re.create(i,o,r);return this.validateNewFilter(u),new Query$$1(this._query.addFilter(u),this.firestore)},Query$$1.prototype.orderBy=function(e,t){validateBetweenNumberOfArgs("Query.orderBy",arguments,1,2),validateOptionalArgType("Query.orderBy","non-empty string",2,t);var n;if(void 0===t||"asc"===t)n=ue.ASCENDING;else{if("desc"!==t)throw new f(l.INVALID_ARGUMENT,"Function Query.orderBy() has unknown direction '"+t+"', expected 'asc' or 'desc'.");n=ue.DESCENDING}if(null!==this._query.startAt)throw new f(l.INVALID_ARGUMENT,"Invalid query. You must not call Query.startAt() or Query.startAfter() before calling Query.orderBy().");if(null!==this._query.endAt)throw new f(l.INVALID_ARGUMENT,"Invalid query. You must not call Query.endAt() or Query.endBefore() before calling Query.orderBy().");var r=fieldPathFromArgument("Query.orderBy",e),i=new he(r,n);return this.validateNewOrderBy(i),new Query$$1(this._query.addOrderBy(i),this.firestore)},Query$$1.prototype.limit=function(e){if(validateExactNumberOfArgs("Query.limit",arguments,1),validateArgType("Query.limit","number",1,e),e<=0)throw new f(l.INVALID_ARGUMENT,"Invalid Query. Query limit ("+e+") is invalid. Limit must be positive.");return new Query$$1(this._query.withLimit(e),this.firestore)},Query$$1.prototype.startAt=function(e){for(var t=[],n=1;n<arguments.length;n++)t[n-1]=arguments[n];validateAtLeastNumberOfArgs("Query.startAt",arguments,1);var r=this.boundFromDocOrFields("Query.startAt",e,t,!0);return new Query$$1(this._query.withStartAt(r),this.firestore)},Query$$1.prototype.startAfter=function(e){for(var t=[],n=1;n<arguments.length;n++)t[n-1]=arguments[n];validateAtLeastNumberOfArgs("Query.startAfter",arguments,1);var r=this.boundFromDocOrFields("Query.startAfter",e,t,!1);return new Query$$1(this._query.withStartAt(r),this.firestore)},Query$$1.prototype.endBefore=function(e){for(var t=[],n=1;n<arguments.length;n++)t[n-1]=arguments[n];validateAtLeastNumberOfArgs("Query.endBefore",arguments,1);var r=this.boundFromDocOrFields("Query.endBefore",e,t,!0);return new Query$$1(this._query.withEndAt(r),this.firestore)},Query$$1.prototype.endAt=function(e){for(var t=[],n=1;n<arguments.length;n++)t[n-1]=arguments[n];validateAtLeastNumberOfArgs("Query.endAt",arguments,1);var r=this.boundFromDocOrFields("Query.endAt",e,t,!1);return new Query$$1(this._query.withEndAt(r),this.firestore)},Query$$1.prototype.isEqual=function(e){if(!(e instanceof Query$$1))throw invalidClassError("isEqual","Query",1,e);return this.firestore===e.firestore&&this._query.isEqual(e._query)},Query$$1.prototype.boundFromDocOrFields=function(e,t,n,r){if(validateDefined(e,1,t),t instanceof Gr){if(n.length>0)throw new f(l.INVALID_ARGUMENT,"Too many arguments provided to "+e+"().");var i=t;if(!i.exists)throw new f(l.NOT_FOUND,"Can't use a DocumentSnapshot that doesn't exist for "+e+"().");return this.boundFromDocument(e,i._document,r)}var o=[t].concat(n);return this.boundFromFields(e,o,r)},Query$$1.prototype.boundFromDocument=function(e,t,n){for(var r=[],i=0,o=this._query.orderBy;i<o.length;i++){var a=o[i];if(a.field.isKeyField())r.push(new H(this.firestore._databaseId,t.key));else{var s=t.field(a.field);if(void 0===s){var u=a.field.canonicalString();throw new f(l.INVALID_ARGUMENT,"Invalid query. You are trying to start or end a query using a document for which the field '"+u+"' (used as the orderBy) does not exist.")}r.push(s)}}return new ce(r,n)},Query$$1.prototype.boundFromFields=function(e,t,n){var r=this._query.explicitOrderBy;if(t.length>r.length)throw new f(l.INVALID_ARGUMENT,"Too many arguments provided to "+e+"(). The number of arguments must be less than or equal to the number of Query.orderBy() clauses");for(var i=[],o=0;o<t.length;o++){var a=t[o];if(r[o].field.isKeyField()){if("string"!=typeof a)throw new f(l.INVALID_ARGUMENT,"Invalid query. Expected a string for document ID in "+e+"(), but got a "+typeof a);if(-1!==a.indexOf("/"))throw new f(l.INVALID_ARGUMENT,"Invalid query. Document ID '"+a+"' contains a slash in "+e+"()");var s=new C(this._query.path.child(a));i.push(new H(this.firestore._databaseId,s))}else{var u=this.firestore._dataConverter.parseQueryValue(e,a);i.push(u)}}return new ce(i,n)},Query$$1.prototype.onSnapshot=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];validateBetweenNumberOfArgs("Query.onSnapshot",arguments,1,4);var n,r={},i=0;return"object"!=typeof e[i]||isPartialObserver(e[i])||(r=e[i],validateOptionNames("Query.onSnapshot",r,["includeMetadataChanges"]),validateNamedOptionalType("Query.onSnapshot","boolean","includeMetadataChanges",r.includeMetadataChanges),i++),isPartialObserver(e[i])?n=e[i]:(validateArgType("Query.onSnapshot","function",i,e[i]),validateOptionalArgType("Query.onSnapshot","function",i+1,e[i+1]),validateOptionalArgType("Query.onSnapshot","function",i+2,e[i+2]),n={next:e[i],error:e[i+1],complete:e[i+2]}),this.onSnapshotInternal(r,n)},Query$$1.prototype.onSnapshotInternal=function(e,t){var n=this,r=function(e){console.error("Uncaught Error in onSnapshot:",e)};t.error&&(r=t.error.bind(t));var i=new mr({next:function(e){t.next&&t.next(new Xr(n.firestore,n._query,e))},error:r}),o=this.firestore.ensureClientConfigured(),a=o.listen(this._query,i,e);return function(){i.mute(),o.unlisten(a)}},Query$$1.prototype.get=function(e){var t=this;return validateBetweenNumberOfArgs("Query.get",arguments,0,1),validateGetOptions("Query.get",e),new Promise(function(n,r){e&&"cache"===e.source?t.firestore.ensureClientConfigured().getDocumentsFromLocalCache(t._query).then(function(e){n(new Xr(t.firestore,t._query,e))},r):t.getViaSnapshotListener(n,r,e)})},Query$$1.prototype.getViaSnapshotListener=function(e,t,n){var r=this.onSnapshotInternal({includeMetadataChanges:!0,waitForSyncWhenOnline:!0},{next:function(i){r(),i.metadata.fromCache&&n&&"server"===n.source?t(new f(l.UNAVAILABLE,'Failed to get documents from server. (However, these documents may exist in the local cache. Run again without setting source to "server" to retrieve the cached documents.)')):e(i)},error:t})},Query$$1.prototype.validateNewFilter=function(e){if(e instanceof oe)if(e.isInequality()){var t=this._query.getInequalityFilterField();if(null!==t&&!t.isEqual(e.field))throw new f(l.INVALID_ARGUMENT,"Invalid query. All where filters with an inequality (<, <=, >, or >=) must be on the same field. But you have inequality filters on '"+t.toString()+"' and '"+e.field.toString()+"'");var n=this._query.getFirstOrderByField();null!==n&&this.validateOrderByAndInequalityMatch(e.field,n)}else if(e.op===ie.ARRAY_CONTAINS&&this._query.hasArrayContainsFilter())throw new f(l.INVALID_ARGUMENT,"Invalid query. Queries only support a single array-contains filter.")},Query$$1.prototype.validateNewOrderBy=function(e){if(null===this._query.getFirstOrderByField()){var t=this._query.getInequalityFilterField();null!==t&&this.validateOrderByAndInequalityMatch(t,e.field)}},Query$$1.prototype.validateOrderByAndInequalityMatch=function(e,t){if(!t.isEqual(e))throw new f(l.INVALID_ARGUMENT,"Invalid query. You have a where filter with an inequality (<, <=, >, or >=) on field '"+e.toString()+"' and so you must also use '"+e.toString()+"' as your first Query.orderBy(), but your first Query.orderBy() is on field '"+t.toString()+"' instead.")},Query$$1}(),Xr=function(){function QuerySnapshot(e,t,n){this._firestore=e,this._originalQuery=t,this._snapshot=n,this._cachedChanges=null,this._cachedChangesIncludeMetadataChanges=null,this.metadata=new zr(n.hasPendingWrites,n.fromCache)}return Object.defineProperty(QuerySnapshot.prototype,"docs",{get:function(){var e=[];return this.forEach(function(t){return e.push(t)}),e},enumerable:!0,configurable:!0}),Object.defineProperty(QuerySnapshot.prototype,"empty",{get:function(){return this._snapshot.docs.isEmpty()},enumerable:!0,configurable:!0}),Object.defineProperty(QuerySnapshot.prototype,"size",{get:function(){return this._snapshot.docs.size},enumerable:!0,configurable:!0}),QuerySnapshot.prototype.forEach=function(e,t){var n=this;validateBetweenNumberOfArgs("QuerySnapshot.forEach",arguments,1,2),validateArgType("QuerySnapshot.forEach","function",1,e),this._snapshot.docs.forEach(function(r){e.call(t,n.convertToDocumentImpl(r))})},Object.defineProperty(QuerySnapshot.prototype,"query",{get:function(){return new Jr(this._originalQuery,this._firestore)},enumerable:!0,configurable:!0}),QuerySnapshot.prototype.docChanges=function(e){e&&(validateOptionNames("QuerySnapshot.docChanges",e,["includeMetadataChanges"]),validateNamedOptionalType("QuerySnapshot.docChanges","boolean","includeMetadataChanges",e.includeMetadataChanges));var t=!(!e||!e.includeMetadataChanges);if(t&&this._snapshot.excludesMetadataChanges)throw new f(l.INVALID_ARGUMENT,"To include metadata changes with your document changes, you must also pass { includeMetadataChanges:true } to onSnapshot().");return this._cachedChanges&&this._cachedChangesIncludeMetadataChanges===t||(this._cachedChanges=changesFromSnapshot(this._firestore,t,this._snapshot),this._cachedChangesIncludeMetadataChanges=t),this._cachedChanges},QuerySnapshot.prototype.isEqual=function(e){if(!(e instanceof QuerySnapshot))throw invalidClassError("isEqual","QuerySnapshot",1,e);return this._firestore===e._firestore&&this._originalQuery.isEqual(e._originalQuery)&&this._snapshot.isEqual(e._snapshot)},QuerySnapshot.prototype.convertToDocumentImpl=function(e){return new Hr(this._firestore,e.key,e,this.metadata.fromCache,this._snapshot.mutatedKeys.has(e.key))},QuerySnapshot}();["length","forEach","map"].concat("undefined"!=typeof Symbol?[Symbol.iterator]:[]).forEach(function(e){try{Object.defineProperty(Xr.prototype.docChanges,e,{get:function(){return throwDocChangesMethodError()}})}catch(e){}});var Yr=function(e){function CollectionReference(t,n){var r=e.call(this,ne.atPath(t),n)||this;if(t.length%2!=1)throw new f(l.INVALID_ARGUMENT,"Invalid collection reference. Collection references must have an odd number of segments, but "+t.canonicalString()+" has "+t.length);return r}return a.__extends(CollectionReference,e),Object.defineProperty(CollectionReference.prototype,"id",{get:function(){return this._query.path.lastSegment()},enumerable:!0,configurable:!0}),Object.defineProperty(CollectionReference.prototype,"parent",{get:function(){var e=this._query.path.popLast();return e.isEmpty()?null:new Kr(new C(e),this.firestore)},enumerable:!0,configurable:!0}),Object.defineProperty(CollectionReference.prototype,"path",{get:function(){return this._query.path.canonicalString()},enumerable:!0,configurable:!0}),CollectionReference.prototype.doc=function(e){if(validateBetweenNumberOfArgs("CollectionReference.doc",arguments,0,1),0===arguments.length&&(e=d.newId()),validateArgType("CollectionReference.doc","non-empty string",1,e),""===e)throw new f(l.INVALID_ARGUMENT,"Document path must be a non-empty string");var t=T.fromString(e);return Kr.forPath(this._query.path.child(t),this.firestore)},CollectionReference.prototype.add=function(e){validateExactNumberOfArgs("CollectionReference.add",arguments,1),validateArgType("CollectionReference.add","object",1,e);var t=this.doc();return t.set(e).then(function(){return t})},CollectionReference}(Jr),$r=makeConstructorPrivate(Qr,"Use firebase.firestore() instead."),Zr=makeConstructorPrivate(jr,"Use firebase.firestore().runTransaction() instead."),ei=makeConstructorPrivate(Wr,"Use firebase.firestore().batch() instead."),ti=makeConstructorPrivate(Kr,"Use firebase.firestore().doc() instead."),ni=makeConstructorPrivate(Gr),ri=makeConstructorPrivate(Hr),ii=makeConstructorPrivate(Jr),oi=makeConstructorPrivate(Xr),ai=makeConstructorPrivate(Yr,"Use firebase.firestore().collection() instead."),si={Firestore:$r,GeoPoint:y,Timestamp:g,Blob:m,Transaction:Zr,WriteBatch:ei,DocumentReference:ti,DocumentSnapshot:ni,Query:ii,QueryDocumentSnapshot:ri,QuerySnapshot:oi,CollectionReference:ai,FieldPath:yr,FieldValue:Ar,setLogLevel:Qr.setLogLevel};registerFirestore(i),t.registerFirestore=registerFirestore},function(e,t,n){"use strict";function setLogLevel(e){i.forEach(function(t){t.logLevel=e})}Object.defineProperty(t,"__esModule",{value:!0}),n.d(t,"setLogLevel",function(){return setLogLevel}),n.d(t,"Logger",function(){return s}),n.d(t,"LogLevel",function(){return r});var r,i=[];!function(e){e[e.DEBUG=0]="DEBUG",e[e.VERBOSE=1]="VERBOSE",e[e.INFO=2]="INFO",e[e.WARN=3]="WARN",e[e.ERROR=4]="ERROR",e[e.SILENT=5]="SILENT"}(r||(r={}));var o=r.INFO,a=function(e,t){for(var n=[],i=2;i<arguments.length;i++)n[i-2]=arguments[i];if(!(t<e.logLevel)){var o=(new Date).toISOString();switch(t){case r.DEBUG:case r.VERBOSE:console.log.apply(console,["["+o+"]  "+e.name+":"].concat(n));break;case r.INFO:console.info.apply(console,["["+o+"]  "+e.name+":"].concat(n));break;case r.WARN:console.warn.apply(console,["["+o+"]  "+e.name+":"].concat(n));break;case r.ERROR:console.error.apply(console,["["+o+"]  "+e.name+":"].concat(n));break;default:throw new Error("Attempted to log a message with an invalid logType (value: "+t+")")}}},s=function(){function Logger(e){this.name=e,this._logLevel=o,this._logHandler=a,i.push(this)}return Object.defineProperty(Logger.prototype,"logLevel",{get:function(){return this._logLevel},set:function(e){if(!(e in r))throw new TypeError("Invalid value assigned to `logLevel`");this._logLevel=e},enumerable:!0,configurable:!0}),Object.defineProperty(Logger.prototype,"logHandler",{get:function(){return this._logHandler},set:function(e){if("function"!=typeof e)throw new TypeError("Value assigned to `logHandler` must be a function");this._logHandler=e},enumerable:!0,configurable:!0}),Logger.prototype.debug=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];this._logHandler.apply(this,[this,r.DEBUG].concat(e))},Logger.prototype.log=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];this._logHandler.apply(this,[this,r.VERBOSE].concat(e))},Logger.prototype.info=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];this._logHandler.apply(this,[this,r.INFO].concat(e))},Logger.prototype.warn=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];this._logHandler.apply(this,[this,r.WARN].concat(e))},Logger.prototype.error=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];this._logHandler.apply(this,[this,r.ERROR].concat(e))},Logger}()},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),function(e){function l(e){return"string"==typeof e}function m(e,t){e=e.split("."),t=t||c;for(var n=0;n<e.length;n++)if(null==(t=t[e[n]]))return null;return t}function aa(){}function ba(e){var t=typeof e;if("object"==t){if(!e)return"null";if(e instanceof Array)return"array";if(e instanceof Object)return t;var n=Object.prototype.toString.call(e);if("[object Window]"==n)return"object";if("[object Array]"==n||"number"==typeof e.length&&void 0!==e.splice&&void 0!==e.propertyIsEnumerable&&!e.propertyIsEnumerable("splice"))return"array";if("[object Function]"==n||void 0!==e.call&&void 0!==e.propertyIsEnumerable&&!e.propertyIsEnumerable("call"))return"function"}else if("function"==t&&void 0===e.call)return"object";return t}function n(e){return"array"==ba(e)}function ca(e){var t=ba(e);return"array"==t||"object"==t&&"number"==typeof e.length}function q(e){return"function"==ba(e)}function r(e){var t=typeof e;return"object"==t&&null!=e||"function"==t}function ea(e,t,n){return e.call.apply(e.bind,arguments)}function fa(e,t,n){if(!e)throw Error();if(2<arguments.length){var r=Array.prototype.slice.call(arguments,2);return function(){var n=Array.prototype.slice.call(arguments);return Array.prototype.unshift.apply(n,r),e.apply(t,n)}}return function(){return e.apply(t,arguments)}}function u(e,t,n){return u=Function.prototype.bind&&-1!=Function.prototype.bind.toString().indexOf("native code")?ea:fa,u.apply(null,arguments)}function v(e,t){var n=Array.prototype.slice.call(arguments,1);return function(){var t=n.slice();return t.push.apply(t,arguments),e.apply(this,t)}}function x(e,t){function c(){}c.prototype=t.prototype,e.L=t.prototype,e.prototype=new c,e.prototype.constructor=e,e.mh=function(e,n,r){for(var i=Array(arguments.length-2),o=2;o<arguments.length;o++)i[o-2]=arguments[o];return t.prototype[n].apply(e,i)}}function y(e){if(Error.captureStackTrace)Error.captureStackTrace(this,y);else{var t=Error().stack;t&&(this.stack=t)}e&&(this.message=String(e))}function ha(e,t){e=e.split("%s");for(var n="",r=e.length-1,i=0;i<r;i++)n+=e[i]+(i<t.length?t[i]:"%s");y.call(this,n+e[r])}function ia(e,t){throw new ha("Failure"+(e?": "+e:""),Array.prototype.slice.call(arguments,1))}function z(){0!=p&&(g[this[h]||(this[h]=++f)]=this),this.Ka=this.Ka,this.Qa=this.Qa}function pa(e){e:{for(var t=qa,n=e.length,r=l(e)?e.split(""):e,i=0;i<n;i++)if(i in r&&t.call(void 0,r[i],i,e)){t=i;break e}t=-1}return 0>t?null:l(e)?e.charAt(t):e[t]}function ra(e){if(!n(e))for(var t=e.length-1;0<=t;t--)delete e[t];e.length=0}function sa(e,t){t=w(e,t);var n;return(n=0<=t)&&Array.prototype.splice.call(e,t,1),n}function ta(e){return Array.prototype.concat.apply([],arguments)}function ua(e){var t=e.length;if(0<t){for(var n=Array(t),r=0;r<t;r++)n[r]=e[r];return n}return[]}function va(e){return/^[\s\xa0]*$/.test(e)}function xa(e,t){return e<t?-1:e>t?1:0}function B(e){return-1!=b.indexOf(e)}function Aa(e,t,n){for(var r in e)t.call(n,e[r],r,e)}function Ba(e){var t,n=[],r=0;for(t in e)n[r++]=e[t];return n}function Ca(e){var t,n=[],r=0;for(t in e)n[r++]=t;return n}function Da(e){var t,n={};for(t in e)n[t]=e[t];return n}function Fa(e,t){for(var n,r,i=1;i<arguments.length;i++){r=arguments[i];for(n in r)e[n]=r[n];for(var o=0;o<j.length;o++)n=j[o],Object.prototype.hasOwnProperty.call(r,n)&&(e[n]=r[n])}}function Ga(e){return Ga[" "](e),e}function Ha(e,t){var n=he;return Object.prototype.hasOwnProperty.call(n,e)?n[e]:n[e]=t(e)}function Oa(){var e=c.document;return e?e.documentMode:void 0}function Ta(e){return Ha(e,function(){for(var t=0,n=M(String($)).split("."),r=M(String(e)).split("."),i=Math.max(n.length,r.length),o=0;0==t&&o<i;o++){var a=n[o]||"",s=r[o]||"";do{if(a=/(\d*)(\D*)(.*)/.exec(a)||["","","",""],s=/(\d*)(\D*)(.*)/.exec(s)||["","","",""],0==a[0].length&&0==s[0].length)break;t=xa(0==a[1].length?0:parseInt(a[1],10),0==s[1].length?0:parseInt(s[1],10))||xa(0==a[2].length,0==s[2].length)||xa(a[2],s[2]),a=a[3],s=s[3]}while(0==t)}return 0<=t})}function D(e,t){this.type=e,this.currentTarget=this.target=t,this.defaultPrevented=this.Ea=!1,this.Be=!0}function E(e,t){D.call(this,e?e.type:""),this.relatedTarget=this.currentTarget=this.target=null,this.button=this.screenY=this.screenX=this.clientY=this.clientX=this.offsetY=this.offsetX=0,this.key="",this.charCode=this.keyCode=0,this.metaKey=this.shiftKey=this.altKey=this.ctrlKey=!1,this.state=null,this.pointerId=0,this.pointerType="",this.fb=null,e&&this.Kf(e,t)}function F(e){return!(!e||!e[ge])}function cb(e,t,n,r,i){this.listener=e,this.proxy=null,this.src=t,this.type=n,this.capture=!!r,this.Ob=i,this.key=++ve,this.Sa=this.Eb=!1}function db(e){this.src=e,this.J={},this.xb=0}function eb(e,t,n,r){for(var i=0;i<e.length;++i){var o=e[i];if(!o.Sa&&o.listener==t&&o.capture==!!n&&o.Ob==r)return i}return-1}function ib(e,t,i,o,a){if(o&&o.once)return jb(e,t,i,o,a);if(n(t)){for(var s=0;s<t.length;s++)ib(e,t[s],i,o,a);return null}return i=kb(i),F(e)?e.nb(t,i,r(o)?!!o.capture:!!o,a):lb(e,t,i,!1,o,a)}function lb(e,t,n,i,o,a){if(!t)throw Error("Invalid event type");var s=r(o)?!!o.capture:!!o,u=G(e);if(u||(e[be]=u=new db(e)),n=u.add(t,n,i,s,a),n.proxy)return n;if(i=mb(),n.proxy=i,i.src=e,i.listener=n,e.addEventListener)me||(o=s),void 0===o&&(o=!1),e.addEventListener(t.toString(),i,o);else if(e.attachEvent)e.attachEvent(nb(t.toString()),i);else{if(!e.addListener||!e.removeListener)throw Error("addEventListener and attachEvent are unavailable.");e.addListener(i)}return n}function mb(){var e=ob,t=de?function(n){return e.call(t.src,t.listener,n)}:function(n){if(!(n=e.call(t.src,t.listener,n)))return n};return t}function jb(e,t,i,o,a){if(n(t)){for(var s=0;s<t.length;s++)jb(e,t[s],i,o,a);return null}return i=kb(i),F(e)?e.Oc(t,i,r(o)?!!o.capture:!!o,a):lb(e,t,i,!0,o,a)}function pb(e,t,i,o,a){if(n(t))for(var s=0;s<t.length;s++)pb(e,t[s],i,o,a);else o=r(o)?!!o.capture:!!o,i=kb(i),F(e)?e.ed(t,i,o,a):e&&(e=G(e))&&(t=e.jb(t,i,o,a))&&qb(t)}function qb(e){if("number"!=typeof e&&e&&!e.Sa){var t=e.src;if(F(t))t.Le(e);else{var n=e.type,r=e.proxy;t.removeEventListener?t.removeEventListener(n,r,e.capture):t.detachEvent?t.detachEvent(nb(n),r):t.addListener&&t.removeListener&&t.removeListener(r),(n=G(t))?(n.ye(e),0==n.xb&&(n.src=null,t[be]=null)):e.Vb()}}}function nb(e){return e in Se?Se[e]:Se[e]="on"+e}function rb(e,t,n,r){var i=!0;if((e=G(e))&&(t=e.J[t.toString()]))for(t=t.concat(),e=0;e<t.length;e++){var o=t[e];o&&o.capture==n&&!o.Sa&&(o=sb(o,r),i=i&&!1!==o)}return i}function sb(e,t){var n=e.listener,r=e.Ob||e.src;return e.Eb&&qb(e),n.call(r,t)}function ob(e,t){if(e.Sa)return!0;if(!de){var n=t||m("window.event");t=new E(n,this);var r=!0;if(!(0>n.keyCode||void 0!=n.returnValue)){e:{var i=!1;if(0==n.keyCode)try{n.keyCode=-1;break e}catch(e){i=!0}(i||void 0==n.returnValue)&&(n.returnValue=!0)}for(n=[],i=t.currentTarget;i;i=i.parentNode)n.push(i);for(e=e.type,i=n.length-1;!t.Ea&&0<=i;i--){t.currentTarget=n[i];var o=rb(n[i],e,!0,t);r=r&&o}for(i=0;!t.Ea&&i<n.length;i++)t.currentTarget=n[i],o=rb(n[i],e,!1,t),r=r&&o}return r}return sb(e,new E(t,this))}function G(e){return e=e[be],e instanceof db?e:null}function kb(e){return q(e)?e:(e[we]||(e[we]=function(t){return e.handleEvent(t)}),e[we])}function H(){z.call(this),this.ka=new db(this),this.Pe=this,this.Uc=null}function vb(e,t){this.Sf=100,this.ef=e,this.ug=t,this.Zb=0,this.Pb=null}function I(){this.lc=this.Va=null}function wb(){this.next=this.scope=this.Gc=null}function yb(e){c.setTimeout(function(){throw e},0)}function Ab(){var e=c.MessageChannel;if(void 0===e&&"undefined"!=typeof window&&window.postMessage&&window.addEventListener&&!B("Presto")&&(e=function(){var e=document.createElement("IFRAME");e.style.display="none",e.src="",document.documentElement.appendChild(e);var t=e.contentWindow;e=t.document,e.open(),e.write(""),e.close();var n="callImmediate"+Math.random(),r="file:"==t.location.protocol?"*":t.location.protocol+"//"+t.location.host;e=u(function(e){"*"!=r&&e.origin!=r||e.data!=n||this.port1.onmessage()},this),t.addEventListener("message",e,!1),this.port1={},this.port2={postMessage:function(){t.postMessage(n,r)}}}),void 0!==e&&!B("Trident")&&!B("MSIE")){var t=new e,n={},r=n;return t.port1.onmessage=function(){if(void 0!==n.next){n=n.next;var e=n.rd;n.rd=null,e()}},function(e){r.next={rd:e},r=r.next,t.port2.postMessage(0)}}return"undefined"!=typeof document&&"onreadystatechange"in document.createElement("SCRIPT")?function(e){var t=document.createElement("SCRIPT");t.onreadystatechange=function(){t.onreadystatechange=null,t.parentNode.removeChild(t),t=null,e(),e=null},document.documentElement.appendChild(t)}:function(e){c.setTimeout(e,0)}}function Cb(){if(c.Promise&&c.Promise.resolve){var e=c.Promise.resolve(void 0);Ce=function(){e.then(Db)}}else Ce=function(){var e=Db;!q(c.setImmediate)||c.Window&&c.Window.prototype&&!B("Edge")&&c.Window.prototype.setImmediate==c.setImmediate?(Ee||(Ee=Ab()),Ee(e)):c.setImmediate(e)}}function Db(){for(var e;e=_e.remove();){try{e.Gc.call(e.scope)}catch(e){yb(e)}_e.wg(e)}Ie=!1}function Gb(e,t){H.call(this),this.Na=e||1,this.wb=t||c,this.nd=u(this.Rg,this),this.ie=d()}function Hb(e,t,n){if(q(e))n&&(e=u(e,n));else{if(!e||"function"!=typeof e.handleEvent)throw Error("Invalid listener argument");e=u(e.handleEvent,e)}return 2147483647<Number(t)?-1:c.setTimeout(e,t||0)}function Ib(e,t,n){z.call(this),this.Uf=null!=n?u(e,n):e,this.Na=t,this.Xe=u(this.fg,this),this.qc=[]}function Jb(e){z.call(this),this.i=e,this.o={}}function J(e,t,n){this.reset(e,t,n,void 0,void 0)}function Mb(e){this.pe=e,this.Zd=this.uc=this.mb=this.$b=null}function K(e,t){this.name=e,this.value=t}function Vb(e){Le||(Le=new Mb(""),ke[""]=Le,Le.Ge(Me));var t;if(!(t=ke[e])){t=new Mb(e);var n=e.lastIndexOf("."),r=e.substr(n+1);n=Vb(e.substr(0,n)),n.Qe(r,t),t.Fg(n),ke[e]=t}return t}function Wb(e,t){e&&e.info(t,void 0)}function L(e,t){e&&e.lf(t)}function Xb(){this.s=Vb("goog.labs.net.webChannel.WebChannelDebug"),this.Wc=!0}function Yb(e){D.call(this,"serverreachability",e)}function N(e){xe.dispatchEvent(new Yb(xe,e))}function Zb(e,t){D.call(this,"statevent",e),this.stat=t}function O(e){xe.dispatchEvent(new Zb(xe,e))}function $b(e,t,n){D.call(this,"timingevent",e),this.size=t,this.rtt=n}function ac(e,t,n){xe.dispatchEvent(new $b(xe,e,t,n))}function P(e,t){if(!q(e))throw Error("Fn must not be null and must be a function");return c.setTimeout(function(){e()},t)}function dc(){}function ec(){}function fc(){D.call(this,"d")}function gc(){D.call(this,"c")}function ic(){}function R(e,t,n,r,i){this.b=e,this.a=t,this.ra=n,this.R=r,this.Xc=i||1,this.Fc=new Jb(this),this.Ua=Ue,e=re?125:void 0,this.Vc=new Gb(e),this.A=null,this.S=!1,this.Da=this.pa=this.ua=this.ic=this.qb=this.hd=this.Ga=null,this.ba=[],this.h=null,this.Bb=0,this.I=this.Fa=null,this.w=-1,this.Za=!1,this.Ra=0,this.ac=null,this.lb=this.Ed=this.yc=!1}function kc(e,t){switch(e){case 0:return"Non-200 return code ("+t+")";case 1:return"XMLHTTP failure (no data)";case 2:return"HttpConnection timeout";default:return"Unknown error"}}function nc(e){if(e.H&&"function"==typeof e.H)return e.H();if(l(e))return e.split("");if(ca(e)){for(var t=[],n=e.length,r=0;r<n;r++)t.push(e[r]);return t}return Ba(e)}function oc(e,t,n){if(e.forEach&&"function"==typeof e.forEach)e.forEach(t,n);else if(ca(e)||l(e))_(e,t,n);else{if(e.W&&"function"==typeof e.W)var r=e.W();else if(e.H&&"function"==typeof e.H)r=void 0;else if(ca(e)||l(e)){r=[];for(var i=e.length,o=0;o<i;o++)r.push(o)}else r=Ca(e);i=nc(e),o=i.length;for(var a=0;a<o;a++)t.call(n,i[a],r&&r[a],e)}}function S(e,t){this.D={},this.o=[],this.j=0;var n=arguments.length;if(1<n){if(n%2)throw Error("Uneven number of arguments");for(var r=0;r<n;r+=2)this.set(arguments[r],arguments[r+1])}else e&&this.addAll(e)}function T(e,t){return Object.prototype.hasOwnProperty.call(e,t)}function qc(e,t){if(e){e=e.split("&");for(var n=0;n<e.length;n++){var r=e[n].indexOf("="),i=null;if(0<=r){var o=e[n].substring(0,r);i=e[n].substring(r+1)}else o=e[n];t(o,i?decodeURIComponent(i.replace(/\+/g," ")):"")}}}function U(e,t){this.xa=this.zb=this.qa="",this.Ca=null,this.ib=this.K="",this.O=this.Qf=!1;var n;e instanceof U?(this.O=void 0!==t?t:e.O,this.tb(e.qa),this.cd(e.zb),this.rb(e.xa),this.sb(e.Ca),this.ec(e.K),this.bd(e.P.clone()),this.$c(e.ib)):e&&(n=String(e).match(We))?(this.O=!!t,this.tb(n[1]||"",!0),this.cd(n[2]||"",!0),this.rb(n[3]||"",!0),this.sb(n[4]),this.ec(n[5]||"",!0),this.bd(n[6]||"",!0),this.$c(n[7]||"",!0)):(this.O=!!t,this.P=new rc(null,this.O))}function Ac(e){return e instanceof U?e.clone():new U(e,void 0)}function Bc(e,t,n,r){var i=new U(null,void 0);return e&&i.tb(e),t&&i.rb(t),n&&i.sb(n),r&&i.ec(r),i}function yc(e,t){return e?t?decodeURI(e.replace(/%25/g,"%2525")):decodeURIComponent(e):""}function sc(e,t,n){return l(e)?(e=encodeURI(e).replace(t,Cc),n&&(e=e.replace(/%25([0-9a-fA-F]{2})/g,"%$1")),e):null}function Cc(e){return e=e.charCodeAt(0),"%"+(e>>4&15).toString(16)+(15&e).toString(16)}function rc(e,t){this.j=this.m=null,this.ja=e||null,this.O=!!t}function Fc(){}function Gc(){}function Hc(e,t){this.b=e,this.a=t,this.f=this.A=null,this.bc=!1,this.K=null,this.w=-1,this.Ad=this.na=null}function Ic(){this.od=this.$d=null}function Jc(e){this.D=new S,e&&this.addAll(e)}function Kc(e){var t=typeof e;return"object"==t&&e||"function"==t?"o"+(e[h]||(e[h]=++f)):t.substr(0,1)+e}function Lc(e,t){this.Pc=e,this.map=t,this.context=null}function Mc(e){this.me=e||Xe,c.PerformanceNavigationTiming?(e=c.performance.getEntriesByType("navigation"),e=0<e.length&&("hq"==e[0].nextHopProtocol||"h2"==e[0].nextHopProtocol)):e=!!(c.vc&&c.vc.ke&&c.vc.ke()&&c.vc.ke().nh),this.Xb=e?this.me:1,this.v=null,1<this.Xb&&(this.v=new Jc),this.f=null,this.ba=[]}function Oc(){this.xg=this.rg=void 0}function Pc(){this.jg=new Oc}function Qc(e,t){var n=new Xb;n.debug("TestLoadImage: loading "+e);var r=new Image;r.onload=v(Rc,n,r,"TestLoadImage: loaded",!0,t),r.onerror=v(Rc,n,r,"TestLoadImage: error",!1,t),r.onabort=v(Rc,n,r,"TestLoadImage: abort",!1,t),r.ontimeout=v(Rc,n,r,"TestLoadImage: timeout",!1,t),c.setTimeout(function(){r.ontimeout&&r.ontimeout()},1e4),r.src=e}function Rc(e,t,n,r,i){try{e.debug(n),t.onload=null,t.onerror=null,t.onabort=null,t.ontimeout=null,i(r)}catch(t){e.cb(t)}}function V(e){H.call(this),this.headers=new S,this.Xa=e||null,this.ha=!1,this.mc=this.c=null,this.ge=this.Tb="",this.Pa=0,this.I="",this.Aa=this.Lc=this.Qb=this.Ec=!1,this.vb=0,this.hc=null,this.Ae=$e,this.jc=this.lg=this.Ab=!1}function Wc(e){return te&&Ta(9)&&"number"==typeof e.timeout&&void 0!==e.ontimeout}function qa(e){return"content-type"==e.toLowerCase()}function Xc(e,t){return{type:t,lengthComputable:e.lengthComputable,loaded:e.loaded,total:e.total}}function Yc(e){var t="";return Aa(e,function(e,n){t+=n,t+=":",t+=e,t+="\r\n"}),t}function Zc(e,t,n){e:{for(r in n){var r=!1;break e}r=!0}if(r)return e;if(n=Yc(n),l(e)){if(t=encodeURIComponent(String(t)),n=null!=n?"="+encodeURIComponent(String(n)):"",t+=n){if(n=e.indexOf("#"),0>n&&(n=e.length),0>(r=e.indexOf("?"))||r>n){r=n;var i=""}else i=e.substring(r+1,n);e=[e.substr(0,r),i,e.substr(n)],n=e[1],e[1]=t?n?n+"&"+t:t:n,e=e[0]+(e[1]?"?"+e[1]:"")+e[2]}return e}return e.l(t,n),e}function $c(e){this.Bd=22,this.De=0,this.M=[],this.a=new Xb,this.Ib=new Ic,this.na=this.md=this.hb=this.K=this.u=this.Kc=this.aa=this.gb=this.N=this.Rb=this.A=null,this.Te=!0,this.ag=this.Yb=0,this.kf=!!m("internalChannelParams.failFast",e),this.fd=this.Ja=this.wa=this.ia=this.ea=this.i=null,this.Se=!0,this.w=this.he=this.Sb=-1,this.rc=this.Ha=this.La=0,this.Ve=m("internalChannelParams.baseRetryDelayMs",e)||5e3,this.vg=m("internalChannelParams.retryDelaySeedMs",e)||1e4,this.nf=m("internalChannelParams.forwardChannelMaxRetries",e)||2,this.Od=m("internalChannelParams.forwardChannelRequestTimeoutMs",e)||2e4,this.Xa=e&&e.oh||void 0,this.Db=void 0,this.Ra=0,this.gc=e&&e.supportsCrossDomainXhr||!1,this.ra="",this.G=new Mc(e&&e.concurrentRequestLimit),this.kc=new Pc,this.ta=!e||void 0===e.backgroundChannelTest||e.backgroundChannelTest,(this.Nd=e&&e.fastHandshake||!1)&&!this.ta&&(this.a.T("Force backgroundChannelTest when fastHandshake is enabled."),this.ta=!0),e&&e.Id&&this.a.Id()}function ad(){}function bd(e){for(var t=arguments[0],n=1;n<arguments.length;n++){var r=arguments[n];if(0==r.lastIndexOf("/",0))t=r;else{var i;(i=""==t)||(i=t.length-1,i=0<=i&&t.indexOf("/",i)==i),t=i?t+r:t+"/"+r}}return t}function cd(){if(te&&!(10<=Number(ce)))throw Error("Environmental error: no available transport.")}function W(e,t){H.call(this),this.b=new $c(t),this.yb=e,this.Qg=t&&t.testUrl?t.testUrl:bd(this.yb,"test"),this.s=Vb("goog.labs.net.webChannel.WebChannelBaseTransport"),this.Rc=t&&t.messageUrlParams||null,e=t&&t.messageHeaders||null,t&&t.clientProtocolHeaderRequired&&(e?e["X-Client-Protocol"]="webchannel":e={"X-Client-Protocol":"webchannel"}),this.b.ga(e),e=t&&t.initMessageHeaders||null,t&&t.messageContentType&&(e?e["X-WebChannel-Content-Type"]=t.messageContentType:e={"X-WebChannel-Content-Type":t.messageContentType}),t&&t.zd&&(e?e["X-WebChannel-Client-Profile"]=t.zd:e={"X-WebChannel-Client-Profile":t.zd}),this.b.Eg(e),(e=t&&t.httpHeadersOverwriteParam)&&!va(e)&&this.b.Cg(e),this.Og=t&&t.supportsCrossDomainXhr||!1,this.zg=t&&t.sendRawJson||!1,(t=t&&t.httpSessionIdParam)&&!va(t)&&(this.b.Dg(t),null!==(e=this.Rc)&&t in e&&(e=this.Rc,t in e&&delete e[t],(e=this.s)&&e.T("Ignore httpSessionIdParam also specified with messageUrlParams: "+t,void 0))),this.vd=new X(this)}function dd(e){fc.call(this);var t=e.__sm__;if(t){e:{for(var n in t){e=n;break e}e=void 0}(this.ne=e)&&(e=this.ne,t=null!==t&&e in t?t[e]:void 0),this.data=t}else this.data=e}function ed(e){gc.call(this),this.status=1,this.errorCode=e}function X(e){this.b=e}function gd(){this.V=[],this.Z=[]}function hd(e,t){if(z.call(this),this.oe=e||0,this.Wb=t||10,this.oe>this.Wb)throw Error(nt);this.fa=new gd,this.oa=new Jc,this.Ac=0,this.Nc=null,this.Cb()}function jd(e,t){this.fe=e,this.gd=t}function kd(e){this.Y=[],e&&this.Lf(e)}function ld(){kd.call(this)}function Y(e,t){this.Gd=void 0,this.cc=new ld,hd.call(this,e,t)}function Z(e,t,n,r){this.Jf=e,this.Ab=!!r,Y.call(this,t,n)}i.d(t,"createWebChannelTransport",function(){return it}),i.d(t,"ErrorCode",function(){return ot}),i.d(t,"EventType",function(){return at}),i.d(t,"WebChannel",function(){return st}),i.d(t,"XhrIoPool",function(){return ut});var o,a="undefined"!=typeof window?window:void 0!==e?e:"undefined"!=typeof self?self:{},s=s||{},c=a,h="closure_uid_"+(1e9*Math.random()>>>0),f=0,d=Date.now||function(){return+new Date};x(y,Error),y.prototype.name="CustomError",x(ha,y),ha.prototype.name="AssertionError";var p=0,g={};z.prototype.Ka=!1,z.prototype.bb=function(){if(!this.Ka&&(this.Ka=!0,this.F(),0!=p)){var e=this[h]||(this[h]=++f);if(0!=p&&this.Qa&&0<this.Qa.length)throw Error(this+" did not empty its onDisposeCallbacks queue. This probably means it overrode dispose() or disposeInternal() without calling the superclass' method.");delete g[e]}},z.prototype.F=function(){if(this.Qa)for(;this.Qa.length;)this.Qa.shift()()};var b,w=Array.prototype.indexOf?function(e,t){return Array.prototype.indexOf.call(e,t,void 0)}:function(e,t){if(l(e))return l(t)&&1==t.length?e.indexOf(t,0):-1;for(var n=0;n<e.length;n++)if(n in e&&e[n]===t)return n;return-1},C=Array.prototype.lastIndexOf?function(e,t){return Array.prototype.lastIndexOf.call(e,t,e.length-1)}:function(e,t){var n=e.length-1;if(0>n&&(n=Math.max(0,e.length+n)),l(e))return l(t)&&1==t.length?e.lastIndexOf(t,n):-1;for(;0<=n;n--)if(n in e&&e[n]===t)return n;return-1},_=Array.prototype.forEach?function(e,t,n){Array.prototype.forEach.call(e,t,n)}:function(e,t,n){for(var r=e.length,i=l(e)?e.split(""):e,o=0;o<r;o++)o in i&&t.call(n,i[o],o,e)},A=Array.prototype.some?function(e,t){return Array.prototype.some.call(e,t,void 0)}:function(e,t){for(var n=e.length,r=l(e)?e.split(""):e,i=0;i<n;i++)if(i in r&&t.call(void 0,r[i],i,e))return!0;return!1},M=String.prototype.trim?function(e){return e.trim()}:function(e){return/^[\s\xa0]*([\s\S]*?)[\s\xa0]*$/.exec(e)[1]};e:{var k=c.navigator;if(k){var Q=k.userAgent;if(Q){b=Q;break e}}b=""}var j="constructor hasOwnProperty isPrototypeOf propertyIsEnumerable toLocaleString toString valueOf".split(" ");Ga[" "]=aa;var $,ee=B("Opera"),te=B("Trident")||B("MSIE"),ne=B("Edge"),re=ne||te,ie=B("Gecko")&&!(-1!=b.toLowerCase().indexOf("webkit")&&!B("Edge"))&&!(B("Trident")||B("MSIE"))&&!B("Edge"),oe=-1!=b.toLowerCase().indexOf("webkit")&&!B("Edge");e:{var ae="",se=function(){var e=b;return ie?/rv:([^\);]+)(\)|;)/.exec(e):ne?/Edge\/([\d\.]+)/.exec(e):te?/\b(?:MSIE|rv)[: ]([^\);]+)(\)|;)/.exec(e):oe?/WebKit\/(\S+)/.exec(e):ee?/(?:Version)[ \/]?(\S+)/.exec(e):void 0}();if(se&&(ae=se?se[1]:""),te){var ue=Oa();if(null!=ue&&ue>parseFloat(ae)){$=String(ue);break e}}$=ae}var ce,he={},le=c.document;ce=le&&te?Oa()||("CSS1Compat"==le.compatMode?parseInt($,10):5):void 0;var fe=Object.freeze||function(e){return e},de=!te||9<=Number(ce),pe=te&&!Ta("9"),me=function(){if(!c.addEventListener||!Object.defineProperty)return!1;var e=!1,t=Object.defineProperty({},"passive",{get:function(){e=!0}});try{c.addEventListener("test",aa,t),c.removeEventListener("test",aa,t)}catch(e){}return e}();D.prototype.stopPropagation=function(){this.Ea=!0},D.prototype.preventDefault=function(){this.defaultPrevented=!0,this.Be=!1},x(E,D);var ye=fe({2:"touch",3:"pen",4:"mouse"});E.prototype.Kf=function(e,t){var n=this.type=e.type,r=e.changedTouches?e.changedTouches[0]:null;if(this.target=e.target||e.srcElement,this.currentTarget=t,t=e.relatedTarget){if(ie){e:{try{Ga(t.nodeName);var i=!0;break e}catch(e){}i=!1}i||(t=null)}}else"mouseover"==n?t=e.fromElement:"mouseout"==n&&(t=e.toElement);this.relatedTarget=t,null===r?(this.offsetX=oe||void 0!==e.offsetX?e.offsetX:e.layerX,this.offsetY=oe||void 0!==e.offsetY?e.offsetY:e.layerY,this.clientX=void 0!==e.clientX?e.clientX:e.pageX,this.clientY=void 0!==e.clientY?e.clientY:e.pageY,this.screenX=e.screenX||0,this.screenY=e.screenY||0):(this.clientX=void 0!==r.clientX?r.clientX:r.pageX,this.clientY=void 0!==r.clientY?r.clientY:r.pageY,this.screenX=r.screenX||0,this.screenY=r.screenY||0),this.button=e.button,this.keyCode=e.keyCode||0,this.key=e.key||"",this.charCode=e.charCode||("keypress"==n?e.keyCode:0),this.ctrlKey=e.ctrlKey,this.altKey=e.altKey,this.shiftKey=e.shiftKey,this.metaKey=e.metaKey,this.pointerId=e.pointerId||0,this.pointerType=l(e.pointerType)?e.pointerType:ye[e.pointerType]||"",this.state=e.state,this.fb=e,e.defaultPrevented&&this.preventDefault()},E.prototype.stopPropagation=function(){E.L.stopPropagation.call(this),this.fb.stopPropagation?this.fb.stopPropagation():this.fb.cancelBubble=!0},E.prototype.preventDefault=function(){E.L.preventDefault.call(this);var e=this.fb;if(e.preventDefault)e.preventDefault();else if(e.returnValue=!1,pe)try{(e.ctrlKey||112<=e.keyCode&&123>=e.keyCode)&&(e.keyCode=-1)}catch(e){}};var ge="closure_listenable_"+(1e6*Math.random()|0),ve=0;cb.prototype.Vb=function(){this.Sa=!0,this.Ob=this.src=this.proxy=this.listener=null},o=db.prototype,o.add=function(e,t,n,r,i){var o=e.toString();(e=this.J[o])||(e=this.J[o]=[],this.xb++);var a=eb(e,t,r,i);return-1<a?(t=e[a],n||(t.Eb=!1)):(t=new cb(t,this.src,o,!!r,i),t.Eb=n,e.push(t)),t},o.remove=function(e,t,n,r){if(!((e=e.toString())in this.J))return!1;var i=this.J[e];return-1<(t=eb(i,t,n,r))&&(i[t].Vb(),Array.prototype.splice.call(i,t,1),0==i.length&&(delete this.J[e],this.xb--),!0)},o.ye=function(e){var t=e.type;t in this.J&&sa(this.J[t],e)&&(e.Vb(),0==this.J[t].length&&(delete this.J[t],this.xb--))},o.pb=function(e){e=e&&e.toString();var t;for(t in this.J)if(!e||t==e){for(var n=this.J[t],r=0;r<n.length;r++)n[r].Vb();delete this.J[t],this.xb--}},o.jb=function(e,t,n,r){e=this.J[e.toString()];var i=-1;return e&&(i=eb(e,t,n,r)),-1<i?e[i]:null};var be="closure_lm_"+(1e6*Math.random()|0),Se={},we="__closure_events_fn_"+(1e9*Math.random()>>>0);x(H,z),H.prototype[ge]=!0,o=H.prototype,o.addEventListener=function(e,t,n,r){ib(this,e,t,n,r)},o.removeEventListener=function(e,t,n,r){pb(this,e,t,n,r)},o.dispatchEvent=function(e){var t,n=this.Uc;if(n)for(t=[];n;n=n.Uc)t.push(n);n=this.Pe;var r=e.type||e;if(l(e))e=new D(e,n);else if(e instanceof D)e.target=e.target||n;else{var i=e;e=new D(r,n),Fa(e,i)}if(i=!0,t)for(var o=t.length-1;!e.Ea&&0<=o;o--){var a=e.currentTarget=t[o];i=a.Lb(r,!0,e)&&i}if(e.Ea||(a=e.currentTarget=n,i=a.Lb(r,!0,e)&&i,e.Ea||(i=a.Lb(r,!1,e)&&i)),t)for(o=0;!e.Ea&&o<t.length;o++)a=e.currentTarget=t[o],i=a.Lb(r,!1,e)&&i;return i},o.F=function(){H.L.F.call(this),this.pg(),this.Uc=null},o.nb=function(e,t,n,r){return this.ka.add(String(e),t,!1,n,r)},o.Oc=function(e,t,n,r){return this.ka.add(String(e),t,!0,n,r)},o.ed=function(e,t,n,r){this.ka.remove(String(e),t,n,r)},o.Le=function(e){this.ka.ye(e)},o.pg=function(){this.ka&&this.ka.pb(void 0)},o.Lb=function(e,t,n){if(!(e=this.ka.J[String(e)]))return!0;e=e.concat();for(var r=!0,i=0;i<e.length;++i){var o=e[i];if(o&&!o.Sa&&o.capture==t){var a=o.listener,s=o.Ob||o.src;o.Eb&&this.Le(o),r=!1!==a.call(s,n)&&r}}return r&&0!=n.Be},o.jb=function(e,t,n,r){return this.ka.jb(String(e),t,n,r)};var Te=c.JSON.stringify;vb.prototype.get=function(){if(0<this.Zb){this.Zb--;var e=this.Pb;this.Pb=e.next,e.next=null}else e=this.ef();return e},vb.prototype.put=function(e){this.ug(e),this.Zb<this.Sf&&(this.Zb++,e.next=this.Pb,this.Pb=e)};var De=new vb(function(){return new wb},function(e){e.reset()});I.prototype.add=function(e,t){var n=this.Af();n.set(e,t),this.lc?this.lc.next=n:this.Va=n,this.lc=n},I.prototype.remove=function(){var e=null;return this.Va&&(e=this.Va,this.Va=this.Va.next,this.Va||(this.lc=null),e.next=null),e},I.prototype.wg=function(e){De.put(e)},I.prototype.Af=function(){return De.get()},wb.prototype.set=function(e,t){this.Gc=e,this.scope=t,this.next=null},wb.prototype.reset=function(){this.next=this.scope=this.Gc=null};var Ee,Ce,Ie=!1,_e=new I;x(Gb,H),o=Gb.prototype,o.enabled=!1,o.B=null,o.setInterval=function(e){this.Na=e,this.B&&this.enabled?(this.stop(),this.start()):this.B&&this.stop()},o.Rg=function(){if(this.enabled){var e=d()-this.ie;0<e&&e<.8*this.Na?this.B=this.wb.setTimeout(this.nd,this.Na-e):(this.B&&(this.wb.clearTimeout(this.B),this.B=null),this.ff(),this.enabled&&(this.stop(),this.start()))}},o.ff=function(){this.dispatchEvent("tick")},o.start=function(){this.enabled=!0,this.B||(this.B=this.wb.setTimeout(this.nd,this.Na),this.ie=d())},o.stop=function(){this.enabled=!1,this.B&&(this.wb.clearTimeout(this.B),this.B=null)},o.F=function(){Gb.L.F.call(this),this.stop(),delete this.wb},x(Ib,z),o=Ib.prototype,o.Ta=!1,o.ob=0,o.B=null,o.mf=function(e){this.qc=arguments,this.B||this.ob?this.Ta=!0:this.Cc()},o.stop=function(){this.B&&(c.clearTimeout(this.B),this.B=null,this.Ta=!1,this.qc=[])},o.pause=function(){this.ob++},o.resume=function(){--this.ob||!this.Ta||this.B||(this.Ta=!1,this.Cc())},o.F=function(){Ib.L.F.call(this),this.stop()},o.fg=function(){this.B=null,this.Ta&&!this.ob&&(this.Ta=!1,this.Cc())},o.Cc=function(){this.B=Hb(this.Xe,this.Na),this.Uf.apply(null,this.qc)},x(Jb,z);var Ae=[];o=Jb.prototype,o.nb=function(e,t,n,r){return this.Tf(e,t,n,r)},o.Tf=function(e,t,r,i){n(t)||(t&&(Ae[0]=t.toString()),t=Ae);for(var o=0;o<t.length;o++){var a=ib(e,t[o],r||this.handleEvent,i||!1,this.i||this);if(!a)break;this.o[a.key]=a}return this},o.Oc=function(e,t,n,r){return this.je(e,t,n,r)},o.je=function(e,t,r,i,o){if(n(t))for(var a=0;a<t.length;a++)this.je(e,t[a],r,i,o);else{if(!(e=jb(e,t,r||this.handleEvent,i,o||this.i||this)))return this;this.o[e.key]=e}return this},o.ed=function(e,t,i,o,a){if(n(t))for(var s=0;s<t.length;s++)this.ed(e,t[s],i,o,a);else i=i||this.handleEvent,o=r(o)?!!o.capture:!!o,a=a||this.i||this,i=kb(i),o=!!o,(t=F(e)?e.jb(t,i,o,a):e&&(e=G(e))?e.jb(t,i,o,a):null)&&(qb(t),delete this.o[t.key])},o.pb=function(){Aa(this.o,function(e,t){this.o.hasOwnProperty(t)&&qb(e)},this),this.o={}},o.F=function(){Jb.L.F.call(this),this.pb()},o.handleEvent=function(){throw Error("EventHandler.handleEvent not implemented")},J.prototype.Md=null,J.prototype.reset=function(e,t,n,r,i){this.mb=e,delete this.Md},J.prototype.Bg=function(e){this.Md=e},J.prototype.Ge=function(e){this.mb=e},K.prototype.toString=function(){return this.name};var Pe=new K("SEVERE",1e3),Ne=new K("WARNING",900),Re=new K("INFO",800),Me=new K("CONFIG",700),Oe=new K("FINE",500);o=Mb.prototype,o.getName=function(){return this.pe},o.getParent=function(){return this.$b},o.pf=function(){return this.uc||(this.uc={}),this.uc},o.Ge=function(e){this.mb=e},o.Qd=function(){return this.mb?this.mb:this.$b?this.$b.Qd():(ia("Root logger has no level set."),null)},o.Pf=function(e){return e.value>=this.Qd().value},o.log=function(e,t,n){this.Pf(e)&&(q(t)&&(t=t()),this.gf(this.uf(e,t,n)))},o.uf=function(e,t,n){return e=new J(e,String(t),this.pe),n&&e.Bg(n),e},o.ca=function(e,t){this.log(Pe,e,t)},o.T=function(e,t){this.log(Ne,e,t)},o.info=function(e,t){this.log(Re,e,t)},o.lf=function(e){this.log(Oe,e,void 0)},o.gf=function(e){for(var t=this;t;)t.We(e),t=t.getParent()},o.We=function(e){if(this.Zd)for(var t,n=0;t=this.Zd[n];n++)t(e)},o.Fg=function(e){this.$b=e},o.Qe=function(e,t){this.pf()[e]=t};var ke={},Le=null;o=Xb.prototype,o.Id=function(){this.Wc=!1},o.Tg=function(e,t,n,r,i){var o=this;this.info(function(){return"XMLHTTP REQ ("+n+") [attempt "+r+"]: "+e+"\n"+t+"\n"+o.Xf(i)})},o.Ug=function(e,t,n,r,i,o){this.info(function(){return"XMLHTTP RESP ("+n+") [ attempt "+r+"]: "+e+"\n"+t+"\n"+i+" "+o})},o.Wa=function(e,t,n){var r=this;this.info(function(){return"XMLHTTP TEXT ("+e+"): "+r.ng(t)+(n?" "+n:"")})},o.Sg=function(e){this.info(function(){return"TIMEOUT: "+e})},o.debug=function(e){L(this.s,e)},o.cb=function(e,t){var n=this.s;n&&n.ca(t||"Exception",e)},o.info=function(e){Wb(this.s,e)},o.T=function(e){var t=this.s;t&&t.T(e,void 0)},o.ca=function(e){var t=this.s;t&&t.ca(e,void 0)},o.ng=function(e){if(!this.Wc)return e;if(!e)return null;try{var t=JSON.parse(e);if(t)for(var r=0;r<t.length;r++)n(t[r])&&this.Wf(t[r]);return Te(t)}catch(t){return this.debug("Exception parsing expected JS array - probably was not JS"),e}},o.Wf=function(e){if(!(2>e.length||(e=e[1],!n(e)||1>e.length))){var t=e[0];if("noop"!=t&&"stop"!=t&&"close"!=t)for(t=1;t<e.length;t++)e[t]=""}},o.Xf=function(e){if(!this.Wc)return e;if(!e)return null;var t="";e=e.split("&");for(var n=0;n<e.length;n++){var r=e[n].split("=");if(1<r.length){var i=r[0];r=r[1];var o=i.split("_");t=2<=o.length&&"type"==o[1]?t+(i+"=")+r+"&":t+(i+"=redacted&")}}return t};var xe=new H;x(Yb,D),x(Zb,D),x($b,D);var Fe={NO_ERROR:0,Vg:1,bh:2,ah:3,Yg:4,$g:5,dh:6,Ne:7,TIMEOUT:8,gh:9},Ve={Xg:"complete",kh:"success",Oe:"error",Ne:"abort",ih:"ready",jh:"readystatechange",TIMEOUT:"timeout",eh:"incrementaldata",hh:"progress",Zg:"downloadprogress",lh:"uploadprogress"};dc.prototype.pd=null,dc.prototype.Vd=function(){return this.pd||(this.pd=this.Mf())};var Be={OPEN:"a",Wg:"b",Oe:"c",fh:"d"};x(fc,D),x(gc,D);var qe;x(ic,dc),ic.prototype.Dd=function(){var e=this.Wd();return e?new ActiveXObject(e):new XMLHttpRequest},ic.prototype.Mf=function(){var e={};return this.Wd()&&(e[0]=!0,e[1]=!0),e},ic.prototype.Wd=function(){if(!this.be&&"undefined"==typeof XMLHttpRequest&&"undefined"!=typeof ActiveXObject){for(var e=["MSXML2.XMLHTTP.6.0","MSXML2.XMLHTTP.3.0","MSXML2.XMLHTTP","Microsoft.XMLHTTP"],t=0;t<e.length;t++){var n=e[t];try{return new ActiveXObject(n),this.be=n}catch(e){}}throw Error("Could not create ActiveXObject. ActiveX might be disabled, or MSXML might not be installed")}return this.be},qe=new ic;var Ue=45e3,Qe={},je={};o=R.prototype,o.ga=function(e){this.A=e},o.setTimeout=function(e){this.Ua=e},o.He=function(e){this.Ra=e},o.Gg=function(e){this.ba=e},o.la=function(){return this.ba},o.kd=function(e,t){this.ic=1,this.ua=e.clone().Ub(),this.Da=t,this.yc=!0,this.Ce(null)},o.jd=function(e,t,n){this.ic=1,this.ua=e.clone().Ub(),this.Da=null,this.yc=t,this.Ce(n)},o.Ce=function(e){this.qb=d(),this.eb(),this.pa=this.ua.clone(),this.pa.dc("t",this.Xc),this.Bb=0,this.h=this.b.Jb(this.b.fc()?e:null),0<this.Ra&&(this.ac=new Ib(u(this.Me,this,this.h),this.Ra)),this.Fc.nb(this.h,"readystatechange",this.mg),e=this.A?Da(this.A):{},this.Da?(this.Fa||(this.Fa="POST"),e["Content-Type"]="application/x-www-form-urlencoded",this.h.send(this.pa,this.Fa,this.Da,e)):(this.Fa="GET",this.h.send(this.pa,this.Fa,null,e)),N(1),this.a.Tg(this.Fa,this.pa,this.R,this.Xc,this.Da)},o.mg=function(e){e=e.target;var t=this.ac;t&&3==e.ma()?(this.a.debug("Throttling readystatechange."),t.mf()):this.Me(e)},o.Me=function(e){try{e==this.h?this.hg():this.a.T("Called back with an unexpected xmlhttp")}catch(e){if(this.a.debug("Failed call to OnXmlHttpReadyStateChanged_"),this.h&&this.h.ya()){var t=this;this.a.cb(e,function(){return"ResponseText: "+t.h.ya()})}else this.a.cb(e,"No response text")}},o.hg=function(){var e=this.h.ma(),t=this.h.Ud(),n=this.h.za();if(!(3>e||3==e&&!re&&!this.h.ya())){this.Za||4!=e||7==t||N(8==t||0>=n?3:2),this.Fb();var r=this.h.za();if(this.w=r,!(t=this.h.ya())){var i=this;this.a.debug(function(){return"No response text for uri "+i.pa+" status "+r})}if(this.S=200==r,this.a.Ug(this.Fa,this.pa,this.R,this.Xc,e,r),this.S){if(this.Ig()){if(!(n=this.sf()))return this.S=!1,this.I=3,O(12),this.a.T("XMLHTTP Missing X_HTTP_INITIAL_RESPONSE ("+this.R+")"),this.Ia(),void this.Kb();this.a.Wa(this.R,n,"Initial handshake response via X-HTTP-Initial-Response"),this.lb=!0,this.Yc(n)}this.yc?(this.Fd(e,t),re&&this.S&&3==e&&this.Ng()):(this.a.Wa(this.R,t,null),this.Yc(t)),4==e&&this.Ia(),this.S&&!this.Za&&(4==e?this.b.Tc(this):(this.S=!1,this.eb()))}else 400==r&&0<t.indexOf("Unknown SID")?(this.I=3,O(12),this.a.T("XMLHTTP Unknown SID ("+this.R+")")):(this.I=0,O(13),this.a.T("XMLHTTP Bad status "+r+" ("+this.R+")")),this.Ia(),this.Kb()}},o.Ig=function(){return this.Ed&&!this.lb},o.sf=function(){if(this.h){var e=this.h.kb("X-HTTP-Initial-Response");if(e&&!va(e))return e}return null},o.Ag=function(){this.Ed=!0},o.Fd=function(e,t){for(var n=!0;!this.Za&&this.Bb<t.length;){var r=this.vf(t);if(r==je){4==e&&(this.I=4,O(14),n=!1),this.a.Wa(this.R,null,"[Incomplete Response]");break}if(r==Qe){this.I=4,O(15),this.a.Wa(this.R,t,"[Invalid Chunk]"),n=!1;break}this.a.Wa(this.R,r,null),this.Yc(r)}4==e&&0==t.length&&(this.I=1,O(16),n=!1),this.S=this.S&&n,n||(this.a.Wa(this.R,t,"[Invalid Chunked Response]"),this.Ia(),this.Kb())},o.kg=function(){if(this.h){var e=this.h.ma(),t=this.h.ya();this.Bb<t.length&&(this.Fb(),this.Fd(e,t),this.S&&4!=e&&this.eb())}},o.Ng=function(){this.Fc.nb(this.Vc,"tick",this.kg),this.Vc.start()},o.vf=function(e){var t=this.Bb,n=e.indexOf("\n",t);return-1==n?je:(t=Number(e.substring(t,n)),isNaN(t)?Qe:(n+=1)+t>e.length?je:(e=e.substr(n,t),this.Bb=n+t,e))},o.yg=function(e){this.ic=2,this.ua=e.clone().Ub(),e=!1,c.navigator&&c.navigator.sendBeacon&&(e=c.navigator.sendBeacon(this.ua.toString(),"")),!e&&c.Image&&((new Image).src=this.ua,e=!0),e||(this.h=this.b.Jb(null),this.h.send(this.ua)),this.qb=d(),this.eb()},o.cancel=function(){this.Za=!0,this.Ia()},o.tg=function(e){e&&this.setTimeout(e),this.Ga&&(this.Fb(),this.eb())},o.eb=function(){this.hd=d()+this.Ua,this.Ke(this.Ua)},o.Ke=function(e){if(null!=this.Ga)throw Error("WatchDog timer not null");this.Ga=P(u(this.gg,this),e)},o.Fb=function(){this.Ga&&(c.clearTimeout(this.Ga),this.Ga=null)},o.gg=function(){this.Ga=null;var e=d();0<=e-this.hd?this.Df():(this.a.T("WatchDog timer called too early"),this.Ke(this.hd-e))},o.Df=function(){this.S&&this.a.ca("Received watchdog timeout even though request loaded successfully"),this.a.Sg(this.pa),2!=this.ic&&(N(3),O(17)),this.Ia(),this.I=2,this.Kb()},o.Kb=function(){this.b.de()||this.Za||this.b.Tc(this)},o.Ia=function(){this.Fb();var e=this.ac;e&&"function"==typeof e.bb&&e.bb(),this.ac=null,this.Vc.stop(),this.Fc.pb(),this.h&&(e=this.h,this.h=null,e.abort(),e.bb())},o.Hc=function(){return this.I},o.Yc=function(e){try{this.b.ue(this,e),N(4)}catch(e){this.a.cb(e,"Error in httprequest callback")}},o=S.prototype,o.C=function(){return this.j},o.H=function(){this.wc();for(var e=[],t=0;t<this.o.length;t++)e.push(this.D[this.o[t]]);return e},o.W=function(){return this.wc(),this.o.concat()},o.va=function(e){return T(this.D,e)},o.X=function(){return 0==this.j},o.clear=function(){this.D={},this.j=this.o.length=0},o.remove=function(e){return!!T(this.D,e)&&(delete this.D[e],this.j--,this.o.length>2*this.j&&this.wc(),!0)},o.wc=function(){if(this.j!=this.o.length){for(var e=0,t=0;e<this.o.length;){var n=this.o[e];T(this.D,n)&&(this.o[t++]=n),e++}this.o.length=t}if(this.j!=this.o.length){var r={};for(t=e=0;e<this.o.length;)n=this.o[e],T(r,n)||(this.o[t++]=n,r[n]=1),e++;this.o.length=t}},o.get=function(e,t){return T(this.D,e)?this.D[e]:t},o.set=function(e,t){T(this.D,e)||(this.j++,this.o.push(e)),this.D[e]=t},o.addAll=function(e){if(e instanceof S)for(var t=e.W(),n=0;n<t.length;n++)this.set(t[n],e.get(t[n]));else for(t in e)this.set(t,e[t])},o.forEach=function(e,t){for(var n=this.W(),r=0;r<n.length;r++){var i=n[r],o=this.get(i);e.call(t,o,i,this)}},o.clone=function(){return new S(this)};var We=/^(?:([^:\/?#.]+):)?(?:\/\/(?:([^\/?#]*)@)?([^\/#?]*?)(?::([0-9]+))?(?=[\/#?]|$))?([^?#]+)?(?:\?([^#]*))?(?:#([\s\S]*))?$/;o=U.prototype,o.toString=function(){var e=[],t=this.qa;t&&e.push(sc(t,Ke,!0),":");var n=this.xa;return(n||"file"==t)&&(e.push("//"),(t=this.zb)&&e.push(sc(t,Ke,!0),"@"),e.push(encodeURIComponent(String(n)).replace(/%25([0-9a-fA-F]{2})/g,"%$1")),null!=(n=this.Ca)&&e.push(":",String(n))),(n=this.K)&&(this.Ic()&&"/"!=n.charAt(0)&&e.push("/"),e.push(sc(n,"/"==n.charAt(0)?Ge:ze,!0))),(n=this.Rd())&&e.push("?",n),(n=this.ib)&&e.push("#",sc(n,Je)),e.join("")},o.resolve=function(e){var t=this.clone(),n=e.Hf();n?t.tb(e.qa):n=e.If(),n?t.cd(e.zb):n=e.Ic(),n?t.rb(e.xa):n=e.Ff();var r=e.K;if(n)t.sb(e.Ca);else if(n=e.ae()){if("/"!=r.charAt(0))if(this.Ic()&&!this.ae())r="/"+r;else{var i=t.K.lastIndexOf("/");-1!=i&&(r=t.K.substr(0,i+1)+r)}if(".."==(i=r)||"."==i)r="";else if(-1!=i.indexOf("./")||-1!=i.indexOf("/.")){r=0==i.lastIndexOf("/",0),i=i.split("/");for(var o=[],a=0;a<i.length;){var s=i[a++];"."==s?r&&a==i.length&&o.push(""):".."==s?((1<o.length||1==o.length&&""!=o[0])&&o.pop(),r&&a==i.length&&o.push("")):(o.push(s),r=!0)}r=o.join("/")}else r=i}return n?t.ec(r):n=e.Gf(),n?t.bd(e.P.clone()):n=e.Ef(),n&&t.$c(e.ib),t},o.clone=function(){return new U(this)},o.tb=function(e,t){this.U(),(this.qa=t?yc(e,!0):e)&&(this.qa=this.qa.replace(/:$/,""))},o.Hf=function(){return!!this.qa},o.cd=function(e,t){this.U(),this.zb=t?yc(e):e},o.If=function(){return!!this.zb},o.rb=function(e,t){this.U(),this.xa=t?yc(e,!0):e},o.Ic=function(){return!!this.xa},o.sb=function(e){if(this.U(),e){if(e=Number(e),isNaN(e)||0>e)throw Error("Bad port number "+e);this.Ca=e}else this.Ca=null},o.Ff=function(){return null!=this.Ca},o.ec=function(e,t){this.U(),this.K=t?yc(e,!0):e},o.ae=function(){return!!this.K},o.Gf=function(){return""!==this.P.toString()},o.bd=function(e,t){this.U(),e instanceof rc?(this.P=e,this.P.ad(this.O)):(t||(e=sc(e,He)),this.P=new rc(e,this.O))},o.Rd=function(){return this.P.toString()},o.getQuery=function(){return this.Rd()},o.l=function(e,t){this.U(),this.P.set(e,t)},o.dc=function(e,t){this.U(),n(t)||(t=[String(t)]),this.P.Ie(e,t)},o.$c=function(e,t){this.U(),this.ib=t?yc(e):e},o.Ef=function(){return!!this.ib},o.Ub=function(){return this.U(),this.l("zx",Math.floor(2147483648*Math.random()).toString(36)+Math.abs(Math.floor(2147483648*Math.random())^d()).toString(36)),this},o.removeParameter=function(e){return this.U(),this.P.remove(e),this},o.U=function(){if(this.Qf)throw Error("Tried to modify a read-only Uri")},o.ad=function(e){this.O=e,this.P&&this.P.ad(e)};var Ke=/[#\/\?@]/g,ze=/[#\?:]/g,Ge=/[#\?]/g,He=/[#\?@]/g,Je=/#/g;o=rc.prototype,o.$=function(){if(!this.m&&(this.m=new S,this.j=0,this.ja)){var e=this;qc(this.ja,function(t,n){e.add(decodeURIComponent(t.replace(/\+/g," ")),n)})}},o.C=function(){return this.$(),this.j},o.add=function(e,t){this.$(),this.Oa(),e=this.Ma(e);var n=this.m.get(e);return n||this.m.set(e,n=[]),n.push(t),this.j+=1,this},o.remove=function(e){return this.$(),e=this.Ma(e),!!this.m.va(e)&&(this.Oa(),this.j-=this.m.get(e).length,this.m.remove(e))},o.clear=function(){this.Oa(),this.m=null,this.j=0},o.X=function(){return this.$(),0==this.j},o.va=function(e){return this.$(),e=this.Ma(e),this.m.va(e)},o.forEach=function(e,t){this.$(),this.m.forEach(function(n,r){_(n,function(n){e.call(t,n,r,this)},this)},this)},o.W=function(){this.$();for(var e=this.m.H(),t=this.m.W(),n=[],r=0;r<t.length;r++)for(var i=e[r],o=0;o<i.length;o++)n.push(t[r]);return n},o.H=function(e){this.$();var t=[];if(l(e))this.va(e)&&(t=ta(t,this.m.get(this.Ma(e))));else{e=this.m.H();for(var n=0;n<e.length;n++)t=ta(t,e[n])}return t},o.set=function(e,t){return this.$(),this.Oa(),e=this.Ma(e),this.va(e)&&(this.j-=this.m.get(e).length),this.m.set(e,[t]),this.j+=1,this},o.get=function(e,t){return e?(e=this.H(e),0<e.length?String(e[0]):t):t},o.Ie=function(e,t){this.remove(e),0<t.length&&(this.Oa(),this.m.set(this.Ma(e),ua(t)),this.j+=t.length)},o.toString=function(){if(this.ja)return this.ja;if(!this.m)return"";for(var e=[],t=this.m.W(),n=0;n<t.length;n++){var r=t[n],i=encodeURIComponent(String(r));r=this.H(r);for(var o=0;o<r.length;o++){var a=i;""!==r[o]&&(a+="="+encodeURIComponent(String(r[o]))),e.push(a)}}return this.ja=e.join("&")},o.Oa=function(){this.ja=null},o.clone=function(){var e=new rc;return e.ja=this.ja,this.m&&(e.m=this.m.clone(),e.j=this.j),e},o.Ma=function(e){return e=String(e),this.O&&(e=e.toLowerCase()),e},o.ad=function(e){e&&!this.O&&(this.$(),this.Oa(),this.m.forEach(function(e,t){var n=t.toLowerCase();t!=n&&(this.remove(t),this.Ie(n,e))},this)),this.O=e},o.extend=function(e){for(var t=0;t<arguments.length;t++)oc(arguments[t],function(e,t){this.add(t,e)},this)},x(Gc,Fc),o=Hc.prototype,o.g=null,o.ga=function(e){this.A=e},o.connect=function(e){this.K=e,e=this.b.Sd(this.K),O(3);var t=this.b.Ib.$d;null!=t?(this.na=this.b.$a(t[0]),this.g=1,this.xd()):(e.dc("MODE","init"),!this.b.ta&&this.b.aa&&e.dc("X-HTTP-Session-Id",this.b.aa),this.f=new R(this,this.a,void 0,void 0,void 0),this.f.ga(this.A),this.f.jd(e,!1,null),this.g=0)},o.xd=function(){this.a.debug("TestConnection: starting stage 2");var e=this.b.Ib.od;if(null!=e)this.a.debug(function(){return"Buffered"}),O(4),e?(O(10),this.b.ub(this,!1)):(O(11),this.b.ub(this,!0));else{this.f=new R(this,this.a,void 0,void 0,void 0),this.f.ga(this.A);var t=this.b.Pd(this.na,this.K);O(4),t.dc("TYPE","xmlhttp");var n=this.b.aa,r=this.b.Kc;n&&r&&t.l(n,r),this.f.jd(t,!1,this.na)}},o.Jb=function(e){return this.b.Jb(e)},o.abort=function(){this.f&&(this.f.cancel(),this.f=null),this.w=-1},o.de=function(){return!1},o.ue=function(e,t){if(this.w=e.w,0==this.g)if(this.a.debug("TestConnection: Got data for stage 1"),this.pc(e),t){try{var n=this.b.kc.zc(t)}catch(e){return this.a.cb(e),void this.b.dd(this)}this.na=this.b.$a(n[0])}else this.a.debug("TestConnection: Null responseText"),this.b.dd(this);else 1==this.g&&(this.bc?O(6):"11111"==t?(O(5),this.bc=!0,this.Ze()&&(this.w=200,this.f.cancel(),this.a.debug("Test connection succeeded; using streaming connection"),O(11),this.b.ub(this,!0))):(O(7),this.bc=!1))},o.Tc=function(){this.w=this.f.w,this.f.S?0==this.g?(this.g=1,this.a.debug("TestConnection: request complete for initial check"),this.xd()):1==this.g&&(this.a.debug("TestConnection: request complete for stage 2"),this.bc?(this.a.debug("Test connection succeeded; using streaming connection"),O(11),this.b.ub(this,!0)):(this.a.debug("Test connection failed; not using streaming"),O(10),this.b.ub(this,!1))):(this.a.debug("TestConnection: request failed, in state "+this.g),0==this.g?O(8):1==this.g&&O(9),this.b.dd(this))},o.pc=function(e){if(!this.b.ta&&(e=e.h)){var t=e.kb("X-Client-Wire-Protocol");this.Ad=t||null,this.b.aa&&((e=e.kb("X-HTTP-Session-Id"))?this.b.Fe(e):this.a.T("Missing X_HTTP_SESSION_ID in the handshake response"))}},o.fc=function(){return this.b.fc()},o.Ba=function(){return this.b.Ba()},o.Ze=function(){return!te||10<=Number(ce)},o=Jc.prototype,o.C=function(){return this.D.C()},o.add=function(e){this.D.set(Kc(e),e)},o.addAll=function(e){e=nc(e);for(var t=e.length,n=0;n<t;n++)this.add(e[n])},o.pb=function(e){e=nc(e);for(var t=e.length,n=0;n<t;n++)this.remove(e[n])},o.remove=function(e){return this.D.remove(Kc(e))},o.clear=function(){this.D.clear()},o.X=function(){return this.D.X()},o.contains=function(e){return this.D.va(Kc(e))},o.H=function(){return this.D.H()},o.clone=function(){return new Jc(this)};var Xe=10;o=Mc.prototype,o.ld=function(e){this.v||-1==e.indexOf("spdy")&&-1==e.indexOf("quic")&&-1==e.indexOf("h2")||(this.Xb=this.me,this.v=new Jc,this.f&&(this.oc(this.f),this.f=null))},o.ee=function(){return!!this.f||!!this.v&&this.v.C()>=this.Xb},o.xf=function(){return this.f?1:this.v?this.v.C():0},o.Jc=function(e){return this.f?this.f==e:!!this.v&&this.v.contains(e)},o.oc=function(e){this.v?this.v.add(e):this.f=e},o.ze=function(e){this.f&&this.f==e?this.f=null:this.v&&this.v.contains(e)&&this.v.remove(e)},o.cancel=function(){this.ba=this.la(),this.f?(this.f.cancel(),this.f=null):this.v&&!this.v.X()&&(_(this.v.H(),function(e){e.cancel()}),this.v.clear())},o.la=function(){if(null!=this.f)return this.ba.concat(this.f.la());if(null!=this.v&&!this.v.X()){var e=this.ba;return _(this.v.H(),function(t){e=e.concat(t.la())}),e}return ua(this.ba)},o.Re=function(e){this.ba=this.ba.concat(e)},o.$e=function(){this.ba.length=0},Oc.prototype.stringify=function(e){return c.JSON.stringify(e,this.rg)},Oc.prototype.parse=function(e){return c.JSON.parse(e,this.xg)},Pc.prototype.hf=function(e,t,n){var i=n||"";try{oc(e,function(e,n){var o=e;r(e)&&(o=Te(e)),t.push(i+n+"="+encodeURIComponent(o))})}catch(e){throw t.push(i+"type="+encodeURIComponent("_badmap")),e}},Pc.prototype.jf=function(e,t,n){for(var r=-1;;){var i=["count="+t];-1==r?0<t?(r=e[0].Pc,i.push("ofs="+r)):r=0:i.push("ofs="+r);for(var o=!0,a=0;a<t;a++){var s=e[a].Pc,u=e[a].map;if(0>(s-=r))r=Math.max(0,e[a].Pc-100),o=!1;else try{this.hf(u,i,"req"+s+"_")}catch(e){n&&n(u)}}if(o)return i.join("&")}},Pc.prototype.zc=function(e){return this.jg.parse(e)};var Ye=c.JSON.parse;x(V,H);var $e="";V.prototype.s=Vb("goog.net.XhrIo");var Ze=/^https?$/i,et=["POST","PUT"];o=V.prototype,o.Je=function(e){this.Ab=e},o.send=function(e,t,n,r){if(this.c)throw Error("[goog.net.XhrIo] Object is active with another request="+this.Tb+"; newUri="+e);t=t?t.toUpperCase():"GET",this.Tb=e,this.I="",this.Pa=0,this.ge=t,this.Ec=!1,this.ha=!0,this.c=this.df(),this.mc=this.Xa?this.Xa.Vd():qe.Vd(),this.c.onreadystatechange=u(this.te,this),this.lg&&"onprogress"in this.c&&(this.c.onprogress=u(function(e){this.re(e,!0)},this),this.c.upload&&(this.c.upload.onprogress=u(this.re,this)));try{L(this.s,this.da("Opening Xhr")),this.Lc=!0,this.c.open(t,String(e),!0),this.Lc=!1}catch(e){return L(this.s,this.da("Error opening Xhr: "+e.message)),void this.Ld(e)}e=n||"";var i=this.headers.clone();r&&oc(r,function(e,t){i.set(t,e)}),r=pa(i.W()),n=c.FormData&&e instanceof c.FormData,!(0<=w(et,t))||r||n||i.set("Content-Type","application/x-www-form-urlencoded;charset=utf-8"),i.forEach(function(e,t){this.c.setRequestHeader(t,e)},this),this.Ae&&(this.c.responseType=this.Ae),"withCredentials"in this.c&&this.c.withCredentials!==this.Ab&&(this.c.withCredentials=this.Ab);try{this.yd(),0<this.vb&&(this.jc=Wc(this.c),L(this.s,this.da("Will abort after "+this.vb+"ms if incomplete, xhr2 "+this.jc)),this.jc?(this.c.timeout=this.vb,this.c.ontimeout=u(this.Ua,this)):this.hc=Hb(this.Ua,this.vb,this)),L(this.s,this.da("Sending request")),this.Qb=!0,this.c.send(e),this.Qb=!1}catch(e){L(this.s,this.da("Send error: "+e.message)),this.Ld(e)}},o.df=function(){return this.Xa?this.Xa.Dd():qe.Dd()},o.Ua=function(){void 0!==s&&this.c&&(this.I="Timed out after "+this.vb+"ms, aborting",this.Pa=8,L(this.s,this.da(this.I)),this.dispatchEvent("timeout"),this.abort(8))},o.Ld=function(e){this.ha=!1,this.c&&(this.Aa=!0,this.c.abort(),this.Aa=!1),this.I=e,this.Pa=5,this.Jd(),this.Gb()},o.Jd=function(){this.Ec||(this.Ec=!0,this.dispatchEvent("complete"),this.dispatchEvent("error"))},o.abort=function(e){this.c&&this.ha&&(L(this.s,this.da("Aborting")),this.ha=!1,this.Aa=!0,this.c.abort(),this.Aa=!1,this.Pa=e||7,this.dispatchEvent("complete"),this.dispatchEvent("abort"),this.Gb())},o.F=function(){this.c&&(this.ha&&(this.ha=!1,this.Aa=!0,this.c.abort(),this.Aa=!1),this.Gb(!0)),V.L.F.call(this)},o.te=function(){this.Ka||(this.Lc||this.Qb||this.Aa?this.se():this.eg())},o.eg=function(){this.se()},o.se=function(){if(this.ha&&void 0!==s)if(this.mc[1]&&4==this.ma()&&2==this.za())L(this.s,this.da("Local request error detected and ignored"));else if(this.Qb&&4==this.ma())Hb(this.te,0,this);else if(this.dispatchEvent("readystatechange"),this.Mc()){L(this.s,this.da("Request complete")),this.ha=!1;try{this.Rf()?(this.dispatchEvent("complete"),this.dispatchEvent("success")):(this.Pa=6,this.I=this.Yd()+" ["+this.za()+"]",this.Jd())}finally{this.Gb()}}},o.re=function(e,t){this.dispatchEvent(Xc(e,"progress")),this.dispatchEvent(Xc(e,t?"downloadprogress":"uploadprogress"))},o.Gb=function(e){if(this.c){this.yd();var t=this.c,n=this.mc[0]?aa:null;this.mc=this.c=null,e||this.dispatchEvent("ready");try{t.onreadystatechange=n}catch(t){(e=this.s)&&e.ca("Problem encountered resetting onreadystatechange: "+t.message,void 0)}}},o.yd=function(){this.c&&this.jc&&(this.c.ontimeout=null),this.hc&&(c.clearTimeout(this.hc),this.hc=null)},o.Ba=function(){return!!this.c},o.Mc=function(){return 4==this.ma()},o.Rf=function(){var e=this.za();e:switch(e){case 200:case 201:case 202:case 204:case 206:case 304:case 1223:var t=!0;break e;default:t=!1}return t||0===e&&!this.Of()},o.Of=function(){var e=String(this.Tb).match(We)[1]||null;return!e&&c.self&&c.self.location&&(e=c.self.location.protocol,e=e.substr(0,e.length-1)),Ze.test(e?e.toLowerCase():"")},o.ma=function(){return this.c?this.c.readyState:0},o.za=function(){try{return 2<this.ma()?this.c.status:-1}catch(e){return-1}},o.Yd=function(){try{return 2<this.ma()?this.c.statusText:""}catch(e){return L(this.s,"Can not get status: "+e.message),""}},o.ya=function(){try{return this.c?this.c.responseText:""}catch(e){return L(this.s,"Can not get responseText: "+e.message),""}},o.yf=function(e){if(this.c){var t=this.c.responseText;return e&&0==t.indexOf(e)&&(t=t.substring(e.length)),Ye(t)}},o.getResponseHeader=function(e){if(this.c&&this.Mc())return e=this.c.getResponseHeader(e),null===e?void 0:e},o.getAllResponseHeaders=function(){return this.c&&this.Mc()?this.c.getAllResponseHeaders()||"":""},o.kb=function(e){return this.c?this.c.getResponseHeader(e):null},o.Ud=function(){return this.Pa},o.Hc=function(){return l(this.I)?this.I:String(this.I)},o.da=function(e){return e+" ["+this.ge+" "+this.Tb+" "+this.za()+"]"},o=$c.prototype,o.tc=8,o.g=1,o.connect=function(e,t,n,r,i){this.a.debug("connect()"),O(0),this.K=t,this.gb=n||{},r&&void 0!==i&&(this.gb.OSID=r,this.gb.OAID=i),this.ta&&(this.a.debug("connect() bypassed channel-test."),this.Ib.$d=[],this.Ib.od=!1),this.bf(e)},o.disconnect=function(){if(this.a.debug("disconnect()"),this.qd(),3==this.g){var e=this.Yb++,t=this.hb.clone();t.l("SID",this.ra),t.l("RID",e),t.l("TYPE","terminate"),this.Ya(t),new R(this,this.a,this.ra,e,void 0).yg(t)}this.qe()},o.bf=function(e){this.a.debug("connectTest_()"),this.Ja=new Hc(this,this.a),null===this.N&&this.Ja.ga(this.A);var t=e;this.N&&this.A&&(t=Zc(e,this.N,this.A)),this.Ja.connect(t)},o.af=function(){this.a.debug("connectChannel_()"),this.hb=this.Sd(this.K),this.Dc()},o.qd=function(){this.Ja&&(this.Ja.abort(),this.Ja=null),this.u&&(this.u.cancel(),this.u=null),this.ia&&(c.clearTimeout(this.ia),this.ia=null),this.Hb(),this.G.cancel(),this.ea&&(c.clearTimeout(this.ea),this.ea=null)},o.ga=function(e){this.A=e},o.Eg=function(e){this.Rb=e},o.Cg=function(e){this.N=e},o.Dg=function(e){this.aa=e},o.Fe=function(e){this.Kc=e},o.He=function(e){this.Ra=e},o.Hg=function(){this.gc=!0},o.Ee=function(e){this.i=e},o.Nf=function(){return!this.fd},o.Zc=function(e){1e3==this.M.length&&this.a.ca(function(){return"Already have 1000 queued maps upon queueing "+Te(e)}),this.M.push(new Lc(this.ag++,e)),3==this.g&&this.Dc()},o.qf=function(){return this.kf?0:this.nf},o.de=function(){return 0==this.g},o.getState=function(){return this.g},o.Dc=function(){this.G.ee()||this.ea||(this.ea=P(u(this.we,this),0),this.La=0)},o.Yf=function(e){return this.G.xf()>=this.G.Xb-(this.ea?1:0)?(this.a.ca("Unexpected retry request is scheduled."),!1):this.ea?(this.a.debug("Use the retry request that is already scheduled."),this.M=e.la().concat(this.M),!0):!(1==this.g||2==this.g||this.La>=this.qf())&&(this.a.debug("Going to retry POST"),this.ea=P(u(this.we,this,e),this.Xd(this.La)),this.La++,!0)},o.we=function(e){this.ea=null,this.Mg(e)},o.Mg=function(e){this.a.debug("startForwardChannel_"),1==this.g?e?this.a.ca("Not supposed to retry the open"):(this.ig(),this.g=2):3==this.g&&(e?this.le(e):0==this.M.length?this.a.debug("startForwardChannel_ returned: nothing to send"):this.G.ee()?this.a.ca("startForwardChannel_ returned: connection already in progress"):(this.le(),this.a.debug("startForwardChannel_ finished, sent request")))},o.ig=function(){this.a.debug("open_()"),this.Yb=Math.floor(1e5*Math.random());var e=this.Yb++,t=new R(this,this.a,"",e,void 0),n=this.A;this.Rb&&(n?(n=Da(n),Fa(n,this.Rb)):n=this.Rb),null===this.N&&t.ga(n);var r=this.Hd(t),i=this.hb.clone();i.l("RID",e),0<this.Bd&&i.l("CVER",this.Bd),this.ta&&this.aa&&i.l("X-HTTP-Session-Id",this.aa),this.Ya(i),this.N&&n&&Zc(i,this.N,n),this.G.oc(t),this.Nd?(i.l("$req",r),i.l("SID","null"),t.Ag(),t.kd(i,null)):t.kd(i,r)},o.le=function(e){var t=e?e.R:this.Yb++,n=this.hb.clone();n.l("SID",this.ra),n.l("RID",t),n.l("AID",this.Sb),this.Ya(n),this.N&&this.A&&Zc(n,this.N,this.A),t=new R(this,this.a,this.ra,t,this.La+1),null===this.N&&t.ga(this.A),e&&this.sg(e),e=this.Hd(t),t.setTimeout(Math.round(.5*this.Od)+Math.round(.5*this.Od*Math.random())),this.G.oc(t),t.kd(n,e)},o.Ya=function(e){this.i&&oc({},function(t,n){e.l(n,t)})},o.Hd=function(e){var t=Math.min(this.M.length,1e3),n=this.i?u(this.i.Ue,this.i,this):null;return n=this.kc.jf(this.M,t,n),e.Gg(this.M.splice(0,t)),n},o.sg=function(e){this.M=e.la().concat(this.M)},o.Kd=function(){if(!this.u&&!this.ia){this.rc=1;var e=this.ve;Ce||Cb(),Ie||(Ce(),Ie=!0),_e.add(e,this),this.Ha=0}},o.Qc=function(){return this.u||this.ia?(this.a.ca("Request already in progress"),!1):!(3<=this.Ha)&&(this.a.debug("Going to retry GET"),this.rc++,this.ia=P(u(this.ve,this),this.Xd(this.Ha)),this.Ha++,!0)},o.ve=function(){this.ia=null,this.Kg()},o.Kg=function(){this.a.debug("Creating new HttpRequest"),this.u=new R(this,this.a,this.ra,"rpc",this.rc),null===this.N&&this.u.ga(this.A),this.u.He(this.Ra);var e=this.md.clone();e.l("RID","rpc"),e.l("SID",this.ra),e.l("CI",this.fd?"0":"1"),e.l("AID",this.Sb),this.Ya(e),e.l("TYPE","xmlhttp"),this.N&&this.A&&Zc(e,this.N,this.A),this.Db&&this.u.setTimeout(this.Db),this.u.jd(e,!0,this.na),this.a.debug("New Request created")},o.ub=function(e,t){this.a.debug("Test Connection Finished");var n=e.Ad;n&&this.G.ld(n),this.fd=this.Se&&t,this.w=e.w,this.af()},o.dd=function(e){this.a.debug("Test Connection Failed"),this.w=e.w,this.sa(2)},o.ue=function(e,t){if(0!=this.g&&(this.u==e||this.G.Jc(e)))if(this.w=e.w,!e.lb&&this.G.Jc(e)&&3==this.g){try{var r=this.kc.zc(t)}catch(e){r=null}n(r)&&3==r.length?this.Cf(r,e):(this.a.debug("Bad POST response data returned"),this.sa(11))}else(e.lb||this.u==e)&&this.Hb(),va(t)||(r=this.kc.zc(t),this.dg(r,e))},o.Cf=function(e,t){0==e[0]?this.Bf(t):(this.he=e[1],0<(t=this.he-this.Sb)&&(e=e[2],this.a.debug(e+" bytes (in "+t+" arrays) are outstanding on the BackChannel"),this.Jg(e)&&!this.wa&&(this.wa=P(u(this.bg,this),6e3))))},o.Bf=function(e){if(this.a.debug("Server claims our backchannel is missing."),this.ia)this.a.debug("But we are currently starting the request.");else{if(this.u){if(!(this.u.qb+3e3<e.qb))return;this.Hb(),this.u.cancel(),this.u=null}else this.a.T("We do not have a BackChannel established");this.Qc(),O(18)}},o.Jg=function(e){return 37500>e&&!this.Nf()&&0==this.Ha},o.$a=function(e){return this.Te?this.i?this.i.$a(e):e:null},o.bg=function(){null!=this.wa&&(this.wa=null,this.u.cancel(),this.u=null,this.Qc(),O(19))},o.Hb=function(){null!=this.wa&&(c.clearTimeout(this.wa),this.wa=null)},o.Tc=function(e){this.a.debug("Request complete");var t=null;if(this.u==e){this.Hb(),this.u=null;var n=2}else{if(!this.G.Jc(e))return;t=e.la(),this.G.ze(e),n=1}if(this.w=e.w,0!=this.g)if(e.S)1==n?(ac(e.Da?e.Da.length:0,d()-e.qb,this.La),this.Dc()):this.Kd();else{var r=e.Hc();if(3==r||0==r&&0<this.w)this.a.debug("Not retrying due to error type");else{var i=this;if(this.a.debug(function(){return"Maybe retrying, last error: "+kc(r,i.w)}),1==n&&this.Yf(e)||2==n&&this.Qc())return;this.a.debug("Exceeded max number of retries")}switch(t&&0<t.length&&this.G.Re(t),this.a.debug("Error: HTTP request failed"),r){case 1:this.sa(5);break;case 4:this.sa(10);break;case 3:this.sa(6);break;default:this.sa(2)}}},o.Xd=function(e){var t=this.Ve+Math.floor(Math.random()*this.vg);return this.Ba()||(this.a.debug("Inactive channel"),t*=2),t*e},o.pc=function(e){if(this.ta&&(e=e.h)){var t=e.kb("X-Client-Wire-Protocol");t&&this.G.ld(t),this.aa&&((e=e.kb("X-HTTP-Session-Id"))?(this.Fe(e),this.hb.l(this.aa,e)):this.a.T("Missing X_HTTP_SESSION_ID in the handshake response"))}},o.dg=function(e,t){for(var n=this.i&&this.i.sc?[]:null,r=0;r<e.length;r++){var i=e[r];if(this.Sb=i[0],i=i[1],2==this.g)if("c"==i[0]){this.ra=i[1],this.na=this.$a(i[2]);var o=i[3];null!=o&&(this.tc=o,this.a.info("VER="+this.tc)),o=i[4],null!=o&&(this.De=o,this.a.info("SVER="+this.De)),i=i[5],null!=i&&"number"==typeof i&&0<i&&(this.Db=i*=1.5,this.a.info("backChannelRequestTimeoutMs_="+i)),this.pc(t),this.g=3,this.i&&this.i.wd(),this.Lg(t)}else"stop"!=i[0]&&"close"!=i[0]||this.sa(7);else 3==this.g&&("stop"==i[0]||"close"==i[0]?(n&&0!=n.length&&(this.i.sc(this,n),n.length=0),"stop"==i[0]?this.sa(7):this.disconnect()):"noop"!=i[0]&&(n?n.push(i):this.i&&this.i.ud(i)),this.Ha=0)}n&&0!=n.length&&this.i.sc(this,n)},o.Lg=function(e){this.md=this.Pd(this.na,this.K),e.lb?(this.a.debug("Upgrade the handshake request to a backchannel."),this.G.ze(e),e.tg(this.Db),this.u=e):this.Kd()},o.sa=function(e){if(this.a.info("Error code "+e),2==e){var t=null;this.i&&(t=null);var n=u(this.Pg,this);t||(t=new U("//www.google.com/images/cleardot.gif"),c.location&&"http"==c.location.protocol||t.tb("https"),t.Ub()),Qc(t.toString(),n)}else O(2);this.cg(e)},o.Pg=function(e){e?(this.a.info("Successfully pinged google.com"),O(2)):(this.a.info("Failed to ping google.com"),O(1))},o.cg=function(e){this.a.debug("HttpChannel: error - "+e),this.g=0,this.i&&this.i.td(e),this.qe(),this.qd()},o.qe=function(){if(this.g=0,this.w=-1,this.i){var e=this.G.la();if(0!=e.length||0!=this.M.length){var t=this;this.a.debug(function(){return"Number of undelivered maps, pending: "+e.length+", outgoing: "+t.M.length}),this.G.$e(),ua(this.M),this.M.length=0}this.i.sd()}},o.Sd=function(e){return e=this.Cd(null,e),this.a.debug("GetForwardChannelUri: "+e),e},o.Pd=function(e,t){return e=this.Cd(this.fc()?e:null,t),this.a.debug("GetBackChannelUri: "+e),e},o.Cd=function(e,t){var n=Ac(t);if(""!=n.xa)e&&n.rb(e+"."+n.xa),n.sb(n.Ca);else{var r=c.location;n=Bc(r.protocol,e?e+"."+r.hostname:r.hostname,+r.port,t)}return this.gb&&Aa(this.gb,function(e,t){n.l(t,e)}),e=this.aa,t=this.Kc,e&&t&&n.l(e,t),n.l("VER",this.tc),this.Ya(n),n},o.Jb=function(e){if(e&&!this.gc)throw Error("Can't create secondary domain capable XhrIo object.");return e=new V(this.Xa),e.Je(this.gc),e},o.Ba=function(){return!!this.i&&this.i.Ba()},o.fc=function(){return this.gc},o=ad.prototype,o.sc=null,o.wd=function(){},o.ud=function(){},o.td=function(){},o.sd=function(){},o.Ba=function(){return!0},o.Ue=function(){},o.$a=function(e){return e},cd.prototype.cf=function(e,t){return new W(e,t)},x(W,H),o=W.prototype,o.addEventListener=function(e,t,n,r){W.L.addEventListener.call(this,e,t,n,r)},o.removeEventListener=function(e,t,n,r){W.L.removeEventListener.call(this,e,t,n,r)},o.open=function(){this.b.Ee(this.vd),this.Og&&this.b.Hg(),this.b.connect(this.Qg,this.yb,this.Rc||void 0)},o.close=function(){this.b.disconnect()},o.send=function(e){if(l(e)){var t={};t.__data__=e,this.b.Zc(t)}else this.zg?(t={},t.__data__=Te(e),this.b.Zc(t)):this.b.Zc(e)},o.F=function(){this.b.Ee(null),delete this.vd,this.b.disconnect(),delete this.b,W.L.F.call(this)},x(dd,fc),x(ed,gc),x(X,ad),X.prototype.wd=function(){Wb(this.b.s,"WebChannel opened on "+this.b.yb),this.b.dispatchEvent("a")},X.prototype.ud=function(e){this.b.dispatchEvent(new dd(e))},X.prototype.td=function(e){Wb(this.b.s,"WebChannel aborted on "+this.b.yb+" due to channel error: "+e),this.b.dispatchEvent(new ed(e))},X.prototype.sd=function(){Wb(this.b.s,"WebChannel closed on "+this.b.yb),this.b.dispatchEvent("b")};var tt=v(function(e,t){function c(){}c.prototype=e.prototype;var n=new c;return e.apply(n,Array.prototype.slice.call(arguments,1)),n},cd);o=gd.prototype,o.Vf=function(){0==this.V.length&&(this.V=this.Z,this.V.reverse(),this.Z=[])},o.enqueue=function(e){this.Z.push(e)},o.ab=function(){return this.Vf(),this.V.pop()},o.C=function(){return this.V.length+this.Z.length},o.X=function(){return 0==this.V.length&&0==this.Z.length},o.clear=function(){this.V=[],this.Z=[]},o.contains=function(e){return 0<=w(this.V,e)||0<=w(this.Z,e)},o.remove=function(e){var t=this.V,n=C(t,e);return 0<=n?(Array.prototype.splice.call(t,n,1),t=!0):t=!1,t||sa(this.Z,e)},o.H=function(){for(var e=[],t=this.V.length-1;0<=t;--t)e.push(this.V[t]);var n=this.Z.length;for(t=0;t<n;++t)e.push(this.Z[t]);return e},x(hd,z);var nt="[goog.structs.Pool] Min can not be greater than max";o=hd.prototype,o.Mb=function(){var e=d();if(!(null!=this.Nc&&e-this.Nc<this.Ac)){var t=this.qg();return t&&(this.Nc=e,this.oa.add(t)),t}},o.og=function(e){return!!this.oa.remove(e)&&(this.nc(e),!0)},o.qg=function(){for(var e;0<this.Td()&&(e=this.fa.ab(),!this.Sc(e));)this.Cb();return!e&&this.C()<this.Wb&&(e=this.xc()),e},o.nc=function(e){this.oa.remove(e),this.Sc(e)&&this.C()<this.Wb?this.fa.enqueue(e):this.Bc(e)},o.Cb=function(){for(var e=this.fa;this.C()<this.oe;)e.enqueue(this.xc());for(;this.C()>this.Wb&&0<this.Td();)this.Bc(e.ab())},o.xc=function(){return{}},o.Bc=function(e){if("function"==typeof e.bb)e.bb();else for(var t in e)e[t]=null},o.Sc=function(e){return"function"!=typeof e.Ye||e.Ye()},o.contains=function(e){return this.fa.contains(e)||this.oa.contains(e)},o.C=function(){return this.fa.C()+this.oa.C()},o.rf=function(){return this.oa.C()},o.Td=function(){return this.fa.C()},o.X=function(){return this.fa.X()&&this.oa.X()},o.F=function(){if(hd.L.F.call(this),0<this.rf())throw Error("[goog.structs.Pool] Objects not released");delete this.oa;for(var e=this.fa;!e.X();)this.Bc(e.ab());delete this.fa},jd.prototype.getKey=function(){return this.fe},jd.prototype.clone=function(){return new jd(this.fe,this.gd)},o=kd.prototype,o.ce=function(e,t){var n=this.Y;n.push(new jd(e,t)),this.$f(n.length-1)},o.Lf=function(e){if(e instanceof kd){var t=e.W();if(e=e.H(),0>=this.C()){for(var n=this.Y,r=0;r<t.length;r++)n.push(new jd(t[r],e[r]));return}}else t=Ca(e),e=Ba(e);for(r=0;r<t.length;r++)this.ce(t[r],e[r])},o.remove=function(){var e=this.Y,t=e.length,n=e[0];if(!(0>=t))return 1==t?ra(e):(e[0]=e.pop(),this.Zf()),n.gd},o.Zf=function(){for(var e=0,t=this.Y,n=t.length,r=t[e];e<n>>1;){var i=this.tf(e),o=this.zf(e);if(i=o<n&&t[o].getKey()<t[i].getKey()?o:i,t[i].getKey()>r.getKey())break;t[e]=t[i],e=i}t[e]=r},o.$f=function(e){for(var t=this.Y,n=t[e];0<e;){var r=this.wf(e);if(!(t[r].getKey()>n.getKey()))break;t[e]=t[r],e=r}t[e]=n},o.tf=function(e){return 2*e+1},o.zf=function(e){return 2*e+2},o.wf=function(e){return e-1>>1},o.H=function(){for(var e=this.Y,t=[],n=e.length,r=0;r<n;r++)t.push(e[r].gd);return t},o.W=function(){for(var e=this.Y,t=[],n=e.length,r=0;r<n;r++)t.push(e[r].getKey());return t},o.va=function(e){return A(this.Y,function(t){return t.getKey()==e})},o.clone=function(){return new kd(this)},o.C=function(){return this.Y.length},o.X=function(){return 0==this.Y.length},o.clear=function(){ra(this.Y)},x(ld,kd),ld.prototype.enqueue=function(e,t){this.ce(e,t)},ld.prototype.ab=function(){return this.remove()},x(Y,hd),o=Y.prototype,o.Mb=function(e,t){if(!e)return(e=Y.L.Mb.call(this))&&this.Ac&&(this.Gd=c.setTimeout(u(this.Nb,this),this.Ac)),e;this.cc.enqueue(void 0!==t?t:100,e),this.Nb()},o.Nb=function(){for(var e=this.cc;0<e.C();){var t=this.Mb();if(!t)break;e.ab().apply(this,[t])}},o.nc=function(e){Y.L.nc.call(this,e),this.Nb()},o.Cb=function(){Y.L.Cb.call(this),this.Nb()},o.F=function(){Y.L.F.call(this),c.clearTimeout(this.Gd),this.cc.clear(),this.cc=null},x(Z,Y),Z.prototype.xc=function(){var e=new V,t=this.Jf;return t&&t.forEach(function(t,n){e.headers.set(n,t)}),this.Ab&&e.Je(!0),e},Z.prototype.Sc=function(e){return!e.Ka&&!e.Ba()},cd.prototype.createWebChannel=cd.prototype.cf,W.prototype.send=W.prototype.send,W.prototype.open=W.prototype.open,W.prototype.close=W.prototype.close,Fe.NO_ERROR=0,Fe.TIMEOUT=8,Fe.HTTP_ERROR=6,Ve.COMPLETE="complete",ec.EventType=Be,Be.OPEN="a",Be.CLOSE="b",Be.ERROR="c",Be.MESSAGE="d",H.prototype.listen=H.prototype.nb,Z.prototype.getObject=Z.prototype.Mb,Z.prototype.releaseObject=Z.prototype.og,V.prototype.listenOnce=V.prototype.Oc,V.prototype.getLastError=V.prototype.Hc,V.prototype.getLastErrorCode=V.prototype.Ud,V.prototype.getStatus=V.prototype.za,V.prototype.getStatusText=V.prototype.Yd,V.prototype.getResponseJson=V.prototype.yf,V.prototype.getResponseText=V.prototype.ya,V.prototype.getResponseText=V.prototype.ya,V.prototype.send=V.prototype.send;var rt={createWebChannelTransport:tt,ErrorCode:Fe,EventType:Ve,WebChannel:ec,XhrIoPool:Z},it=rt.createWebChannelTransport,ot=rt.ErrorCode,at=rt.EventType,st=rt.WebChannel,ut=rt.XhrIoPool;t.default=rt}.call(t,i(0))}]);
